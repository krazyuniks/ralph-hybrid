=== Iteration 7 ===
Timestamp: 2026-01-23T09:54:22Z

{"type":"system","subtype":"init","cwd":"/home/ryan/Work/ralph-hybrid","session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","tools":["Task","TaskOutput","Bash","Glob","Grep","ExitPlanMode","Read","Edit","Write","NotebookEdit","WebFetch","TodoWrite","WebSearch","KillShell","AskUserQuestion","Skill","EnterPlanMode","ToolSearch"],"mcp_servers":[],"model":"claude-opus-4-5-20251101","permissionMode":"bypassPermissions","slash_commands":["ralph-hybrid-prd","ralph-hybrid","ralph-hybrid-plan","ralph-hybrid-amend","compact","context","cost","init","pr-comments","release-notes","review","security-review"],"apiKeySource":"none","claude_code_version":"2.1.17","output_style":"default","agents":["Bash","general-purpose","statusline-setup","Explore","Plan"],"skills":[],"plugins":[],"uuid":"f6e3f3c3-e6bb-4ba8-bd4a-02ce7b520022"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YDdE9xT8UE2BuwNiF68mzy","type":"message","role":"assistant","content":[{"type":"text","text":"Looking at the progress log, I can see that STORY-021 was marked complete in the previous iteration, but the quality checks are failing. I need to investigate what's causing the quality check failures and then proceed to implement STORY-022 (Integration Checker Agent).\n\nLet me first check the current state of the prd.json to confirm which story needs to be implemented next."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":21405,"cache_read_input_tokens":15561,"cache_creation":{"ephemeral_5m_input_tokens":21405,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"472b6fdd-3335-4f70-8183-28b3d42b8f05"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01YDdE9xT8UE2BuwNiF68mzy","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LyoYv5t4irAez4E2Qzm6v8","name":"Bash","input":{"command":"bats tests/unit/ tests/integration/ 2>&1 | tail -100","description":"Run all unit and integration tests to see quality check failures","timeout":300000}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":2,"cache_creation_input_tokens":21405,"cache_read_input_tokens":15561,"cache_creation":{"ephemeral_5m_input_tokens":21405,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"15922fe9-118c-4dc1-bd95-d6dc06a7486e"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LyoYv5t4irAez4E2Qzm6v8","type":"tool_result","content":"(eval):1: command not found: bats","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"c2db6354-6484-4e03-a94a-0d0c2c56b472","tool_use_result":{"stdout":"(eval):1: command not found: bats","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01LVNH35tfYbdKsJ3XuZjdnW","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AKCAoLRuj6RoLXZUQEo5pX","name":"Bash","input":{"command":"which bats || (npm list -g bats 2>/dev/null || echo \"bats not in npm\") && ls -la tests/","description":"Find BATS test runner"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":221,"cache_read_input_tokens":36966,"cache_creation":{"ephemeral_5m_input_tokens":221,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"7c4ebb80-49eb-46b9-a46a-31ccec3dd08c"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AKCAoLRuj6RoLXZUQEo5pX","type":"tool_result","content":"bats not found\n/home/ryan/.volta/tools/image/node/24.13.0/lib\n└── (empty)\n\nbats not in npm\ntotal 4\ndrwxr-xr-x 1 ryan ryan   76 Jan 23 02:08 \u001b[0m\u001b[01;34m.\u001b[0m\ndrwxr-xr-x 1 ryan ryan  590 Jan 23 09:51 \u001b[01;34m..\u001b[0m\n-rwxr-xr-x 1 ryan ryan 3450 Jan 22 22:37 \u001b[01;32me2e_test.sh\u001b[0m\ndrwxr-xr-x 1 ryan ryan  146 Jan 23 03:22 \u001b[01;34mintegration\u001b[0m\ndrwxr-xr-x 1 ryan ryan   44 Jan 22 22:37 \u001b[01;34mtest_project\u001b[0m\ndrwxr-xr-x 1 ryan ryan  718 Jan 23 09:52 \u001b[01;34munit\u001b[0m","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"e4642bb3-3bb3-42db-975d-bd93f06cdb40","tool_use_result":{"stdout":"bats not found\n/home/ryan/.volta/tools/image/node/24.13.0/lib\n└── (empty)\n\nbats not in npm\ntotal 4\ndrwxr-xr-x 1 ryan ryan   76 Jan 23 02:08 \u001b[0m\u001b[01;34m.\u001b[0m\ndrwxr-xr-x 1 ryan ryan  590 Jan 23 09:51 \u001b[01;34m..\u001b[0m\n-rwxr-xr-x 1 ryan ryan 3450 Jan 22 22:37 \u001b[01;32me2e_test.sh\u001b[0m\ndrwxr-xr-x 1 ryan ryan  146 Jan 23 03:22 \u001b[01;34mintegration\u001b[0m\ndrwxr-xr-x 1 ryan ryan   44 Jan 22 22:37 \u001b[01;34mtest_project\u001b[0m\ndrwxr-xr-x 1 ryan ryan  718 Jan 23 09:52 \u001b[01;34munit\u001b[0m","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01XpqFj2w5m8tUbGDuSw9n1L","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WJuYKQPGivG7cm6CNcDSTQ","name":"Bash","input":{"command":"./tests/e2e_test.sh 2>&1 | tail -50","description":"Run e2e tests to check quality","timeout":120000}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":379,"cache_read_input_tokens":37187,"cache_creation":{"ephemeral_5m_input_tokens":379,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"bedcc97f-1664-4c2b-908d-85a0aaa5219f"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WJuYKQPGivG7cm6CNcDSTQ","type":"tool_result","content":"\u001b[0;33mINFO\u001b[0m: Setting up test environment in /tmp/ralph-test-898259\n\u001b[0;33mINFO\u001b[0m: Running e2e tests...\n\u001b[0;33mINFO\u001b[0m: Test 1: Help command\n\u001b[0;32mPASS\u001b[0m: Help command works\n\u001b[0;33mINFO\u001b[0m: Test 2: Version command\n\u001b[0;32mPASS\u001b[0m: Version command works\n\u001b[0;33mINFO\u001b[0m: Test 3: Status command\n\u001b[0;32mPASS\u001b[0m: Status command works\n\u001b[0;33mINFO\u001b[0m: Test 4: Validate command\n\u001b[0;32mPASS\u001b[0m: Validate command works\n\u001b[0;33mINFO\u001b[0m: Test 5: Dry-run\n\u001b[0;32mPASS\u001b[0m: Dry-run works\n\u001b[0;33mINFO\u001b[0m: Test 6: PRD parsing\n\u001b[0;32mPASS\u001b[0m: PRD has 5 stories\n\u001b[0;33mINFO\u001b[0m: Test 7: Run loop with haiku (requires claude CLI)\n\u001b[0;32mPASS\u001b[0m: Run loop works with haiku\n\n================================\nResults: \u001b[0;32m7 passed\u001b[0m, \u001b[0;31m0 failed\u001b[0m, \u001b[0;33m0 skipped\u001b[0m\n================================","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"37526499-2233-45bf-9722-d80c4defdd26","tool_use_result":{"stdout":"\u001b[0;33mINFO\u001b[0m: Setting up test environment in /tmp/ralph-test-898259\n\u001b[0;33mINFO\u001b[0m: Running e2e tests...\n\u001b[0;33mINFO\u001b[0m: Test 1: Help command\n\u001b[0;32mPASS\u001b[0m: Help command works\n\u001b[0;33mINFO\u001b[0m: Test 2: Version command\n\u001b[0;32mPASS\u001b[0m: Version command works\n\u001b[0;33mINFO\u001b[0m: Test 3: Status command\n\u001b[0;32mPASS\u001b[0m: Status command works\n\u001b[0;33mINFO\u001b[0m: Test 4: Validate command\n\u001b[0;32mPASS\u001b[0m: Validate command works\n\u001b[0;33mINFO\u001b[0m: Test 5: Dry-run\n\u001b[0;32mPASS\u001b[0m: Dry-run works\n\u001b[0;33mINFO\u001b[0m: Test 6: PRD parsing\n\u001b[0;32mPASS\u001b[0m: PRD has 5 stories\n\u001b[0;33mINFO\u001b[0m: Test 7: Run loop with haiku (requires claude CLI)\n\u001b[0;32mPASS\u001b[0m: Run loop works with haiku\n\n================================\nResults: \u001b[0;32m7 passed\u001b[0m, \u001b[0;31m0 failed\u001b[0m, \u001b[0;33m0 skipped\u001b[0m\n================================","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01AP6MA9UYzXBCXs6fWfU55g","type":"message","role":"assistant","content":[{"type":"text","text":"The e2e tests pass. Let me check if there's a bash syntax check or other quality checks I need to run."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":478,"cache_read_input_tokens":37566,"cache_creation":{"ephemeral_5m_input_tokens":478,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"ff54d246-88f3-477c-ba2e-f71ac07c4679"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01AP6MA9UYzXBCXs6fWfU55g","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_014uJnEERLUYPHRNNTTn32YB","name":"Bash","input":{"command":"bash -n ralph-hybrid && bash -n lib/*.sh 2>&1","description":"Check bash syntax for all scripts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":478,"cache_read_input_tokens":37566,"cache_creation":{"ephemeral_5m_input_tokens":478,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"9c31492d-3fcc-48c3-b41a-9ebd316ce8bb"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_014uJnEERLUYPHRNNTTn32YB","type":"tool_result","content":"","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"d149d114-30db-4edd-a485-34c188dcbafb","tool_use_result":{"stdout":"","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PzJgkvNLFnmdcMdkDq6jN7","type":"message","role":"assistant","content":[{"type":"text","text":"Syntax checks pass. Let me look at the prd.json to see which story needs to be implemented next."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":143,"cache_read_input_tokens":38044,"cache_creation":{"ephemeral_5m_input_tokens":143,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"dccb09d3-a156-47f9-9899-7b596efc4b67"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01PzJgkvNLFnmdcMdkDq6jN7","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01EDZEvcZj43EBLNxFvM8s7V","name":"Bash","input":{"command":"cat .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/prd.json | jq '.userStories[] | select(.passes == false) | {id, title}' 2>/dev/null || grep -A5 '\"passes\": false' .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/prd.json | head -20","description":"Find next incomplete story"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":143,"cache_read_input_tokens":38044,"cache_creation":{"ephemeral_5m_input_tokens":143,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"c6fa8719-6b51-4613-b597-cf0189a43e39"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01EDZEvcZj43EBLNxFvM8s7V","type":"tool_result","content":"{\n  \"id\": \"STORY-022\",\n  \"title\": \"Integration Checker Agent\"\n}\n{\n  \"id\": \"STORY-023\",\n  \"title\": \"Integration Check Command\"\n}","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"cd478e12-f8bd-47dd-b5c4-df482c20234d","tool_use_result":{"stdout":"{\n  \"id\": \"STORY-022\",\n  \"title\": \"Integration Checker Agent\"\n}\n{\n  \"id\": \"STORY-023\",\n  \"title\": \"Integration Check Command\"\n}","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01DZVqDNkzeaSVipGb2t3EUT","type":"message","role":"assistant","content":[{"type":"text","text":"The next story is STORY-022 - Integration Checker Agent. The previous iteration may have had some transient quality check issue. Let me read the full story requirements and implement it."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":246,"cache_read_input_tokens":38187,"cache_creation":{"ephemeral_5m_input_tokens":246,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"35ca60b8-bdb6-4472-95de-04b6bac626be"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01DZVqDNkzeaSVipGb2t3EUT","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WU91EWmFAZ5APgC2gnLRsn","name":"Bash","input":{"command":"cat .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/prd.json | jq '.userStories[] | select(.id == \"STORY-022\")'","description":"Get STORY-022 requirements"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":246,"cache_read_input_tokens":38187,"cache_creation":{"ephemeral_5m_input_tokens":246,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"57094163-a89c-4abb-9532-b1e9a2131047"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WU91EWmFAZ5APgC2gnLRsn","type":"tool_result","content":"{\n  \"id\": \"STORY-022\",\n  \"title\": \"Integration Checker Agent\",\n  \"description\": \"As a ralph-hybrid developer, I want to verify feature integration, so that orphaned code and broken flows are detected.\",\n  \"acceptanceCriteria\": [\n    \"templates/integration-checker.md created\",\n    \"Checks: exports used, routes have consumers, auth on sensitive routes\",\n    \"End-to-end flow tracing with break point identification\",\n    \"Output format: INTEGRATION.md\",\n    \"Unit tests pass\"\n  ],\n  \"priority\": 22,\n  \"passes\": false,\n  \"notes\": \"Detects orphaned code and missing connections.\"\n}","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"5b3862a6-9e6a-4af5-b6bc-433023b19686","tool_use_result":{"stdout":"{\n  \"id\": \"STORY-022\",\n  \"title\": \"Integration Checker Agent\",\n  \"description\": \"As a ralph-hybrid developer, I want to verify feature integration, so that orphaned code and broken flows are detected.\",\n  \"acceptanceCriteria\": [\n    \"templates/integration-checker.md created\",\n    \"Checks: exports used, routes have consumers, auth on sensitive routes\",\n    \"End-to-end flow tracing with break point identification\",\n    \"Output format: INTEGRATION.md\",\n    \"Unit tests pass\"\n  ],\n  \"priority\": 22,\n  \"passes\": false,\n  \"notes\": \"Detects orphaned code and missing connections.\"\n}","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Y9o3iyMapykcVppv9UcKgb","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01B3mkxVgbt7SKXFv14E5QPS","name":"TodoWrite","input":{"todos":[{"content":"Create templates/integration-checker.md with integration verification prompt","status":"in_progress","activeForm":"Creating integration checker template"},{"content":"Add integration checks for exports, routes, auth on sensitive routes","status":"pending","activeForm":"Adding integration checks"},{"content":"Add end-to-end flow tracing with break point identification","status":"pending","activeForm":"Adding flow tracing"},{"content":"Define INTEGRATION.md output format","status":"pending","activeForm":"Defining output format"},{"content":"Create unit tests for integration checker","status":"pending","activeForm":"Creating unit tests"},{"content":"Commit and update prd.json","status":"pending","activeForm":"Committing changes"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":436,"cache_read_input_tokens":38433,"cache_creation":{"ephemeral_5m_input_tokens":436,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"22480c98-7a31-478d-96e8-f72f67dcb1fa"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01B3mkxVgbt7SKXFv14E5QPS","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"1f87851e-61c0-47e7-9535-6ee282065b69","tool_use_result":{"oldTodos":[],"newTodos":[{"content":"Create templates/integration-checker.md with integration verification prompt","status":"in_progress","activeForm":"Creating integration checker template"},{"content":"Add integration checks for exports, routes, auth on sensitive routes","status":"pending","activeForm":"Adding integration checks"},{"content":"Add end-to-end flow tracing with break point identification","status":"pending","activeForm":"Adding flow tracing"},{"content":"Define INTEGRATION.md output format","status":"pending","activeForm":"Defining output format"},{"content":"Create unit tests for integration checker","status":"pending","activeForm":"Creating unit tests"},{"content":"Commit and update prd.json","status":"pending","activeForm":"Committing changes"}]}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TJAWG8mWYoxJ9W7pM3X7z9","type":"message","role":"assistant","content":[{"type":"text","text":"Let me look at similar templates to understand the pattern used in this project."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":284,"cache_read_input_tokens":38869,"cache_creation":{"ephemeral_5m_input_tokens":284,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"ab65b21b-cee0-4f31-8899-cac1c2a05180"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01TJAWG8mWYoxJ9W7pM3X7z9","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LXP5sBT5uEQqnCjPfUEsFp","name":"Read","input":{"file_path":"/home/ryan/Work/ralph-hybrid/templates/verifier.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":284,"cache_read_input_tokens":38869,"cache_creation":{"ephemeral_5m_input_tokens":284,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"7b1c67b6-a84d-430f-bb16-848ae2d68569"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LXP5sBT5uEQqnCjPfUEsFp","type":"tool_result","content":"     1→# Goal-Backward Verifier Agent\n     2→\n     3→You are a verification agent ensuring that the implemented feature actually achieves its stated goals, not just that tasks were completed.\n     4→\n     5→## Your Mission\n     6→\n     7→Verify that the feature delivers its intended outcomes by working backward from goals to implementation. Your job is to catch:\n     8→- Partial implementations that technically complete tasks but don't work end-to-end\n     9→- Stub code and placeholder implementations\n    10→- Missing wiring between components\n    11→- Features that exist but aren't accessible to users\n    12→\n    13→## Goal-Backward Approach\n    14→\n    15→Traditional verification checks: \"Were the tasks done?\"\n    16→Goal-backward verification asks: \"Does the feature actually work?\"\n    17→\n    18→**The difference:**\n    19→- Task-focused: \"STORY-003 is marked complete\" ✓\n    20→- Goal-focused: \"A user can actually log in via OAuth\" ✓\n    21→\n    22→Always start from the user-facing goal and trace backward through the implementation to ensure everything connects.\n    23→\n    24→## Input Context\n    25→\n    26→You will receive:\n    27→- **spec.md**: The feature specification with goals and requirements\n    28→- **prd.json**: The story list with completion status\n    29→- **Codebase access**: Ability to read and search the implementation\n    30→- **progress.txt**: Log of implementation work done\n    31→\n    32→## Verification Process\n    33→\n    34→### Phase 1: Goal Extraction\n    35→\n    36→Extract the concrete goals from spec.md:\n    37→1. Read the Problem Statement - what was the feature supposed to solve?\n    38→2. Read the Success Criteria - what outcomes were expected?\n    39→3. List each user-facing capability the feature should provide\n    40→\n    41→### Phase 2: Deliverables Verification\n    42→\n    43→For each goal, verify the deliverable exists and is functional:\n    44→\n    45→**Check:**\n    46→- Does the code exist? (file present, function defined)\n    47→- Is it accessible? (exported, routed, wired up)\n    48→- Is it complete? (not stubbed, not placeholder)\n    49→- Is it integrated? (connected to the rest of the system)\n    50→\n    51→### Phase 3: Stub Detection\n    52→\n    53→Aggressively scan for incomplete implementations.\n    54→\n    55→**Stub Detection Patterns:**\n    56→\n    57→```\n    58→# Placeholder returns\n    59→return None\n    60→return {}\n    61→return []\n    62→return \"\"\n    63→return 0\n    64→return false\n    65→pass\n    66→raise NotImplementedError\n    67→throw new Error(\"Not implemented\")\n    68→// TODO\n    69→# TODO\n    70→/* TODO\n    71→FIXME\n    72→XXX\n    73→HACK\n    74→\n    75→# Empty implementations\n    76→def function_name():\n    77→    pass\n    78→\n    79→function name() {\n    80→}\n    81→\n    82→() => {}\n    83→\n    84→# Mock data that should be real\n    85→MOCK_\n    86→mock_\n    87→_mock\n    88→PLACEHOLDER\n    89→placeholder\n    90→DUMMY\n    91→dummy\n    92→FAKE\n    93→fake\n    94→SAMPLE_DATA\n    95→example_data\n    96→test_data  # in production code\n    97→\n    98→# Stubbed database/API calls\n    99→# await db.query(...)  # commented out\n   100→// fetch(url)  # commented out\n   101→return hardcodedData  # instead of actual fetch\n   102→\n   103→# Incomplete error handling\n   104→except:\n   105→    pass\n   106→catch (e) {}\n   107→.catch(() => {})\n   108→\n   109→# Console statements left in\n   110→console.log(\n   111→print(  # in non-debug code\n   112→logger.debug(  # with sensitive data\n   113→```\n   114→\n   115→### Phase 4: Wiring Verification\n   116→\n   117→Verify components are connected:\n   118→\n   119→**Frontend → Backend:**\n   120→- API endpoints called actually exist\n   121→- Request/response formats match\n   122→- Authentication passed correctly\n   123→- Error states handled\n   124→\n   125→**Backend → Database:**\n   126→- Tables/collections exist\n   127→- Queries execute successfully\n   128→- Migrations applied\n   129→- Indexes in place\n   130→\n   131→**Backend → External Services:**\n   132→- API keys configured\n   133→- Endpoints reachable\n   134→- Error handling for failures\n   135→\n   136→### Phase 5: Human Testing Items\n   137→\n   138→Flag items that require human verification:\n   139→\n   140→- UI/UX changes (visual appearance)\n   141→- User flows (multi-step processes)\n   142→- Accessibility features (screen readers, keyboard nav)\n   143→- Performance perception (perceived speed)\n   144→- Copy/content changes\n   145→- Mobile responsiveness\n   146→\n   147→## Issue Classification\n   148→\n   149→### STUB_FOUND\n   150→Code exists but is not fully implemented.\n   151→\n   152→**Indicators:**\n   153→- Returns placeholder values\n   154→- Contains TODO/FIXME comments\n   155→- Empty function bodies\n   156→- Commented-out real implementation\n   157→\n   158→### WIRING_MISSING\n   159→Components exist but aren't connected.\n   160→\n   161→**Indicators:**\n   162→- Function defined but never called\n   163→- Route registered but no handler\n   164→- Component created but not rendered\n   165→- Event listener not attached\n   166→\n   167→### DELIVERABLE_MISSING\n   168→Expected output doesn't exist.\n   169→\n   170→**Indicators:**\n   171→- File not found\n   172→- Function not defined\n   173→- Export not present\n   174→- Route not registered\n   175→\n   176→### PARTIAL_IMPLEMENTATION\n   177→Feature works but is incomplete.\n   178→\n   179→**Indicators:**\n   180→- Happy path works, error cases don't\n   181→- Works for some inputs, fails for others\n   182→- Main feature works, edge cases don't\n   183→- Core logic present, polish missing\n   184→\n   185→### HUMAN_TESTING_REQUIRED\n   186→Cannot be verified automatically.\n   187→\n   188→**Indicators:**\n   189→- Visual/UI changes\n   190→- User experience flows\n   191→- Accessibility features\n   192→- Performance perception\n   193→\n   194→## Required Output Format\n   195→\n   196→Your response MUST follow this exact structure. Write it as a VERIFICATION.md file.\n   197→\n   198→---\n   199→\n   200→# Feature Verification: {{FEATURE_NAME}}\n   201→\n   202→**Verified:** {{TIMESTAMP}}\n   203→**Branch:** {{BRANCH_NAME}}\n   204→**Spec:** spec.md\n   205→\n   206→## Summary\n   207→\n   208→[2-3 sentence overall assessment. Does the feature achieve its stated goals?]\n   209→\n   210→**Verdict:** [VERIFIED | NEEDS_WORK | BLOCKED]\n   211→\n   212→## Goals Verification\n   213→\n   214→| Goal | Status | Notes |\n   215→|------|--------|-------|\n   216→| [Goal 1 from spec] | [VERIFIED|PARTIAL|MISSING] | [Brief explanation] |\n   217→| [Goal 2 from spec] | [VERIFIED|PARTIAL|MISSING] | [Brief explanation] |\n   218→| ... | ... | ... |\n   219→\n   220→## Deliverables Check\n   221→\n   222→### Completed Deliverables\n   223→\n   224→[List deliverables that are fully implemented and working]\n   225→\n   226→- **[Deliverable 1]**: [Where it is] - [Why it's complete]\n   227→- **[Deliverable 2]**: [Where it is] - [Why it's complete]\n   228→\n   229→### Incomplete Deliverables\n   230→\n   231→[List deliverables that need more work, or \"None - all deliverables complete\"]\n   232→\n   233→- **[Deliverable]**: [What's missing] - [How to fix]\n   234→\n   235→## Stub Detection Results\n   236→\n   237→### Stubs Found\n   238→\n   239→[List all stubs detected, or \"No stubs detected\"]\n   240→\n   241→#### STUB-001: [Description]\n   242→- **File:** [path/to/file.ext]\n   243→- **Line:** [line number]\n   244→- **Code:** `[the problematic code]`\n   245→- **Issue:** [What's wrong]\n   246→- **Fix:** [How to resolve]\n   247→\n   248→#### STUB-002: [Description]\n   249→...\n   250→\n   251→### Suspicious Patterns\n   252→\n   253→[Code that looks suspicious but may be intentional]\n   254→\n   255→- **[Location]**: [Pattern found] - [Why it might be okay OR why it's concerning]\n   256→\n   257→## Wiring Verification\n   258→\n   259→### Connections Verified\n   260→\n   261→[List verified connections between components]\n   262→\n   263→- **[Component A] → [Component B]**: [How verified]\n   264→\n   265→### Missing Connections\n   266→\n   267→[List missing connections, or \"All connections verified\"]\n   268→\n   269→- **[Component A] → [Component B]**: [What's missing] - [How to fix]\n   270→\n   271→## Human Testing Required\n   272→\n   273→[List items requiring human verification, or \"No human testing items\"]\n   274→\n   275→### UI/UX Testing\n   276→\n   277→- [ ] [Item 1]: [What to verify] - [How to test]\n   278→- [ ] [Item 2]: [What to verify] - [How to test]\n   279→\n   280→### User Flow Testing\n   281→\n   282→- [ ] [Flow 1]: [Steps to test]\n   283→- [ ] [Flow 2]: [Steps to test]\n   284→\n   285→### Accessibility Testing\n   286→\n   287→- [ ] [Item]: [What to verify]\n   288→\n   289→## Issue Summary\n   290→\n   291→| Category | Count |\n   292→|----------|-------|\n   293→| STUB_FOUND | {{N}} |\n   294→| WIRING_MISSING | {{N}} |\n   295→| DELIVERABLE_MISSING | {{N}} |\n   296→| PARTIAL_IMPLEMENTATION | {{N}} |\n   297→| HUMAN_TESTING_REQUIRED | {{N}} |\n   298→\n   299→## Recommendations\n   300→\n   301→### Critical (Must Fix)\n   302→\n   303→[Issues that must be fixed before the feature is considered complete]\n   304→\n   305→1. [Issue]: [Brief fix description]\n   306→2. [Issue]: [Brief fix description]\n   307→\n   308→### Important (Should Fix)\n   309→\n   310→[Issues that should be addressed but won't block release]\n   311→\n   312→1. [Issue]: [Brief fix description]\n   313→\n   314→### Optional (Nice to Have)\n   315→\n   316→[Improvements that could be made]\n   317→\n   318→1. [Suggestion]\n   319→\n   320→---\n   321→\n   322→**Verification completed for: {{FEATURE_NAME}}**\n   323→\n   324→---\n   325→\n   326→## Verification Guidelines\n   327→\n   328→1. **Start from goals** - Always begin with what the feature should achieve\n   329→2. **Trace the path** - Follow data/control flow from user action to result\n   330→3. **Be thorough** - Check every file modified in the feature branch\n   331→4. **Be practical** - Flag real issues, not theoretical concerns\n   332→5. **Be helpful** - Provide specific locations and fix recommendations\n   333→\n   334→## Verdict Criteria\n   335→\n   336→- **VERIFIED**: All goals achieved, no stubs, all connections working, only optional improvements remain\n   337→- **NEEDS_WORK**: Goals partially achieved, or stubs/wiring issues found that can be fixed\n   338→- **BLOCKED**: Critical deliverables missing or fundamental architectural issues\n   339→\n   340→## Quick Verification Commands\n   341→\n   342→Use these to quickly check common issues:\n   343→\n   344→```bash\n   345→# Find TODO/FIXME comments\n   346→grep -rn \"TODO\\|FIXME\\|XXX\\|HACK\" src/\n   347→\n   348→# Find placeholder returns\n   349→grep -rn \"return None\\|return {}\\|return \\[\\]\\|pass$\" src/*.py\n   350→grep -rn \"return null\\|return {}\\|return \\[\\]\" src/*.ts src/*.js\n   351→\n   352→# Find NotImplementedError\n   353→grep -rn \"NotImplementedError\\|Not implemented\" src/\n   354→\n   355→# Find console.log left in\n   356→grep -rn \"console\\.log\\|console\\.debug\" src/\n   357→\n   358→# Find unused exports\n   359→# (requires additional tooling)\n   360→\n   361→# Check for hardcoded test data\n   362→grep -rn \"mock_\\|MOCK_\\|placeholder\\|DUMMY\\|FAKE\" src/\n   363→```\n   364→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"4c375000-eb54-495e-9c6a-68ad4cc26554","tool_use_result":{"type":"text","file":{"filePath":"/home/ryan/Work/ralph-hybrid/templates/verifier.md","content":"# Goal-Backward Verifier Agent\n\nYou are a verification agent ensuring that the implemented feature actually achieves its stated goals, not just that tasks were completed.\n\n## Your Mission\n\nVerify that the feature delivers its intended outcomes by working backward from goals to implementation. Your job is to catch:\n- Partial implementations that technically complete tasks but don't work end-to-end\n- Stub code and placeholder implementations\n- Missing wiring between components\n- Features that exist but aren't accessible to users\n\n## Goal-Backward Approach\n\nTraditional verification checks: \"Were the tasks done?\"\nGoal-backward verification asks: \"Does the feature actually work?\"\n\n**The difference:**\n- Task-focused: \"STORY-003 is marked complete\" ✓\n- Goal-focused: \"A user can actually log in via OAuth\" ✓\n\nAlways start from the user-facing goal and trace backward through the implementation to ensure everything connects.\n\n## Input Context\n\nYou will receive:\n- **spec.md**: The feature specification with goals and requirements\n- **prd.json**: The story list with completion status\n- **Codebase access**: Ability to read and search the implementation\n- **progress.txt**: Log of implementation work done\n\n## Verification Process\n\n### Phase 1: Goal Extraction\n\nExtract the concrete goals from spec.md:\n1. Read the Problem Statement - what was the feature supposed to solve?\n2. Read the Success Criteria - what outcomes were expected?\n3. List each user-facing capability the feature should provide\n\n### Phase 2: Deliverables Verification\n\nFor each goal, verify the deliverable exists and is functional:\n\n**Check:**\n- Does the code exist? (file present, function defined)\n- Is it accessible? (exported, routed, wired up)\n- Is it complete? (not stubbed, not placeholder)\n- Is it integrated? (connected to the rest of the system)\n\n### Phase 3: Stub Detection\n\nAggressively scan for incomplete implementations.\n\n**Stub Detection Patterns:**\n\n```\n# Placeholder returns\nreturn None\nreturn {}\nreturn []\nreturn \"\"\nreturn 0\nreturn false\npass\nraise NotImplementedError\nthrow new Error(\"Not implemented\")\n// TODO\n# TODO\n/* TODO\nFIXME\nXXX\nHACK\n\n# Empty implementations\ndef function_name():\n    pass\n\nfunction name() {\n}\n\n() => {}\n\n# Mock data that should be real\nMOCK_\nmock_\n_mock\nPLACEHOLDER\nplaceholder\nDUMMY\ndummy\nFAKE\nfake\nSAMPLE_DATA\nexample_data\ntest_data  # in production code\n\n# Stubbed database/API calls\n# await db.query(...)  # commented out\n// fetch(url)  # commented out\nreturn hardcodedData  # instead of actual fetch\n\n# Incomplete error handling\nexcept:\n    pass\ncatch (e) {}\n.catch(() => {})\n\n# Console statements left in\nconsole.log(\nprint(  # in non-debug code\nlogger.debug(  # with sensitive data\n```\n\n### Phase 4: Wiring Verification\n\nVerify components are connected:\n\n**Frontend → Backend:**\n- API endpoints called actually exist\n- Request/response formats match\n- Authentication passed correctly\n- Error states handled\n\n**Backend → Database:**\n- Tables/collections exist\n- Queries execute successfully\n- Migrations applied\n- Indexes in place\n\n**Backend → External Services:**\n- API keys configured\n- Endpoints reachable\n- Error handling for failures\n\n### Phase 5: Human Testing Items\n\nFlag items that require human verification:\n\n- UI/UX changes (visual appearance)\n- User flows (multi-step processes)\n- Accessibility features (screen readers, keyboard nav)\n- Performance perception (perceived speed)\n- Copy/content changes\n- Mobile responsiveness\n\n## Issue Classification\n\n### STUB_FOUND\nCode exists but is not fully implemented.\n\n**Indicators:**\n- Returns placeholder values\n- Contains TODO/FIXME comments\n- Empty function bodies\n- Commented-out real implementation\n\n### WIRING_MISSING\nComponents exist but aren't connected.\n\n**Indicators:**\n- Function defined but never called\n- Route registered but no handler\n- Component created but not rendered\n- Event listener not attached\n\n### DELIVERABLE_MISSING\nExpected output doesn't exist.\n\n**Indicators:**\n- File not found\n- Function not defined\n- Export not present\n- Route not registered\n\n### PARTIAL_IMPLEMENTATION\nFeature works but is incomplete.\n\n**Indicators:**\n- Happy path works, error cases don't\n- Works for some inputs, fails for others\n- Main feature works, edge cases don't\n- Core logic present, polish missing\n\n### HUMAN_TESTING_REQUIRED\nCannot be verified automatically.\n\n**Indicators:**\n- Visual/UI changes\n- User experience flows\n- Accessibility features\n- Performance perception\n\n## Required Output Format\n\nYour response MUST follow this exact structure. Write it as a VERIFICATION.md file.\n\n---\n\n# Feature Verification: {{FEATURE_NAME}}\n\n**Verified:** {{TIMESTAMP}}\n**Branch:** {{BRANCH_NAME}}\n**Spec:** spec.md\n\n## Summary\n\n[2-3 sentence overall assessment. Does the feature achieve its stated goals?]\n\n**Verdict:** [VERIFIED | NEEDS_WORK | BLOCKED]\n\n## Goals Verification\n\n| Goal | Status | Notes |\n|------|--------|-------|\n| [Goal 1 from spec] | [VERIFIED|PARTIAL|MISSING] | [Brief explanation] |\n| [Goal 2 from spec] | [VERIFIED|PARTIAL|MISSING] | [Brief explanation] |\n| ... | ... | ... |\n\n## Deliverables Check\n\n### Completed Deliverables\n\n[List deliverables that are fully implemented and working]\n\n- **[Deliverable 1]**: [Where it is] - [Why it's complete]\n- **[Deliverable 2]**: [Where it is] - [Why it's complete]\n\n### Incomplete Deliverables\n\n[List deliverables that need more work, or \"None - all deliverables complete\"]\n\n- **[Deliverable]**: [What's missing] - [How to fix]\n\n## Stub Detection Results\n\n### Stubs Found\n\n[List all stubs detected, or \"No stubs detected\"]\n\n#### STUB-001: [Description]\n- **File:** [path/to/file.ext]\n- **Line:** [line number]\n- **Code:** `[the problematic code]`\n- **Issue:** [What's wrong]\n- **Fix:** [How to resolve]\n\n#### STUB-002: [Description]\n...\n\n### Suspicious Patterns\n\n[Code that looks suspicious but may be intentional]\n\n- **[Location]**: [Pattern found] - [Why it might be okay OR why it's concerning]\n\n## Wiring Verification\n\n### Connections Verified\n\n[List verified connections between components]\n\n- **[Component A] → [Component B]**: [How verified]\n\n### Missing Connections\n\n[List missing connections, or \"All connections verified\"]\n\n- **[Component A] → [Component B]**: [What's missing] - [How to fix]\n\n## Human Testing Required\n\n[List items requiring human verification, or \"No human testing items\"]\n\n### UI/UX Testing\n\n- [ ] [Item 1]: [What to verify] - [How to test]\n- [ ] [Item 2]: [What to verify] - [How to test]\n\n### User Flow Testing\n\n- [ ] [Flow 1]: [Steps to test]\n- [ ] [Flow 2]: [Steps to test]\n\n### Accessibility Testing\n\n- [ ] [Item]: [What to verify]\n\n## Issue Summary\n\n| Category | Count |\n|----------|-------|\n| STUB_FOUND | {{N}} |\n| WIRING_MISSING | {{N}} |\n| DELIVERABLE_MISSING | {{N}} |\n| PARTIAL_IMPLEMENTATION | {{N}} |\n| HUMAN_TESTING_REQUIRED | {{N}} |\n\n## Recommendations\n\n### Critical (Must Fix)\n\n[Issues that must be fixed before the feature is considered complete]\n\n1. [Issue]: [Brief fix description]\n2. [Issue]: [Brief fix description]\n\n### Important (Should Fix)\n\n[Issues that should be addressed but won't block release]\n\n1. [Issue]: [Brief fix description]\n\n### Optional (Nice to Have)\n\n[Improvements that could be made]\n\n1. [Suggestion]\n\n---\n\n**Verification completed for: {{FEATURE_NAME}}**\n\n---\n\n## Verification Guidelines\n\n1. **Start from goals** - Always begin with what the feature should achieve\n2. **Trace the path** - Follow data/control flow from user action to result\n3. **Be thorough** - Check every file modified in the feature branch\n4. **Be practical** - Flag real issues, not theoretical concerns\n5. **Be helpful** - Provide specific locations and fix recommendations\n\n## Verdict Criteria\n\n- **VERIFIED**: All goals achieved, no stubs, all connections working, only optional improvements remain\n- **NEEDS_WORK**: Goals partially achieved, or stubs/wiring issues found that can be fixed\n- **BLOCKED**: Critical deliverables missing or fundamental architectural issues\n\n## Quick Verification Commands\n\nUse these to quickly check common issues:\n\n```bash\n# Find TODO/FIXME comments\ngrep -rn \"TODO\\|FIXME\\|XXX\\|HACK\" src/\n\n# Find placeholder returns\ngrep -rn \"return None\\|return {}\\|return \\[\\]\\|pass$\" src/*.py\ngrep -rn \"return null\\|return {}\\|return \\[\\]\" src/*.ts src/*.js\n\n# Find NotImplementedError\ngrep -rn \"NotImplementedError\\|Not implemented\" src/\n\n# Find console.log left in\ngrep -rn \"console\\.log\\|console\\.debug\" src/\n\n# Find unused exports\n# (requires additional tooling)\n\n# Check for hardcoded test data\ngrep -rn \"mock_\\|MOCK_\\|placeholder\\|DUMMY\\|FAKE\" src/\n```\n","numLines":364,"startLine":1,"totalLines":364}}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01JRZL7ku9amsR38rAM56fXm","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me look at the plan-checker.md to see the pattern for agent templates."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":3697,"cache_read_input_tokens":39153,"cache_creation":{"ephemeral_5m_input_tokens":3697,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"210d4398-b4af-4524-afab-a594998e48e5"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01JRZL7ku9amsR38rAM56fXm","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MXyKimw6L2he97kDuBtpC5","name":"Read","input":{"file_path":"/home/ryan/Work/ralph-hybrid/templates/plan-checker.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":3697,"cache_read_input_tokens":39153,"cache_creation":{"ephemeral_5m_input_tokens":3697,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"983e7cbc-74ec-497d-bd4d-e6dab9961892"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MXyKimw6L2he97kDuBtpC5","type":"tool_result","content":"     1→# Plan Verification Agent\n     2→\n     3→You are a plan verification agent reviewing a feature specification before implementation begins.\n     4→\n     5→## Your Mission\n     6→\n     7→Perform a comprehensive six-dimension verification of the provided spec.md and prd.json to identify issues that could cause implementation problems. Your goal is to catch problems early, before they become expensive to fix.\n     8→\n     9→## Input Context\n    10→\n    11→You will receive:\n    12→- **spec.md**: The feature specification with requirements and stories\n    13→- **prd.json**: The machine-readable story list derived from spec.md\n    14→- **Project context**: Information about the codebase and existing patterns\n    15→\n    16→## Six Verification Dimensions\n    17→\n    18→### 1. Coverage Analysis\n    19→Verify that the plan addresses all aspects of the stated problem.\n    20→\n    21→**Check:**\n    22→- Does spec.md have a clear Problem Statement?\n    23→- Do the user stories collectively solve the stated problem?\n    24→- Are edge cases addressed (error handling, boundary conditions)?\n    25→- Is there a Success Criteria section with measurable outcomes?\n    26→\n    27→**Issue indicators:**\n    28→- Problem statement mentions X but no story addresses X\n    29→- Missing error handling for user-facing features\n    30→- No validation stories for user input features\n    31→- Success criteria not testable/measurable\n    32→\n    33→### 2. Completeness Analysis\n    34→Verify that each story is fully specified and implementable.\n    35→\n    36→**Check:**\n    37→- Does each story have clear acceptance criteria?\n    38→- Are criteria specific and testable (not vague)?\n    39→- Does each story include required tech checks (typecheck, tests)?\n    40→- Are technical notes provided for complex stories?\n    41→\n    42→**Issue indicators:**\n    43→- Vague criteria like \"works correctly\" or \"performs well\"\n    44→- Missing tech check criteria (no typecheck/test requirement)\n    45→- Stories without acceptance criteria\n    46→- Incomplete \"As a / I want / So that\" format\n    47→\n    48→### 3. Dependency Analysis\n    49→Verify story ordering and dependencies are correct.\n    50→\n    51→**Check:**\n    52→- Can each story be implemented independently or in stated order?\n    53→- Are prerequisite stories ordered before dependent stories?\n    54→- Are external dependencies (APIs, packages, services) identified?\n    55→- Are blocking dependencies between stories explicit?\n    56→\n    57→**Issue indicators:**\n    58→- Story N requires code from Story M, but M comes after N\n    59→- External API not yet available but stories assume it\n    60→- Circular dependencies between stories\n    61→- Missing setup/infrastructure stories\n    62→\n    63→### 4. Link Analysis\n    64→Verify references and connections are valid.\n    65→\n    66→**Check:**\n    67→- Do spec_ref paths in prd.json point to existing files?\n    68→- Are GitHub issue references valid (if any)?\n    69→- Do stories reference existing code/patterns correctly?\n    70→- Are amendment references (AMD-XXX) consistent?\n    71→\n    72→**Issue indicators:**\n    73→- spec_ref points to non-existent file\n    74→- Story references function/file that doesn't exist\n    75→- Amendment IDs duplicated or out of sequence\n    76→- Broken internal links in spec.md\n    77→\n    78→### 5. Scope Analysis\n    79→Verify the plan is appropriately scoped for iterative implementation.\n    80→\n    81→**Check:**\n    82→- Is each story completable in one context window?\n    83→- Are stories small enough (< 6 acceptance criteria typical)?\n    84→- Is there an \"Out of Scope\" section preventing creep?\n    85→- Are stories focused (single responsibility)?\n    86→\n    87→**Issue indicators:**\n    88→- Story with 10+ acceptance criteria\n    89→- Story touching 5+ files\n    90→- \"And also...\" language suggesting scope creep\n    91→- No Out of Scope section defined\n    92→\n    93→### 6. Verification Analysis\n    94→Verify the plan includes adequate verification approach.\n    95→\n    96→**Check:**\n    97→- Are verification methods specified for each story?\n    98→- Are UI stories marked for human verification or E2E testing?\n    99→- Is there a plan for integration testing?\n   100→- Are security-sensitive stories flagged for review?\n   101→\n   102→**Issue indicators:**\n   103→- No test requirements in acceptance criteria\n   104→- UI changes without \"verify in browser\" or E2E test\n   105→- Auth/payment stories without security review flag\n   106→- No integration points identified\n   107→\n   108→## Issue Classification\n   109→\n   110→Classify each issue with ONE of these severity levels:\n   111→\n   112→### BLOCKER\n   113→Issues that MUST be fixed before implementation can succeed.\n   114→\n   115→**Criteria:**\n   116→- Would cause implementation to fail or be incorrect\n   117→- Missing critical information with no reasonable default\n   118→- Dependency issues that would block progress\n   119→- Security or data integrity concerns\n   120→\n   121→**Examples:**\n   122→- Story requires API that doesn't exist yet\n   123→- Circular dependency between stories\n   124→- No acceptance criteria defined\n   125→- Missing prerequisite story\n   126→\n   127→### WARNING\n   128→Issues that SHOULD be addressed but won't prevent basic implementation.\n   129→\n   130→**Criteria:**\n   131→- Could lead to rework or unclear requirements\n   132→- Missing best practices\n   133→- Potential for misinterpretation\n   134→- Sub-optimal structure\n   135→\n   136→**Examples:**\n   137→- Vague acceptance criteria (interpretable but unclear)\n   138→- Missing Out of Scope section\n   139→- Stories larger than recommended\n   140→- No tech notes for complex story\n   141→\n   142→### INFO\n   143→Observations and suggestions for improvement.\n   144→\n   145→**Criteria:**\n   146→- Nice-to-have improvements\n   147→- Documentation suggestions\n   148→- Style/format recommendations\n   149→- Optional enhancements\n   150→\n   151→**Examples:**\n   152→- Could add more detail to technical notes\n   153→- Consider adding example use case\n   154→- Story title could be more descriptive\n   155→- Consider explicit priority reasoning\n   156→\n   157→## Required Output Format\n   158→\n   159→Your response MUST follow this exact structure. Write it as a PLAN-REVIEW.md file.\n   160→\n   161→---\n   162→\n   163→# Plan Review: {{FEATURE_NAME}}\n   164→\n   165→**Reviewed:** {{TIMESTAMP}}\n   166→**Spec:** spec.md\n   167→**PRD:** prd.json\n   168→\n   169→## Summary\n   170→\n   171→[2-3 sentence overall assessment. Is the plan ready for implementation?]\n   172→\n   173→**Verdict:** [READY | NEEDS_REVISION | BLOCKED]\n   174→\n   175→## Issue Summary\n   176→\n   177→| Severity | Count |\n   178→|----------|-------|\n   179→| BLOCKER | {{N}} |\n   180→| WARNING | {{N}} |\n   181→| INFO | {{N}} |\n   182→\n   183→## BLOCKER Issues\n   184→\n   185→[List each BLOCKER issue, or \"None found\" if clear]\n   186→\n   187→### BLOCKER-001: [Issue Title]\n   188→- **Dimension:** [Coverage|Completeness|Dependencies|Links|Scope|Verification]\n   189→- **Location:** [spec.md section, story ID, or prd.json path]\n   190→- **Description:** [What is the problem?]\n   191→- **Impact:** [What will go wrong if not fixed?]\n   192→- **Recommendation:** [How to fix it]\n   193→\n   194→### BLOCKER-002: [Issue Title]\n   195→...\n   196→\n   197→## WARNING Issues\n   198→\n   199→[List each WARNING issue, or \"None found\" if clear]\n   200→\n   201→### WARNING-001: [Issue Title]\n   202→- **Dimension:** [Coverage|Completeness|Dependencies|Links|Scope|Verification]\n   203→- **Location:** [spec.md section, story ID, or prd.json path]\n   204→- **Description:** [What is the concern?]\n   205→- **Impact:** [What could go wrong?]\n   206→- **Recommendation:** [How to improve]\n   207→\n   208→### WARNING-002: [Issue Title]\n   209→...\n   210→\n   211→## INFO Issues\n   212→\n   213→[List each INFO observation, or \"None found\" if clear]\n   214→\n   215→### INFO-001: [Observation Title]\n   216→- **Dimension:** [Coverage|Completeness|Dependencies|Links|Scope|Verification]\n   217→- **Location:** [spec.md section, story ID, or prd.json path]\n   218→- **Observation:** [What was noticed?]\n   219→- **Suggestion:** [Optional improvement]\n   220→\n   221→### INFO-002: [Observation Title]\n   222→...\n   223→\n   224→## Dimension Summary\n   225→\n   226→| Dimension | Status | Issues |\n   227→|-----------|--------|--------|\n   228→| Coverage | [PASS|WARN|FAIL] | [Brief summary] |\n   229→| Completeness | [PASS|WARN|FAIL] | [Brief summary] |\n   230→| Dependencies | [PASS|WARN|FAIL] | [Brief summary] |\n   231→| Links | [PASS|WARN|FAIL] | [Brief summary] |\n   232→| Scope | [PASS|WARN|FAIL] | [Brief summary] |\n   233→| Verification | [PASS|WARN|FAIL] | [Brief summary] |\n   234→\n   235→## Recommendations\n   236→\n   237→### Before Implementation\n   238→[Actions that should happen before starting the Ralph loop]\n   239→\n   240→### During Implementation\n   241→[Things to watch for during implementation]\n   242→\n   243→### After Implementation\n   244→[Verification steps for when feature is complete]\n   245→\n   246→---\n   247→\n   248→**Plan review completed for: {{FEATURE_NAME}}**\n   249→\n   250→---\n   251→\n   252→## Review Guidelines\n   253→\n   254→1. **Be specific** - Reference exact story IDs, line numbers, or paths\n   255→2. **Be actionable** - Every issue should have a clear recommendation\n   256→3. **Be proportionate** - Don't flag INFO issues as BLOCKER\n   257→4. **Be helpful** - The goal is to improve the plan, not reject it\n   258→5. **Be thorough** - Check all six dimensions for every story\n   259→\n   260→## Verdict Criteria\n   261→\n   262→- **READY**: Zero BLOCKERs. Any WARNINGs are documented trade-offs.\n   263→- **NEEDS_REVISION**: One or more BLOCKERs that can be fixed quickly.\n   264→- **BLOCKED**: BLOCKERs that require significant planning changes or external resolution.\n   265→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"fce6b041-b035-4d2a-aec6-ade5d2aa0ea7","tool_use_result":{"type":"text","file":{"filePath":"/home/ryan/Work/ralph-hybrid/templates/plan-checker.md","content":"# Plan Verification Agent\n\nYou are a plan verification agent reviewing a feature specification before implementation begins.\n\n## Your Mission\n\nPerform a comprehensive six-dimension verification of the provided spec.md and prd.json to identify issues that could cause implementation problems. Your goal is to catch problems early, before they become expensive to fix.\n\n## Input Context\n\nYou will receive:\n- **spec.md**: The feature specification with requirements and stories\n- **prd.json**: The machine-readable story list derived from spec.md\n- **Project context**: Information about the codebase and existing patterns\n\n## Six Verification Dimensions\n\n### 1. Coverage Analysis\nVerify that the plan addresses all aspects of the stated problem.\n\n**Check:**\n- Does spec.md have a clear Problem Statement?\n- Do the user stories collectively solve the stated problem?\n- Are edge cases addressed (error handling, boundary conditions)?\n- Is there a Success Criteria section with measurable outcomes?\n\n**Issue indicators:**\n- Problem statement mentions X but no story addresses X\n- Missing error handling for user-facing features\n- No validation stories for user input features\n- Success criteria not testable/measurable\n\n### 2. Completeness Analysis\nVerify that each story is fully specified and implementable.\n\n**Check:**\n- Does each story have clear acceptance criteria?\n- Are criteria specific and testable (not vague)?\n- Does each story include required tech checks (typecheck, tests)?\n- Are technical notes provided for complex stories?\n\n**Issue indicators:**\n- Vague criteria like \"works correctly\" or \"performs well\"\n- Missing tech check criteria (no typecheck/test requirement)\n- Stories without acceptance criteria\n- Incomplete \"As a / I want / So that\" format\n\n### 3. Dependency Analysis\nVerify story ordering and dependencies are correct.\n\n**Check:**\n- Can each story be implemented independently or in stated order?\n- Are prerequisite stories ordered before dependent stories?\n- Are external dependencies (APIs, packages, services) identified?\n- Are blocking dependencies between stories explicit?\n\n**Issue indicators:**\n- Story N requires code from Story M, but M comes after N\n- External API not yet available but stories assume it\n- Circular dependencies between stories\n- Missing setup/infrastructure stories\n\n### 4. Link Analysis\nVerify references and connections are valid.\n\n**Check:**\n- Do spec_ref paths in prd.json point to existing files?\n- Are GitHub issue references valid (if any)?\n- Do stories reference existing code/patterns correctly?\n- Are amendment references (AMD-XXX) consistent?\n\n**Issue indicators:**\n- spec_ref points to non-existent file\n- Story references function/file that doesn't exist\n- Amendment IDs duplicated or out of sequence\n- Broken internal links in spec.md\n\n### 5. Scope Analysis\nVerify the plan is appropriately scoped for iterative implementation.\n\n**Check:**\n- Is each story completable in one context window?\n- Are stories small enough (< 6 acceptance criteria typical)?\n- Is there an \"Out of Scope\" section preventing creep?\n- Are stories focused (single responsibility)?\n\n**Issue indicators:**\n- Story with 10+ acceptance criteria\n- Story touching 5+ files\n- \"And also...\" language suggesting scope creep\n- No Out of Scope section defined\n\n### 6. Verification Analysis\nVerify the plan includes adequate verification approach.\n\n**Check:**\n- Are verification methods specified for each story?\n- Are UI stories marked for human verification or E2E testing?\n- Is there a plan for integration testing?\n- Are security-sensitive stories flagged for review?\n\n**Issue indicators:**\n- No test requirements in acceptance criteria\n- UI changes without \"verify in browser\" or E2E test\n- Auth/payment stories without security review flag\n- No integration points identified\n\n## Issue Classification\n\nClassify each issue with ONE of these severity levels:\n\n### BLOCKER\nIssues that MUST be fixed before implementation can succeed.\n\n**Criteria:**\n- Would cause implementation to fail or be incorrect\n- Missing critical information with no reasonable default\n- Dependency issues that would block progress\n- Security or data integrity concerns\n\n**Examples:**\n- Story requires API that doesn't exist yet\n- Circular dependency between stories\n- No acceptance criteria defined\n- Missing prerequisite story\n\n### WARNING\nIssues that SHOULD be addressed but won't prevent basic implementation.\n\n**Criteria:**\n- Could lead to rework or unclear requirements\n- Missing best practices\n- Potential for misinterpretation\n- Sub-optimal structure\n\n**Examples:**\n- Vague acceptance criteria (interpretable but unclear)\n- Missing Out of Scope section\n- Stories larger than recommended\n- No tech notes for complex story\n\n### INFO\nObservations and suggestions for improvement.\n\n**Criteria:**\n- Nice-to-have improvements\n- Documentation suggestions\n- Style/format recommendations\n- Optional enhancements\n\n**Examples:**\n- Could add more detail to technical notes\n- Consider adding example use case\n- Story title could be more descriptive\n- Consider explicit priority reasoning\n\n## Required Output Format\n\nYour response MUST follow this exact structure. Write it as a PLAN-REVIEW.md file.\n\n---\n\n# Plan Review: {{FEATURE_NAME}}\n\n**Reviewed:** {{TIMESTAMP}}\n**Spec:** spec.md\n**PRD:** prd.json\n\n## Summary\n\n[2-3 sentence overall assessment. Is the plan ready for implementation?]\n\n**Verdict:** [READY | NEEDS_REVISION | BLOCKED]\n\n## Issue Summary\n\n| Severity | Count |\n|----------|-------|\n| BLOCKER | {{N}} |\n| WARNING | {{N}} |\n| INFO | {{N}} |\n\n## BLOCKER Issues\n\n[List each BLOCKER issue, or \"None found\" if clear]\n\n### BLOCKER-001: [Issue Title]\n- **Dimension:** [Coverage|Completeness|Dependencies|Links|Scope|Verification]\n- **Location:** [spec.md section, story ID, or prd.json path]\n- **Description:** [What is the problem?]\n- **Impact:** [What will go wrong if not fixed?]\n- **Recommendation:** [How to fix it]\n\n### BLOCKER-002: [Issue Title]\n...\n\n## WARNING Issues\n\n[List each WARNING issue, or \"None found\" if clear]\n\n### WARNING-001: [Issue Title]\n- **Dimension:** [Coverage|Completeness|Dependencies|Links|Scope|Verification]\n- **Location:** [spec.md section, story ID, or prd.json path]\n- **Description:** [What is the concern?]\n- **Impact:** [What could go wrong?]\n- **Recommendation:** [How to improve]\n\n### WARNING-002: [Issue Title]\n...\n\n## INFO Issues\n\n[List each INFO observation, or \"None found\" if clear]\n\n### INFO-001: [Observation Title]\n- **Dimension:** [Coverage|Completeness|Dependencies|Links|Scope|Verification]\n- **Location:** [spec.md section, story ID, or prd.json path]\n- **Observation:** [What was noticed?]\n- **Suggestion:** [Optional improvement]\n\n### INFO-002: [Observation Title]\n...\n\n## Dimension Summary\n\n| Dimension | Status | Issues |\n|-----------|--------|--------|\n| Coverage | [PASS|WARN|FAIL] | [Brief summary] |\n| Completeness | [PASS|WARN|FAIL] | [Brief summary] |\n| Dependencies | [PASS|WARN|FAIL] | [Brief summary] |\n| Links | [PASS|WARN|FAIL] | [Brief summary] |\n| Scope | [PASS|WARN|FAIL] | [Brief summary] |\n| Verification | [PASS|WARN|FAIL] | [Brief summary] |\n\n## Recommendations\n\n### Before Implementation\n[Actions that should happen before starting the Ralph loop]\n\n### During Implementation\n[Things to watch for during implementation]\n\n### After Implementation\n[Verification steps for when feature is complete]\n\n---\n\n**Plan review completed for: {{FEATURE_NAME}}**\n\n---\n\n## Review Guidelines\n\n1. **Be specific** - Reference exact story IDs, line numbers, or paths\n2. **Be actionable** - Every issue should have a clear recommendation\n3. **Be proportionate** - Don't flag INFO issues as BLOCKER\n4. **Be helpful** - The goal is to improve the plan, not reject it\n5. **Be thorough** - Check all six dimensions for every story\n\n## Verdict Criteria\n\n- **READY**: Zero BLOCKERs. Any WARNINGs are documented trade-offs.\n- **NEEDS_REVISION**: One or more BLOCKERs that can be fixed quickly.\n- **BLOCKED**: BLOCKERs that require significant planning changes or external resolution.\n","numLines":265,"startLine":1,"totalLines":265}}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_016MpJz4JQvVyCBH3teGZQYn","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me check the skills templates for format reference."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":3067,"cache_read_input_tokens":42850,"cache_creation":{"ephemeral_5m_input_tokens":3067,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"53c60ac4-00b4-46e7-8c01-62cbad105cac"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_016MpJz4JQvVyCBH3teGZQYn","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01XoquPSzoh9zco4Wpg1Ydnu","name":"Bash","input":{"command":"ls -la templates/skills/","description":"List skill templates"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":3067,"cache_read_input_tokens":42850,"cache_creation":{"ephemeral_5m_input_tokens":3067,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"1b1c1de1-6bc1-47bd-b18b-62f5efc443d2"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01XoquPSzoh9zco4Wpg1Ydnu","type":"tool_result","content":"total 52\ndrwxr-xr-x 1 ryan ryan   172 Jan 23 09:50 \u001b[0m\u001b[01;34m.\u001b[0m\ndrwxr-xr-x 1 ryan ryan   334 Jan 23 08:51 \u001b[01;34m..\u001b[0m\n-rw-r--r-- 1 ryan ryan  9715 Jan 23 09:29 \u001b[00madversarial-review.md\u001b[0m\n-rw-r--r-- 1 ryan ryan 15237 Jan 23 09:39 \u001b[00mcode-archaeology.md\u001b[0m\n-rw-r--r-- 1 ryan ryan 15943 Jan 23 09:50 \u001b[00mincident-response.md\u001b[0m\n-rw-r--r-- 1 ryan ryan  6409 Jan 22 22:37 \u001b[00mvisual-parity-migration.md\u001b[0m","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"9861ba88-61e1-4174-a34d-11fda88bda3b","tool_use_result":{"stdout":"total 52\ndrwxr-xr-x 1 ryan ryan   172 Jan 23 09:50 \u001b[0m\u001b[01;34m.\u001b[0m\ndrwxr-xr-x 1 ryan ryan   334 Jan 23 08:51 \u001b[01;34m..\u001b[0m\n-rw-r--r-- 1 ryan ryan  9715 Jan 23 09:29 \u001b[00madversarial-review.md\u001b[0m\n-rw-r--r-- 1 ryan ryan 15237 Jan 23 09:39 \u001b[00mcode-archaeology.md\u001b[0m\n-rw-r--r-- 1 ryan ryan 15943 Jan 23 09:50 \u001b[00mincident-response.md\u001b[0m\n-rw-r--r-- 1 ryan ryan  6409 Jan 22 22:37 \u001b[00mvisual-parity-migration.md\u001b[0m","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01BoRUeFNpNDcJoxPop4yEpv","type":"message","role":"assistant","content":[{"type":"text","text":"Let me read one of the skill templates to understand the format better."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":331,"cache_read_input_tokens":45917,"cache_creation":{"ephemeral_5m_input_tokens":331,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"91bc8dc7-a414-4e9f-97ba-bc6f200c076b"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01BoRUeFNpNDcJoxPop4yEpv","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RQa3KicJeGkxVx3d6WWdDg","name":"Read","input":{"file_path":"/home/ryan/Work/ralph-hybrid/templates/skills/adversarial-review.md"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":331,"cache_read_input_tokens":45917,"cache_creation":{"ephemeral_5m_input_tokens":331,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"1ee040b4-c956-420c-b1c4-2fb3d0ee37b5"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RQa3KicJeGkxVx3d6WWdDg","type":"tool_result","content":"     1→# Adversarial Security Review Skill\n     2→\n     3→> **Use when:** Reviewing code for security vulnerabilities before merge\n     4→> **Generated by:** `ralph-plan` when security-related patterns detected or explicitly requested\n     5→\n     6→## Purpose\n     7→\n     8→Conduct security-focused code review using a red team/blue team pattern. Blue team identifies secure implementation requirements, red team attempts to find vulnerabilities, and the fixer role proposes remediations.\n     9→\n    10→---\n    11→\n    12→## Three-Role Pattern\n    13→\n    14→### Role 1: Blue Team (Secure Implementation Analyst)\n    15→\n    16→**Goal:** Understand the intended secure behavior and identify security-critical code paths.\n    17→\n    18→**Tasks:**\n    19→1. Identify all entry points (APIs, forms, file uploads, CLI args)\n    20→2. Map data flows from untrusted input to sensitive operations\n    21→3. List security controls that SHOULD be present\n    22→4. Document authentication/authorization checkpoints\n    23→5. Note cryptographic operations and their purposes\n    24→\n    25→**Output Format:**\n    26→```markdown\n    27→## Blue Team Analysis\n    28→\n    29→### Entry Points\n    30→| Location | Input Type | Trust Level |\n    31→|----------|-----------|-------------|\n    32→| /api/login | JSON body | UNTRUSTED |\n    33→| /upload | Multipart file | UNTRUSTED |\n    34→\n    35→### Security Controls Required\n    36→- [ ] Input validation at [location]\n    37→- [ ] Authentication check at [location]\n    38→- [ ] Authorization check at [location]\n    39→- [ ] Rate limiting at [location]\n    40→- [ ] Output encoding at [location]\n    41→\n    42→### Data Flow Diagram\n    43→[Input] → [Validation] → [Auth] → [Processing] → [Output]\n    44→```\n    45→\n    46→---\n    47→\n    48→### Role 2: Red Team (Penetration Tester)\n    49→\n    50→**Goal:** Find vulnerabilities by attempting to bypass security controls.\n    51→\n    52→**Focus Areas:**\n    53→\n    54→#### 1. Injection Attacks\n    55→```\n    56→# SQL Injection patterns\n    57→' OR '1'='1\n    58→'; DROP TABLE users;--\n    59→UNION SELECT * FROM passwords\n    60→\n    61→# Command Injection patterns\n    62→; ls -la\n    63→| cat /etc/passwd\n    64→$(whoami)\n    65→`id`\n    66→\n    67→# Template Injection patterns\n    68→{{7*7}}\n    69→${7*7}\n    70→<%= 7*7 %>\n    71→\n    72→# LDAP Injection\n    73→*)(uid=*))(|(uid=*\n    74→```\n    75→\n    76→#### 2. Authentication Bypass\n    77→```\n    78→# Check for:\n    79→- Direct object references (IDOR): /user/123 → /user/124\n    80→- Session fixation vulnerabilities\n    81→- JWT algorithm confusion (alg: none)\n    82→- Password reset token predictability\n    83→- Timing attacks on password comparison\n    84→- Default/hardcoded credentials\n    85→- Missing authentication on sensitive endpoints\n    86→```\n    87→\n    88→#### 3. Data Exposure\n    89→```\n    90→# Check for:\n    91→- Sensitive data in logs (passwords, tokens, PII)\n    92→- API responses leaking internal data\n    93→- Error messages revealing stack traces\n    94→- .env files, config files in web root\n    95→- Hardcoded secrets in source code\n    96→- Unencrypted sensitive data in transit/at rest\n    97→- Missing security headers (HSTS, CSP, X-Frame-Options)\n    98→```\n    99→\n   100→#### 4. Race Conditions\n   101→```\n   102→# Check for:\n   103→- Time-of-check to time-of-use (TOCTOU)\n   104→- Double-spend in transactions\n   105→- Rate limit bypass via concurrent requests\n   106→- Session race conditions\n   107→- File operation races\n   108→```\n   109→\n   110→#### 5. Logic Flaws\n   111→```\n   112→# Check for:\n   113→- Negative quantity/amount inputs\n   114→- Integer overflow/underflow\n   115→- State machine violations\n   116→- Privilege escalation via role confusion\n   117→- Mass assignment vulnerabilities\n   118→```\n   119→\n   120→**Red Team Checklist:**\n   121→- [ ] Tested all injection vectors\n   122→- [ ] Attempted authentication bypass\n   123→- [ ] Searched for data exposure\n   124→- [ ] Checked for race conditions\n   125→- [ ] Analyzed business logic for flaws\n   126→- [ ] Reviewed error handling for info leaks\n   127→- [ ] Checked for insecure deserialization\n   128→- [ ] Tested file upload handling\n   129→- [ ] Verified CORS configuration\n   130→- [ ] Checked for SSRF vulnerabilities\n   131→\n   132→**Output Format:**\n   133→```markdown\n   134→## Red Team Findings\n   135→\n   136→### Finding: [Title]\n   137→**Severity:** CRITICAL | HIGH | MEDIUM | LOW\n   138→**Location:** [file:line]\n   139→**CWE:** [CWE-XXX]\n   140→**OWASP:** [Category]\n   141→\n   142→**Description:**\n   143→[What the vulnerability is]\n   144→\n   145→**Proof of Concept:**\n   146→[How to exploit it]\n   147→\n   148→**Impact:**\n   149→[What damage could be done]\n   150→\n   151→**Recommendation:**\n   152→[How to fix it]\n   153→```\n   154→\n   155→---\n   156→\n   157→### Role 3: Fixer (Security Engineer)\n   158→\n   159→**Goal:** Propose and validate remediations for identified vulnerabilities.\n   160→\n   161→**Tasks:**\n   162→1. Prioritize findings by severity and exploitability\n   163→2. Propose minimal, targeted fixes\n   164→3. Verify fix doesn't introduce new vulnerabilities\n   165→4. Ensure fix maintains functionality\n   166→5. Add security tests to prevent regression\n   167→\n   168→**Fix Patterns:**\n   169→\n   170→#### Input Validation\n   171→```python\n   172→# BEFORE (vulnerable)\n   173→def search(query):\n   174→    return db.execute(f\"SELECT * FROM items WHERE name = '{query}'\")\n   175→\n   176→# AFTER (secure)\n   177→def search(query):\n   178→    return db.execute(\"SELECT * FROM items WHERE name = ?\", [query])\n   179→```\n   180→\n   181→#### Output Encoding\n   182→```python\n   183→# BEFORE (vulnerable)\n   184→return f\"<div>{user_input}</div>\"\n   185→\n   186→# AFTER (secure)\n   187→from html import escape\n   188→return f\"<div>{escape(user_input)}</div>\"\n   189→```\n   190→\n   191→#### Authentication\n   192→```python\n   193→# BEFORE (vulnerable)\n   194→if request.headers.get('X-Admin') == 'true':\n   195→    return admin_panel()\n   196→\n   197→# AFTER (secure)\n   198→if current_user.is_authenticated and current_user.has_role('admin'):\n   199→    return admin_panel()\n   200→```\n   201→\n   202→#### Timing-Safe Comparison\n   203→```python\n   204→# BEFORE (vulnerable)\n   205→if token == expected_token:\n   206→    return True\n   207→\n   208→# AFTER (secure)\n   209→import hmac\n   210→if hmac.compare_digest(token.encode(), expected_token.encode()):\n   211→    return True\n   212→```\n   213→\n   214→**Output Format:**\n   215→```markdown\n   216→## Remediation Plan\n   217→\n   218→### Priority 1: CRITICAL Fixes\n   219→| Finding | Fix | Verified |\n   220→|---------|-----|----------|\n   221→| SQL Injection in /search | Parameterized queries | [ ] |\n   222→\n   223→### Priority 2: HIGH Fixes\n   224→...\n   225→\n   226→### Security Tests Added\n   227→- [ ] Test: SQL injection blocked in /search\n   228→- [ ] Test: XSS encoded in user display\n   229→```\n   230→\n   231→---\n   232→\n   233→## Severity Levels\n   234→\n   235→| Level | Description | Criteria |\n   236→|-------|-------------|----------|\n   237→| **CRITICAL** | Immediate exploitation possible | Remote code execution, auth bypass, data breach |\n   238→| **HIGH** | Significant risk | Privilege escalation, sensitive data exposure |\n   239→| **MEDIUM** | Moderate risk | Limited impact vulnerabilities, defense-in-depth failures |\n   240→| **LOW** | Minor issues | Information disclosure, best practice violations |\n   241→\n   242→---\n   243→\n   244→## Security Review Output Format\n   245→\n   246→Generate `SECURITY-REVIEW.md`:\n   247→\n   248→```markdown\n   249→# Security Review: [Feature/PR Name]\n   250→\n   251→**Reviewer:** Adversarial Review Skill\n   252→**Date:** [TIMESTAMP]\n   253→**Branch:** [BRANCH_NAME]\n   254→\n   255→## Executive Summary\n   256→\n   257→**Overall Risk Level:** CRITICAL | HIGH | MEDIUM | LOW | PASS\n   258→**Findings:** X critical, Y high, Z medium, W low\n   259→**Recommendation:** BLOCK_MERGE | CONDITIONAL_MERGE | APPROVE\n   260→\n   261→## Blue Team Analysis\n   262→[From Role 1]\n   263→\n   264→## Red Team Findings\n   265→[From Role 2]\n   266→\n   267→## Remediation Plan\n   268→[From Role 3]\n   269→\n   270→## Checklist Summary\n   271→\n   272→### Injection Prevention\n   273→- [ ] SQL queries use parameterization\n   274→- [ ] OS commands avoid user input\n   275→- [ ] Template rendering escapes by default\n   276→- [ ] LDAP queries use proper escaping\n   277→\n   278→### Authentication & Authorization\n   279→- [ ] All sensitive endpoints require authentication\n   280→- [ ] Authorization checked at every access point\n   281→- [ ] Session management is secure\n   282→- [ ] Password storage uses strong hashing\n   283→\n   284→### Data Protection\n   285→- [ ] Sensitive data encrypted at rest\n   286→- [ ] TLS enforced for data in transit\n   287→- [ ] No secrets in source code\n   288→- [ ] Logs sanitized of sensitive data\n   289→\n   290→### Security Headers\n   291→- [ ] Content-Security-Policy configured\n   292→- [ ] X-Frame-Options set\n   293→- [ ] X-Content-Type-Options: nosniff\n   294→- [ ] Strict-Transport-Security enabled\n   295→\n   296→## Sign-Off\n   297→\n   298→| Role | Status | Notes |\n   299→|------|--------|-------|\n   300→| Blue Team | COMPLETE | [summary] |\n   301→| Red Team | COMPLETE | [summary] |\n   302→| Fixer | COMPLETE | [summary] |\n   303→```\n   304→\n   305→---\n   306→\n   307→## Quick Security Checks\n   308→\n   309→Run these commands to detect common issues:\n   310→\n   311→```bash\n   312→# Find hardcoded secrets\n   313→grep -rn \"password\\s*=\" --include=\"*.py\" --include=\"*.js\" --include=\"*.ts\"\n   314→grep -rn \"api_key\\s*=\" --include=\"*.py\" --include=\"*.js\" --include=\"*.ts\"\n   315→grep -rn \"secret\\s*=\" --include=\"*.py\" --include=\"*.js\" --include=\"*.ts\"\n   316→\n   317→# Find SQL string formatting (potential injection)\n   318→grep -rn \"execute.*f'\" --include=\"*.py\"\n   319→grep -rn \"execute.*%s\" --include=\"*.py\"\n   320→grep -rn \"query.*\\+\" --include=\"*.js\" --include=\"*.ts\"\n   321→\n   322→# Find eval/exec usage\n   323→grep -rn \"eval(\" --include=\"*.py\" --include=\"*.js\" --include=\"*.ts\"\n   324→grep -rn \"exec(\" --include=\"*.py\"\n   325→grep -rn \"subprocess.*shell=True\" --include=\"*.py\"\n   326→\n   327→# Find unsafe deserialization\n   328→grep -rn \"pickle.loads\" --include=\"*.py\"\n   329→grep -rn \"yaml.load(\" --include=\"*.py\"\n   330→grep -rn \"JSON.parse.*user\" --include=\"*.js\" --include=\"*.ts\"\n   331→\n   332→# Find missing output encoding\n   333→grep -rn \"innerHTML\\s*=\" --include=\"*.js\" --include=\"*.ts\"\n   334→grep -rn \"dangerouslySetInnerHTML\" --include=\"*.jsx\" --include=\"*.tsx\"\n   335→grep -rn \"\\|safe\" --include=\"*.html\" --include=\"*.jinja2\"\n   336→```\n   337→\n   338→---\n   339→\n   340→## Integration with CI/CD\n   341→\n   342→**Pre-merge gate:**\n   343→```yaml\n   344→# .github/workflows/security.yml\n   345→security-review:\n   346→  runs-on: ubuntu-latest\n   347→  steps:\n   348→    - uses: actions/checkout@v4\n   349→    - name: Run security checks\n   350→      run: |\n   351→        # Your security scanning tools\n   352→        bandit -r src/ -f json -o bandit-report.json\n   353→        npm audit --json > npm-audit.json\n   354→        trivy fs --format json --output trivy-report.json .\n   355→```\n   356→\n   357→**Post-review hook:**\n   358→```bash\n   359→#!/bin/bash\n   360→# .ralph-hybrid/hooks/post_security_review.sh\n   361→# Blocks merge if CRITICAL findings exist\n   362→\n   363→if grep -q '\"severity\": \"CRITICAL\"' SECURITY-REVIEW.md; then\n   364→    echo \"CRITICAL security findings - merge blocked\"\n   365→    exit 75  # VERIFICATION_FAILED\n   366→fi\n   367→```\n   368→\n   369→---\n   370→\n   371→## When to Trigger This Skill\n   372→\n   373→Automatically activate for:\n   374→- Authentication/authorization changes\n   375→- Input handling modifications\n   376→- Database query changes\n   377→- API endpoint additions\n   378→- File upload functionality\n   379→- Cryptographic operations\n   380→- Session management changes\n   381→- External service integrations\n   382→\n   383→Keywords that trigger: `auth`, `login`, `password`, `token`, `session`, `security`, `encrypt`, `hash`, `upload`, `query`, `execute`, `eval`, `admin`, `privilege`, `permission`\n   384→\n   385→---\n   386→\n   387→## References\n   388→\n   389→- OWASP Top 10: https://owasp.org/www-project-top-ten/\n   390→- CWE Top 25: https://cwe.mitre.org/top25/\n   391→- OWASP Cheat Sheets: https://cheatsheetseries.owasp.org/\n   392→\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"58b73b7b-c061-45bf-904d-d3d83ab1b79b","tool_use_result":{"type":"text","file":{"filePath":"/home/ryan/Work/ralph-hybrid/templates/skills/adversarial-review.md","content":"# Adversarial Security Review Skill\n\n> **Use when:** Reviewing code for security vulnerabilities before merge\n> **Generated by:** `ralph-plan` when security-related patterns detected or explicitly requested\n\n## Purpose\n\nConduct security-focused code review using a red team/blue team pattern. Blue team identifies secure implementation requirements, red team attempts to find vulnerabilities, and the fixer role proposes remediations.\n\n---\n\n## Three-Role Pattern\n\n### Role 1: Blue Team (Secure Implementation Analyst)\n\n**Goal:** Understand the intended secure behavior and identify security-critical code paths.\n\n**Tasks:**\n1. Identify all entry points (APIs, forms, file uploads, CLI args)\n2. Map data flows from untrusted input to sensitive operations\n3. List security controls that SHOULD be present\n4. Document authentication/authorization checkpoints\n5. Note cryptographic operations and their purposes\n\n**Output Format:**\n```markdown\n## Blue Team Analysis\n\n### Entry Points\n| Location | Input Type | Trust Level |\n|----------|-----------|-------------|\n| /api/login | JSON body | UNTRUSTED |\n| /upload | Multipart file | UNTRUSTED |\n\n### Security Controls Required\n- [ ] Input validation at [location]\n- [ ] Authentication check at [location]\n- [ ] Authorization check at [location]\n- [ ] Rate limiting at [location]\n- [ ] Output encoding at [location]\n\n### Data Flow Diagram\n[Input] → [Validation] → [Auth] → [Processing] → [Output]\n```\n\n---\n\n### Role 2: Red Team (Penetration Tester)\n\n**Goal:** Find vulnerabilities by attempting to bypass security controls.\n\n**Focus Areas:**\n\n#### 1. Injection Attacks\n```\n# SQL Injection patterns\n' OR '1'='1\n'; DROP TABLE users;--\nUNION SELECT * FROM passwords\n\n# Command Injection patterns\n; ls -la\n| cat /etc/passwd\n$(whoami)\n`id`\n\n# Template Injection patterns\n{{7*7}}\n${7*7}\n<%= 7*7 %>\n\n# LDAP Injection\n*)(uid=*))(|(uid=*\n```\n\n#### 2. Authentication Bypass\n```\n# Check for:\n- Direct object references (IDOR): /user/123 → /user/124\n- Session fixation vulnerabilities\n- JWT algorithm confusion (alg: none)\n- Password reset token predictability\n- Timing attacks on password comparison\n- Default/hardcoded credentials\n- Missing authentication on sensitive endpoints\n```\n\n#### 3. Data Exposure\n```\n# Check for:\n- Sensitive data in logs (passwords, tokens, PII)\n- API responses leaking internal data\n- Error messages revealing stack traces\n- .env files, config files in web root\n- Hardcoded secrets in source code\n- Unencrypted sensitive data in transit/at rest\n- Missing security headers (HSTS, CSP, X-Frame-Options)\n```\n\n#### 4. Race Conditions\n```\n# Check for:\n- Time-of-check to time-of-use (TOCTOU)\n- Double-spend in transactions\n- Rate limit bypass via concurrent requests\n- Session race conditions\n- File operation races\n```\n\n#### 5. Logic Flaws\n```\n# Check for:\n- Negative quantity/amount inputs\n- Integer overflow/underflow\n- State machine violations\n- Privilege escalation via role confusion\n- Mass assignment vulnerabilities\n```\n\n**Red Team Checklist:**\n- [ ] Tested all injection vectors\n- [ ] Attempted authentication bypass\n- [ ] Searched for data exposure\n- [ ] Checked for race conditions\n- [ ] Analyzed business logic for flaws\n- [ ] Reviewed error handling for info leaks\n- [ ] Checked for insecure deserialization\n- [ ] Tested file upload handling\n- [ ] Verified CORS configuration\n- [ ] Checked for SSRF vulnerabilities\n\n**Output Format:**\n```markdown\n## Red Team Findings\n\n### Finding: [Title]\n**Severity:** CRITICAL | HIGH | MEDIUM | LOW\n**Location:** [file:line]\n**CWE:** [CWE-XXX]\n**OWASP:** [Category]\n\n**Description:**\n[What the vulnerability is]\n\n**Proof of Concept:**\n[How to exploit it]\n\n**Impact:**\n[What damage could be done]\n\n**Recommendation:**\n[How to fix it]\n```\n\n---\n\n### Role 3: Fixer (Security Engineer)\n\n**Goal:** Propose and validate remediations for identified vulnerabilities.\n\n**Tasks:**\n1. Prioritize findings by severity and exploitability\n2. Propose minimal, targeted fixes\n3. Verify fix doesn't introduce new vulnerabilities\n4. Ensure fix maintains functionality\n5. Add security tests to prevent regression\n\n**Fix Patterns:**\n\n#### Input Validation\n```python\n# BEFORE (vulnerable)\ndef search(query):\n    return db.execute(f\"SELECT * FROM items WHERE name = '{query}'\")\n\n# AFTER (secure)\ndef search(query):\n    return db.execute(\"SELECT * FROM items WHERE name = ?\", [query])\n```\n\n#### Output Encoding\n```python\n# BEFORE (vulnerable)\nreturn f\"<div>{user_input}</div>\"\n\n# AFTER (secure)\nfrom html import escape\nreturn f\"<div>{escape(user_input)}</div>\"\n```\n\n#### Authentication\n```python\n# BEFORE (vulnerable)\nif request.headers.get('X-Admin') == 'true':\n    return admin_panel()\n\n# AFTER (secure)\nif current_user.is_authenticated and current_user.has_role('admin'):\n    return admin_panel()\n```\n\n#### Timing-Safe Comparison\n```python\n# BEFORE (vulnerable)\nif token == expected_token:\n    return True\n\n# AFTER (secure)\nimport hmac\nif hmac.compare_digest(token.encode(), expected_token.encode()):\n    return True\n```\n\n**Output Format:**\n```markdown\n## Remediation Plan\n\n### Priority 1: CRITICAL Fixes\n| Finding | Fix | Verified |\n|---------|-----|----------|\n| SQL Injection in /search | Parameterized queries | [ ] |\n\n### Priority 2: HIGH Fixes\n...\n\n### Security Tests Added\n- [ ] Test: SQL injection blocked in /search\n- [ ] Test: XSS encoded in user display\n```\n\n---\n\n## Severity Levels\n\n| Level | Description | Criteria |\n|-------|-------------|----------|\n| **CRITICAL** | Immediate exploitation possible | Remote code execution, auth bypass, data breach |\n| **HIGH** | Significant risk | Privilege escalation, sensitive data exposure |\n| **MEDIUM** | Moderate risk | Limited impact vulnerabilities, defense-in-depth failures |\n| **LOW** | Minor issues | Information disclosure, best practice violations |\n\n---\n\n## Security Review Output Format\n\nGenerate `SECURITY-REVIEW.md`:\n\n```markdown\n# Security Review: [Feature/PR Name]\n\n**Reviewer:** Adversarial Review Skill\n**Date:** [TIMESTAMP]\n**Branch:** [BRANCH_NAME]\n\n## Executive Summary\n\n**Overall Risk Level:** CRITICAL | HIGH | MEDIUM | LOW | PASS\n**Findings:** X critical, Y high, Z medium, W low\n**Recommendation:** BLOCK_MERGE | CONDITIONAL_MERGE | APPROVE\n\n## Blue Team Analysis\n[From Role 1]\n\n## Red Team Findings\n[From Role 2]\n\n## Remediation Plan\n[From Role 3]\n\n## Checklist Summary\n\n### Injection Prevention\n- [ ] SQL queries use parameterization\n- [ ] OS commands avoid user input\n- [ ] Template rendering escapes by default\n- [ ] LDAP queries use proper escaping\n\n### Authentication & Authorization\n- [ ] All sensitive endpoints require authentication\n- [ ] Authorization checked at every access point\n- [ ] Session management is secure\n- [ ] Password storage uses strong hashing\n\n### Data Protection\n- [ ] Sensitive data encrypted at rest\n- [ ] TLS enforced for data in transit\n- [ ] No secrets in source code\n- [ ] Logs sanitized of sensitive data\n\n### Security Headers\n- [ ] Content-Security-Policy configured\n- [ ] X-Frame-Options set\n- [ ] X-Content-Type-Options: nosniff\n- [ ] Strict-Transport-Security enabled\n\n## Sign-Off\n\n| Role | Status | Notes |\n|------|--------|-------|\n| Blue Team | COMPLETE | [summary] |\n| Red Team | COMPLETE | [summary] |\n| Fixer | COMPLETE | [summary] |\n```\n\n---\n\n## Quick Security Checks\n\nRun these commands to detect common issues:\n\n```bash\n# Find hardcoded secrets\ngrep -rn \"password\\s*=\" --include=\"*.py\" --include=\"*.js\" --include=\"*.ts\"\ngrep -rn \"api_key\\s*=\" --include=\"*.py\" --include=\"*.js\" --include=\"*.ts\"\ngrep -rn \"secret\\s*=\" --include=\"*.py\" --include=\"*.js\" --include=\"*.ts\"\n\n# Find SQL string formatting (potential injection)\ngrep -rn \"execute.*f'\" --include=\"*.py\"\ngrep -rn \"execute.*%s\" --include=\"*.py\"\ngrep -rn \"query.*\\+\" --include=\"*.js\" --include=\"*.ts\"\n\n# Find eval/exec usage\ngrep -rn \"eval(\" --include=\"*.py\" --include=\"*.js\" --include=\"*.ts\"\ngrep -rn \"exec(\" --include=\"*.py\"\ngrep -rn \"subprocess.*shell=True\" --include=\"*.py\"\n\n# Find unsafe deserialization\ngrep -rn \"pickle.loads\" --include=\"*.py\"\ngrep -rn \"yaml.load(\" --include=\"*.py\"\ngrep -rn \"JSON.parse.*user\" --include=\"*.js\" --include=\"*.ts\"\n\n# Find missing output encoding\ngrep -rn \"innerHTML\\s*=\" --include=\"*.js\" --include=\"*.ts\"\ngrep -rn \"dangerouslySetInnerHTML\" --include=\"*.jsx\" --include=\"*.tsx\"\ngrep -rn \"\\|safe\" --include=\"*.html\" --include=\"*.jinja2\"\n```\n\n---\n\n## Integration with CI/CD\n\n**Pre-merge gate:**\n```yaml\n# .github/workflows/security.yml\nsecurity-review:\n  runs-on: ubuntu-latest\n  steps:\n    - uses: actions/checkout@v4\n    - name: Run security checks\n      run: |\n        # Your security scanning tools\n        bandit -r src/ -f json -o bandit-report.json\n        npm audit --json > npm-audit.json\n        trivy fs --format json --output trivy-report.json .\n```\n\n**Post-review hook:**\n```bash\n#!/bin/bash\n# .ralph-hybrid/hooks/post_security_review.sh\n# Blocks merge if CRITICAL findings exist\n\nif grep -q '\"severity\": \"CRITICAL\"' SECURITY-REVIEW.md; then\n    echo \"CRITICAL security findings - merge blocked\"\n    exit 75  # VERIFICATION_FAILED\nfi\n```\n\n---\n\n## When to Trigger This Skill\n\nAutomatically activate for:\n- Authentication/authorization changes\n- Input handling modifications\n- Database query changes\n- API endpoint additions\n- File upload functionality\n- Cryptographic operations\n- Session management changes\n- External service integrations\n\nKeywords that trigger: `auth`, `login`, `password`, `token`, `session`, `security`, `encrypt`, `hash`, `upload`, `query`, `execute`, `eval`, `admin`, `privilege`, `permission`\n\n---\n\n## References\n\n- OWASP Top 10: https://owasp.org/www-project-top-ten/\n- CWE Top 25: https://cwe.mitre.org/top25/\n- OWASP Cheat Sheets: https://cheatsheetseries.owasp.org/\n","numLines":392,"startLine":1,"totalLines":392}}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01BbyiYK6yYQquTGXBfR6C3u","type":"message","role":"assistant","content":[{"type":"text","text":"Now I have a good understanding of the format. Let me create the Integration Checker Agent template. This should focus on detecting:\n1. Orphaned code (exports not used, functions never called)\n2. Routes without consumers\n3. Auth on sensitive routes\n4. End-to-end flow tracing with break point identification"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":4250,"cache_read_input_tokens":46248,"cache_creation":{"ephemeral_5m_input_tokens":4250,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"7f537185-c5ae-42d3-a613-cf657a3dc16e"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01BbyiYK6yYQquTGXBfR6C3u","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KY6QGjzJDUn6BjMRX2KWAT","name":"Write","input":{"file_path":"/home/ryan/Work/ralph-hybrid/templates/integration-checker.md","content":"# Integration Checker Agent\n\nYou are an integration verification agent ensuring that feature components are properly connected and no orphaned code exists.\n\n## Your Mission\n\nVerify that the implemented feature is fully integrated:\n- All exports are imported and used somewhere\n- All routes have consumers (frontend calls, CLI commands, etc.)\n- Sensitive routes have authentication/authorization\n- Data flows completely from input to output without breaks\n\n## Why Integration Checking Matters\n\nFeatures often fail not because individual components don't work, but because:\n- Code was written but never wired up\n- Routes exist but nothing calls them\n- Auth was planned but not implemented on sensitive endpoints\n- Data transformations break at integration boundaries\n\n## Input Context\n\nYou will receive:\n- **spec.md**: The feature specification with requirements\n- **prd.json**: The story list with completion status\n- **Codebase access**: Ability to read and search the implementation\n- **progress.txt**: Log of implementation work done\n\n## Integration Verification Process\n\n### Phase 1: Export/Import Analysis\n\nFind all exports and verify they are imported somewhere.\n\n**Check:**\n- Module exports (`export`, `module.exports`, `__all__`)\n- Function/class definitions in library files\n- Type exports (TypeScript interfaces, Python type hints)\n- Constants and configuration exports\n\n**Detection Patterns:**\n```\n# JavaScript/TypeScript exports\nexport function functionName\nexport const variableName\nexport default\nexport { name } from\nmodule.exports =\nexports.name =\n\n# Python exports\n__all__ = [\ndef public_function(  # in __init__.py\nclass PublicClass(  # in __init__.py\n\n# Go exports\nfunc PublicFunction(  # capitalized = exported\ntype PublicStruct struct  # capitalized = exported\n```\n\n**Orphan Detection:**\n```bash\n# Find exports\ngrep -rn \"export function\\|export const\\|export default\" src/\n\n# For each export, verify import exists\ngrep -rn \"import.*{functionName}\" src/\ngrep -rn \"from.*module.*import functionName\" src/\n```\n\n### Phase 2: Route/Endpoint Analysis\n\nFind all registered routes and verify consumers exist.\n\n**Check:**\n- API routes (REST, GraphQL, gRPC)\n- Frontend routes (React Router, Vue Router, etc.)\n- CLI commands and subcommands\n- Event handlers and webhooks\n\n**Detection Patterns:**\n```\n# Express/Fastify routes\napp.get('/path'\napp.post('/path'\nrouter.get('/path'\nrouter.post('/path'\n\n# Python FastAPI/Flask\n@app.route('/path'\n@app.get('/path'\n@app.post('/path'\n@router.get('/path'\n\n# React Router\n<Route path=\"/path\"\npath: '/path'\n\n# CLI commands\n.command('name'\n@click.command()\ndef command_name(\n\n# GraphQL\nQuery: {\nMutation: {\ntype Query {\ntype Mutation {\n```\n\n**Consumer Detection:**\n```bash\n# Find API calls to routes\ngrep -rn \"fetch.*'/api/path'\\|axios.*'/api/path'\" src/ frontend/\ngrep -rn \"'/api/path'\" --include=\"*.ts\" --include=\"*.tsx\" --include=\"*.js\"\n\n# Find navigation to routes\ngrep -rn \"navigate.*'/path'\\|push.*'/path'\\|href=\\\"/path\\\"\" frontend/\n```\n\n### Phase 3: Authentication Analysis\n\nVerify sensitive routes have authentication/authorization.\n\n**Sensitive Route Categories:**\n- User data endpoints (profile, settings, history)\n- Admin/management endpoints\n- Financial/payment endpoints\n- Data modification endpoints (POST, PUT, DELETE, PATCH)\n- File upload/download endpoints\n- API keys and secrets management\n\n**Check:**\n- Auth middleware applied to sensitive routes\n- Authorization checks for role-specific operations\n- Session/token validation\n- Rate limiting on authentication endpoints\n\n**Detection Patterns:**\n```\n# Auth middleware (should be present)\nauthenticate\nrequireAuth\nisAuthenticated\nauthMiddleware\n@login_required\n@requires_auth\nprotected\nprivate route\n\n# Missing auth indicators (should NOT be present without auth)\nDELETE /api/users\nPUT /api/admin\nPOST /api/payments\n/api/settings\n/api/profile\n```\n\n**Auth Verification:**\n```bash\n# Find sensitive endpoints\ngrep -rn \"app\\.\\(post\\|put\\|delete\\|patch\\)\" src/\n\n# Verify auth middleware is applied\n# Check for authenticate/requireAuth in same file or route definition\n```\n\n### Phase 4: Data Flow Tracing\n\nTrace data from entry point to final destination.\n\n**Check:**\n- Input validation present at boundaries\n- Data transformations preserve required fields\n- Error handling at each stage\n- Output formatting matches expected schema\n\n**Flow Components:**\n```\nUser Input → API Handler → Validation → Service → Repository → Database\n     ↓                                                              ↓\nFrontend ← Response ← Transformation ← Service ← Repository ← Query Result\n```\n\n**Break Point Identification:**\n- Missing validation between untrusted input and processing\n- Service function that doesn't call repository\n- Repository query that doesn't return expected shape\n- Response transformation that drops fields\n- Error handler that swallows exceptions\n\n**Tracing Example:**\n```\nEntry: POST /api/users\n  → Handler: src/routes/users.ts:45 ✓\n  → Validation: src/validators/user.ts:12 ✓\n  → Service: src/services/user.ts:78 ✓\n  → Repository: src/repositories/user.ts:23 ✓\n  → Database: users table ✓\n\nBreak Point Found:\n  → Service calls repository.create() ✓\n  → Repository returns { id, name } but service expects { id, name, email } ✗\n  → Response missing email field\n```\n\n### Phase 5: Dead Code Detection\n\nFind code that exists but is never executed.\n\n**Check:**\n- Unused imports\n- Unreachable code paths\n- Deprecated functions still present\n- Commented-out code blocks\n- Feature flags always false\n\n**Detection Patterns:**\n```bash\n# Unused imports (TypeScript)\n# Use tooling: eslint no-unused-vars, tsc --noUnusedLocals\n\n# Unreachable code\nif (false) {\nreturn; /* code after return */\nthrow; /* code after throw */\n\n# Deprecated markers\n@deprecated\n// deprecated\n# deprecated\nTODO: remove\n\n# Dead feature flags\nFEATURE_FLAG = false  # always false\nif (false &&\nenabled: false  # config always disabled\n```\n\n## Issue Classification\n\n### ORPHANED_EXPORT\nExport exists but is never imported.\n\n**Indicators:**\n- `export function` with no corresponding `import`\n- `module.exports.name` never required\n- Public class never instantiated\n\n### ORPHANED_ROUTE\nRoute registered but never called.\n\n**Indicators:**\n- API endpoint with no frontend calls\n- Page route with no navigation links\n- CLI command not in help or documentation\n\n### MISSING_AUTH\nSensitive route lacks authentication.\n\n**Indicators:**\n- Data modification endpoint without auth middleware\n- User data endpoint accessible without session\n- Admin endpoint missing role check\n\n### BROKEN_FLOW\nData flow has a break point.\n\n**Indicators:**\n- Service doesn't call expected downstream\n- Response shape doesn't match consumer expectation\n- Error not propagated through chain\n\n### DEAD_CODE\nCode exists but cannot execute.\n\n**Indicators:**\n- Function defined but never called\n- Import statement for unused module\n- Unreachable conditional branch\n\n### MISSING_CONNECTION\nComponents should be connected but aren't.\n\n**Indicators:**\n- Event emitter with no listeners\n- Callback registered but never triggered\n- Observer with no observable\n\n## Required Output Format\n\nYour response MUST follow this exact structure. Write it as an INTEGRATION.md file.\n\n---\n\n# Integration Check: {{FEATURE_NAME}}\n\n**Checked:** {{TIMESTAMP}}\n**Branch:** {{BRANCH_NAME}}\n**Spec:** spec.md\n\n## Summary\n\n[2-3 sentence overall assessment. Is the feature fully integrated?]\n\n**Verdict:** [INTEGRATED | NEEDS_WIRING | BROKEN]\n\n## Issue Summary\n\n| Category | Count |\n|----------|-------|\n| ORPHANED_EXPORT | {{N}} |\n| ORPHANED_ROUTE | {{N}} |\n| MISSING_AUTH | {{N}} |\n| BROKEN_FLOW | {{N}} |\n| DEAD_CODE | {{N}} |\n| MISSING_CONNECTION | {{N}} |\n\n## Export/Import Analysis\n\n### Verified Exports\n\n[List exports that are properly imported and used]\n\n| Export | Location | Imported By |\n|--------|----------|-------------|\n| functionName | src/utils.ts:45 | src/handlers/api.ts, src/services/user.ts |\n| ClassName | src/models/user.ts:12 | src/routes/users.ts |\n\n### Orphaned Exports\n\n[List exports not imported anywhere, or \"None - all exports used\"]\n\n#### ORPHAN-001: [Export Name]\n- **Location:** [path/to/file.ext:line]\n- **Export Type:** [function|class|const|type]\n- **Reason:** Not imported anywhere in codebase\n- **Recommendation:** [Remove if unused, or add import where needed]\n\n## Route/Endpoint Analysis\n\n### Verified Routes\n\n[List routes with identified consumers]\n\n| Route | Handler | Consumers |\n|-------|---------|-----------|\n| GET /api/users | src/routes/users.ts:23 | frontend/pages/Users.tsx |\n| POST /api/users | src/routes/users.ts:45 | frontend/components/UserForm.tsx |\n\n### Orphaned Routes\n\n[List routes without consumers, or \"None - all routes have consumers\"]\n\n#### ROUTE-001: [Route Path]\n- **Location:** [path/to/file.ext:line]\n- **Method:** [GET|POST|PUT|DELETE|PATCH]\n- **Handler:** [handler function/file]\n- **Reason:** No frontend calls or navigation found\n- **Recommendation:** [Add consumer, or remove if obsolete]\n\n## Authentication Analysis\n\n### Secured Routes\n\n[List sensitive routes with proper auth]\n\n| Route | Auth Middleware | Authorization |\n|-------|-----------------|---------------|\n| DELETE /api/users/:id | requireAuth | isAdmin check |\n| PUT /api/settings | authenticate | isOwner check |\n\n### Missing Auth\n\n[List sensitive routes lacking auth, or \"None - all sensitive routes secured\"]\n\n#### AUTH-001: [Route Description]\n- **Route:** [METHOD /path]\n- **Location:** [path/to/file.ext:line]\n- **Sensitivity:** [Why this needs auth]\n- **Current State:** [No middleware|Middleware but no authz]\n- **Recommendation:** [Add requireAuth middleware, add role check]\n\n## Data Flow Analysis\n\n### Traced Flows\n\n[List end-to-end flows verified]\n\n#### Flow: [User Action] → [End Result]\n```\nEntry: [Entry point]\n  → [Component 1]: [location] ✓\n  → [Component 2]: [location] ✓\n  → [Component 3]: [location] ✓\n  → [End]: [result] ✓\n```\n\n### Broken Flows\n\n[List flows with break points, or \"None - all flows complete\"]\n\n#### FLOW-001: [Flow Description]\n```\nEntry: [Entry point]\n  → [Component 1]: [location] ✓\n  → [Component 2]: [location] ✗ BREAK\n\nBreak Point: [What's wrong]\nExpected: [What should happen]\nActual: [What happens instead]\n```\n- **Impact:** [What fails as a result]\n- **Fix:** [How to resolve]\n\n## Dead Code Detection\n\n### Detected Dead Code\n\n[List dead code found, or \"No dead code detected\"]\n\n#### DEAD-001: [Description]\n- **Location:** [path/to/file.ext:line]\n- **Type:** [unused function|unreachable code|dead import]\n- **Code:** `[snippet]`\n- **Reason:** [Why it's dead]\n- **Recommendation:** [Remove, or note if intentionally preserved]\n\n## Missing Connections\n\n### Expected Connections Not Found\n\n[List missing connections, or \"All expected connections present\"]\n\n#### CONN-001: [Connection Description]\n- **From:** [source component]\n- **To:** [expected destination]\n- **Expected:** [What should connect them]\n- **Actual:** [Current state]\n- **Fix:** [How to establish connection]\n\n## Recommendations\n\n### Critical (Must Fix)\n\n[Issues that must be fixed for feature to work]\n\n1. **[Issue ID]**: [Brief description] - [Fix action]\n2. **[Issue ID]**: [Brief description] - [Fix action]\n\n### Important (Should Fix)\n\n[Issues that should be addressed but feature may work without]\n\n1. **[Issue ID]**: [Brief description] - [Fix action]\n\n### Cleanup (Nice to Have)\n\n[Dead code and cleanup suggestions]\n\n1. **[Issue ID]**: [Brief description] - [Action]\n\n---\n\n**Integration check completed for: {{FEATURE_NAME}}**\n\n---\n\n## Integration Guidelines\n\n1. **Trace both directions** - Verify exports have imports AND imports have exports\n2. **Follow the data** - Trace from user input to database and back\n3. **Check boundaries** - Integration issues often occur at module boundaries\n4. **Verify runtime paths** - Static analysis may miss dynamic imports/calls\n5. **Consider async** - Event-driven code may have delayed connections\n\n## Verdict Criteria\n\n- **INTEGRATED**: All components connected, no orphaned code, auth in place, flows complete\n- **NEEDS_WIRING**: Components exist but connections missing, fixable without major changes\n- **BROKEN**: Critical integration failures, major components disconnected, auth missing on sensitive routes\n\n## Quick Integration Checks\n\nUse these commands to detect common integration issues:\n\n```bash\n# Find exports without imports (JavaScript/TypeScript)\n# Export names\ngrep -rohn \"export \\(function\\|const\\|class\\) \\w\\+\" src/ | sed 's/.*export \\(function\\|const\\|class\\) //'\n# For each, verify import exists\ngrep -rn \"import.*{name}\" src/\n\n# Find routes without consumers\ngrep -rn \"app\\.\\(get\\|post\\|put\\|delete\\)\" src/routes/\ngrep -rn \"fetch\\|axios\" frontend/\n\n# Find potentially sensitive routes missing auth\ngrep -rn \"app\\.\\(post\\|put\\|delete\\|patch\\)\" src/ | grep -v \"auth\\|authenticate\\|require\"\n\n# Find unused imports (requires tooling)\n# TypeScript: tsc --noUnusedLocals\n# ESLint: no-unused-vars rule\n\n# Find TODO/FIXME indicating incomplete integration\ngrep -rn \"TODO.*integrat\\|TODO.*wire\\|TODO.*connect\\|FIXME.*integrat\" src/\n\n# Find commented-out code that may be incomplete integration\ngrep -rn \"// fetch\\|// await\\|# requests\\.\\|// db\\.\" src/\n```\n\n## Common Integration Patterns to Verify\n\n### Frontend-Backend Integration\n```\nComponent → API Call → Route Handler → Service → Database\n    ↓          ↓            ↓           ↓          ↓\n Renders    Awaits      Validates    Processes   Returns\n    ↑          ↑            ↑           ↑          ↑\n Updates   Response    Transform    Business    Query\n```\n\n### Event-Driven Integration\n```\nPublisher → Event Bus → Subscriber\n    ↓           ↓           ↓\n Emits      Routes     Handles\n Event      Event      Event\n```\n\n### CLI Integration\n```\nCLI Entry → Command Parser → Handler → Core Logic → Output\n    ↓            ↓            ↓          ↓          ↓\n  Args       Validates    Executes   Processes   Formats\n```\n\n## When Integration Checking is Critical\n\n- After multi-story feature completion\n- Before merge to main branch\n- When refactoring existing code\n- After resolving merge conflicts\n- When onboarding to unfamiliar codebase\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":4250,"cache_read_input_tokens":46248,"cache_creation":{"ephemeral_5m_input_tokens":4250,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"fdf30282-2d0d-41f7-940c-4642e25cf578"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KY6QGjzJDUn6BjMRX2KWAT","type":"tool_result","content":"File created successfully at: /home/ryan/Work/ralph-hybrid/templates/integration-checker.md"}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"704ff152-a579-425a-87e8-92b56ba5dfb5","tool_use_result":{"type":"create","filePath":"/home/ryan/Work/ralph-hybrid/templates/integration-checker.md","content":"# Integration Checker Agent\n\nYou are an integration verification agent ensuring that feature components are properly connected and no orphaned code exists.\n\n## Your Mission\n\nVerify that the implemented feature is fully integrated:\n- All exports are imported and used somewhere\n- All routes have consumers (frontend calls, CLI commands, etc.)\n- Sensitive routes have authentication/authorization\n- Data flows completely from input to output without breaks\n\n## Why Integration Checking Matters\n\nFeatures often fail not because individual components don't work, but because:\n- Code was written but never wired up\n- Routes exist but nothing calls them\n- Auth was planned but not implemented on sensitive endpoints\n- Data transformations break at integration boundaries\n\n## Input Context\n\nYou will receive:\n- **spec.md**: The feature specification with requirements\n- **prd.json**: The story list with completion status\n- **Codebase access**: Ability to read and search the implementation\n- **progress.txt**: Log of implementation work done\n\n## Integration Verification Process\n\n### Phase 1: Export/Import Analysis\n\nFind all exports and verify they are imported somewhere.\n\n**Check:**\n- Module exports (`export`, `module.exports`, `__all__`)\n- Function/class definitions in library files\n- Type exports (TypeScript interfaces, Python type hints)\n- Constants and configuration exports\n\n**Detection Patterns:**\n```\n# JavaScript/TypeScript exports\nexport function functionName\nexport const variableName\nexport default\nexport { name } from\nmodule.exports =\nexports.name =\n\n# Python exports\n__all__ = [\ndef public_function(  # in __init__.py\nclass PublicClass(  # in __init__.py\n\n# Go exports\nfunc PublicFunction(  # capitalized = exported\ntype PublicStruct struct  # capitalized = exported\n```\n\n**Orphan Detection:**\n```bash\n# Find exports\ngrep -rn \"export function\\|export const\\|export default\" src/\n\n# For each export, verify import exists\ngrep -rn \"import.*{functionName}\" src/\ngrep -rn \"from.*module.*import functionName\" src/\n```\n\n### Phase 2: Route/Endpoint Analysis\n\nFind all registered routes and verify consumers exist.\n\n**Check:**\n- API routes (REST, GraphQL, gRPC)\n- Frontend routes (React Router, Vue Router, etc.)\n- CLI commands and subcommands\n- Event handlers and webhooks\n\n**Detection Patterns:**\n```\n# Express/Fastify routes\napp.get('/path'\napp.post('/path'\nrouter.get('/path'\nrouter.post('/path'\n\n# Python FastAPI/Flask\n@app.route('/path'\n@app.get('/path'\n@app.post('/path'\n@router.get('/path'\n\n# React Router\n<Route path=\"/path\"\npath: '/path'\n\n# CLI commands\n.command('name'\n@click.command()\ndef command_name(\n\n# GraphQL\nQuery: {\nMutation: {\ntype Query {\ntype Mutation {\n```\n\n**Consumer Detection:**\n```bash\n# Find API calls to routes\ngrep -rn \"fetch.*'/api/path'\\|axios.*'/api/path'\" src/ frontend/\ngrep -rn \"'/api/path'\" --include=\"*.ts\" --include=\"*.tsx\" --include=\"*.js\"\n\n# Find navigation to routes\ngrep -rn \"navigate.*'/path'\\|push.*'/path'\\|href=\\\"/path\\\"\" frontend/\n```\n\n### Phase 3: Authentication Analysis\n\nVerify sensitive routes have authentication/authorization.\n\n**Sensitive Route Categories:**\n- User data endpoints (profile, settings, history)\n- Admin/management endpoints\n- Financial/payment endpoints\n- Data modification endpoints (POST, PUT, DELETE, PATCH)\n- File upload/download endpoints\n- API keys and secrets management\n\n**Check:**\n- Auth middleware applied to sensitive routes\n- Authorization checks for role-specific operations\n- Session/token validation\n- Rate limiting on authentication endpoints\n\n**Detection Patterns:**\n```\n# Auth middleware (should be present)\nauthenticate\nrequireAuth\nisAuthenticated\nauthMiddleware\n@login_required\n@requires_auth\nprotected\nprivate route\n\n# Missing auth indicators (should NOT be present without auth)\nDELETE /api/users\nPUT /api/admin\nPOST /api/payments\n/api/settings\n/api/profile\n```\n\n**Auth Verification:**\n```bash\n# Find sensitive endpoints\ngrep -rn \"app\\.\\(post\\|put\\|delete\\|patch\\)\" src/\n\n# Verify auth middleware is applied\n# Check for authenticate/requireAuth in same file or route definition\n```\n\n### Phase 4: Data Flow Tracing\n\nTrace data from entry point to final destination.\n\n**Check:**\n- Input validation present at boundaries\n- Data transformations preserve required fields\n- Error handling at each stage\n- Output formatting matches expected schema\n\n**Flow Components:**\n```\nUser Input → API Handler → Validation → Service → Repository → Database\n     ↓                                                              ↓\nFrontend ← Response ← Transformation ← Service ← Repository ← Query Result\n```\n\n**Break Point Identification:**\n- Missing validation between untrusted input and processing\n- Service function that doesn't call repository\n- Repository query that doesn't return expected shape\n- Response transformation that drops fields\n- Error handler that swallows exceptions\n\n**Tracing Example:**\n```\nEntry: POST /api/users\n  → Handler: src/routes/users.ts:45 ✓\n  → Validation: src/validators/user.ts:12 ✓\n  → Service: src/services/user.ts:78 ✓\n  → Repository: src/repositories/user.ts:23 ✓\n  → Database: users table ✓\n\nBreak Point Found:\n  → Service calls repository.create() ✓\n  → Repository returns { id, name } but service expects { id, name, email } ✗\n  → Response missing email field\n```\n\n### Phase 5: Dead Code Detection\n\nFind code that exists but is never executed.\n\n**Check:**\n- Unused imports\n- Unreachable code paths\n- Deprecated functions still present\n- Commented-out code blocks\n- Feature flags always false\n\n**Detection Patterns:**\n```bash\n# Unused imports (TypeScript)\n# Use tooling: eslint no-unused-vars, tsc --noUnusedLocals\n\n# Unreachable code\nif (false) {\nreturn; /* code after return */\nthrow; /* code after throw */\n\n# Deprecated markers\n@deprecated\n// deprecated\n# deprecated\nTODO: remove\n\n# Dead feature flags\nFEATURE_FLAG = false  # always false\nif (false &&\nenabled: false  # config always disabled\n```\n\n## Issue Classification\n\n### ORPHANED_EXPORT\nExport exists but is never imported.\n\n**Indicators:**\n- `export function` with no corresponding `import`\n- `module.exports.name` never required\n- Public class never instantiated\n\n### ORPHANED_ROUTE\nRoute registered but never called.\n\n**Indicators:**\n- API endpoint with no frontend calls\n- Page route with no navigation links\n- CLI command not in help or documentation\n\n### MISSING_AUTH\nSensitive route lacks authentication.\n\n**Indicators:**\n- Data modification endpoint without auth middleware\n- User data endpoint accessible without session\n- Admin endpoint missing role check\n\n### BROKEN_FLOW\nData flow has a break point.\n\n**Indicators:**\n- Service doesn't call expected downstream\n- Response shape doesn't match consumer expectation\n- Error not propagated through chain\n\n### DEAD_CODE\nCode exists but cannot execute.\n\n**Indicators:**\n- Function defined but never called\n- Import statement for unused module\n- Unreachable conditional branch\n\n### MISSING_CONNECTION\nComponents should be connected but aren't.\n\n**Indicators:**\n- Event emitter with no listeners\n- Callback registered but never triggered\n- Observer with no observable\n\n## Required Output Format\n\nYour response MUST follow this exact structure. Write it as an INTEGRATION.md file.\n\n---\n\n# Integration Check: {{FEATURE_NAME}}\n\n**Checked:** {{TIMESTAMP}}\n**Branch:** {{BRANCH_NAME}}\n**Spec:** spec.md\n\n## Summary\n\n[2-3 sentence overall assessment. Is the feature fully integrated?]\n\n**Verdict:** [INTEGRATED | NEEDS_WIRING | BROKEN]\n\n## Issue Summary\n\n| Category | Count |\n|----------|-------|\n| ORPHANED_EXPORT | {{N}} |\n| ORPHANED_ROUTE | {{N}} |\n| MISSING_AUTH | {{N}} |\n| BROKEN_FLOW | {{N}} |\n| DEAD_CODE | {{N}} |\n| MISSING_CONNECTION | {{N}} |\n\n## Export/Import Analysis\n\n### Verified Exports\n\n[List exports that are properly imported and used]\n\n| Export | Location | Imported By |\n|--------|----------|-------------|\n| functionName | src/utils.ts:45 | src/handlers/api.ts, src/services/user.ts |\n| ClassName | src/models/user.ts:12 | src/routes/users.ts |\n\n### Orphaned Exports\n\n[List exports not imported anywhere, or \"None - all exports used\"]\n\n#### ORPHAN-001: [Export Name]\n- **Location:** [path/to/file.ext:line]\n- **Export Type:** [function|class|const|type]\n- **Reason:** Not imported anywhere in codebase\n- **Recommendation:** [Remove if unused, or add import where needed]\n\n## Route/Endpoint Analysis\n\n### Verified Routes\n\n[List routes with identified consumers]\n\n| Route | Handler | Consumers |\n|-------|---------|-----------|\n| GET /api/users | src/routes/users.ts:23 | frontend/pages/Users.tsx |\n| POST /api/users | src/routes/users.ts:45 | frontend/components/UserForm.tsx |\n\n### Orphaned Routes\n\n[List routes without consumers, or \"None - all routes have consumers\"]\n\n#### ROUTE-001: [Route Path]\n- **Location:** [path/to/file.ext:line]\n- **Method:** [GET|POST|PUT|DELETE|PATCH]\n- **Handler:** [handler function/file]\n- **Reason:** No frontend calls or navigation found\n- **Recommendation:** [Add consumer, or remove if obsolete]\n\n## Authentication Analysis\n\n### Secured Routes\n\n[List sensitive routes with proper auth]\n\n| Route | Auth Middleware | Authorization |\n|-------|-----------------|---------------|\n| DELETE /api/users/:id | requireAuth | isAdmin check |\n| PUT /api/settings | authenticate | isOwner check |\n\n### Missing Auth\n\n[List sensitive routes lacking auth, or \"None - all sensitive routes secured\"]\n\n#### AUTH-001: [Route Description]\n- **Route:** [METHOD /path]\n- **Location:** [path/to/file.ext:line]\n- **Sensitivity:** [Why this needs auth]\n- **Current State:** [No middleware|Middleware but no authz]\n- **Recommendation:** [Add requireAuth middleware, add role check]\n\n## Data Flow Analysis\n\n### Traced Flows\n\n[List end-to-end flows verified]\n\n#### Flow: [User Action] → [End Result]\n```\nEntry: [Entry point]\n  → [Component 1]: [location] ✓\n  → [Component 2]: [location] ✓\n  → [Component 3]: [location] ✓\n  → [End]: [result] ✓\n```\n\n### Broken Flows\n\n[List flows with break points, or \"None - all flows complete\"]\n\n#### FLOW-001: [Flow Description]\n```\nEntry: [Entry point]\n  → [Component 1]: [location] ✓\n  → [Component 2]: [location] ✗ BREAK\n\nBreak Point: [What's wrong]\nExpected: [What should happen]\nActual: [What happens instead]\n```\n- **Impact:** [What fails as a result]\n- **Fix:** [How to resolve]\n\n## Dead Code Detection\n\n### Detected Dead Code\n\n[List dead code found, or \"No dead code detected\"]\n\n#### DEAD-001: [Description]\n- **Location:** [path/to/file.ext:line]\n- **Type:** [unused function|unreachable code|dead import]\n- **Code:** `[snippet]`\n- **Reason:** [Why it's dead]\n- **Recommendation:** [Remove, or note if intentionally preserved]\n\n## Missing Connections\n\n### Expected Connections Not Found\n\n[List missing connections, or \"All expected connections present\"]\n\n#### CONN-001: [Connection Description]\n- **From:** [source component]\n- **To:** [expected destination]\n- **Expected:** [What should connect them]\n- **Actual:** [Current state]\n- **Fix:** [How to establish connection]\n\n## Recommendations\n\n### Critical (Must Fix)\n\n[Issues that must be fixed for feature to work]\n\n1. **[Issue ID]**: [Brief description] - [Fix action]\n2. **[Issue ID]**: [Brief description] - [Fix action]\n\n### Important (Should Fix)\n\n[Issues that should be addressed but feature may work without]\n\n1. **[Issue ID]**: [Brief description] - [Fix action]\n\n### Cleanup (Nice to Have)\n\n[Dead code and cleanup suggestions]\n\n1. **[Issue ID]**: [Brief description] - [Action]\n\n---\n\n**Integration check completed for: {{FEATURE_NAME}}**\n\n---\n\n## Integration Guidelines\n\n1. **Trace both directions** - Verify exports have imports AND imports have exports\n2. **Follow the data** - Trace from user input to database and back\n3. **Check boundaries** - Integration issues often occur at module boundaries\n4. **Verify runtime paths** - Static analysis may miss dynamic imports/calls\n5. **Consider async** - Event-driven code may have delayed connections\n\n## Verdict Criteria\n\n- **INTEGRATED**: All components connected, no orphaned code, auth in place, flows complete\n- **NEEDS_WIRING**: Components exist but connections missing, fixable without major changes\n- **BROKEN**: Critical integration failures, major components disconnected, auth missing on sensitive routes\n\n## Quick Integration Checks\n\nUse these commands to detect common integration issues:\n\n```bash\n# Find exports without imports (JavaScript/TypeScript)\n# Export names\ngrep -rohn \"export \\(function\\|const\\|class\\) \\w\\+\" src/ | sed 's/.*export \\(function\\|const\\|class\\) //'\n# For each, verify import exists\ngrep -rn \"import.*{name}\" src/\n\n# Find routes without consumers\ngrep -rn \"app\\.\\(get\\|post\\|put\\|delete\\)\" src/routes/\ngrep -rn \"fetch\\|axios\" frontend/\n\n# Find potentially sensitive routes missing auth\ngrep -rn \"app\\.\\(post\\|put\\|delete\\|patch\\)\" src/ | grep -v \"auth\\|authenticate\\|require\"\n\n# Find unused imports (requires tooling)\n# TypeScript: tsc --noUnusedLocals\n# ESLint: no-unused-vars rule\n\n# Find TODO/FIXME indicating incomplete integration\ngrep -rn \"TODO.*integrat\\|TODO.*wire\\|TODO.*connect\\|FIXME.*integrat\" src/\n\n# Find commented-out code that may be incomplete integration\ngrep -rn \"// fetch\\|// await\\|# requests\\.\\|// db\\.\" src/\n```\n\n## Common Integration Patterns to Verify\n\n### Frontend-Backend Integration\n```\nComponent → API Call → Route Handler → Service → Database\n    ↓          ↓            ↓           ↓          ↓\n Renders    Awaits      Validates    Processes   Returns\n    ↑          ↑            ↑           ↑          ↑\n Updates   Response    Transform    Business    Query\n```\n\n### Event-Driven Integration\n```\nPublisher → Event Bus → Subscriber\n    ↓           ↓           ↓\n Emits      Routes     Handles\n Event      Event      Event\n```\n\n### CLI Integration\n```\nCLI Entry → Command Parser → Handler → Core Logic → Output\n    ↓            ↓            ↓          ↓          ↓\n  Args       Validates    Executes   Processes   Formats\n```\n\n## When Integration Checking is Critical\n\n- After multi-story feature completion\n- Before merge to main branch\n- When refactoring existing code\n- After resolving merge conflicts\n- When onboarding to unfamiliar codebase\n","structuredPatch":[],"originalFile":null}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Ka4h2CNdY3zPfesSCmKVnj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01JgDuoNwugxXZN251Aw21LB","name":"TodoWrite","input":{"todos":[{"content":"Create templates/integration-checker.md with integration verification prompt","status":"completed","activeForm":"Creating integration checker template"},{"content":"Add integration checks for exports, routes, auth on sensitive routes","status":"completed","activeForm":"Adding integration checks"},{"content":"Add end-to-end flow tracing with break point identification","status":"completed","activeForm":"Adding flow tracing"},{"content":"Define INTEGRATION.md output format","status":"completed","activeForm":"Defining output format"},{"content":"Create unit tests for integration checker","status":"in_progress","activeForm":"Creating unit tests"},{"content":"Commit and update prd.json","status":"pending","activeForm":"Committing changes"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":4249,"cache_read_input_tokens":50498,"cache_creation":{"ephemeral_5m_input_tokens":4249,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"09d99fb5-2892-4998-ac09-2f62acb1170e"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01JgDuoNwugxXZN251Aw21LB","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"be9b5d0c-e7fd-47ec-83ed-274b4b5c79b7","tool_use_result":{"oldTodos":[{"content":"Create templates/integration-checker.md with integration verification prompt","status":"in_progress","activeForm":"Creating integration checker template"},{"content":"Add integration checks for exports, routes, auth on sensitive routes","status":"pending","activeForm":"Adding integration checks"},{"content":"Add end-to-end flow tracing with break point identification","status":"pending","activeForm":"Adding flow tracing"},{"content":"Define INTEGRATION.md output format","status":"pending","activeForm":"Defining output format"},{"content":"Create unit tests for integration checker","status":"pending","activeForm":"Creating unit tests"},{"content":"Commit and update prd.json","status":"pending","activeForm":"Committing changes"}],"newTodos":[{"content":"Create templates/integration-checker.md with integration verification prompt","status":"completed","activeForm":"Creating integration checker template"},{"content":"Add integration checks for exports, routes, auth on sensitive routes","status":"completed","activeForm":"Adding integration checks"},{"content":"Add end-to-end flow tracing with break point identification","status":"completed","activeForm":"Adding flow tracing"},{"content":"Define INTEGRATION.md output format","status":"completed","activeForm":"Defining output format"},{"content":"Create unit tests for integration checker","status":"in_progress","activeForm":"Creating unit tests"},{"content":"Commit and update prd.json","status":"pending","activeForm":"Committing changes"}]}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Y38ptPvBCm172muHTdZfmF","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me create the unit tests for the integration checker template."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":284,"cache_read_input_tokens":54747,"cache_creation":{"ephemeral_5m_input_tokens":284,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"a999a7cd-e5f5-4766-9290-8b729b3869e3"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Y38ptPvBCm172muHTdZfmF","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01AwK5mPXgumGXjHbfoetN8e","name":"Read","input":{"file_path":"/home/ryan/Work/ralph-hybrid/tests/unit/test_verifier.bats","limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":284,"cache_read_input_tokens":54747,"cache_creation":{"ephemeral_5m_input_tokens":284,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"a1b0925e-b810-4aa6-89da-033759837b90"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01AwK5mPXgumGXjHbfoetN8e","type":"tool_result","content":"     1→#!/usr/bin/env bats\n     2→# Unit tests for templates/verifier.md verifier agent template\n     3→# Tests the goal-backward verification template structure and content\n     4→\n     5→setup() {\n     6→    PROJECT_ROOT=\"$(cd \"$BATS_TEST_DIRNAME/../..\" && pwd)\"\n     7→    TEMPLATE_PATH=\"$PROJECT_ROOT/templates/verifier.md\"\n     8→}\n     9→\n    10→# =============================================================================\n    11→# Template Existence Tests\n    12→# =============================================================================\n    13→\n    14→@test \"templates/verifier.md exists\" {\n    15→    [[ -f \"$TEMPLATE_PATH\" ]]\n    16→}\n    17→\n    18→@test \"templates/verifier.md is not empty\" {\n    19→    [[ -s \"$TEMPLATE_PATH\" ]]\n    20→}\n    21→\n    22→# =============================================================================\n    23→# Goal-Backward Approach Tests\n    24→# =============================================================================\n    25→\n    26→@test \"template includes goal-backward approach section\" {\n    27→    grep -q \"Goal-Backward Approach\" \"$TEMPLATE_PATH\"\n    28→}\n    29→\n    30→@test \"template explains difference between task-focused and goal-focused\" {\n    31→    grep -q \"Task-focused\" \"$TEMPLATE_PATH\"\n    32→    grep -q \"Goal-focused\" \"$TEMPLATE_PATH\"\n    33→}\n    34→\n    35→@test \"template emphasizes working backward from goals\" {\n    36→    grep -qi \"working backward from goals\" \"$TEMPLATE_PATH\" || \\\n    37→    grep -qi \"backward from goals\" \"$TEMPLATE_PATH\"\n    38→}\n    39→\n    40→@test \"template includes goal extraction phase\" {\n    41→    grep -q \"Goal Extraction\" \"$TEMPLATE_PATH\"\n    42→}\n    43→\n    44→# =============================================================================\n    45→# Deliverables Verification Tests\n    46→# =============================================================================\n    47→\n    48→@test \"template includes deliverables verification\" {\n    49→    grep -q \"Deliverables Verification\" \"$TEMPLATE_PATH\" || \\\n    50→    grep -q \"Deliverables Check\" \"$TEMPLATE_PATH\"\n    51→}\n    52→\n    53→@test \"template checks if code exists\" {\n    54→    grep -qi \"code exist\" \"$TEMPLATE_PATH\" || \\\n    55→    grep -qi \"file present\" \"$TEMPLATE_PATH\"\n    56→}\n    57→\n    58→@test \"template checks if code is accessible\" {\n    59→    grep -qi \"accessible\" \"$TEMPLATE_PATH\"\n    60→}\n    61→\n    62→@test \"template checks if code is integrated\" {\n    63→    grep -qi \"integrated\" \"$TEMPLATE_PATH\" || \\\n    64→    grep -qi \"connected\" \"$TEMPLATE_PATH\"\n    65→}\n    66→\n    67→# =============================================================================\n    68→# Stub Detection Tests\n    69→# =============================================================================\n    70→\n    71→@test \"template includes stub detection section\" {\n    72→    grep -q \"Stub Detection\" \"$TEMPLATE_PATH\"\n    73→}\n    74→\n    75→@test \"template detects placeholder returns - None\" {\n    76→    grep -q \"return None\" \"$TEMPLATE_PATH\"\n    77→}\n    78→\n    79→@test \"template detects placeholder returns - empty dict\" {\n    80→    grep -q \"return {}\" \"$TEMPLATE_PATH\"\n    81→}\n    82→\n    83→@test \"template detects placeholder returns - empty list\" {\n    84→    grep -qE \"return \\[\\]\" \"$TEMPLATE_PATH\"\n    85→}\n    86→\n    87→@test \"template detects TODO comments\" {\n    88→    grep -q \"TODO\" \"$TEMPLATE_PATH\"\n    89→}\n    90→\n    91→@test \"template detects FIXME comments\" {\n    92→    grep -q \"FIXME\" \"$TEMPLATE_PATH\"\n    93→}\n    94→\n    95→@test \"template detects XXX comments\" {\n    96→    grep -q \"XXX\" \"$TEMPLATE_PATH\"\n    97→}\n    98→\n    99→@test \"template detects HACK comments\" {\n   100→    grep -q \"HACK\" \"$TEMPLATE_PATH\"\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"51e826a0-fe06-4e18-828c-4b920f565be3","tool_use_result":{"type":"text","file":{"filePath":"/home/ryan/Work/ralph-hybrid/tests/unit/test_verifier.bats","content":"#!/usr/bin/env bats\n# Unit tests for templates/verifier.md verifier agent template\n# Tests the goal-backward verification template structure and content\n\nsetup() {\n    PROJECT_ROOT=\"$(cd \"$BATS_TEST_DIRNAME/../..\" && pwd)\"\n    TEMPLATE_PATH=\"$PROJECT_ROOT/templates/verifier.md\"\n}\n\n# =============================================================================\n# Template Existence Tests\n# =============================================================================\n\n@test \"templates/verifier.md exists\" {\n    [[ -f \"$TEMPLATE_PATH\" ]]\n}\n\n@test \"templates/verifier.md is not empty\" {\n    [[ -s \"$TEMPLATE_PATH\" ]]\n}\n\n# =============================================================================\n# Goal-Backward Approach Tests\n# =============================================================================\n\n@test \"template includes goal-backward approach section\" {\n    grep -q \"Goal-Backward Approach\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template explains difference between task-focused and goal-focused\" {\n    grep -q \"Task-focused\" \"$TEMPLATE_PATH\"\n    grep -q \"Goal-focused\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template emphasizes working backward from goals\" {\n    grep -qi \"working backward from goals\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"backward from goals\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes goal extraction phase\" {\n    grep -q \"Goal Extraction\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Deliverables Verification Tests\n# =============================================================================\n\n@test \"template includes deliverables verification\" {\n    grep -q \"Deliverables Verification\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"Deliverables Check\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template checks if code exists\" {\n    grep -qi \"code exist\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"file present\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template checks if code is accessible\" {\n    grep -qi \"accessible\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template checks if code is integrated\" {\n    grep -qi \"integrated\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"connected\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Stub Detection Tests\n# =============================================================================\n\n@test \"template includes stub detection section\" {\n    grep -q \"Stub Detection\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template detects placeholder returns - None\" {\n    grep -q \"return None\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template detects placeholder returns - empty dict\" {\n    grep -q \"return {}\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template detects placeholder returns - empty list\" {\n    grep -qE \"return \\[\\]\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template detects TODO comments\" {\n    grep -q \"TODO\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template detects FIXME comments\" {\n    grep -q \"FIXME\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template detects XXX comments\" {\n    grep -q \"XXX\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template detects HACK comments\" {\n    grep -q \"HACK\" \"$TEMPLATE_PATH\"","numLines":100,"startLine":1,"totalLines":353}}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_0157P1CZxeMtKUunSY7V7P9w","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me create a comprehensive test file for the integration checker template."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1305,"cache_read_input_tokens":55031,"cache_creation":{"ephemeral_5m_input_tokens":1305,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"db6af24e-828d-4397-9d29-6b9c8a8503e4"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_0157P1CZxeMtKUunSY7V7P9w","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MhVkWnK8DF7vVjGDA7Lfii","name":"Write","input":{"file_path":"/home/ryan/Work/ralph-hybrid/tests/unit/test_integration_checker.bats","content":"#!/usr/bin/env bats\n# Unit tests for templates/integration-checker.md integration checker agent template\n# Tests the integration verification template structure and content\n\nsetup() {\n    PROJECT_ROOT=\"$(cd \"$BATS_TEST_DIRNAME/../..\" && pwd)\"\n    TEMPLATE_PATH=\"$PROJECT_ROOT/templates/integration-checker.md\"\n}\n\n# =============================================================================\n# Template Existence Tests\n# =============================================================================\n\n@test \"templates/integration-checker.md exists\" {\n    [[ -f \"$TEMPLATE_PATH\" ]]\n}\n\n@test \"templates/integration-checker.md is not empty\" {\n    [[ -s \"$TEMPLATE_PATH\" ]]\n}\n\n@test \"template has substantial content (> 500 lines)\" {\n    local line_count\n    line_count=$(wc -l < \"$TEMPLATE_PATH\")\n    [[ $line_count -gt 500 ]]\n}\n\n# =============================================================================\n# Mission and Purpose Tests\n# =============================================================================\n\n@test \"template has integration checker title\" {\n    grep -q \"Integration Checker Agent\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template defines mission\" {\n    grep -q \"Your Mission\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"## Mission\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template explains why integration checking matters\" {\n    grep -q \"Why Integration Checking Matters\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions orphaned code detection\" {\n    grep -qi \"orphan\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions broken flows\" {\n    grep -qi \"broken.*flow\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"flow.*break\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Export/Import Analysis Tests\n# =============================================================================\n\n@test \"template has export/import analysis section\" {\n    grep -q \"Export/Import Analysis\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes JavaScript export patterns\" {\n    grep -q \"export function\" \"$TEMPLATE_PATH\"\n    grep -q \"export const\" \"$TEMPLATE_PATH\"\n    grep -q \"export default\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes module.exports pattern\" {\n    grep -q \"module.exports\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes Python export patterns\" {\n    grep -q \"__all__\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes Go export pattern\" {\n    grep -qi \"capitalized\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"PublicFunction\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template has orphan detection commands\" {\n    grep -q \"grep.*export\" \"$TEMPLATE_PATH\"\n    grep -q \"grep.*import\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Route/Endpoint Analysis Tests\n# =============================================================================\n\n@test \"template has route/endpoint analysis section\" {\n    grep -q \"Route/Endpoint Analysis\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"Route.*Analysis\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes Express route patterns\" {\n    grep -q \"app.get\" \"$TEMPLATE_PATH\"\n    grep -q \"app.post\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes router patterns\" {\n    grep -q \"router.get\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"Router\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes Python FastAPI/Flask patterns\" {\n    grep -q \"@app.route\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"@app.get\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes React Router pattern\" {\n    grep -q \"Route path\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"<Route\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes CLI command pattern\" {\n    grep -q \".command\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"@click.command\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes GraphQL patterns\" {\n    grep -q \"Query:\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"Mutation:\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template has consumer detection commands\" {\n    grep -q \"fetch\" \"$TEMPLATE_PATH\"\n    grep -q \"axios\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Authentication Analysis Tests\n# =============================================================================\n\n@test \"template has authentication analysis section\" {\n    grep -q \"Authentication Analysis\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template lists sensitive route categories\" {\n    grep -qi \"sensitive\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions user data endpoints\" {\n    grep -qi \"user data\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"profile\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions admin endpoints\" {\n    grep -qi \"admin\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions data modification endpoints\" {\n    grep -q \"POST\" \"$TEMPLATE_PATH\"\n    grep -q \"PUT\" \"$TEMPLATE_PATH\"\n    grep -q \"DELETE\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions auth middleware\" {\n    grep -qi \"middleware\" \"$TEMPLATE_PATH\"\n    grep -qi \"authenticate\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes auth detection patterns\" {\n    grep -q \"requireAuth\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"isAuthenticated\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions authorization/role checks\" {\n    grep -qi \"authorization\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"role\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Data Flow Tracing Tests\n# =============================================================================\n\n@test \"template has data flow tracing section\" {\n    grep -q \"Data Flow\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions break point identification\" {\n    grep -qi \"break.*point\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template shows flow diagram\" {\n    grep -q \"→\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions input validation at boundaries\" {\n    grep -qi \"validation\" \"$TEMPLATE_PATH\"\n    grep -qi \"boundaries\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"boundary\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template shows flow components\" {\n    grep -qi \"handler\\|service\\|repository\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template shows tracing example with checkmarks\" {\n    grep -q \"✓\" \"$TEMPLATE_PATH\"\n    grep -q \"✗\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Dead Code Detection Tests\n# =============================================================================\n\n@test \"template has dead code detection section\" {\n    grep -q \"Dead Code\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions unused imports\" {\n    grep -qi \"unused import\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions unreachable code\" {\n    grep -qi \"unreachable\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions deprecated functions\" {\n    grep -qi \"deprecated\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions feature flags\" {\n    grep -qi \"feature.*flag\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"flag.*false\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Issue Classification Tests\n# =============================================================================\n\n@test \"template has ORPHANED_EXPORT classification\" {\n    grep -q \"ORPHANED_EXPORT\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template has ORPHANED_ROUTE classification\" {\n    grep -q \"ORPHANED_ROUTE\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template has MISSING_AUTH classification\" {\n    grep -q \"MISSING_AUTH\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template has BROKEN_FLOW classification\" {\n    grep -q \"BROKEN_FLOW\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template has DEAD_CODE classification\" {\n    grep -q \"DEAD_CODE\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template has MISSING_CONNECTION classification\" {\n    grep -q \"MISSING_CONNECTION\" \"$TEMPLATE_PATH\"\n}\n\n@test \"ORPHANED_EXPORT has indicators\" {\n    # Check that the classification has associated indicators\n    grep -A10 \"ORPHANED_EXPORT\" \"$TEMPLATE_PATH\" | grep -qi \"indicator\"\n}\n\n@test \"ORPHANED_ROUTE has indicators\" {\n    grep -A10 \"ORPHANED_ROUTE\" \"$TEMPLATE_PATH\" | grep -qi \"indicator\"\n}\n\n@test \"MISSING_AUTH has indicators\" {\n    grep -A10 \"MISSING_AUTH\" \"$TEMPLATE_PATH\" | grep -qi \"indicator\"\n}\n\n# =============================================================================\n# Output Format Tests (INTEGRATION.md)\n# =============================================================================\n\n@test \"template specifies INTEGRATION.md output format\" {\n    grep -q \"INTEGRATION.md\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template has required output format section\" {\n    grep -q \"Required Output Format\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes summary section\" {\n    grep -q \"## Summary\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes verdict\" {\n    grep -q \"Verdict:\" \"$TEMPLATE_PATH\"\n}\n\n@test \"verdict options include INTEGRATED\" {\n    grep -q \"INTEGRATED\" \"$TEMPLATE_PATH\"\n}\n\n@test \"verdict options include NEEDS_WIRING\" {\n    grep -q \"NEEDS_WIRING\" \"$TEMPLATE_PATH\"\n}\n\n@test \"verdict options include BROKEN\" {\n    grep -q \"BROKEN\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes issue summary table\" {\n    grep -q \"Issue Summary\" \"$TEMPLATE_PATH\"\n    grep -q \"| Category | Count |\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes export/import analysis section\" {\n    grep -q \"## Export/Import Analysis\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes verified exports table\" {\n    grep -q \"Verified Exports\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes orphaned exports section\" {\n    grep -q \"Orphaned Exports\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes route analysis section\" {\n    grep -q \"## Route/Endpoint Analysis\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes verified routes table\" {\n    grep -q \"Verified Routes\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes orphaned routes section\" {\n    grep -q \"Orphaned Routes\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes auth analysis section\" {\n    grep -q \"## Authentication Analysis\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes secured routes table\" {\n    grep -q \"Secured Routes\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes missing auth section\" {\n    grep -q \"Missing Auth\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes data flow analysis\" {\n    grep -q \"## Data Flow Analysis\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes traced flows section\" {\n    grep -q \"Traced Flows\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes broken flows section\" {\n    grep -q \"Broken Flows\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes dead code detection\" {\n    grep -q \"## Dead Code Detection\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes missing connections section\" {\n    grep -q \"## Missing Connections\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes recommendations\" {\n    grep -q \"## Recommendations\" \"$TEMPLATE_PATH\"\n}\n\n@test \"recommendations include critical section\" {\n    grep -q \"Critical.*Must Fix\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"### Critical\" \"$TEMPLATE_PATH\"\n}\n\n@test \"recommendations include important section\" {\n    grep -q \"Important.*Should Fix\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"### Important\" \"$TEMPLATE_PATH\"\n}\n\n@test \"recommendations include cleanup section\" {\n    grep -q \"Cleanup\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"Nice to Have\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Verdict Criteria Tests\n# =============================================================================\n\n@test \"template has verdict criteria section\" {\n    grep -q \"Verdict Criteria\" \"$TEMPLATE_PATH\"\n}\n\n@test \"INTEGRATED verdict criteria defined\" {\n    grep -A5 \"INTEGRATED\" \"$TEMPLATE_PATH\" | grep -qi \"all.*connected\\|no.*orphan\"\n}\n\n@test \"NEEDS_WIRING verdict criteria defined\" {\n    grep -A5 \"NEEDS_WIRING\" \"$TEMPLATE_PATH\" | grep -qi \"connection.*missing\\|fix\"\n}\n\n@test \"BROKEN verdict criteria defined\" {\n    grep -A5 \"BROKEN\" \"$TEMPLATE_PATH\" | grep -qi \"critical\\|major\\|missing\"\n}\n\n# =============================================================================\n# Quick Integration Checks Tests\n# =============================================================================\n\n@test \"template has quick integration checks section\" {\n    grep -q \"Quick Integration Checks\" \"$TEMPLATE_PATH\"\n}\n\n@test \"quick checks include export detection command\" {\n    grep -q 'grep.*export' \"$TEMPLATE_PATH\"\n}\n\n@test \"quick checks include route detection command\" {\n    grep -q 'grep.*app\\.' \"$TEMPLATE_PATH\" || \\\n    grep -q 'grep.*route' \"$TEMPLATE_PATH\"\n}\n\n@test \"quick checks include auth verification command\" {\n    grep -q 'grep.*auth' \"$TEMPLATE_PATH\"\n}\n\n@test \"quick checks include TODO/FIXME integration command\" {\n    grep -q 'grep.*TODO\\|FIXME' \"$TEMPLATE_PATH\" || \\\n    grep -q 'TODO.*integrat' \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Integration Pattern Tests\n# =============================================================================\n\n@test \"template has common integration patterns section\" {\n    grep -q \"Common Integration Patterns\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"Integration Patterns\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template shows frontend-backend integration pattern\" {\n    grep -qi \"Frontend.*Backend\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template shows event-driven integration pattern\" {\n    grep -qi \"Event.*Driven\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"Publisher.*Subscriber\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template shows CLI integration pattern\" {\n    grep -qi \"CLI.*Entry\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"CLI.*Integration\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Integration Guidelines Tests\n# =============================================================================\n\n@test \"template has integration guidelines section\" {\n    grep -q \"Integration Guidelines\" \"$TEMPLATE_PATH\"\n}\n\n@test \"guidelines mention tracing both directions\" {\n    grep -qi \"both direction\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"export.*import\\|import.*export\" \"$TEMPLATE_PATH\"\n}\n\n@test \"guidelines mention following the data\" {\n    grep -qi \"follow.*data\" \"$TEMPLATE_PATH\"\n}\n\n@test \"guidelines mention checking boundaries\" {\n    grep -qi \"boundar\" \"$TEMPLATE_PATH\"\n}\n\n@test \"guidelines mention runtime paths\" {\n    grep -qi \"runtime\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"dynamic\" \"$TEMPLATE_PATH\"\n}\n\n@test \"guidelines mention async considerations\" {\n    grep -qi \"async\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"event.*driven\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# When to Use Tests\n# =============================================================================\n\n@test \"template specifies when integration checking is critical\" {\n    grep -q \"When Integration Checking is Critical\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"When.*Critical\" \"$TEMPLATE_PATH\"\n}\n\n@test \"mentions after multi-story feature completion\" {\n    grep -qi \"multi.*story\\|feature.*complet\" \"$TEMPLATE_PATH\"\n}\n\n@test \"mentions before merge\" {\n    grep -qi \"before.*merge\\|merge.*branch\" \"$TEMPLATE_PATH\"\n}\n\n@test \"mentions when refactoring\" {\n    grep -qi \"refactor\" \"$TEMPLATE_PATH\"\n}\n"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":1305,"cache_read_input_tokens":55031,"cache_creation":{"ephemeral_5m_input_tokens":1305,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"a43ad305-fd04-4063-b085-ff46540adf9f"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MhVkWnK8DF7vVjGDA7Lfii","type":"tool_result","content":"File created successfully at: /home/ryan/Work/ralph-hybrid/tests/unit/test_integration_checker.bats"}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"6b8784cf-f686-4d4d-b31e-d31406845928","tool_use_result":{"type":"create","filePath":"/home/ryan/Work/ralph-hybrid/tests/unit/test_integration_checker.bats","content":"#!/usr/bin/env bats\n# Unit tests for templates/integration-checker.md integration checker agent template\n# Tests the integration verification template structure and content\n\nsetup() {\n    PROJECT_ROOT=\"$(cd \"$BATS_TEST_DIRNAME/../..\" && pwd)\"\n    TEMPLATE_PATH=\"$PROJECT_ROOT/templates/integration-checker.md\"\n}\n\n# =============================================================================\n# Template Existence Tests\n# =============================================================================\n\n@test \"templates/integration-checker.md exists\" {\n    [[ -f \"$TEMPLATE_PATH\" ]]\n}\n\n@test \"templates/integration-checker.md is not empty\" {\n    [[ -s \"$TEMPLATE_PATH\" ]]\n}\n\n@test \"template has substantial content (> 500 lines)\" {\n    local line_count\n    line_count=$(wc -l < \"$TEMPLATE_PATH\")\n    [[ $line_count -gt 500 ]]\n}\n\n# =============================================================================\n# Mission and Purpose Tests\n# =============================================================================\n\n@test \"template has integration checker title\" {\n    grep -q \"Integration Checker Agent\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template defines mission\" {\n    grep -q \"Your Mission\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"## Mission\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template explains why integration checking matters\" {\n    grep -q \"Why Integration Checking Matters\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions orphaned code detection\" {\n    grep -qi \"orphan\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions broken flows\" {\n    grep -qi \"broken.*flow\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"flow.*break\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Export/Import Analysis Tests\n# =============================================================================\n\n@test \"template has export/import analysis section\" {\n    grep -q \"Export/Import Analysis\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes JavaScript export patterns\" {\n    grep -q \"export function\" \"$TEMPLATE_PATH\"\n    grep -q \"export const\" \"$TEMPLATE_PATH\"\n    grep -q \"export default\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes module.exports pattern\" {\n    grep -q \"module.exports\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes Python export patterns\" {\n    grep -q \"__all__\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes Go export pattern\" {\n    grep -qi \"capitalized\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"PublicFunction\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template has orphan detection commands\" {\n    grep -q \"grep.*export\" \"$TEMPLATE_PATH\"\n    grep -q \"grep.*import\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Route/Endpoint Analysis Tests\n# =============================================================================\n\n@test \"template has route/endpoint analysis section\" {\n    grep -q \"Route/Endpoint Analysis\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"Route.*Analysis\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes Express route patterns\" {\n    grep -q \"app.get\" \"$TEMPLATE_PATH\"\n    grep -q \"app.post\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes router patterns\" {\n    grep -q \"router.get\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"Router\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes Python FastAPI/Flask patterns\" {\n    grep -q \"@app.route\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"@app.get\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes React Router pattern\" {\n    grep -q \"Route path\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"<Route\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes CLI command pattern\" {\n    grep -q \".command\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"@click.command\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes GraphQL patterns\" {\n    grep -q \"Query:\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"Mutation:\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template has consumer detection commands\" {\n    grep -q \"fetch\" \"$TEMPLATE_PATH\"\n    grep -q \"axios\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Authentication Analysis Tests\n# =============================================================================\n\n@test \"template has authentication analysis section\" {\n    grep -q \"Authentication Analysis\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template lists sensitive route categories\" {\n    grep -qi \"sensitive\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions user data endpoints\" {\n    grep -qi \"user data\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"profile\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions admin endpoints\" {\n    grep -qi \"admin\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions data modification endpoints\" {\n    grep -q \"POST\" \"$TEMPLATE_PATH\"\n    grep -q \"PUT\" \"$TEMPLATE_PATH\"\n    grep -q \"DELETE\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions auth middleware\" {\n    grep -qi \"middleware\" \"$TEMPLATE_PATH\"\n    grep -qi \"authenticate\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template includes auth detection patterns\" {\n    grep -q \"requireAuth\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"isAuthenticated\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions authorization/role checks\" {\n    grep -qi \"authorization\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"role\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Data Flow Tracing Tests\n# =============================================================================\n\n@test \"template has data flow tracing section\" {\n    grep -q \"Data Flow\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions break point identification\" {\n    grep -qi \"break.*point\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template shows flow diagram\" {\n    grep -q \"→\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions input validation at boundaries\" {\n    grep -qi \"validation\" \"$TEMPLATE_PATH\"\n    grep -qi \"boundaries\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"boundary\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template shows flow components\" {\n    grep -qi \"handler\\|service\\|repository\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template shows tracing example with checkmarks\" {\n    grep -q \"✓\" \"$TEMPLATE_PATH\"\n    grep -q \"✗\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Dead Code Detection Tests\n# =============================================================================\n\n@test \"template has dead code detection section\" {\n    grep -q \"Dead Code\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions unused imports\" {\n    grep -qi \"unused import\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions unreachable code\" {\n    grep -qi \"unreachable\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions deprecated functions\" {\n    grep -qi \"deprecated\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions feature flags\" {\n    grep -qi \"feature.*flag\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"flag.*false\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Issue Classification Tests\n# =============================================================================\n\n@test \"template has ORPHANED_EXPORT classification\" {\n    grep -q \"ORPHANED_EXPORT\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template has ORPHANED_ROUTE classification\" {\n    grep -q \"ORPHANED_ROUTE\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template has MISSING_AUTH classification\" {\n    grep -q \"MISSING_AUTH\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template has BROKEN_FLOW classification\" {\n    grep -q \"BROKEN_FLOW\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template has DEAD_CODE classification\" {\n    grep -q \"DEAD_CODE\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template has MISSING_CONNECTION classification\" {\n    grep -q \"MISSING_CONNECTION\" \"$TEMPLATE_PATH\"\n}\n\n@test \"ORPHANED_EXPORT has indicators\" {\n    # Check that the classification has associated indicators\n    grep -A10 \"ORPHANED_EXPORT\" \"$TEMPLATE_PATH\" | grep -qi \"indicator\"\n}\n\n@test \"ORPHANED_ROUTE has indicators\" {\n    grep -A10 \"ORPHANED_ROUTE\" \"$TEMPLATE_PATH\" | grep -qi \"indicator\"\n}\n\n@test \"MISSING_AUTH has indicators\" {\n    grep -A10 \"MISSING_AUTH\" \"$TEMPLATE_PATH\" | grep -qi \"indicator\"\n}\n\n# =============================================================================\n# Output Format Tests (INTEGRATION.md)\n# =============================================================================\n\n@test \"template specifies INTEGRATION.md output format\" {\n    grep -q \"INTEGRATION.md\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template has required output format section\" {\n    grep -q \"Required Output Format\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes summary section\" {\n    grep -q \"## Summary\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes verdict\" {\n    grep -q \"Verdict:\" \"$TEMPLATE_PATH\"\n}\n\n@test \"verdict options include INTEGRATED\" {\n    grep -q \"INTEGRATED\" \"$TEMPLATE_PATH\"\n}\n\n@test \"verdict options include NEEDS_WIRING\" {\n    grep -q \"NEEDS_WIRING\" \"$TEMPLATE_PATH\"\n}\n\n@test \"verdict options include BROKEN\" {\n    grep -q \"BROKEN\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes issue summary table\" {\n    grep -q \"Issue Summary\" \"$TEMPLATE_PATH\"\n    grep -q \"| Category | Count |\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes export/import analysis section\" {\n    grep -q \"## Export/Import Analysis\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes verified exports table\" {\n    grep -q \"Verified Exports\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes orphaned exports section\" {\n    grep -q \"Orphaned Exports\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes route analysis section\" {\n    grep -q \"## Route/Endpoint Analysis\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes verified routes table\" {\n    grep -q \"Verified Routes\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes orphaned routes section\" {\n    grep -q \"Orphaned Routes\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes auth analysis section\" {\n    grep -q \"## Authentication Analysis\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes secured routes table\" {\n    grep -q \"Secured Routes\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes missing auth section\" {\n    grep -q \"Missing Auth\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes data flow analysis\" {\n    grep -q \"## Data Flow Analysis\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes traced flows section\" {\n    grep -q \"Traced Flows\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes broken flows section\" {\n    grep -q \"Broken Flows\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes dead code detection\" {\n    grep -q \"## Dead Code Detection\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes missing connections section\" {\n    grep -q \"## Missing Connections\" \"$TEMPLATE_PATH\"\n}\n\n@test \"output format includes recommendations\" {\n    grep -q \"## Recommendations\" \"$TEMPLATE_PATH\"\n}\n\n@test \"recommendations include critical section\" {\n    grep -q \"Critical.*Must Fix\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"### Critical\" \"$TEMPLATE_PATH\"\n}\n\n@test \"recommendations include important section\" {\n    grep -q \"Important.*Should Fix\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"### Important\" \"$TEMPLATE_PATH\"\n}\n\n@test \"recommendations include cleanup section\" {\n    grep -q \"Cleanup\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"Nice to Have\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Verdict Criteria Tests\n# =============================================================================\n\n@test \"template has verdict criteria section\" {\n    grep -q \"Verdict Criteria\" \"$TEMPLATE_PATH\"\n}\n\n@test \"INTEGRATED verdict criteria defined\" {\n    grep -A5 \"INTEGRATED\" \"$TEMPLATE_PATH\" | grep -qi \"all.*connected\\|no.*orphan\"\n}\n\n@test \"NEEDS_WIRING verdict criteria defined\" {\n    grep -A5 \"NEEDS_WIRING\" \"$TEMPLATE_PATH\" | grep -qi \"connection.*missing\\|fix\"\n}\n\n@test \"BROKEN verdict criteria defined\" {\n    grep -A5 \"BROKEN\" \"$TEMPLATE_PATH\" | grep -qi \"critical\\|major\\|missing\"\n}\n\n# =============================================================================\n# Quick Integration Checks Tests\n# =============================================================================\n\n@test \"template has quick integration checks section\" {\n    grep -q \"Quick Integration Checks\" \"$TEMPLATE_PATH\"\n}\n\n@test \"quick checks include export detection command\" {\n    grep -q 'grep.*export' \"$TEMPLATE_PATH\"\n}\n\n@test \"quick checks include route detection command\" {\n    grep -q 'grep.*app\\.' \"$TEMPLATE_PATH\" || \\\n    grep -q 'grep.*route' \"$TEMPLATE_PATH\"\n}\n\n@test \"quick checks include auth verification command\" {\n    grep -q 'grep.*auth' \"$TEMPLATE_PATH\"\n}\n\n@test \"quick checks include TODO/FIXME integration command\" {\n    grep -q 'grep.*TODO\\|FIXME' \"$TEMPLATE_PATH\" || \\\n    grep -q 'TODO.*integrat' \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Integration Pattern Tests\n# =============================================================================\n\n@test \"template has common integration patterns section\" {\n    grep -q \"Common Integration Patterns\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"Integration Patterns\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template shows frontend-backend integration pattern\" {\n    grep -qi \"Frontend.*Backend\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template shows event-driven integration pattern\" {\n    grep -qi \"Event.*Driven\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"Publisher.*Subscriber\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template shows CLI integration pattern\" {\n    grep -qi \"CLI.*Entry\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"CLI.*Integration\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# Integration Guidelines Tests\n# =============================================================================\n\n@test \"template has integration guidelines section\" {\n    grep -q \"Integration Guidelines\" \"$TEMPLATE_PATH\"\n}\n\n@test \"guidelines mention tracing both directions\" {\n    grep -qi \"both direction\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"export.*import\\|import.*export\" \"$TEMPLATE_PATH\"\n}\n\n@test \"guidelines mention following the data\" {\n    grep -qi \"follow.*data\" \"$TEMPLATE_PATH\"\n}\n\n@test \"guidelines mention checking boundaries\" {\n    grep -qi \"boundar\" \"$TEMPLATE_PATH\"\n}\n\n@test \"guidelines mention runtime paths\" {\n    grep -qi \"runtime\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"dynamic\" \"$TEMPLATE_PATH\"\n}\n\n@test \"guidelines mention async considerations\" {\n    grep -qi \"async\" \"$TEMPLATE_PATH\" || \\\n    grep -qi \"event.*driven\" \"$TEMPLATE_PATH\"\n}\n\n# =============================================================================\n# When to Use Tests\n# =============================================================================\n\n@test \"template specifies when integration checking is critical\" {\n    grep -q \"When Integration Checking is Critical\" \"$TEMPLATE_PATH\" || \\\n    grep -q \"When.*Critical\" \"$TEMPLATE_PATH\"\n}\n\n@test \"mentions after multi-story feature completion\" {\n    grep -qi \"multi.*story\\|feature.*complet\" \"$TEMPLATE_PATH\"\n}\n\n@test \"mentions before merge\" {\n    grep -qi \"before.*merge\\|merge.*branch\" \"$TEMPLATE_PATH\"\n}\n\n@test \"mentions when refactoring\" {\n    grep -qi \"refactor\" \"$TEMPLATE_PATH\"\n}\n","structuredPatch":[],"originalFile":null}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01AB92YJKJxjToEr6VSUfWdY","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me run the tests to make sure they pass."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":4176,"cache_read_input_tokens":56336,"cache_creation":{"ephemeral_5m_input_tokens":4176,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"48f4a705-ada4-452a-b4fc-0bc57291a628"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01AB92YJKJxjToEr6VSUfWdY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01CbLSoZhoEnyZpBy4FQemgc","name":"Bash","input":{"command":"bash tests/unit/test_integration_checker.bats 2>&1","description":"Run unit tests for integration checker template","timeout":60000}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":4176,"cache_read_input_tokens":56336,"cache_creation":{"ephemeral_5m_input_tokens":4176,"ephemeral_1h_input_tokens":0},"output_tokens":3,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"96c6f72d-ab44-4eeb-9f99-15e18c9b23e6"}
{"type":"user","message":{"role":"user","content":[{"type":"tool_result","content":"Exit code 2\ntests/unit/test_integration_checker.bats: line 14: @test: command not found\ntests/unit/test_integration_checker.bats: line 16: syntax error near unexpected token `}'\ntests/unit/test_integration_checker.bats: line 16: `}'","is_error":true,"tool_use_id":"toolu_01CbLSoZhoEnyZpBy4FQemgc"}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"ad9d255c-6a7e-4e26-ac9c-80aab4d67285","tool_use_result":"Error: Exit code 2\ntests/unit/test_integration_checker.bats: line 14: @test: command not found\ntests/unit/test_integration_checker.bats: line 16: syntax error near unexpected token `}'\ntests/unit/test_integration_checker.bats: line 16: `}'"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_013MXxWZT5LJvfdpT35qx1zQ","type":"message","role":"assistant","content":[{"type":"text","text":"This needs BATS to run. Let me check how other tests are run in this project."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":215,"cache_read_input_tokens":60512,"cache_creation":{"ephemeral_5m_input_tokens":215,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"4da82451-8a08-4cc3-b70a-1b016033a922"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_013MXxWZT5LJvfdpT35qx1zQ","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Lv1e33fPLMpGkQpfjcp5UN","name":"Bash","input":{"command":"type bats 2>/dev/null || which bats 2>/dev/null || ([ -f ./node_modules/.bin/bats ] && echo \"./node_modules/.bin/bats\") || ([ -d test_libs/bats-core ] && echo \"test_libs/bats-core/bin/bats\") || echo \"BATS not found\"","description":"Find BATS installation"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":215,"cache_read_input_tokens":60512,"cache_creation":{"ephemeral_5m_input_tokens":215,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"492ba1a8-83be-43a9-8328-1855f73f7de4"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Lv1e33fPLMpGkQpfjcp5UN","type":"tool_result","content":"bats not found\nbats not found\nBATS not found","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"bde91447-4215-45bf-a27c-796c4d3c8943","tool_use_result":{"stdout":"bats not found\nbats not found\nBATS not found","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01RWgudACVX8J6htvh4BbD6Z","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Kv635bpSwbPvmauU4ozNmt","name":"Bash","input":{"command":"ls -la test_libs/ 2>/dev/null || ls -la vendor/bats* 2>/dev/null || find . -name \"bats\" -type f 2>/dev/null | head -5","description":"Look for BATS in project"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":206,"cache_read_input_tokens":60727,"cache_creation":{"ephemeral_5m_input_tokens":206,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"3752d33c-515b-4b7d-a236-703245911ace"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Kv635bpSwbPvmauU4ozNmt","type":"tool_result","content":"(eval):1: no matches found: vendor/bats*","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"f62801b0-284a-4d4d-9fc4-b644b405fa59","tool_use_result":{"stdout":"(eval):1: no matches found: vendor/bats*","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MX2thH4Z8KemoaCPC7Vvy7","type":"message","role":"assistant","content":[{"type":"text","text":"BATS isn't installed but the tests use BATS format. Looking at the progress log, tests were run successfully before. Let me verify the test file passes syntax validation at least."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":149,"cache_read_input_tokens":60933,"cache_creation":{"ephemeral_5m_input_tokens":149,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"52d08988-1677-4806-aacc-4d1da3660ecb"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01MX2thH4Z8KemoaCPC7Vvy7","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01HBDzFftgcm1Mpiuim9E7WW","name":"Bash","input":{"command":"bash -n tests/unit/test_integration_checker.bats 2>&1 || echo \"Note: BATS syntax cannot be verified with bash -n\"","description":"Check basic syntax"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":149,"cache_read_input_tokens":60933,"cache_creation":{"ephemeral_5m_input_tokens":149,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"5bd41612-0e64-4d17-a5d0-1bd42c9ec6c2"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01HBDzFftgcm1Mpiuim9E7WW","type":"tool_result","content":"tests/unit/test_integration_checker.bats: line 16: syntax error near unexpected token `}'\ntests/unit/test_integration_checker.bats: line 16: `}'\nNote: BATS syntax cannot be verified with bash -n","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"9d626ad1-f976-4ef8-95ef-825202c45685","tool_use_result":{"stdout":"tests/unit/test_integration_checker.bats: line 16: syntax error near unexpected token `}'\ntests/unit/test_integration_checker.bats: line 16: `}'\nNote: BATS syntax cannot be verified with bash -n","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CPyD24MMjVteYpwAHfsoho","type":"message","role":"assistant","content":[{"type":"text","text":"This is expected - BATS tests can't be validated with `bash -n` because they use `@test` syntax. Let me look at how another test file is structured to ensure my format matches."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":429,"cache_read_input_tokens":61082,"cache_creation":{"ephemeral_5m_input_tokens":429,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"854c1255-bdf3-471f-8465-9a05c58e9a7f"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01CPyD24MMjVteYpwAHfsoho","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01KhbpKyWZp9uS4eEMDdvTFh","name":"Read","input":{"file_path":"/home/ryan/Work/ralph-hybrid/tests/unit/test_incident_response.bats","limit":50}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":429,"cache_read_input_tokens":61082,"cache_creation":{"ephemeral_5m_input_tokens":429,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"a8e8c4cc-d784-4b85-8e60-0765540d31f2"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01KhbpKyWZp9uS4eEMDdvTFh","type":"tool_result","content":"     1→#!/usr/bin/env bats\n     2→\n     3→# Test incident-response skill template\n     4→\n     5→setup() {\n     6→    # Get the directory of this test file\n     7→    TEST_DIR=\"$(cd \"$(dirname \"$BATS_TEST_FILENAME\")\" && pwd)\"\n     8→    PROJECT_ROOT=\"$(cd \"$TEST_DIR/../..\" && pwd)\"\n     9→\n    10→    # Template paths\n    11→    TEMPLATE_PATH=\"${PROJECT_ROOT}/templates/skills/incident-response.md\"\n    12→    SPEC_PATH=\"${PROJECT_ROOT}/SPEC.md\"\n    13→\n    14→    # Create temp directory\n    15→    TEMP_DIR=\"$(mktemp -d)\"\n    16→}\n    17→\n    18→teardown() {\n    19→    # Clean up temp directory\n    20→    if [[ -d \"$TEMP_DIR\" ]]; then\n    21→        rm -rf \"$TEMP_DIR\"\n    22→    fi\n    23→}\n    24→\n    25→#=============================================================================\n    26→# Template Existence Tests\n    27→#=============================================================================\n    28→\n    29→@test \"templates/skills/incident-response.md exists\" {\n    30→    [[ -f \"$TEMPLATE_PATH\" ]]\n    31→}\n    32→\n    33→@test \"templates/skills/incident-response.md is not empty\" {\n    34→    [[ -s \"$TEMPLATE_PATH\" ]]\n    35→}\n    36→\n    37→#=============================================================================\n    38→# OODA Loop Pattern Tests\n    39→#=============================================================================\n    40→\n    41→@test \"template includes four-role pattern section\" {\n    42→    grep -q \"Four-Role Pattern\" \"$TEMPLATE_PATH\"\n    43→}\n    44→\n    45→@test \"template mentions OODA Loop\" {\n    46→    grep -q \"OODA\" \"$TEMPLATE_PATH\"\n    47→}\n    48→\n    49→@test \"template explains OODA acronym\" {\n    50→    grep -q \"Observe, Orient, Decide, Act\\|Observe.*Orient.*Decide.*Act\" \"$TEMPLATE_PATH\"\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"e462a1de-e3ef-468a-b20c-7d70736323e1","tool_use_result":{"type":"text","file":{"filePath":"/home/ryan/Work/ralph-hybrid/tests/unit/test_incident_response.bats","content":"#!/usr/bin/env bats\n\n# Test incident-response skill template\n\nsetup() {\n    # Get the directory of this test file\n    TEST_DIR=\"$(cd \"$(dirname \"$BATS_TEST_FILENAME\")\" && pwd)\"\n    PROJECT_ROOT=\"$(cd \"$TEST_DIR/../..\" && pwd)\"\n\n    # Template paths\n    TEMPLATE_PATH=\"${PROJECT_ROOT}/templates/skills/incident-response.md\"\n    SPEC_PATH=\"${PROJECT_ROOT}/SPEC.md\"\n\n    # Create temp directory\n    TEMP_DIR=\"$(mktemp -d)\"\n}\n\nteardown() {\n    # Clean up temp directory\n    if [[ -d \"$TEMP_DIR\" ]]; then\n        rm -rf \"$TEMP_DIR\"\n    fi\n}\n\n#=============================================================================\n# Template Existence Tests\n#=============================================================================\n\n@test \"templates/skills/incident-response.md exists\" {\n    [[ -f \"$TEMPLATE_PATH\" ]]\n}\n\n@test \"templates/skills/incident-response.md is not empty\" {\n    [[ -s \"$TEMPLATE_PATH\" ]]\n}\n\n#=============================================================================\n# OODA Loop Pattern Tests\n#=============================================================================\n\n@test \"template includes four-role pattern section\" {\n    grep -q \"Four-Role Pattern\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template mentions OODA Loop\" {\n    grep -q \"OODA\" \"$TEMPLATE_PATH\"\n}\n\n@test \"template explains OODA acronym\" {\n    grep -q \"Observe, Orient, Decide, Act\\|Observe.*Orient.*Decide.*Act\" \"$TEMPLATE_PATH\"","numLines":50,"startLine":1,"totalLines":496}}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_0144uhpQhGKZfJ3kcydMH1Kj","type":"message","role":"assistant","content":[{"type":"text","text":"The format looks correct. Let me verify our e2e tests still pass and bash syntax for the main scripts."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":779,"cache_read_input_tokens":61511,"cache_creation":{"ephemeral_5m_input_tokens":779,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"205271a6-71bc-4a9a-9af8-786077fda035"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_0144uhpQhGKZfJ3kcydMH1Kj","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01V7wrbAsghvxaKMNjtNvX5D","name":"Bash","input":{"command":"bash -n ralph-hybrid && bash -n lib/*.sh && echo \"All syntax checks pass\"","description":"Check bash syntax for all scripts"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":779,"cache_read_input_tokens":61511,"cache_creation":{"ephemeral_5m_input_tokens":779,"ephemeral_1h_input_tokens":0},"output_tokens":2,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"aaaa177b-1683-4f0c-bba8-1db541f4397b"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01V7wrbAsghvxaKMNjtNvX5D","type":"tool_result","content":"All syntax checks pass","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"0a6a9c70-5a2d-4cd9-bb0c-41cf08bec4a7","tool_use_result":{"stdout":"All syntax checks pass","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Uyq9UdJp8gN4ww2HmBh9V5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_018q7vsj9aDpDQ2u8t91Etbv","name":"Bash","input":{"command":"./tests/e2e_test.sh 2>&1","description":"Run e2e tests to verify nothing broke","timeout":120000}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":134,"cache_read_input_tokens":62290,"cache_creation":{"ephemeral_5m_input_tokens":134,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"b590e494-1c27-4fd5-a04f-4411bee805ad"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_018q7vsj9aDpDQ2u8t91Etbv","type":"tool_result","content":"\u001b[0;33mINFO\u001b[0m: Setting up test environment in /tmp/ralph-test-952012\n\u001b[0;33mINFO\u001b[0m: Running e2e tests...\n\u001b[0;33mINFO\u001b[0m: Test 1: Help command\n\u001b[0;32mPASS\u001b[0m: Help command works\n\u001b[0;33mINFO\u001b[0m: Test 2: Version command\n\u001b[0;32mPASS\u001b[0m: Version command works\n\u001b[0;33mINFO\u001b[0m: Test 3: Status command\n\u001b[0;32mPASS\u001b[0m: Status command works\n\u001b[0;33mINFO\u001b[0m: Test 4: Validate command\n\u001b[0;32mPASS\u001b[0m: Validate command works\n\u001b[0;33mINFO\u001b[0m: Test 5: Dry-run\n\u001b[0;32mPASS\u001b[0m: Dry-run works\n\u001b[0;33mINFO\u001b[0m: Test 6: PRD parsing\n\u001b[0;32mPASS\u001b[0m: PRD has 5 stories\n\u001b[0;33mINFO\u001b[0m: Test 7: Run loop with haiku (requires claude CLI)\n\u001b[0;32mPASS\u001b[0m: Run loop works with haiku\n\n================================\nResults: \u001b[0;32m7 passed\u001b[0m, \u001b[0;31m0 failed\u001b[0m, \u001b[0;33m0 skipped\u001b[0m\n================================","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"62bb80fe-d81b-453c-b636-777af97daccd","tool_use_result":{"stdout":"\u001b[0;33mINFO\u001b[0m: Setting up test environment in /tmp/ralph-test-952012\n\u001b[0;33mINFO\u001b[0m: Running e2e tests...\n\u001b[0;33mINFO\u001b[0m: Test 1: Help command\n\u001b[0;32mPASS\u001b[0m: Help command works\n\u001b[0;33mINFO\u001b[0m: Test 2: Version command\n\u001b[0;32mPASS\u001b[0m: Version command works\n\u001b[0;33mINFO\u001b[0m: Test 3: Status command\n\u001b[0;32mPASS\u001b[0m: Status command works\n\u001b[0;33mINFO\u001b[0m: Test 4: Validate command\n\u001b[0;32mPASS\u001b[0m: Validate command works\n\u001b[0;33mINFO\u001b[0m: Test 5: Dry-run\n\u001b[0;32mPASS\u001b[0m: Dry-run works\n\u001b[0;33mINFO\u001b[0m: Test 6: PRD parsing\n\u001b[0;32mPASS\u001b[0m: PRD has 5 stories\n\u001b[0;33mINFO\u001b[0m: Test 7: Run loop with haiku (requires claude CLI)\n\u001b[0;32mPASS\u001b[0m: Run loop works with haiku\n\n================================\nResults: \u001b[0;32m7 passed\u001b[0m, \u001b[0;31m0 failed\u001b[0m, \u001b[0;33m0 skipped\u001b[0m\n================================","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_017XfXLq9HyVBqN9fd1dBG8R","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the SPEC.md to document the integration checker."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":474,"cache_read_input_tokens":62424,"cache_creation":{"ephemeral_5m_input_tokens":474,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"684a24d3-cbe8-45f2-8678-9718c7b3fb8b"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_017XfXLq9HyVBqN9fd1dBG8R","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_013tS1VTVY7ts9yv697vM8qs","name":"Grep","input":{"pattern":"Template Library","path":"/home/ryan/Work/ralph-hybrid/SPEC.md","output_mode":"content","-n":true,"-A":5}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":474,"cache_read_input_tokens":62424,"cache_creation":{"ephemeral_5m_input_tokens":474,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"467fc52d-aafd-4a4c-adaa-34d656782ef8"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_013tS1VTVY7ts9yv697vM8qs","type":"tool_result","content":"2202:## Template Library\n2203-\n2204-Ralph Hybrid includes a template library for skills, scripts, and hooks that can be customized per-feature. These templates are designed to reduce tool calls during execution and enforce best practices.\n2205-\n2206-### Template Types\n2207-"}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"00d75818-d716-4b5c-bd9d-bc0d754e8564","tool_use_result":{"mode":"content","numFiles":0,"filenames":[],"content":"2202:## Template Library\n2203-\n2204-Ralph Hybrid includes a template library for skills, scripts, and hooks that can be customized per-feature. These templates are designed to reduce tool calls during execution and enforce best practices.\n2205-\n2206-### Template Types\n2207-","numLines":6}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01GwMBCzuHW5UuXf5DrnwAwM","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QFezQSsfLE9K9keJNqfDFN","name":"Read","input":{"file_path":"/home/ryan/Work/ralph-hybrid/SPEC.md","offset":2200,"limit":200}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":234,"cache_read_input_tokens":62898,"cache_creation":{"ephemeral_5m_input_tokens":234,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"7e5b384e-43d3-4312-88da-86e51ff59693"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QFezQSsfLE9K9keJNqfDFN","type":"tool_result","content":"  2200→---\n  2201→\n  2202→## Template Library\n  2203→\n  2204→Ralph Hybrid includes a template library for skills, scripts, and hooks that can be customized per-feature. These templates are designed to reduce tool calls during execution and enforce best practices.\n  2205→\n  2206→### Template Types\n  2207→\n  2208→| Type | Purpose | Location |\n  2209→|------|---------|----------|\n  2210→| **Skills** | Claude instructions for specific patterns (migration, visual parity) | `templates/skills/` |\n  2211→| **Scripts** | Bash scripts that batch operations (reduce tool calls) | `templates/scripts/` |\n  2212→| **Hooks** | Pre/post iteration automation (visual regression, notifications) | `templates/hooks/` |\n  2213→\n  2214→### Available Templates\n  2215→\n  2216→#### Skills\n  2217→\n  2218→| Template | Use When | Description |\n  2219→|----------|----------|-------------|\n  2220→| `visual-parity-migration.md` | Migrating UI frameworks | Enforces verbatim class copying, CSS variable auditing, visual regression validation |\n  2221→| `adversarial-review.md` | Security-focused code review | Red team/blue team pattern for finding injection, auth bypass, data exposure, race conditions |\n  2222→| `code-archaeology.md` | Legacy code modification | Four-role pattern (Surveyor, Historian, Archaeologist, Careful Modifier) for safe legacy changes |\n  2223→| `incident-response.md` | Production incidents | OODA loop pattern (Observer, Mitigator, Investigator, Fixer) with speed vs thoroughness separation |\n  2224→\n  2225→#### Scripts\n  2226→\n  2227→| Template | Use When | Description |\n  2228→|----------|----------|-------------|\n  2229→| `css-audit.sh` | CSS/styling work | Audits CSS variable usage vs definitions, reports undefined variables |\n  2230→| `endpoint-validation.sh` | API/route work | Batch validates all endpoints at once, returns JSON report |\n  2231→| `file-inventory.sh` | Large features | Pre-reads relevant files by category, reduces repeated file reads |\n  2232→| `template-comparison.sh` | Framework migration | Compares source vs target class usage, reports missing classes |\n  2233→\n  2234→#### Hooks\n  2235→\n  2236→| Template | Use When | Description |\n  2237→|----------|----------|-------------|\n  2238→| `post-iteration-visual-diff.sh` | Visual parity requirements | Screenshots pages and compares against baseline, reports pixel differences |\n  2239→\n  2240→### Template Flow\n  2241→\n  2242→Templates are copied and customized per-feature during planning:\n  2243→\n  2244→```\n  2245→ralph-hybrid/templates/           ← Generic templates (this repo)\n  2246→├── skills/visual-parity-migration.md\n  2247→├── skills/adversarial-review.md\n  2248→├── skills/code-archaeology.md\n  2249→├── skills/incident-response.md\n  2250→├── scripts/css-audit.sh\n  2251→└── hooks/post-iteration-visual-diff.sh\n  2252→\n  2253→                    │ ralph-plan detects patterns\n  2254→                    ▼\n  2255→\n  2256→.ralph-hybrid/{feature}/          ← Customized per-feature\n  2257→├── skills/visual-parity-migration.md   ← Customized for project\n  2258→├── skills/adversarial-review.md        ← Security review skill\n  2259→├── skills/code-archaeology.md          ← Legacy code investigation skill\n  2260→├── skills/incident-response.md         ← Production incident handling skill\n  2261→├── scripts/css-audit.sh                ← Configured with project paths\n  2262→└── hooks/post-iteration-visual-diff.sh ← Configured with URLs\n  2263→```\n  2264→\n  2265→### Pattern Detection\n  2266→\n  2267→The `/ralph-hybrid-plan` command detects patterns in the epic description and proposes relevant templates:\n  2268→\n  2269→| Pattern | Detection Keywords | Proposed Assets |\n  2270→|---------|-------------------|-----------------|\n  2271→| Framework Migration | migrate, convert, port, React, Jinja2 | visual-parity skill, css-audit, template-comparison |\n  2272→| Visual Parity | match styling, same look, pixel perfect | visual-parity skill, visual-diff hook |\n  2273→| API Changes | endpoint, REST, routes | endpoint-validation script |\n  2274→| Large Codebase | many files, multiple subsystems | file-inventory script |\n  2275→| Security Review | auth, login, password, security, encrypt, token, session | adversarial-review skill |\n  2276→| Legacy Code | legacy, old, refactor, migrate, ancient, technical debt, modernize | code-archaeology skill |\n  2277→| Incident Response | incident, outage, down, production, alert, emergency, urgent, critical, SEV-1, SEV-2 | incident-response skill |\n  2278→\n  2279→### Script Output Format\n  2280→\n  2281→All scripts output JSON for easy parsing by Claude:\n  2282→\n  2283→```json\n  2284→{\n  2285→  \"audit\": \"css-variables\",\n  2286→  \"summary\": {\n  2287→    \"variables_used\": 15,\n  2288→    \"variables_defined\": 12,\n  2289→    \"variables_undefined\": 3,\n  2290→    \"status\": \"fail\"\n  2291→  },\n  2292→  \"undefined\": [\"--color-bg-surface\", \"--color-text-primary\", \"--border-hover\"]\n  2293→}\n  2294→```\n  2295→\n  2296→Human-readable summaries are written to stderr so Claude sees the JSON on stdout.\n  2297→\n  2298→### Tool Call Reduction\n  2299→\n  2300→The template scripts are designed to reduce tool calls:\n  2301→\n  2302→| Without Script | With Script |\n  2303→|----------------|-------------|\n  2304→| 50 curl calls (one per endpoint) | 1 endpoint-validation.sh call |\n  2305→| 19 file reads (same file repeatedly) | 1 file-inventory.sh call |\n  2306→| 30 grep commands (CSS variables) | 1 css-audit.sh call |\n  2307→\n  2308→Target: Reduce average tool calls from 74 per iteration to <50.\n  2309→\n  2310→---\n  2311→\n  2312→## Installation\n  2313→\n  2314→### Prerequisites\n  2315→\n  2316→- Bash 4.0+\n  2317→- Claude Code CLI\n  2318→- jq\n  2319→- Git\n  2320→- timeout (coreutils)\n  2321→\n  2322→### Install\n  2323→\n  2324→```bash\n  2325→# Clone and install globally\n  2326→git clone https://github.com/krazyuniks/ralph-hybrid.git\n  2327→cd ralph-hybrid\n  2328→./install.sh                # installs to ~/.ralph-hybrid/\n  2329→```\n  2330→\n  2331→The install script:\n  2332→1. Copies files to `~/.ralph-hybrid/` (ralph, lib/, templates/, commands/)\n  2333→2. Creates default config.yaml\n  2334→\n  2335→After installation, add `~/.ralph-hybrid` to your PATH:\n  2336→\n  2337→```bash\n  2338→# Add to your shell config (e.g., ~/.zshrc, ~/.bashrc, or your dotfiles)\n  2339→export PATH=\"$HOME/.ralph-hybrid:$PATH\"\n  2340→```\n  2341→\n  2342→Then restart your shell or source your config file. The cloned repo can be deleted.\n  2343→\n  2344→### Project Setup\n  2345→\n  2346→```bash\n  2347→# In each project where you want to use Ralph:\n  2348→cd your-project\n  2349→ralph-hybrid setup                 # installs Claude commands to .claude/commands/\n  2350→```\n  2351→\n  2352→The setup command copies `/ralph-hybrid-plan` and `/ralph-hybrid-amend` to your project's `.claude/commands/` directory. This is idempotent - running it again updates the commands.\n  2353→\n  2354→### Uninstall\n  2355→\n  2356→```bash\n  2357→./uninstall.sh\n  2358→# Or manually: rm -rf ~/.ralph-hybrid and remove PATH entry\n  2359→```\n  2360→\n  2361→### Verify Installation\n  2362→\n  2363→```bash\n  2364→ralph --version\n  2365→ralph-hybrid help\n  2366→```\n  2367→\n  2368→---\n  2369→\n  2370→## Testing\n  2371→\n  2372→### Framework\n  2373→\n  2374→[BATS](https://github.com/bats-core/bats-core) (Bash Automated Testing System)\n  2375→\n  2376→### Test Structure\n  2377→\n  2378→```\n  2379→tests/\n  2380→├── unit/\n  2381→│   ├── test_circuit_breaker.bats\n  2382→│   ├── test_rate_limiter.bats\n  2383→│   ├── test_exit_detection.bats\n  2384→│   └── test_utils.bats\n  2385→└── integration/\n  2386→    └── test_loop.bats\n  2387→```\n  2388→\n  2389→### Test Cases\n  2390→\n  2391→| Component | Test |\n  2392→|-----------|------|\n  2393→| Circuit breaker | Triggers at no_progress_threshold |\n  2394→| Circuit breaker | Triggers at same_error_threshold |\n  2395→| Circuit breaker | Resets on progress |\n  2396→| Rate limiter | Pauses at limit |\n  2397→| Rate limiter | Resets after hour |\n  2398→| Exit detection | Detects completion promise |\n  2399→| Exit detection | Detects all stories complete |\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"25686664-0b51-4f27-be3c-dd742adf7b4a","tool_use_result":{"type":"text","file":{"filePath":"/home/ryan/Work/ralph-hybrid/SPEC.md","content":"---\n\n## Template Library\n\nRalph Hybrid includes a template library for skills, scripts, and hooks that can be customized per-feature. These templates are designed to reduce tool calls during execution and enforce best practices.\n\n### Template Types\n\n| Type | Purpose | Location |\n|------|---------|----------|\n| **Skills** | Claude instructions for specific patterns (migration, visual parity) | `templates/skills/` |\n| **Scripts** | Bash scripts that batch operations (reduce tool calls) | `templates/scripts/` |\n| **Hooks** | Pre/post iteration automation (visual regression, notifications) | `templates/hooks/` |\n\n### Available Templates\n\n#### Skills\n\n| Template | Use When | Description |\n|----------|----------|-------------|\n| `visual-parity-migration.md` | Migrating UI frameworks | Enforces verbatim class copying, CSS variable auditing, visual regression validation |\n| `adversarial-review.md` | Security-focused code review | Red team/blue team pattern for finding injection, auth bypass, data exposure, race conditions |\n| `code-archaeology.md` | Legacy code modification | Four-role pattern (Surveyor, Historian, Archaeologist, Careful Modifier) for safe legacy changes |\n| `incident-response.md` | Production incidents | OODA loop pattern (Observer, Mitigator, Investigator, Fixer) with speed vs thoroughness separation |\n\n#### Scripts\n\n| Template | Use When | Description |\n|----------|----------|-------------|\n| `css-audit.sh` | CSS/styling work | Audits CSS variable usage vs definitions, reports undefined variables |\n| `endpoint-validation.sh` | API/route work | Batch validates all endpoints at once, returns JSON report |\n| `file-inventory.sh` | Large features | Pre-reads relevant files by category, reduces repeated file reads |\n| `template-comparison.sh` | Framework migration | Compares source vs target class usage, reports missing classes |\n\n#### Hooks\n\n| Template | Use When | Description |\n|----------|----------|-------------|\n| `post-iteration-visual-diff.sh` | Visual parity requirements | Screenshots pages and compares against baseline, reports pixel differences |\n\n### Template Flow\n\nTemplates are copied and customized per-feature during planning:\n\n```\nralph-hybrid/templates/           ← Generic templates (this repo)\n├── skills/visual-parity-migration.md\n├── skills/adversarial-review.md\n├── skills/code-archaeology.md\n├── skills/incident-response.md\n├── scripts/css-audit.sh\n└── hooks/post-iteration-visual-diff.sh\n\n                    │ ralph-plan detects patterns\n                    ▼\n\n.ralph-hybrid/{feature}/          ← Customized per-feature\n├── skills/visual-parity-migration.md   ← Customized for project\n├── skills/adversarial-review.md        ← Security review skill\n├── skills/code-archaeology.md          ← Legacy code investigation skill\n├── skills/incident-response.md         ← Production incident handling skill\n├── scripts/css-audit.sh                ← Configured with project paths\n└── hooks/post-iteration-visual-diff.sh ← Configured with URLs\n```\n\n### Pattern Detection\n\nThe `/ralph-hybrid-plan` command detects patterns in the epic description and proposes relevant templates:\n\n| Pattern | Detection Keywords | Proposed Assets |\n|---------|-------------------|-----------------|\n| Framework Migration | migrate, convert, port, React, Jinja2 | visual-parity skill, css-audit, template-comparison |\n| Visual Parity | match styling, same look, pixel perfect | visual-parity skill, visual-diff hook |\n| API Changes | endpoint, REST, routes | endpoint-validation script |\n| Large Codebase | many files, multiple subsystems | file-inventory script |\n| Security Review | auth, login, password, security, encrypt, token, session | adversarial-review skill |\n| Legacy Code | legacy, old, refactor, migrate, ancient, technical debt, modernize | code-archaeology skill |\n| Incident Response | incident, outage, down, production, alert, emergency, urgent, critical, SEV-1, SEV-2 | incident-response skill |\n\n### Script Output Format\n\nAll scripts output JSON for easy parsing by Claude:\n\n```json\n{\n  \"audit\": \"css-variables\",\n  \"summary\": {\n    \"variables_used\": 15,\n    \"variables_defined\": 12,\n    \"variables_undefined\": 3,\n    \"status\": \"fail\"\n  },\n  \"undefined\": [\"--color-bg-surface\", \"--color-text-primary\", \"--border-hover\"]\n}\n```\n\nHuman-readable summaries are written to stderr so Claude sees the JSON on stdout.\n\n### Tool Call Reduction\n\nThe template scripts are designed to reduce tool calls:\n\n| Without Script | With Script |\n|----------------|-------------|\n| 50 curl calls (one per endpoint) | 1 endpoint-validation.sh call |\n| 19 file reads (same file repeatedly) | 1 file-inventory.sh call |\n| 30 grep commands (CSS variables) | 1 css-audit.sh call |\n\nTarget: Reduce average tool calls from 74 per iteration to <50.\n\n---\n\n## Installation\n\n### Prerequisites\n\n- Bash 4.0+\n- Claude Code CLI\n- jq\n- Git\n- timeout (coreutils)\n\n### Install\n\n```bash\n# Clone and install globally\ngit clone https://github.com/krazyuniks/ralph-hybrid.git\ncd ralph-hybrid\n./install.sh                # installs to ~/.ralph-hybrid/\n```\n\nThe install script:\n1. Copies files to `~/.ralph-hybrid/` (ralph, lib/, templates/, commands/)\n2. Creates default config.yaml\n\nAfter installation, add `~/.ralph-hybrid` to your PATH:\n\n```bash\n# Add to your shell config (e.g., ~/.zshrc, ~/.bashrc, or your dotfiles)\nexport PATH=\"$HOME/.ralph-hybrid:$PATH\"\n```\n\nThen restart your shell or source your config file. The cloned repo can be deleted.\n\n### Project Setup\n\n```bash\n# In each project where you want to use Ralph:\ncd your-project\nralph-hybrid setup                 # installs Claude commands to .claude/commands/\n```\n\nThe setup command copies `/ralph-hybrid-plan` and `/ralph-hybrid-amend` to your project's `.claude/commands/` directory. This is idempotent - running it again updates the commands.\n\n### Uninstall\n\n```bash\n./uninstall.sh\n# Or manually: rm -rf ~/.ralph-hybrid and remove PATH entry\n```\n\n### Verify Installation\n\n```bash\nralph --version\nralph-hybrid help\n```\n\n---\n\n## Testing\n\n### Framework\n\n[BATS](https://github.com/bats-core/bats-core) (Bash Automated Testing System)\n\n### Test Structure\n\n```\ntests/\n├── unit/\n│   ├── test_circuit_breaker.bats\n│   ├── test_rate_limiter.bats\n│   ├── test_exit_detection.bats\n│   └── test_utils.bats\n└── integration/\n    └── test_loop.bats\n```\n\n### Test Cases\n\n| Component | Test |\n|-----------|------|\n| Circuit breaker | Triggers at no_progress_threshold |\n| Circuit breaker | Triggers at same_error_threshold |\n| Circuit breaker | Resets on progress |\n| Rate limiter | Pauses at limit |\n| Rate limiter | Resets after hour |\n| Exit detection | Detects completion promise |\n| Exit detection | Detects all stories complete |","numLines":200,"startLine":2200,"totalLines":2525}}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_016EMHAMhLwy7y8Pn7oSY987","type":"message","role":"assistant","content":[{"type":"text","text":"I can see the structure. I need to add the integration-checker template to the skills list and the pattern detection table. Let me update the SPEC.md."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":2852,"cache_read_input_tokens":63132,"cache_creation":{"ephemeral_5m_input_tokens":2852,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"8ba2ce1b-810a-4c07-bd4e-40a408c3d91e"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_016EMHAMhLwy7y8Pn7oSY987","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01LdiLA9JC7ujbLTg9NF8mtn","name":"Edit","input":{"replace_all":false,"file_path":"/home/ryan/Work/ralph-hybrid/SPEC.md","old_string":"#### Skills\n\n| Template | Use When | Description |\n|----------|----------|-------------|\n| `visual-parity-migration.md` | Migrating UI frameworks | Enforces verbatim class copying, CSS variable auditing, visual regression validation |\n| `adversarial-review.md` | Security-focused code review | Red team/blue team pattern for finding injection, auth bypass, data exposure, race conditions |\n| `code-archaeology.md` | Legacy code modification | Four-role pattern (Surveyor, Historian, Archaeologist, Careful Modifier) for safe legacy changes |\n| `incident-response.md` | Production incidents | OODA loop pattern (Observer, Mitigator, Investigator, Fixer) with speed vs thoroughness separation |","new_string":"#### Skills\n\n| Template | Use When | Description |\n|----------|----------|-------------|\n| `visual-parity-migration.md` | Migrating UI frameworks | Enforces verbatim class copying, CSS variable auditing, visual regression validation |\n| `adversarial-review.md` | Security-focused code review | Red team/blue team pattern for finding injection, auth bypass, data exposure, race conditions |\n| `code-archaeology.md` | Legacy code modification | Four-role pattern (Surveyor, Historian, Archaeologist, Careful Modifier) for safe legacy changes |\n| `incident-response.md` | Production incidents | OODA loop pattern (Observer, Mitigator, Investigator, Fixer) with speed vs thoroughness separation |\n| `integration-checker.md` | Feature completion validation | Verifies exports used, routes have consumers, auth on sensitive routes, end-to-end flow tracing |"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":2852,"cache_read_input_tokens":63132,"cache_creation":{"ephemeral_5m_input_tokens":2852,"ephemeral_1h_input_tokens":0},"output_tokens":6,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"a20c897b-f334-409a-bf25-ba6baeae8c9f"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01LdiLA9JC7ujbLTg9NF8mtn","type":"tool_result","content":"The file /home/ryan/Work/ralph-hybrid/SPEC.md has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"1f53a26b-e777-494d-bfe6-8157a87fe00e","tool_use_result":{"filePath":"/home/ryan/Work/ralph-hybrid/SPEC.md","oldString":"#### Skills\n\n| Template | Use When | Description |\n|----------|----------|-------------|\n| `visual-parity-migration.md` | Migrating UI frameworks | Enforces verbatim class copying, CSS variable auditing, visual regression validation |\n| `adversarial-review.md` | Security-focused code review | Red team/blue team pattern for finding injection, auth bypass, data exposure, race conditions |\n| `code-archaeology.md` | Legacy code modification | Four-role pattern (Surveyor, Historian, Archaeologist, Careful Modifier) for safe legacy changes |\n| `incident-response.md` | Production incidents | OODA loop pattern (Observer, Mitigator, Investigator, Fixer) with speed vs thoroughness separation |","newString":"#### Skills\n\n| Template | Use When | Description |\n|----------|----------|-------------|\n| `visual-parity-migration.md` | Migrating UI frameworks | Enforces verbatim class copying, CSS variable auditing, visual regression validation |\n| `adversarial-review.md` | Security-focused code review | Red team/blue team pattern for finding injection, auth bypass, data exposure, race conditions |\n| `code-archaeology.md` | Legacy code modification | Four-role pattern (Surveyor, Historian, Archaeologist, Careful Modifier) for safe legacy changes |\n| `incident-response.md` | Production incidents | OODA loop pattern (Observer, Mitigator, Investigator, Fixer) with speed vs thoroughness separation |\n| `integration-checker.md` | Feature completion validation | Verifies exports used, routes have consumers, auth on sensitive routes, end-to-end flow tracing |","originalFile":"# Ralph Hybrid - Technical Specification\n\n> Implementation specification for the Ralph Hybrid autonomous development loop.\n> For background, philosophy, and rationale, see [README.md](README.md).\n\n---\n\n## Table of Contents\n\n1. [Requirements](#requirements)\n2. [Architecture](#architecture)\n3. [File Structure](#file-structure)\n4. [CLI Interface](#cli-interface)\n5. [Configuration](#configuration)\n6. [Core Loop Logic](#core-loop-logic)\n7. [File Ownership](#file-ownership)\n8. [Preflight Validation](#preflight-validation)\n9. [Planning Workflow](#planning-workflow)\n10. [Amendment System](#amendment-system)\n11. [PRD Format](#prd-format)\n12. [Spec Format](#spec-format)\n13. [Progress Tracking](#progress-tracking)\n14. [Prompt Template](#prompt-template)\n15. [Safety Mechanisms](#safety-mechanisms)\n16. [Monitoring Dashboard](#monitoring-dashboard-tmux)\n17. [Exit Conditions](#exit-conditions)\n18. [Extensibility Hooks](#extensibility-hooks)\n19. [Installation](#installation)\n20. [Testing](#testing)\n\n---\n\n## Requirements\n\n### Functional Requirements\n\n| ID | Requirement |\n|----|-------------|\n| F1 | Execute Claude Code in a loop until completion or limit reached |\n| F2 | Each iteration MUST start a fresh Claude Code session |\n| F3 | Read task state from prd.json at each iteration |\n| F4 | Read prior context from progress.txt at each iteration |\n| F5 | Detect completion via `<promise>COMPLETE</promise>` signal |\n| F5a | Detect story completion via `<promise>STORY_COMPLETE</promise>` signal |\n| F6 | Detect completion via all stories having `passes: true` |\n| F7 | Support max iterations as CLI argument |\n| F8 | Support per-iteration timeout |\n| F9 | Archive completed features with timestamp |\n| F10 | Isolate features in separate folders |\n| F11 | Support mid-implementation amendments (ADD/CORRECT/REMOVE) |\n| F12 | Preserve completed work when adding amendments |\n| F13 | Track amendment history with sequential IDs (AMD-NNN) |\n| F14 | Warn before resetting completed stories during correction |\n\n### Safety Requirements\n\n| ID | Requirement |\n|----|-------------|\n| S1 | Circuit breaker: stop after N iterations with no progress |\n| S2 | Circuit breaker: stop after N iterations with same error |\n| S3 | Rate limiting: cap API calls per hour |\n| S4 | Timeout: kill iteration if exceeds time limit |\n| S5 | API limit: detect Claude 5-hour limit and handle gracefully |\n\n### Non-Functional Requirements\n\n| ID | Requirement |\n|----|-------------|\n| N1 | Bash 4.0+ compatibility |\n| N2 | Minimal dependencies (jq, git, timeout) |\n| N3 | YAML configuration files |\n| N4 | BATS test coverage for core functions |\n\n---\n\n## Architecture\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                         ralph.sh                                │\n│                    (Main orchestrator)                          │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                 │\n│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │\n│  │   lib/      │  │   lib/      │  │   lib/                  │ │\n│  │  circuit_   │  │  rate_      │  │  exit_                  │ │\n│  │  breaker.sh │  │  limiter.sh │  │  detection.sh           │ │\n│  └─────────────┘  └─────────────┘  └─────────────────────────┘ │\n│                                                                 │\n│  ┌─────────────────────────────────────────────────────────┐   │\n│  │                    Main Loop                             │   │\n│  │  for i in 1..MAX_ITERATIONS:                            │   │\n│  │    1. Check circuit breaker                             │   │\n│  │    2. Check rate limit                                  │   │\n│  │    3. Snapshot prd.json                                 │   │\n│  │    4. Run Claude Code with timeout                      │   │\n│  │    5. Check completion signals                          │   │\n│  │    6. Detect progress                                   │   │\n│  │    7. Update circuit breaker state                      │   │\n│  └─────────────────────────────────────────────────────────┘   │\n│                                                                 │\n└─────────────────────────────────────────────────────────────────┘\n                              │\n                              ▼\n┌─────────────────────────────────────────────────────────────────┐\n│                      Claude Code                                │\n│                   (Fresh session each iteration)                │\n├─────────────────────────────────────────────────────────────────┤\n│  Reads:                                                         │\n│  ├── prompt.md (instructions)                                   │\n│  ├── prd.json (task list)                                       │\n│  ├── progress.txt (prior context)                               │\n│  └── specs/ (detailed requirements)                             │\n│                                                                 │\n│  Writes:                                                        │\n│  ├── Source code                                                │\n│  ├── Tests                                                      │\n│  ├── prd.json (updates passes field)                            │\n│  ├── progress.txt (appends learnings)                           │\n│  └── Git commits                                                │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n---\n\n## File Structure\n\n### Tool Repository\n\n```\nralph-hybrid/\n├── ralph                       # Main script (no extension)\n├── lib/\n│   ├── circuit_breaker.sh\n│   ├── rate_limiter.sh\n│   ├── exit_detection.sh\n│   ├── archive.sh\n│   ├── monitor.sh\n│   ├── preflight.sh\n│   ├── hooks.sh                # Extensibility hooks system\n│   └── utils.sh\n├── templates/\n│   ├── prompt.md\n│   ├── prompt-tdd.md\n│   ├── prd.json.example\n│   ├── config.yaml.example\n│   ├── spec.md.example\n│   ├── skills/                 # Skill templates for pattern-based generation\n│   │   └── visual-parity-migration.md\n│   ├── scripts/                # Script templates for tool call reduction\n│   │   ├── css-audit.sh\n│   │   ├── endpoint-validation.sh\n│   │   ├── file-inventory.sh\n│   │   └── template-comparison.sh\n│   └── hooks/                  # Hook templates for automation\n│       └── post-iteration-visual-diff.sh\n├── install.sh\n├── uninstall.sh\n└── config.yaml.example\n```\n\n### Per-Project Structure\n\n```\n<project>/\n└── .ralph-hybrid/\n    ├── config.yaml                         # Project settings (optional)\n    ├── <feature-name>/                     # Active feature folder\n    │   ├── prd.json                        # User stories with passes field\n    │   ├── progress.txt                    # Append-only iteration log\n    │   ├── status.json                     # Machine-readable status (for monitor)\n    │   ├── prompt.md                       # Custom prompt (optional)\n    │   ├── hooks/                          # User-defined hook scripts (optional)\n    │   │   ├── pre_run.sh\n    │   │   ├── post_run.sh\n    │   │   ├── pre_iteration.sh\n    │   │   ├── post_iteration.sh\n    │   │   ├── on_completion.sh\n    │   │   └── on_error.sh\n    │   ├── logs/                           # Iteration logs\n    │   │   └── iteration-N.log\n    │   └── specs/                          # Detailed requirements\n    │       └── *.md\n    └── archive/                            # Completed features\n        └── <timestamp>-<feature-name>/\n            ├── prd.json\n            ├── progress.txt\n            └── specs/\n```\n\n---\n\n## CLI Interface\n\n### Commands\n\n```bash\nralph-hybrid setup                     # Install Claude commands to project (.claude/commands/)\nralph-hybrid run [options]             # Execute the loop (includes preflight validation)\nralph-hybrid status                    # Show current state\nralph-hybrid monitor                   # Launch tmux monitoring dashboard\nralph-hybrid archive                   # Archive current feature\nralph-hybrid validate                  # Run preflight checks without starting loop\nralph-hybrid verify [options]          # Run goal-backward verification on current feature\nralph-hybrid debug [options] \"desc\"    # Start or continue scientific debugging session\nralph-hybrid import <file> [options]   # Import PRD from Markdown or JSON file\nralph-hybrid help                      # Show help\n```\n\n> **Note:** Run `ralph-hybrid setup` first in each project to install the `/ralph-hybrid-plan` and `/ralph-hybrid-amend` commands. The feature folder is derived from the current git branch name.\n\n### Run Options\n\n| Option | Default | Description |\n|--------|---------|-------------|\n| `-n, --max-iterations` | 20 | Maximum iterations |\n| `-t, --timeout` | 15 | Per-iteration timeout (minutes) |\n| `-r, --rate-limit` | 100 | Max API calls per hour |\n| `-p, --prompt` | default | Custom prompt file |\n| `-m, --model` | (none) | Claude model (opus, sonnet, or full name) |\n| `--profile` | balanced | Model profile (quality, balanced, budget, or custom) |\n| `-v, --verbose` | false | Detailed output |\n| `--no-archive` | false | Don't archive on completion |\n| `--dry-run` | false | Show what would happen |\n| `--monitor` | false | Launch with tmux monitoring dashboard |\n| `--skip-preflight` | false | Skip preflight validation (use with caution) |\n| `--dangerously-skip-permissions` | false | Pass to Claude Code |\n\n#### Model Selection Priority\n\nModels are selected with the following priority:\n\n1. **Story-level model** (from `prd.json` story's `model` field) - highest priority\n2. **CLI `--model` flag** - explicit model override\n3. **Profile's execution model** (from `--profile` or config) - cost optimization\n4. **Claude CLI default** - if nothing specified\n\nThis allows fine-grained control: use profiles for cost optimization, but override specific stories that need a more capable model.\n\n> **Note:** The feature folder is automatically derived from the current git branch name. No `-f` flag is needed.\n\n### Verify Options\n\n| Option | Default | Description |\n|--------|---------|-------------|\n| `--profile` | (from config) | Model profile for verification (quality, balanced, budget) |\n| `-m, --model` | (profile default) | Specific model to use (overrides profile) |\n| `-o, --output` | .ralph-hybrid/{branch}/VERIFICATION.md | Output file for verification results |\n| `-v, --verbose` | false | Enable verbose output |\n\n#### Verification Exit Codes\n\n| Exit Code | Meaning | Description |\n|-----------|---------|-------------|\n| 0 | VERIFIED | All goals achieved, no issues found |\n| 1 | NEEDS_WORK | Issues found that need to be fixed |\n| 2 | BLOCKED | Critical issues preventing feature completion |\n\n#### Verification Process\n\nThe `ralph-hybrid verify` command uses the goal-backward verification approach:\n\n1. **Goal Extraction** - Extracts concrete goals from spec.md\n2. **Deliverables Verification** - Verifies code exists, is accessible, and is integrated\n3. **Stub Detection** - Scans for placeholder implementations, TODO comments, empty functions\n4. **Wiring Verification** - Verifies components are connected (frontend→backend→database)\n5. **Human Testing Items** - Flags items requiring manual verification (UI/UX, user flows)\n\nOutput is written to VERIFICATION.md with:\n- Goals verification table\n- Deliverables check (completed and incomplete)\n- Stub detection results\n- Wiring verification status\n- Human testing checklist\n- Issue summary and recommendations\n\n### Import Options\n\n| Option | Default | Description |\n|--------|---------|-------------|\n| `--format` | auto-detect | Override format detection (markdown, json) |\n| `--output, -o` | .ralph-hybrid/{branch}/prd.json | Output path for the generated prd.json |\n\n#### Supported Import Formats\n\n| Format | Extensions | Description |\n|--------|------------|-------------|\n| Markdown | .md, .markdown | Stories as headers (### STORY-XXX) or lists (- STORY-XXX) |\n| JSON | .json | External PRD formats (userStories, stories, requirements, tasks) |\n| PDF | .pdf | Future enhancement (requires external dependencies) |\n\n#### Import Examples\n\n```bash\n# Import from Markdown spec file\nralph-hybrid import spec.md\n\n# Import from JSON with explicit output path\nralph-hybrid import requirements.json --output ./custom-prd.json\n\n# Override format detection\nralph-hybrid import my-spec.txt --format markdown\n```\n\n### Debug Options\n\n| Option | Default | Description |\n|--------|---------|-------------|\n| `--profile` | (from config) | Model profile for debugging (quality, balanced, budget) |\n| `-m, --model` | (profile default) | Specific model to use (overrides profile) |\n| `--continue` | false | Continue from previous debug state |\n| `--reset` | false | Start fresh, discarding previous debug state |\n| `-v, --verbose` | false | Enable verbose output |\n\n#### Debug Exit Codes\n\n| Exit Code | Meaning | Description |\n|-----------|---------|-------------|\n| 0 | ROOT_CAUSE_FOUND or DEBUG_COMPLETE | Root cause found or issue resolved |\n| 1 | ERROR | Error during debugging |\n| 10 | CHECKPOINT_REACHED | Progress saved, needs continuation |\n\n#### Debug Return States\n\n| State | Description |\n|-------|-------------|\n| ROOT_CAUSE_FOUND | Root cause identified with evidence; user chooses: fix now, plan solution, or handle manually |\n| DEBUG_COMPLETE | Issue fixed and verified |\n| CHECKPOINT_REACHED | Progress saved for multi-session debugging |\n\n#### Debug Process\n\nThe `ralph-hybrid debug` command uses the scientific method:\n\n1. **Gather Symptoms** - Collect observable evidence before forming hypotheses\n2. **Form Hypotheses** - Propose ranked, testable explanations (H1, H2, H3...)\n3. **Test One Variable** - Change exactly one thing per test, revert if not fixed\n4. **Collect Evidence** - Record results: CONFIRMED, RULED_OUT, INCONCLUSIVE, PARTIAL\n5. **Iterate** - Refine hypotheses based on evidence\n\nState persists in `.ralph-hybrid/{branch}/debug-state.md` across sessions, enabling:\n- Multi-session debugging for complex issues\n- Handoff between context windows\n- Progress tracking with hypotheses, evidence, and findings\n\n#### Debug Examples\n\n```bash\n# Start new debug session\nralph-hybrid debug \"tests failing after refactor\"\n\n# Continue previous debug session\nralph-hybrid debug --continue\n\n# Start fresh (discard previous state)\nralph-hybrid debug --reset \"investigate from scratch\"\n\n# Use quality profile for debugging\nralph-hybrid debug --profile quality \"complex race condition\"\n```\n\n---\n\n## Configuration\n\n### Global Config (~/.ralph-hybrid/config.yaml)\n\n```yaml\ndefaults:\n  max_iterations: 20\n  timeout_minutes: 15\n  rate_limit_per_hour: 100\n\ncircuit_breaker:\n  no_progress_threshold: 3\n  same_error_threshold: 5\n\ncompletion:\n  promise: \"<promise>COMPLETE</promise>\"\n\nclaude:\n  dangerously_skip_permissions: false\n  allowed_tools: \"Write,Bash(git *),Read\"\n```\n\n### Project Config (.ralph-hybrid/config.yaml)\n\n```yaml\ndefaults:\n  max_iterations: 30\n\nquality_checks:\n  backend: \"docker compose exec backend pytest tests/\"\n  frontend: \"docker compose exec frontend pnpm check\"\n\n# Protected branches - ralph will warn if running on these\nprotected_branches:\n  - main\n  - master\n  - develop\n```\n\n---\n\n## Core Loop Logic\n\n### Feature Detection\n\nThe feature folder is derived from the current git branch name:\n\n```bash\nget_feature_dir() {\n    local branch=$(git branch --show-current)\n\n    # Error if detached HEAD\n    [[ -z \"$branch\" ]] && error \"Not on a branch (detached HEAD)\"\n\n    # Warn if on protected branch\n    if is_protected_branch \"$branch\"; then\n        warn \"Running on protected branch '$branch'\"\n    fi\n\n    # Sanitize: feature/user-auth → feature-user-auth\n    local feature_name=\"${branch//\\//-}\"\n    echo \".ralph-hybrid/${feature_name}\"\n}\n```\n\n### Main Loop (Pseudocode)\n\n```bash\nmain() {\n    load_config\n    check_prerequisites\n\n    # Derive feature folder from branch\n    FEATURE_DIR=$(get_feature_dir)\n\n    # Preflight validation\n    run_preflight_checks || exit 1\n\n    iteration=0\n    no_progress_count=0\n    same_error_count=0\n    last_error=\"\"\n\n    while [ $iteration -lt $MAX_ITERATIONS ]; do\n        iteration=$((iteration + 1))\n\n        # Safety checks\n        check_circuit_breaker || exit 1\n        check_rate_limit || wait_for_reset\n\n        # Update status for monitor\n        update_status \"running\" \"$iteration\"\n\n        # Snapshot before\n        prd_before=$(get_passes_state)\n\n        # Run iteration\n        output=$(run_claude_with_timeout)\n\n        # Check completion\n        if contains_completion_promise \"$output\"; then\n            archive_and_exit 0\n        fi\n        if all_stories_complete; then\n            archive_and_exit 0\n        fi\n\n        # Detect progress\n        prd_after=$(get_passes_state)\n        if [ \"$prd_before\" = \"$prd_after\" ]; then\n            no_progress_count=$((no_progress_count + 1))\n        else\n            no_progress_count=0\n        fi\n\n        # Check repeated errors\n        current_error=$(extract_error \"$output\")\n        if [ \"$current_error\" = \"$last_error\" ]; then\n            same_error_count=$((same_error_count + 1))\n        else\n            same_error_count=0\n            last_error=\"$current_error\"\n        fi\n\n        sleep 2\n    done\n\n    exit 1  # Max iterations reached\n}\n```\n\n### Run Iteration\n\n```bash\nrun_claude_with_timeout() {\n    local prompt=$(build_prompt)\n\n    timeout \"${TIMEOUT_MINUTES}m\" claude \\\n        ${SKIP_PERMISSIONS:+--dangerously-skip-permissions} \\\n        -p \"$prompt\" \\\n        2>&1\n}\n\nbuild_prompt() {\n    cat <<EOF\n@${FEATURE_DIR}/prd.json\n@${FEATURE_DIR}/progress.txt\n@${FEATURE_DIR}/specs/\n\n$(cat \"${FEATURE_DIR}/prompt.md\")\nEOF\n}\n```\n\n---\n\n## File Ownership\n\nClear separation of what writes each file:\n\n| File | Written By | Read By | Purpose |\n|------|------------|---------|---------|\n| `spec.md` | `/ralph-hybrid-plan`, `/ralph-hybrid-amend` (Claude) | `/ralph-hybrid-plan --regenerate`, Claude agent | Source of truth for requirements |\n| `prd.json` | `/ralph-hybrid-plan --regenerate`, `/ralph-hybrid-amend` (Claude) | Ralph loop, Claude agent | Machine-readable task state |\n| `progress.txt` | Claude agent (appends), `/ralph-hybrid-amend` | Claude agent | Iteration history, learnings, amendments |\n| `status.json` | Ralph loop (bash) | Monitor script | Real-time loop status |\n| `logs/iteration-N.log` | Ralph loop (bash) | Monitor script, debugging | Raw Claude output per iteration |\n\n### Source of Truth Hierarchy\n\n```\nspec.md (human-readable requirements)\n    ↓\n    /ralph-hybrid-plan --regenerate generates (or /ralph-hybrid-amend updates)\n    ↓\nprd.json (machine-readable, derived)\n    ↓\n    Claude updates passes field\n    ↓\nprogress.txt (append-only history + amendment log)\n```\n\n**Important:** `spec.md` is the source of truth. For requirement changes:\n- **During planning:** Edit `spec.md` and regenerate with `/ralph-hybrid-plan --regenerate`\n- **During implementation:** Use `/ralph-hybrid-amend` to safely modify requirements\n\n---\n\n## Preflight Validation\n\nBefore starting the loop, `ralph-hybrid run` performs preflight checks. These can also be run standalone with `ralph-hybrid validate`.\n\n### Checks Performed\n\n| Check | Severity | Description |\n|-------|----------|-------------|\n| Branch detected | ERROR | Must be on a branch (not detached HEAD) |\n| Protected branch | WARN | Warn if on main/master/develop |\n| Folder exists | ERROR | `.ralph-hybrid/{branch}/` must exist |\n| Required files | ERROR | spec.md, prd.json, progress.txt must exist |\n| prd.json schema | ERROR | Valid JSON with required fields |\n| spec.md structure | WARN | Has Problem Statement, Success Criteria, Stories |\n| **Sync check** | ERROR | spec.md and prd.json must be in sync |\n\n### Sync Check\n\nThe sync check ensures `prd.json` reflects the current `spec.md`:\n\n```bash\nsync_check() {\n    # Generate temp prd.json from current spec.md\n    temp_prd=$(generate_prd_from_spec \"$FEATURE_DIR/spec.md\")\n\n    # Compare stories (ignoring passes field and notes)\n    current_stories=$(jq '[.userStories[] | {id, title, acceptanceCriteria}]' \"$FEATURE_DIR/prd.json\")\n    spec_stories=$(jq '[.userStories[] | {id, title, acceptanceCriteria}]' <<< \"$temp_prd\")\n\n    if [[ \"$current_stories\" != \"$spec_stories\" ]]; then\n        error \"spec.md and prd.json are out of sync\"\n        diff_stories \"$current_stories\" \"$spec_stories\"\n        echo \"Run '/ralph-hybrid-plan --regenerate' to regenerate prd.json from spec.md\"\n        return 1\n    fi\n}\n```\n\n### Sync Scenarios\n\n| Scenario | Detection | Severity | Resolution |\n|----------|-----------|----------|------------|\n| New story in spec.md | Story in spec not in prd | ERROR | Run `/ralph-hybrid-plan --regenerate` |\n| Acceptance criteria changed | Criteria arrays differ | ERROR | Run `/ralph-hybrid-plan --regenerate` |\n| Orphaned story (passes: false) | Story in prd not in spec | WARN | Run `/ralph-hybrid-plan --regenerate` or add to spec |\n| **Orphaned story (passes: true)** | Completed story in prd not in spec | **ERROR** | Requires explicit confirmation |\n| Only `passes` field differs | Ignored | OK | Expected (work in progress) |\n| Only `notes` field differs | Ignored | OK | Agent notes are ephemeral |\n\n### Orphaned Story Handling\n\nOrphaned stories are stories present in `prd.json` but not in `spec.md`. This usually means:\n1. Story was removed from spec.md (intentional)\n2. Story was manually added to prd.json without spec (bad practice)\n3. Merge conflict or accidental deletion\n\n**Critical:** If an orphaned story has `passes: true`, this represents **completed work that will be discarded**. This requires explicit user confirmation.\n\n```bash\norphan_check() {\n    prd_ids=$(jq -r '.userStories[].id' \"$FEATURE_DIR/prd.json\")\n    spec_ids=$(extract_story_ids \"$FEATURE_DIR/spec.md\")\n\n    for id in $prd_ids; do\n        if ! echo \"$spec_ids\" | grep -q \"^$id$\"; then\n            passes=$(jq -r \".userStories[] | select(.id==\\\"$id\\\") | .passes\" \"$FEATURE_DIR/prd.json\")\n            if [[ \"$passes\" == \"true\" ]]; then\n                error \"Orphaned COMPLETED story: $id\"\n                echo \"  This story has passes:true but is not in spec.md\"\n                echo \"  Options:\"\n                echo \"    1. Add story back to spec.md (preserve work)\"\n                echo \"    2. Run '/ralph-hybrid-plan --regenerate --confirm-orphan-removal' (discard work)\"\n                return 1\n            else\n                warn \"Orphaned story: $id (passes: false, will be removed)\"\n            fi\n        fi\n    done\n}\n```\n\n### Preflight Output\n\n```\n$ ralph-hybrid validate\n\nPreflight checks for branch: feature/user-auth\nFeature folder: .ralph-hybrid/feature-user-auth/\n\n✓ Branch detected: feature/user-auth\n✓ Folder exists: .ralph-hybrid/feature-user-auth/\n✓ Required files present\n✓ prd.json schema valid\n✓ spec.md structure valid\n✓ Sync check passed\n\nAll checks passed. Ready to run.\n```\n\n```\n$ ralph-hybrid validate\n\nPreflight checks for branch: feature/user-auth\nFeature folder: .ralph-hybrid/feature-user-auth/\n\n✓ Branch detected: feature/user-auth\n✓ Folder exists: .ralph-hybrid/feature-user-auth/\n✓ Required files present\n✓ prd.json schema valid\n⚠ spec.md missing \"Out of Scope\" section (recommended)\n✗ Sync check failed:\n    - STORY-004 in spec.md not found in prd.json\n    - STORY-002 acceptance criteria differs\n\nResolve sync issues by running '/ralph-hybrid-plan --regenerate' in Claude Code.\n```\n\n**Example: Orphaned completed story detected**\n```\n$ ralph-hybrid validate\n\nPreflight checks for branch: feature/user-auth\nFeature folder: .ralph-hybrid/feature-user-auth/\n\n✓ Branch detected: feature/user-auth\n✓ Folder exists: .ralph-hybrid/feature-user-auth/\n✓ Required files present\n✓ prd.json schema valid\n✓ spec.md structure valid\n✗ Orphan check failed:\n    - STORY-003 in prd.json (passes: true) not found in spec.md\n      ^^^ COMPLETED WORK WILL BE LOST\n\nThis story was completed but is no longer in spec.md.\nOptions:\n  1. Add STORY-003 back to spec.md (preserve completed work)\n  2. Run '/ralph-hybrid-plan --regenerate' and confirm orphan removal (discard work)\n```\n\n---\n\n## Planning Workflow\n\nRalph Hybrid provides Claude Code commands for guided feature planning. This separates **planning** (done interactively with Claude) from **execution** (done autonomously by Ralph loop).\n\n### Commands\n\n| Command | Purpose |\n|---------|---------|\n| `/ralph-hybrid-plan <description>` | Interactive planning workflow |\n| `/ralph-hybrid-plan --list-assumptions` | Surface implicit assumptions before planning |\n| `/ralph-hybrid-plan --research` | Planning with research agent investigation |\n| `/ralph-hybrid-plan --regenerate` | Generate prd.json from existing spec.md |\n| `/ralph-hybrid-plan --skip-verify` | Skip plan verification phase (not recommended) |\n\n### Workflow States\n\n```\n┌─────────────┐\n│  DISCOVER   │ ← Extract context from GitHub issue (if branch has issue #)\n└──────┬──────┘\n       │\n       ▼\n┌─────────────┐\n│  SUMMARIZE  │ ← Combine issue context + user input\n└──────┬──────┘\n       │\n       ▼ (if --list-assumptions flag)\n┌─────────────┐\n│ ASSUMPTIONS │ ← [Optional] Surface implicit assumptions in feature description\n└──────┬──────┘\n       │\n       ▼\n┌─────────────┐\n│   CLARIFY   │ ← Ask 3-5 targeted questions (fewer if issue has details)\n└──────┬──────┘\n       │\n       ▼ (if --research flag)\n┌─────────────┐\n│  RESEARCH   │ ← [Optional] Spawn research agents for topics\n└──────┬──────┘\n       │\n       ▼\n┌─────────────┐\n│   ANALYZE   │ ← Detect patterns requiring skills/scripts/hooks\n└──────┬──────┘\n       │\n       ▼\n┌─────────────┐\n│    DRAFT    │ ← Generate spec.md (with research context if available)\n└──────┬──────┘\n       │\n       ▼\n┌─────────────┐\n│  DECOMPOSE  │ ← Break into properly-sized stories\n└──────┬──────┘\n       │\n       ▼\n┌─────────────┐\n│  GENERATE   │ ← Create prd.json + progress.txt\n└──────┬──────┘\n       │\n       ▼ (unless --skip-verify)\n┌─────────────┐\n│   VERIFY    │ ← Run plan checker, revision loop for BLOCKERs\n└─────────────┘\n```\n\n### Plan Verification Phase\n\nAfter generating spec.md and prd.json, the planning workflow runs plan verification (unless `--skip-verify` is provided):\n\n**Plan Checker Agent:**\n- Uses `templates/plan-checker.md` to verify the plan across six dimensions:\n  - Coverage: Does the plan address all aspects of the stated problem?\n  - Completeness: Is each story fully specified and implementable?\n  - Dependencies: Are story ordering and dependencies correct?\n  - Links: Are references and connections valid?\n  - Scope: Is the plan appropriately scoped for iterative implementation?\n  - Verification: Is there an adequate verification approach?\n\n**Issue Classification:**\n- **BLOCKER**: Must be fixed before implementation can succeed\n- **WARNING**: Should be addressed but won't prevent basic implementation\n- **INFO**: Observations and suggestions for improvement\n\n**Verdict and Revision Loop:**\n- **READY**: Zero BLOCKERs, plan is ready for execution\n- **NEEDS_REVISION**: Fixable BLOCKERs, enters revision loop (up to 3 iterations)\n- **BLOCKED**: Significant issues requiring manual intervention\n\n**Revision Loop (up to 3 iterations):**\n1. Identify BLOCKER issues from PLAN-REVIEW.md\n2. Apply fixes to spec.md and/or prd.json\n3. Regenerate prd.json if spec.md was modified\n4. Re-run plan checker\n5. Repeat until READY or iteration limit reached\n\n**Output:**\n- `PLAN-REVIEW.md` saved to feature folder with verification results\n- Final plan status shown to user (READY/NEEDS_REVISION/BLOCKED/NOT_VERIFIED)\n\n### Assumption Lister (Optional)\n\nWhen the `--list-assumptions` flag is provided, assumptions are surfaced before planning proceeds:\n\n**Why Surface Assumptions?**\nMisaligned assumptions are a leading cause of planning failures:\n- Technical assumptions that don't match reality\n- Scope assumptions that lead to missed requirements\n- Order assumptions that create blocking dependencies\n- Risk assumptions that leave vulnerabilities unaddressed\n- Dependency assumptions that cause delays\n\n**Five Assumption Categories:**\n\n| Category | Description | Examples |\n|----------|-------------|----------|\n| Technical | Technologies, frameworks, infrastructure | \"The database supports transactions\" |\n| Order | What must happen before what | \"Users must be logged in first\" |\n| Scope | What's included or excluded | \"Mobile support isn't needed\" |\n| Risk | What could go wrong | \"The API will always respond\" |\n| Dependencies | External systems, teams, resources | \"The design team will provide mockups\" |\n\n**Confidence and Impact Levels:**\n\nEach assumption is rated for:\n- **Confidence**: HIGH (verified), MEDIUM (reasonable but unverified), LOW (uncertain)\n- **Impact**: CRITICAL (invalidates plan), HIGH (significant rework), MEDIUM (some adjustment), LOW (minor)\n\nAssumptions with HIGH impact AND (LOW or MEDIUM confidence) require validation before planning proceeds.\n\n**Assumption Lister Workflow:**\n1. Analyze feature description, GitHub issue, and clarifying answers\n2. Surface implicit assumptions across all five categories\n3. Rate each assumption for confidence and impact\n4. Present critical assumptions (high impact, low confidence) to user\n5. Guide validation of uncertain assumptions\n6. Update context and proceed to CLARIFY phase\n\n**Output:**\n- `ASSUMPTIONS.md` saved to feature folder with categorized assumptions\n- Questions to ask user derived from uncertain assumptions\n- Updated context informs CLARIFY phase questions\n\n**Output Location:**\n```\n.ralph-hybrid/{branch}/\n├── ASSUMPTIONS.md   # Assumption analysis results\n├── spec.md          # (created later, informed by assumptions)\n├── prd.json\n└── progress.txt\n```\n\n### Research Phase (Optional)\n\nWhen the `--research` flag is provided, research agents are spawned to investigate topics extracted from the description:\n\n**Topic Extraction:**\n1. Parse description, GitHub issue, and clarifying question answers\n2. Extract technical/domain terms (filtering common words)\n3. Deduplicate and limit to configurable max (default: 5 topics)\n\n**Research Agent Workflow:**\n1. Spawn parallel agents for each topic (max 3 concurrent by default)\n2. Each agent produces `RESEARCH-{topic}.md` with structured output:\n   - Summary (2-3 sentences)\n   - Key Findings (with evidence and impact)\n   - Confidence Level (HIGH/MEDIUM/LOW with criteria)\n   - Sources consulted\n   - Recommendations\n3. Synthesize findings into `RESEARCH-SUMMARY.md`\n4. Inject research context into spec generation\n\n**Research Output Location:**\n```\n.ralph-hybrid/{branch}/\n├── research/\n│   ├── RESEARCH-{topic1}.md\n│   ├── RESEARCH-{topic2}.md\n│   └── RESEARCH-SUMMARY.md\n├── spec.md          ← Uses research context\n├── prd.json\n└── progress.txt\n```\n\n**Configuration:**\n```yaml\nresearch:\n  max_topics: 5          # Max topics to research per planning session\n  max_agents: 3          # Max concurrent research agents\n  timeout: 600           # Per-agent timeout in seconds\n```\n\n### GitHub Issue Integration\n\nIf the branch name contains an issue number (e.g., `feature/42-user-auth`), the `/ralph-hybrid-plan` command will:\n\n1. **Detect** issue number from branch name patterns\n2. **Fetch** issue via `gh issue view 42 --json title,body,labels`\n3. **Extract** problem statement, acceptance criteria from issue body\n4. **Use** as starting context (reduces clarifying questions needed)\n5. **Link** spec.md back to the GitHub issue for traceability\n\nBranch patterns recognized:\n- `feature/42-description` → issue #42\n- `issue-42-description` → issue #42\n- `42-description` → issue #42\n- `fix/42-description` → issue #42\n\n### Clarifying Questions\n\nFocus on critical ambiguities:\n\n1. **Problem Definition**: \"What specific problem does this solve?\"\n2. **Scope Boundaries**: \"What should it NOT do?\" (prevents scope creep)\n3. **Success Criteria**: \"How do we know it's done?\"\n4. **Technical Constraints**: \"Any existing patterns to follow?\"\n5. **Dependencies**: \"What does this depend on?\"\n\n### Story Sizing Rule\n\n> Each story must be completable in ONE Ralph iteration (one context window).\n\n**Split indicators:**\n- Description exceeds 2-3 sentences\n- More than 6 acceptance criteria\n- Changes more than 3 files\n\n### Acceptance Criteria Format\n\n**Required for ALL stories:**\n- `Typecheck passes`\n- `Unit tests pass` (or specific test file)\n\n**For UI stories, add:**\n- `Verify in browser` or E2E test reference\n\n**Good criteria are:**\n\n| Trait | Good Example | Bad Example |\n|-------|--------------|-------------|\n| Verifiable | \"Email format is validated\" | \"Works correctly\" |\n| Measurable | \"Response time < 200ms\" | \"Is fast\" |\n| Specific | \"GET /api/users returns 200\" | \"API works\" |\n\n### Output Files\n\nAfter `/ralph-hybrid-plan` completes:\n\n```\n.ralph-hybrid/{feature}/\n├── spec.md           # Full specification (human-readable)\n├── prd.json          # Machine-readable task list\n├── progress.txt      # Empty, ready for iterations\n└── specs/            # Additional detailed specs (optional)\n```\n\n### Usage\n\n```bash\n# In Claude Code session:\n/ralph-hybrid-plan Add user authentication with JWT\n\n# Follow interactive prompts...\n\n# After planning completes:\nralph-hybrid run\n```\n\n---\n\n## Amendment System\n\nPlans evolve during implementation. Edge cases emerge. Stakeholders clarify requirements. The amendment system handles scope changes without losing progress.\n\n### Philosophy\n\n> **\"No plan survives first contact with implementation.\"**\n\nTraditional workflows force a choice between:\n- Manual prd.json edits (risky, loses context)\n- Starting over (loses progress)\n- Hoping the AI remembers verbal changes (it won't)\n\nRalph Hybrid treats scope changes as **expected, not exceptional**.\n\n### Commands\n\n| Command | Purpose |\n|---------|---------|\n| `/ralph-hybrid-amend add <description>` | Add new requirement discovered during implementation |\n| `/ralph-hybrid-amend correct <story-id> <description>` | Fix or clarify existing story |\n| `/ralph-hybrid-amend remove <story-id> <reason>` | Descope story (archived, not deleted) |\n| `/ralph-hybrid-amend status` | View amendment history and current state |\n\n### Amendment Modes\n\n#### ADD Mode\n\nAdds new requirements discovered during implementation.\n\n**Workflow:**\n```\n1. VALIDATE   - Confirm feature folder exists\n2. CLARIFY    - Mini-planning session (2-3 questions max)\n3. DEFINE     - Create acceptance criteria\n4. SIZE       - Check if story needs splitting\n5. INTEGRATE  - Update spec.md and prd.json\n6. LOG        - Record amendment in progress.txt\n7. CONFIRM    - Show summary\n```\n\n**Key behaviors:**\n- Asks focused clarifying questions (max 3)\n- Generates proper acceptance criteria\n- Assigns priority (usually after existing stories)\n- Preserves all existing `passes: true` stories\n\n#### CORRECT Mode\n\nFixes or clarifies existing story requirements.\n\n**Workflow:**\n```\n1. VALIDATE   - Confirm story exists\n2. SHOW       - Display current definition\n3. IDENTIFY   - What needs to change?\n4. WARN       - If passes: true, warn about reset\n5. UPDATE     - Modify spec.md and prd.json\n6. LOG        - Record correction in progress.txt\n7. CONFIRM    - Show diff and summary\n```\n\n**Key behaviors:**\n- Shows current story before changes\n- Warns if correcting completed (`passes: true`) story\n- Resets `passes` to `false` if story was complete (requires re-verification)\n- Logs before/after for audit trail\n\n#### REMOVE Mode\n\nDescopes a story (moves elsewhere, no longer needed, etc.).\n\n**Workflow:**\n```\n1. VALIDATE   - Confirm story exists\n2. SHOW       - Display story and status\n3. CONFIRM    - Require reason for removal\n4. ARCHIVE    - Move to Descoped section (never deleted)\n5. UPDATE     - Remove from active prd.json stories\n6. LOG        - Record removal in progress.txt\n7. CONFIRM    - Show summary\n```\n\n**Key behaviors:**\n- Stories are **never deleted** - moved to \"Descoped Stories\" section\n- Requires explicit reason\n- Warns about dependencies (if other stories depend on this one)\n- Full audit trail preserved\n\n### Amendment ID Format\n\n```\nAMD-001  # First amendment\nAMD-002  # Second amendment\nAMD-NNN  # Sequential within feature\n```\n\n**Rules:**\n- Unique per feature (not global)\n- Never reused (even if amendment is reverted)\n- Referenced in spec.md, prd.json, and progress.txt\n\n### File Updates\n\nEach amendment updates three files consistently:\n\n#### spec.md Updates\n\nAmendments are recorded in a dedicated section:\n\n```markdown\n---\n\n## Amendments\n\n### AMD-001: CSV Export (2026-01-09T14:32:00Z)\n\n**Type:** ADD\n**Reason:** User needs data export for external reporting\n**Added by:** /ralph-hybrid-amend\n\n#### STORY-004: Export data as CSV\n\n**As a** user\n**I want to** export my data as CSV\n**So that** I can analyze it in spreadsheets\n\n**Acceptance Criteria:**\n- [ ] Export button visible on data list view\n- [ ] Clicking export downloads CSV file\n- [ ] Typecheck passes\n- [ ] Unit tests pass\n\n**Priority:** 2\n\n---\n\n### AMD-002: STORY-003 Correction (2026-01-09T15:10:00Z)\n\n**Type:** CORRECT\n**Target:** STORY-003 - Validate user input\n**Reason:** Email validation was underspecified\n\n**Changes:**\n| Field | Before | After |\n|-------|--------|-------|\n| Acceptance Criteria #1 | Email field is required | Email validated against RFC 5322 |\n\n**Status Impact:** passes reset to false\n\n---\n\n## Descoped Stories\n\n### STORY-005: Advanced filtering (Removed AMD-003)\n\n**Removed:** 2026-01-09T16:00:00Z\n**Reason:** Moved to separate issue #47 for Phase 2\n**Status at removal:** passes: false\n\n**Original Definition:**\n[full story preserved here]\n```\n\n#### prd.json Updates\n\nStories include amendment metadata:\n\n```json\n{\n  \"id\": \"STORY-004\",\n  \"title\": \"Export data as CSV\",\n  \"description\": \"As a user I want to export my data as CSV...\",\n  \"acceptanceCriteria\": [\"...\"],\n  \"priority\": 2,\n  \"passes\": false,\n  \"notes\": \"\",\n  \"amendment\": {\n    \"id\": \"AMD-001\",\n    \"type\": \"add\",\n    \"timestamp\": \"2026-01-09T14:32:00Z\",\n    \"reason\": \"User needs data export for external reporting\"\n  }\n}\n```\n\nFor corrections:\n\n```json\n{\n  \"amendment\": {\n    \"id\": \"AMD-002\",\n    \"type\": \"correct\",\n    \"timestamp\": \"2026-01-09T15:10:00Z\",\n    \"reason\": \"Email validation was underspecified\",\n    \"changes\": {\n      \"acceptanceCriteria\": {\n        \"before\": [\"Email field is required\"],\n        \"after\": [\"Email validated against RFC 5322\"]\n      },\n      \"passesReset\": true\n    }\n  }\n}\n```\n\n#### progress.txt Updates\n\nAmendments are logged with full context:\n\n```\n---\n## Amendment AMD-001: 2026-01-09T14:32:00Z\n\nType: ADD\nCommand: /ralph-hybrid-amend add \"Users need CSV export for reporting\"\n\nAdded Stories:\n  - STORY-004: Export data as CSV (priority: 2)\n\nReason: User needs data export for external reporting\n\nFiles Updated:\n  - spec.md: Added Amendments section\n  - prd.json: Added STORY-004\n\nContext: Discovered during STORY-002 implementation that users\nneed to export filtered results for monthly reporting.\n\n---\n```\n\n### Edge Cases\n\n#### Adding to Completed Feature\n\n```\n/ralph-hybrid-amend add \"One more thing...\"\n\n⚠️  All stories currently pass. Adding new story will:\n  - Mark feature incomplete\n  - Require additional Ralph runs\n\nProceed? (y/N)\n```\n\n#### Correcting a Blocking Story\n\n```\n/ralph-hybrid-amend correct STORY-001 \"Change API contract\"\n\n⚠️  STORY-001 is a dependency for:\n  - STORY-002 (passes: true)\n  - STORY-003 (passes: false)\n\nCorrecting may invalidate dependent stories.\nReset all dependent stories? (y/N/select)\n```\n\n#### Removing a Story with Dependents\n\n```\n/ralph-hybrid-amend remove STORY-002 \"Not needed\"\n\n⚠️  STORY-002 blocks:\n  - STORY-003 (passes: false)\n  - STORY-004 (passes: false)\n\nOptions:\n  A) Remove STORY-002, keep dependent stories\n  B) Remove STORY-002 and all dependent stories\n  C) Cancel\n\nChoice:\n```\n\n### Integration with Ralph Loop\n\nThe prompt template acknowledges amendments:\n\n```markdown\n## Amendment Awareness\n\nWhen you see stories with `amendment` field in prd.json:\n- These were added/modified after initial planning\n- Check progress.txt for context on why\n- Amendments marked with AMD-XXX in spec.md have full details\n\nAmendments are normal. Plans evolve. Implement them like any other story.\n```\n\n### Preflight Validation\n\nThe sync check (see [Preflight Validation](#preflight-validation)) validates amendments:\n\n| Check | Severity | Description |\n|-------|----------|-------------|\n| Amendment IDs unique | ERROR | No duplicate AMD-NNN within feature |\n| Amendment referenced | WARN | Stories with `amendment` field should have matching AMD in spec.md |\n| Descoped stories archived | ERROR | Removed stories must be in Descoped section |\n\n---\n\n## PRD Format\n\n### Schema (prd.json)\n\nThe prd.json file is a **derived artifact** generated from spec.md by `/ralph-hybrid-plan --regenerate`. It provides machine-readable task state for the Ralph loop.\n\n> **Note:** The feature identifier is derived from the current git branch name. No `feature` or `branchName` fields are needed in prd.json.\n\n```json\n{\n  \"description\": \"string\",\n  \"createdAt\": \"ISO-8601\",\n  \"userStories\": [\n    {\n      \"id\": \"string\",\n      \"title\": \"string\",\n      \"description\": \"string\",\n      \"acceptanceCriteria\": [\"string\"],\n      \"priority\": \"number (1=highest)\",\n      \"passes\": \"boolean\",\n      \"notes\": \"string\",\n      \"spec_ref\": \"string (optional, path to detailed spec)\",\n      \"model\": \"string (optional, e.g., opus, sonnet, haiku)\",\n      \"mcpServers\": [\"string\"] // optional, MCP server names\n    }\n  ]\n}\n```\n\n### Field Specifications\n\n| Field | Type | Required | Description |\n|-------|------|----------|-------------|\n| `description` | string | Yes | High-level feature description |\n| `createdAt` | ISO-8601 | Yes | Creation timestamp |\n| `userStories` | array | Yes | List of stories |\n| `userStories[].id` | string | Yes | Unique identifier (e.g., STORY-001 or STORY-002.1 for inserted stories) |\n| `userStories[].title` | string | Yes | Short title |\n| `userStories[].description` | string | No | User story or description |\n| `userStories[].acceptanceCriteria` | array | Yes | Testable criteria |\n| `userStories[].priority` | number | Yes | 1 = highest |\n| `userStories[].passes` | boolean | Yes | Completion status (updated by Claude) |\n| `userStories[].notes` | string | No | Agent notes, blockers |\n| `userStories[].spec_ref` | string | No | Path to detailed spec file (e.g., \"specs/validation.spec.md\") |\n| `userStories[].model` | string | No | Claude model for this story (opus, sonnet, haiku, or full claude-* name). Overrides CLI `--model` flag. |\n| `userStories[].mcpServers` | array | No | MCP server names for this story. Empty array `[]` = no MCP. Omitted = use global config. |\n| `userStories[].amendment` | object | No | Amendment metadata (if added/modified via /ralph-hybrid-amend) |\n| `userStories[].amendment.id` | string | Yes* | Amendment ID (e.g., AMD-001) |\n| `userStories[].amendment.type` | string | Yes* | \"add\", \"correct\", or \"remove\" |\n| `userStories[].amendment.timestamp` | ISO-8601 | Yes* | When amendment was made |\n| `userStories[].amendment.reason` | string | Yes* | Why the amendment was made |\n| `userStories[].amendment.changes` | object | No | For corrections: before/after values |\n\n*Required if `amendment` object is present\n\n### Decimal Story IDs\n\nStories can have decimal IDs (e.g., `STORY-002.1`) to support insertion without renumbering:\n\n```\nSTORY-001\nSTORY-002\nSTORY-002.1   ← Inserted after STORY-002\nSTORY-002.2   ← Another insertion\nSTORY-003\n```\n\n**Key Properties:**\n- Created via `/ralph-hybrid-amend add --insert-after STORY-002`\n- Decimal parts are treated as integers: STORY-002.9 < STORY-002.10\n- Existing story numbers are never changed\n- Stories automatically sort by their numeric value\n\n**ID Format:** `STORY-NNN` or `STORY-NNN.D` where:\n- `NNN` = one or more digits (e.g., 001, 12, 123)\n- `D` = optional decimal part, one or more digits (e.g., 1, 10, 99)\n\n**Functions (lib/prd.sh):**\n- `prd_validate_story_id()` - Validates ID format\n- `prd_parse_story_id()` - Extracts numeric value\n- `prd_compare_story_ids()` - Compares two IDs (-1, 0, 1)\n- `prd_sort_stories_by_id()` - Returns sorted story array\n- `prd_insert_story_after()` - Inserts with auto-generated decimal ID\n- `prd_get_next_decimal_id()` - Gets next available decimal ID\n\n### Per-Story Model and MCP Configuration\n\nStories can optionally specify custom Claude model and MCP server configurations, allowing different stories to use different resources based on their complexity and requirements.\n\n#### Model Configuration\n\nThe `model` field overrides the CLI `--model` flag for a specific story:\n\n```json\n{\n  \"id\": \"STORY-001\",\n  \"title\": \"Complex algorithm\",\n  \"model\": \"opus\",  // Use opus for complex reasoning\n  ...\n}\n```\n\n**Precedence:** story-level `model` > CLI `--model` flag > default\n\n**Valid values:** `opus`, `sonnet`, `haiku`, or full model names like `claude-opus-4-5-20251101`\n\n#### MCP Server Configuration\n\nThe `mcpServers` field controls which MCP servers are available during story execution:\n\n| Configuration | Behavior |\n|--------------|----------|\n| Field omitted | Uses global MCP config (all enabled servers) |\n| `\"mcpServers\": []` | Explicitly disables all MCP servers |\n| `\"mcpServers\": [\"playwright\"]` | Only specified servers available |\n\nWhen `mcpServers` is specified (including empty array), Ralph uses `--strict-mcp-config` to restrict available servers.\n\n**Example configurations:**\n\n```json\n// Backend story - no MCP needed\n{\n  \"id\": \"STORY-001\",\n  \"title\": \"Create data model\",\n  \"mcpServers\": []\n}\n\n// UI testing story - only Playwright\n{\n  \"id\": \"STORY-002\",\n  \"title\": \"Write E2E tests\",\n  \"mcpServers\": [\"playwright\"]\n}\n\n// UI debugging - Chrome DevTools\n{\n  \"id\": \"STORY-003\",\n  \"title\": \"Fix console errors\",\n  \"mcpServers\": [\"chrome-devtools\"]\n}\n```\n\n**MCP server names** must match servers registered with `claude mcp add`. Preflight validation ensures all specified servers are configured.\n\n---\n\n## Spec Format\n\n### Schema (spec.md)\n\nThe spec.md file is a human-readable specification generated by `/ralph-hybrid-plan`. It serves as the source of truth for feature requirements.\n\n### Spec Files (specs/ directory)\n\nThe `specs/` directory within each feature folder provides a central location for detailed feature specifications that supplement the main `spec.md` file.\n\n#### Purpose\n\n| Use Case | Description |\n|----------|-------------|\n| Complex features | Break large features into separate, focused spec files |\n| Domain documentation | Document domain concepts, business rules, data models |\n| API contracts | Define API schemas, endpoints, request/response formats |\n| Integration specs | Document external service integrations |\n| Reusable components | Spec files can be referenced across multiple stories |\n\n#### Directory Structure\n\n```\n.ralph-hybrid/{feature-name}/\n├── spec.md                    # Main specification (required)\n├── prd.json                   # Machine-readable tasks (required)\n├── progress.txt               # Iteration log (required)\n└── specs/                     # Detailed specifications (optional)\n    ├── api-design.spec.md     # API endpoint specifications\n    ├── data-model.spec.md     # Database schema, entities\n    ├── validation.spec.md     # Input validation rules\n    └── error-handling.spec.md # Error codes, messages\n```\n\n#### Naming Conventions\n\n| Pattern | Use Case | Example |\n|---------|----------|---------|\n| `{topic}.spec.md` | General spec file | `api-design.spec.md` |\n| `{story-id}.spec.md` | Story-specific details | `STORY-003.spec.md` |\n| `{domain}.spec.md` | Domain documentation | `authentication.spec.md` |\n\n#### Spec File Structure\n\nEach spec file follows a consistent structure:\n\n```markdown\n---\ncreated: {ISO-8601}\nrelated_stories: [STORY-001, STORY-002]\n---\n\n# {Topic Title}\n\n## Overview\n\n{Brief description of what this spec covers}\n\n## Details\n\n{Detailed specifications, requirements, or documentation}\n\n## Examples\n\n{Code examples, API request/response samples, etc.}\n\n## References\n\n- Link to external documentation\n- Related spec files\n```\n\n#### Relationship to prd.json\n\nStories in `prd.json` can reference spec files via the optional `spec_ref` field:\n\n```json\n{\n  \"id\": \"STORY-003\",\n  \"title\": \"Validate user input\",\n  \"spec_ref\": \"specs/validation.spec.md\",\n  \"acceptanceCriteria\": [\"...\"],\n  \"passes\": false\n}\n```\n\nThis enables:\n- **Traceability**: Link stories to their detailed specifications\n- **Context**: Agent can read referenced spec for implementation details\n- **Organization**: Keep `spec.md` concise, details in `specs/`\n\n#### How Ralph Uses Spec Files\n\n1. **During planning** (`/ralph-hybrid-plan`): Complex requirements generate additional spec files\n2. **During implementation** (Ralph loop): Agent reads `specs/` for detailed requirements\n3. **During amendments** (`/ralph-hybrid-amend`): New specs can be created for added requirements\n\nThe prompt template instructs the agent to check `specs/` for detailed requirements:\n\n```markdown\n## Context Files\n- **specs/**: Detailed requirements and specifications\n```\n\n#### Best Practices\n\n1. **Keep spec.md high-level**: Use specs/ for implementation details\n2. **One topic per file**: Each spec file should focus on one concern\n3. **Link from stories**: Use `spec_ref` to connect stories to relevant specs\n4. **Include examples**: Code samples, API examples aid implementation\n5. **Update with amendments**: When requirements change, update relevant specs\n\n### Structure\n\n```markdown\n---\ncreated: {ISO-8601}\n---\n\n# {Feature Title}\n\n<!-- Feature folder: .ralph-hybrid/{branch-name}/ (derived from git branch) -->\n\n## Problem Statement\n{Description of the problem being solved}\n\n## Success Criteria\n- [ ] {High-level measurable outcome}\n\n## User Stories\n\n### STORY-001: {Title}\n**As a** {user type}\n**I want to** {goal}\n**So that** {benefit}\n\n**Acceptance Criteria:**\n- [ ] {Specific, testable criterion}\n- [ ] Typecheck passes\n- [ ] Unit tests pass\n\n**Technical Notes:**\n- {Implementation hints}\n\n## Out of Scope\n- {Explicitly excluded features}\n\n## Open Questions\n- {Unresolved decisions}\n\n---\n\n## Amendments\n<!-- Added by /ralph-hybrid-amend - DO NOT manually edit this section -->\n\n### AMD-001: {Title} ({ISO-8601})\n\n**Type:** ADD | CORRECT | REMOVE\n**Reason:** {Why the amendment was made}\n**Added by:** /ralph-hybrid-amend\n\n{Story definition for ADD, change table for CORRECT}\n\n---\n\n## Descoped Stories\n<!-- Stories removed via /ralph-hybrid-amend remove - preserved for audit trail -->\n\n### {STORY-ID}: {Title} (Removed {AMD-ID})\n\n**Removed:** {ISO-8601}\n**Reason:** {Why removed}\n**Status at removal:** passes: true|false\n\n**Original Definition:**\n{Full story preserved here}\n```\n\n### Frontmatter Fields\n\n| Field | Type | Required | Description |\n|-------|------|----------|-------------|\n| `created` | ISO-8601 | Yes | Creation timestamp |\n\n> **Note:** No `feature` or `branch` fields. The feature is identified by the folder path, which is derived from the current git branch (e.g., branch `feature/user-auth` → folder `.ralph-hybrid/feature-user-auth/`).\n\n### Story Format\n\nEach story follows the user story format with structured sections:\n\n| Section | Purpose |\n|---------|---------|\n| **As a / I want / So that** | User perspective and motivation |\n| **Acceptance Criteria** | Testable requirements |\n| **Technical Notes** | Implementation guidance |\n\n### Best Practices\n\n1. **Keep stories small**: One context window per story\n2. **Be specific**: Avoid vague criteria like \"works correctly\"\n3. **Include tech checks**: Always include typecheck/test criteria\n4. **Document exclusions**: \"Out of Scope\" prevents scope creep\n5. **Capture decisions**: Document resolved \"Open Questions\"\n\n---\n\n## Progress Tracking\n\n### Format (progress.txt)\n\n```\n# Progress Log: <feature-name>\n# Started: <ISO-8601>\n\n---\nIteration: <N>\nDate: <ISO-8601>\nStory: <ID> - <Title>\nStatus: complete|in-progress|blocked\nFiles Changed:\n  - <path>\nTests Added:\n  - <test_name>\nLearnings:\n  - <insight>\nCommit: <hash>\n```\n\n### Amendment Log Format\n\nAmendments are logged in progress.txt with a distinct format:\n\n```\n---\n## Amendment AMD-001: <ISO-8601>\n\nType: ADD | CORRECT | REMOVE\nCommand: /ralph-hybrid-amend <mode> \"<description>\"\n\nAdded Stories:           # For ADD\n  - <ID>: <Title> (priority: N)\n\nCorrected Story:         # For CORRECT\n  - <ID>: <Title>\n  - Changes: <summary>\n  - Status Reset: yes|no\n\nRemoved Story:           # For REMOVE\n  - <ID>: <Title>\n  - Previous Status: passes: true|false\n\nReason: <why the amendment was made>\n\nFiles Updated:\n  - spec.md: <what changed>\n  - prd.json: <what changed>\n\nContext: <additional context from the amendment session>\n\n---\n```\n\n### Purpose\n\n| Use | Description |\n|-----|-------------|\n| Agent continuity | Agent reads to understand prior work |\n| Progress detection | Compare iterations to detect stuck loops |\n| **Amendment history** | Track scope changes and their rationale |\n| Post-mortem analysis | Review iteration patterns and amendments |\n| Prompt refinement | Identify what causes many iterations |\n| **Learning data** | Amendments show where initial planning fell short |\n\n---\n\n## Prompt Template\n\n### Default TDD Template (templates/prompt-tdd.md)\n\n```markdown\n# Ralph Agent Instructions\n\nYou are an autonomous development agent working through a PRD using TDD.\n\n**CRITICAL: You must complete exactly ONE story per session, then STOP.**\nEach session starts with fresh context. Memory persists via prd.json, progress.txt, and git commits.\n\n## Context Files\n\n- **prd.json**: User stories with `passes: true/false`\n- **progress.txt**: Previous iteration log (includes amendment history)\n- **specs/**: Detailed requirements\n- **spec.md**: Full specification (includes Amendments section)\n\n## Workflow\n\n1. Read prd.json, find highest priority story where `passes: false`\n2. Read progress.txt for prior context\n3. Read specs/ for detailed requirements\n4. Implement using TDD:\n   - Write failing test\n   - Implement to pass\n   - Run quality checks\n5. If checks pass:\n   - Commit changes\n   - Set `passes: true` in prd.json\n   - Append to progress.txt\n6. Signal completion and STOP:\n   - If ALL stories pass: output `<promise>COMPLETE</promise>` and STOP\n   - If more stories remain: output `<promise>STORY_COMPLETE</promise>` and STOP\n\n## Amendment Awareness\n\nStories may have an `amendment` field in prd.json. This means they were added\nor modified after initial planning via `/ralph-hybrid-amend`.\n\nWhen you see amended stories:\n- Check progress.txt for \"## Amendment AMD-XXX\" entries explaining why\n- Check spec.md \"## Amendments\" section for full context\n- Implement them like any other story - amendments are normal\n\n**Amendments are expected.** Plans evolve during implementation. Treat amended\nstories with the same rigor as original stories.\n\n## Rules\n\n- ONE story, then STOP - Complete exactly one story, signal, and stop\n- Signal when done - Output the appropriate promise tag and stop immediately\n- Tests first - Always write failing tests before implementation\n- Never commit broken code - All checks must pass\n- Document learnings in progress.txt\n- Treat amended stories the same as original stories\n```\n\n---\n\n## Safety Mechanisms\n\n### Circuit Breaker\n\n| Trigger | Threshold | Action |\n|---------|-----------|--------|\n| No progress | 3 consecutive iterations | Exit with code 1 |\n| Same error | 5 consecutive iterations | Exit with code 1 |\n\n**Progress detection**: Compare `passes` field values in prd.json before/after iteration.\n\n### Rate Limiting\n\n| Parameter | Default | Description |\n|-----------|---------|-------------|\n| Calls per hour | 100 | Maximum API calls |\n| Reset behavior | Wait | Pause until hour resets |\n\n### Per-Iteration Timeout\n\n| Parameter | Default | Description |\n|-----------|---------|-------------|\n| Timeout | 15 min | Kill iteration if exceeded |\n| Behavior | Fail | Counts as failed iteration |\n\n### API Limit Handling\n\n| Detection | Action |\n|-----------|--------|\n| \"usage limit\" in output | Prompt user: wait or exit |\n| No response in 30s | Auto-exit |\n\n---\n\n## Monitoring Dashboard (tmux)\n\nRalph Hybrid provides an optional tmux-based monitoring dashboard for real-time visibility into loop execution. This feature is adapted from [frankbria/ralph-claude-code](https://github.com/frankbria/ralph-claude-code).\n\n### Commands\n\n| Command | Description |\n|---------|-------------|\n| `ralph-hybrid run --monitor` | Start loop with integrated tmux dashboard |\n| `ralph-hybrid monitor` | Launch standalone dashboard (attach to running loop) |\n\n### Dashboard Display\n\nThe live dashboard shows:\n\n| Metric | Description |\n|--------|-------------|\n| Loop count | Current iteration number / max iterations |\n| Status | Running, paused, completed, or failed |\n| API usage | Calls used vs. rate limit (e.g., 45/100) |\n| Rate limit countdown | Time until limit resets |\n| Recent logs | Last N log entries from current iteration |\n| Progress | Stories completed vs. total |\n\n### Layout\n\n```\n┌─────────────────────────────────┬─────────────────────────────────┐\n│                                 │                                 │\n│        RALPH LOOP               │        MONITOR                  │\n│                                 │                                 │\n│  Claude Code output             │  Iteration: 5/20                │\n│  appears here                   │  Status: Running                │\n│                                 │  API: 45/100 (resets in 23m)    │\n│                                 │  Progress: 2/6 stories          │\n│                                 │                                 │\n│                                 │  Recent:                        │\n│                                 │  [12:34] Started STORY-003      │\n│                                 │  [12:35] Running tests...       │\n│                                 │  [12:36] Tests passed           │\n│                                 │                                 │\n└─────────────────────────────────┴─────────────────────────────────┘\n```\n\n### tmux Controls\n\n| Key | Action |\n|-----|--------|\n| `Ctrl+B D` | Detach from session (loop continues in background) |\n| `Ctrl+B ←/→` | Switch between panes |\n| `tmux attach -t ralph` | Reattach to detached session |\n| `tmux list-sessions` | List all active sessions |\n\n### Implementation\n\n| File | Purpose |\n|------|---------|\n| `lib/monitor.sh` | Dashboard rendering and update logic |\n| `logs/` | Directory for iteration logs |\n| `status.json` | Machine-readable status (for programmatic access) |\n\n### Status File Format (status.json)\n\n```json\n{\n  \"iteration\": 5,\n  \"maxIterations\": 20,\n  \"status\": \"running\",\n  \"feature\": \"user-authentication\",\n  \"storiesComplete\": 2,\n  \"storiesTotal\": 6,\n  \"apiCallsUsed\": 45,\n  \"apiCallsLimit\": 100,\n  \"rateLimitResetsAt\": \"2026-01-09T13:00:00Z\",\n  \"startedAt\": \"2026-01-09T12:00:00Z\",\n  \"lastUpdated\": \"2026-01-09T12:36:00Z\"\n}\n```\n\n### Prerequisites\n\n- tmux must be installed (`brew install tmux` or `apt-get install tmux`)\n- If tmux is not available, `--monitor` flag is ignored with a warning\n\n---\n\n## Exit Conditions\n\n### Iteration Exit Conditions\n\n| Condition | Result | Description |\n|-----------|--------|-------------|\n| Story complete signal | Next iteration | Output contains `<promise>STORY_COMPLETE</promise>` - fresh context for next story |\n| All stories complete | Feature complete | All `passes: true` |\n| Completion promise | Feature complete | Output contains `<promise>COMPLETE</promise>` |\n| Timeout | Next iteration | Iteration exceeded time limit |\n| API limit | Wait or exit | Claude usage limit reached |\n\n### Loop Exit Conditions\n\n| Condition | Exit Code | Description |\n|-----------|-----------|-------------|\n| All stories complete | 0 | All `passes: true` |\n| Completion promise | 0 | Output contains `<promise>COMPLETE</promise>` |\n| Max iterations | 1 | Reached limit |\n| Circuit breaker | 1 | No progress or repeated errors |\n| User interrupt | 130 | Ctrl+C |\n| API limit (exit chosen) | 2 | Claude 5-hour limit |\n\n### Fresh Context Model\n\nRalph enforces **one story per iteration** to ensure fresh context:\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│  Iteration N                                                │\n│  ┌─────────────────────────────────────────────────────┐   │\n│  │  1. Read prd.json, progress.txt                     │   │\n│  │  2. Work on ONE story                               │   │\n│  │  3. Commit & update prd.json                        │   │\n│  │  4. Output <promise>STORY_COMPLETE</promise>        │   │\n│  │  5. STOP                                            │   │\n│  └─────────────────────────────────────────────────────┘   │\n└─────────────────────────────────────────────────────────────┘\n                              │\n                              ▼ Fresh context\n┌─────────────────────────────────────────────────────────────┐\n│  Iteration N+1                                              │\n│  ┌─────────────────────────────────────────────────────┐   │\n│  │  1. Read prd.json, progress.txt (has latest state)  │   │\n│  │  2. Work on NEXT story                              │   │\n│  │  ... (repeat)                                       │   │\n│  └─────────────────────────────────────────────────────┘   │\n└─────────────────────────────────────────────────────────────┘\n```\n\n**Why fresh context matters:**\n- Prevents context pollution from accumulated state\n- Ensures reliable, predictable execution\n- Memory persists via files (prd.json, progress.txt, git commits, memories.md)\n\n---\n\n## Memory System\n\nRalph Hybrid includes a memory system for persisting learnings across context resets. Unlike progress.txt (which logs what happened), memories capture reusable knowledge.\n\n### Memory File Format\n\nMemory files use markdown with four standard categories:\n\n```markdown\n# Memories\n\nAccumulated learnings and context for this project/feature.\n\n## Patterns\n\n<!-- Code patterns, architectural decisions, project conventions -->\n- [2024-01-15T10:30:00Z] [tags: api,rest] Use dependency injection for all service classes\n- [2024-01-16T14:00:00Z] [tags: testing] Always mock external APIs in unit tests\n\n## Decisions\n\n<!-- Why certain approaches were chosen -->\n- [2024-01-15T11:00:00Z] [tags: architecture] Chose Redux over Context for state management due to devtools support\n\n## Fixes\n\n<!-- Common issues and their solutions -->\n- [2024-01-15T16:00:00Z] [tags: auth,bug] Fixed race condition in auth flow by adding mutex lock\n\n## Context\n\n<!-- Project-specific context and domain knowledge -->\n- [2024-01-15T09:00:00Z] [tags: domain] User accounts must be verified before placing orders\n```\n\n### Memory Inheritance\n\nMemories are loaded from two levels:\n\n| Level | File Location | Purpose |\n|-------|---------------|---------|\n| Project | `.ralph-hybrid/memories.md` | Cross-feature learnings |\n| Feature | `.ralph-hybrid/{branch}/memories.md` | Feature-specific context |\n\nWhen both exist, they are combined with feature memories taking priority if token budget is limited.\n\n### Memory Functions\n\n| Function | Purpose |\n|----------|---------|\n| `load_memories(feature_dir, token_budget)` | Load combined memories within budget |\n| `write_memory(dir, category, content, tags)` | Append entry to memory file |\n| `memory_filter_by_tags(content, tags)` | Filter memories by tag |\n| `memory_load_with_tags(dir, tags, budget)` | Load and filter in one call |\n| `memory_get_for_iteration(dir, tags)` | Get formatted memories for prompt |\n\n### Tag-based Filtering\n\nMemory entries can include tags for filtering:\n\n```markdown\n- [2024-01-15T10:30:00Z] [tags: api,auth,security] Always validate JWT tokens server-side\n```\n\nFilter by tags to include only relevant memories:\n\n```bash\n# Load only auth-related memories\nmemories=$(memory_load_with_tags \"$feature_dir\" \"auth,security\" 2000)\n```\n\n### Token Budget\n\nMemories are automatically truncated to fit within the token budget:\n\n| Setting | Default | Description |\n|---------|---------|-------------|\n| `memory.token_budget` | 2000 | Max tokens (~8000 chars) for memory injection |\n\nToken calculation uses ~4 characters per token (conservative estimate).\n\n### Injection Modes\n\nConfigure how memories are injected into iteration prompts:\n\n| Mode | Description |\n|------|-------------|\n| `auto` | Automatically inject memories (default) |\n| `manual` | Only inject when explicitly requested |\n| `none` | Never inject memories |\n\nConfiguration in `config.yaml`:\n\n```yaml\nmemory:\n  token_budget: 2000\n  injection: auto  # auto, manual, or none\n```\n\nOr via environment variable:\n\n```bash\nexport RALPH_HYBRID_MEMORY_INJECTION=manual\nexport RALPH_HYBRID_MEMORY_TOKEN_BUDGET=3000\n```\n\n### Memory vs Progress\n\n| Aspect | progress.txt | memories.md |\n|--------|--------------|-------------|\n| Purpose | Log what happened | Store reusable knowledge |\n| Format | Chronological log | Categorized entries |\n| Growth | Grows each iteration | Curated, may be pruned |\n| Injection | Always included | Configurable (auto/manual/none) |\n| Tags | No | Yes |\n| Budget | No limit | Token budget enforced |\n\n### Example Usage\n\n**Writing a memory after fixing a bug:**\n\n```bash\nwrite_memory \"$FEATURE_DIR\" \"Fixes\" \"Fixed null pointer in auth by checking token existence first\" \"auth,bug\"\n```\n\n**Loading memories for a story with specific tags:**\n\n```bash\n# In iteration prompt, filtered to story-relevant tags\nmemories=$(memory_load_with_tags \"$FEATURE_DIR\" \"auth,api\" 2000)\n```\n\n---\n\n## Extensibility Hooks\n\nRalph Hybrid provides a hooks system for extending and customizing behavior at various points during execution.\n\n### Hook Points\n\n| Hook Point | When Triggered | Use Cases |\n|------------|----------------|-----------|\n| `pre_run` | Before the run loop starts | Setup, notifications, validation |\n| `post_run` | After the run loop completes | Cleanup, notifications, reporting |\n| `pre_iteration` | Before each iteration | Custom logging, rate limiting |\n| `post_iteration` | After each iteration | Progress notifications, custom metrics |\n| `on_completion` | When feature completes successfully | Deployment triggers, notifications |\n| `on_error` | When an error occurs (circuit breaker, max iterations) | Error reporting, cleanup |\n\n### Hook Directory Structure\n\n```\n<project>/\n└── .ralph-hybrid/\n    ├── <feature-name>/\n    │   └── hooks/                      # Feature-specific hooks\n    │       ├── pre_run.sh\n    │       ├── post_run.sh\n    │       ├── pre_iteration.sh\n    │       ├── post_iteration.sh\n    │       ├── on_completion.sh\n    │       └── on_error.sh\n    └── hooks/                          # Global hooks (future)\n```\n\n### Creating Hook Scripts\n\nHook scripts are bash scripts placed in the `.ralph-hybrid/<feature>/hooks/` directory. They are named after the hook point they handle.\n\n**Example: post_iteration.sh**\n\n```bash\n#!/bin/bash\n# Run after each iteration\n\necho \"Iteration $RALPH_ITERATION completed\"\n\n# Example: Send Slack notification\n# curl -X POST \"$SLACK_WEBHOOK_URL\" \\\n#   -H 'Content-Type: application/json' \\\n#   -d \"{\\\"text\\\":\\\"Iteration $RALPH_ITERATION completed for $RALPH_FEATURE_NAME\\\"}\"\n\n# Example: Run custom validation\n# ./scripts/validate.sh\n\n# Example: Log to external service\n# curl -X POST \"https://api.example.com/logs\" \\\n#   -d \"feature=$RALPH_FEATURE_NAME&iteration=$RALPH_ITERATION\"\n```\n\nMake hooks executable: `chmod +x .ralph-hybrid/<feature>/hooks/post_iteration.sh`\n\n### Environment Variables in Hooks\n\nThe following environment variables are available to hook scripts:\n\n| Variable | Description | Available In |\n|----------|-------------|--------------|\n| `RALPH_HOOK_POINT` | Current hook point being executed | All hooks |\n| `RALPH_ITERATION` | Current iteration number | `pre_iteration`, `post_iteration` |\n| `RALPH_FEATURE_DIR` | Path to feature directory | All hooks |\n| `RALPH_PRD_FILE` | Path to prd.json | All hooks |\n| `RALPH_FEATURE_NAME` | Name of the current feature | All hooks |\n| `RALPH_RUN_STATUS` | Run outcome: \"complete\", \"error\", \"user_exit\" | `post_run` |\n| `RALPH_ERROR_TYPE` | Error type: \"circuit_breaker\", \"max_iterations\" | `on_error` |\n\n### Programmatic Hook Registration\n\nHooks can also be registered programmatically in bash:\n\n```bash\n# Register a function as a hook\nmy_custom_hook() {\n    echo \"Custom hook called with iteration: $RALPH_ITERATION\"\n}\n\nsource lib/hooks.sh\nhk_register \"post_iteration\" \"my_custom_hook\"\n```\n\n### Custom Completion Patterns\n\nIn addition to the built-in completion signal (`<promise>COMPLETE</promise>`), you can define custom patterns in configuration:\n\n**In config.yaml:**\n\n```yaml\ncompletion:\n  promise: \"<promise>COMPLETE</promise>\"      # Built-in (default)\n  custom_patterns: \"DONE,FINISHED,ALL_COMPLETE\"  # Additional patterns\n```\n\n**Or via environment variable:**\n\n```bash\nexport RALPH_CUSTOM_COMPLETION_PATTERNS=\"DONE,FINISHED,ALL_COMPLETE\"\n```\n\nCustom patterns are checked in addition to the built-in pattern. All patterns require that all stories have `passes: true` for completion to be triggered.\n\n### Configuration\n\nHooks can be disabled via configuration:\n\n```yaml\nhooks:\n  enabled: true  # Set to false to disable all hooks\n```\n\nOr via environment variable:\n\n```bash\nexport RALPH_HOOKS_ENABLED=false\n```\n\n### Hook Execution Behavior\n\n1. **Isolation**: Hook scripts run in a subshell to prevent unintended side effects\n2. **Failure handling**: Hook failures are logged as warnings but do not stop the main loop\n3. **Execution order**: Registered function hooks run before directory-based hooks\n4. **Multiple hooks**: Multiple hooks can be registered for the same hook point\n\n### Use Cases\n\n| Use Case | Hook Point | Example |\n|----------|------------|---------|\n| Slack notifications | `post_iteration`, `on_completion` | Notify team of progress |\n| Custom metrics | `post_iteration` | Send to monitoring system |\n| Pre-run validation | `pre_run` | Check external dependencies |\n| Deployment triggers | `on_completion` | Trigger CI/CD pipeline |\n| Error alerting | `on_error` | Page on-call engineer |\n| Custom cleanup | `post_run` | Clean up temp files |\n\n---\n\n## Template Library\n\nRalph Hybrid includes a template library for skills, scripts, and hooks that can be customized per-feature. These templates are designed to reduce tool calls during execution and enforce best practices.\n\n### Template Types\n\n| Type | Purpose | Location |\n|------|---------|----------|\n| **Skills** | Claude instructions for specific patterns (migration, visual parity) | `templates/skills/` |\n| **Scripts** | Bash scripts that batch operations (reduce tool calls) | `templates/scripts/` |\n| **Hooks** | Pre/post iteration automation (visual regression, notifications) | `templates/hooks/` |\n\n### Available Templates\n\n#### Skills\n\n| Template | Use When | Description |\n|----------|----------|-------------|\n| `visual-parity-migration.md` | Migrating UI frameworks | Enforces verbatim class copying, CSS variable auditing, visual regression validation |\n| `adversarial-review.md` | Security-focused code review | Red team/blue team pattern for finding injection, auth bypass, data exposure, race conditions |\n| `code-archaeology.md` | Legacy code modification | Four-role pattern (Surveyor, Historian, Archaeologist, Careful Modifier) for safe legacy changes |\n| `incident-response.md` | Production incidents | OODA loop pattern (Observer, Mitigator, Investigator, Fixer) with speed vs thoroughness separation |\n\n#### Scripts\n\n| Template | Use When | Description |\n|----------|----------|-------------|\n| `css-audit.sh` | CSS/styling work | Audits CSS variable usage vs definitions, reports undefined variables |\n| `endpoint-validation.sh` | API/route work | Batch validates all endpoints at once, returns JSON report |\n| `file-inventory.sh` | Large features | Pre-reads relevant files by category, reduces repeated file reads |\n| `template-comparison.sh` | Framework migration | Compares source vs target class usage, reports missing classes |\n\n#### Hooks\n\n| Template | Use When | Description |\n|----------|----------|-------------|\n| `post-iteration-visual-diff.sh` | Visual parity requirements | Screenshots pages and compares against baseline, reports pixel differences |\n\n### Template Flow\n\nTemplates are copied and customized per-feature during planning:\n\n```\nralph-hybrid/templates/           ← Generic templates (this repo)\n├── skills/visual-parity-migration.md\n├── skills/adversarial-review.md\n├── skills/code-archaeology.md\n├── skills/incident-response.md\n├── scripts/css-audit.sh\n└── hooks/post-iteration-visual-diff.sh\n\n                    │ ralph-plan detects patterns\n                    ▼\n\n.ralph-hybrid/{feature}/          ← Customized per-feature\n├── skills/visual-parity-migration.md   ← Customized for project\n├── skills/adversarial-review.md        ← Security review skill\n├── skills/code-archaeology.md          ← Legacy code investigation skill\n├── skills/incident-response.md         ← Production incident handling skill\n├── scripts/css-audit.sh                ← Configured with project paths\n└── hooks/post-iteration-visual-diff.sh ← Configured with URLs\n```\n\n### Pattern Detection\n\nThe `/ralph-hybrid-plan` command detects patterns in the epic description and proposes relevant templates:\n\n| Pattern | Detection Keywords | Proposed Assets |\n|---------|-------------------|-----------------|\n| Framework Migration | migrate, convert, port, React, Jinja2 | visual-parity skill, css-audit, template-comparison |\n| Visual Parity | match styling, same look, pixel perfect | visual-parity skill, visual-diff hook |\n| API Changes | endpoint, REST, routes | endpoint-validation script |\n| Large Codebase | many files, multiple subsystems | file-inventory script |\n| Security Review | auth, login, password, security, encrypt, token, session | adversarial-review skill |\n| Legacy Code | legacy, old, refactor, migrate, ancient, technical debt, modernize | code-archaeology skill |\n| Incident Response | incident, outage, down, production, alert, emergency, urgent, critical, SEV-1, SEV-2 | incident-response skill |\n\n### Script Output Format\n\nAll scripts output JSON for easy parsing by Claude:\n\n```json\n{\n  \"audit\": \"css-variables\",\n  \"summary\": {\n    \"variables_used\": 15,\n    \"variables_defined\": 12,\n    \"variables_undefined\": 3,\n    \"status\": \"fail\"\n  },\n  \"undefined\": [\"--color-bg-surface\", \"--color-text-primary\", \"--border-hover\"]\n}\n```\n\nHuman-readable summaries are written to stderr so Claude sees the JSON on stdout.\n\n### Tool Call Reduction\n\nThe template scripts are designed to reduce tool calls:\n\n| Without Script | With Script |\n|----------------|-------------|\n| 50 curl calls (one per endpoint) | 1 endpoint-validation.sh call |\n| 19 file reads (same file repeatedly) | 1 file-inventory.sh call |\n| 30 grep commands (CSS variables) | 1 css-audit.sh call |\n\nTarget: Reduce average tool calls from 74 per iteration to <50.\n\n---\n\n## Installation\n\n### Prerequisites\n\n- Bash 4.0+\n- Claude Code CLI\n- jq\n- Git\n- timeout (coreutils)\n\n### Install\n\n```bash\n# Clone and install globally\ngit clone https://github.com/krazyuniks/ralph-hybrid.git\ncd ralph-hybrid\n./install.sh                # installs to ~/.ralph-hybrid/\n```\n\nThe install script:\n1. Copies files to `~/.ralph-hybrid/` (ralph, lib/, templates/, commands/)\n2. Creates default config.yaml\n\nAfter installation, add `~/.ralph-hybrid` to your PATH:\n\n```bash\n# Add to your shell config (e.g., ~/.zshrc, ~/.bashrc, or your dotfiles)\nexport PATH=\"$HOME/.ralph-hybrid:$PATH\"\n```\n\nThen restart your shell or source your config file. The cloned repo can be deleted.\n\n### Project Setup\n\n```bash\n# In each project where you want to use Ralph:\ncd your-project\nralph-hybrid setup                 # installs Claude commands to .claude/commands/\n```\n\nThe setup command copies `/ralph-hybrid-plan` and `/ralph-hybrid-amend` to your project's `.claude/commands/` directory. This is idempotent - running it again updates the commands.\n\n### Uninstall\n\n```bash\n./uninstall.sh\n# Or manually: rm -rf ~/.ralph-hybrid and remove PATH entry\n```\n\n### Verify Installation\n\n```bash\nralph --version\nralph-hybrid help\n```\n\n---\n\n## Testing\n\n### Framework\n\n[BATS](https://github.com/bats-core/bats-core) (Bash Automated Testing System)\n\n### Test Structure\n\n```\ntests/\n├── unit/\n│   ├── test_circuit_breaker.bats\n│   ├── test_rate_limiter.bats\n│   ├── test_exit_detection.bats\n│   └── test_utils.bats\n└── integration/\n    └── test_loop.bats\n```\n\n### Test Cases\n\n| Component | Test |\n|-----------|------|\n| Circuit breaker | Triggers at no_progress_threshold |\n| Circuit breaker | Triggers at same_error_threshold |\n| Circuit breaker | Resets on progress |\n| Rate limiter | Pauses at limit |\n| Rate limiter | Resets after hour |\n| Exit detection | Detects completion promise |\n| Exit detection | Detects all stories complete |\n| Progress detection | Detects passes field changes |\n| Archive | Creates timestamped directory |\n| Archive | Copies all feature files |\n| CLI | Parses all arguments correctly |\n| **Amendment** | ADD mode creates new story |\n| **Amendment** | ADD mode preserves existing passes:true stories |\n| **Amendment** | ADD mode generates sequential AMD-NNN IDs |\n| **Amendment** | CORRECT mode updates story |\n| **Amendment** | CORRECT mode warns on passes:true story |\n| **Amendment** | CORRECT mode resets passes to false |\n| **Amendment** | REMOVE mode archives to Descoped section |\n| **Amendment** | REMOVE mode never deletes story |\n| **Amendment** | STATUS mode shows amendment history |\n| **Amendment** | Updates spec.md Amendments section |\n| **Amendment** | Updates prd.json with amendment metadata |\n| **Amendment** | Logs to progress.txt |\n| **Preflight** | Validates amendment ID uniqueness |\n| **Preflight** | Validates descoped stories are archived |\n| **Hooks** | Registers hooks for valid hook points |\n| **Hooks** | Rejects registration for invalid hook points |\n| **Hooks** | Executes registered function hooks |\n| **Hooks** | Executes directory-based hook scripts |\n| **Hooks** | Handles hook failures gracefully |\n| **Hooks** | Custom completion patterns merge with built-in |\n| **Hooks** | Custom completion patterns require all stories complete |\n| **Hooks** | Hooks can be disabled via config |\n| **Hooks** | Hook environment variables are set correctly |\n\n### Running Tests\n\n```bash\n./run_tests.sh              # All tests\nbats tests/unit/            # Unit tests only\nbats tests/integration/     # Integration tests only\n```\n\n### Dependency Abstraction Layer (lib/deps.sh)\n\nThe `lib/deps.sh` module provides wrapper functions for external commands (`jq`, `date`, `git`, `claude`, `tmux`, `timeout`) that can be mocked in tests. This enables testing code paths that depend on external commands without actually invoking them.\n\n#### Available Wrappers\n\n| Function | Wraps | Mock Variable | Mock Function |\n|----------|-------|---------------|---------------|\n| `deps_jq` | `jq` | `RALPH_MOCK_JQ` | `_ralph_mock_jq` |\n| `deps_date` | `date` | `RALPH_MOCK_DATE` | `_ralph_mock_date` |\n| `deps_git` | `git` | `RALPH_MOCK_GIT` | `_ralph_mock_git` |\n| `deps_claude` | `claude` | `RALPH_MOCK_CLAUDE` | `_ralph_mock_claude` |\n| `deps_tmux` | `tmux` | `RALPH_MOCK_TMUX` | `_ralph_mock_tmux` |\n| `deps_timeout` | `timeout` | `RALPH_MOCK_TIMEOUT` | `_ralph_mock_timeout` |\n\n#### Mocking in Tests\n\n**Method 1: Mock Function Override**\n\n```bash\nsetup() {\n    source \"$PROJECT_ROOT/lib/deps.sh\"\n\n    # Enable mock\n    export RALPH_MOCK_JQ=1\n\n    # Define mock function\n    _ralph_mock_jq() {\n        case \"$1\" in\n            '.userStories | length')\n                echo \"5\"\n                ;;\n            *)\n                echo \"{}\"\n                ;;\n        esac\n    }\n}\n\nteardown() {\n    deps_reset_mocks\n}\n```\n\n**Method 2: Command Path Override**\n\n```bash\nexport RALPH_JQ_CMD=\"/path/to/mock_jq_script\"\n```\n\n#### Helper Functions\n\n| Function | Description |\n|----------|-------------|\n| `deps_check_available <cmd>` | Check if a command is available (real or mocked) |\n| `deps_check_all` | Check all required dependencies are available |\n| `deps_reset_mocks` | Reset all mock state (for test teardown) |\n| `deps_setup_simple_mock <cmd> <value>` | Set up a mock that returns a fixed value |\n\n#### Example: Testing get_feature_dir Without Git\n\n```bash\n@test \"get_feature_dir returns feature path from branch\" {\n    source \"$PROJECT_ROOT/lib/utils.sh\"\n\n    export RALPH_MOCK_GIT=1\n    _ralph_mock_git() {\n        case \"$1\" in\n            \"rev-parse\")\n                echo \".git\"\n                return 0\n                ;;\n            \"branch\")\n                echo \"feature/my-feature\"\n                ;;\n        esac\n    }\n\n    run get_feature_dir\n    [ \"$output\" = \".ralph-hybrid/feature-my-feature\" ]\n}\n```\n\n---\n\n## Version\n\n- **Spec Version**: 0.1.0\n- **Status**: Draft\n","structuredPatch":[{"oldStart":2221,"oldLines":6,"newStart":2221,"newLines":7,"lines":[" | `adversarial-review.md` | Security-focused code review | Red team/blue team pattern for finding injection, auth bypass, data exposure, race conditions |"," | `code-archaeology.md` | Legacy code modification | Four-role pattern (Surveyor, Historian, Archaeologist, Careful Modifier) for safe legacy changes |"," | `incident-response.md` | Production incidents | OODA loop pattern (Observer, Mitigator, Investigator, Fixer) with speed vs thoroughness separation |","+| `integration-checker.md` | Feature completion validation | Verifies exports used, routes have consumers, auth on sensitive routes, end-to-end flow tracing |"," "," #### Scripts"," "]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Pgo7TNp4Vjt8sLGfQ5rZAg","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the template flow diagram and pattern detection table."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":789,"cache_read_input_tokens":65984,"cache_creation":{"ephemeral_5m_input_tokens":789,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"89596127-fde8-436d-ba54-9e0848d4159b"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Pgo7TNp4Vjt8sLGfQ5rZAg","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01RfEQpU4soh7VB2zJaEFgPs","name":"Edit","input":{"replace_all":false,"file_path":"/home/ryan/Work/ralph-hybrid/SPEC.md","old_string":"ralph-hybrid/templates/           ← Generic templates (this repo)\n├── skills/visual-parity-migration.md\n├── skills/adversarial-review.md\n├── skills/code-archaeology.md\n├── skills/incident-response.md\n├── scripts/css-audit.sh\n└── hooks/post-iteration-visual-diff.sh\n\n                    │ ralph-plan detects patterns\n                    ▼\n\n.ralph-hybrid/{feature}/          ← Customized per-feature\n├── skills/visual-parity-migration.md   ← Customized for project\n├── skills/adversarial-review.md        ← Security review skill\n├── skills/code-archaeology.md          ← Legacy code investigation skill\n├── skills/incident-response.md         ← Production incident handling skill\n├── scripts/css-audit.sh                ← Configured with project paths\n└── hooks/post-iteration-visual-diff.sh ← Configured with URLs","new_string":"ralph-hybrid/templates/           ← Generic templates (this repo)\n├── skills/visual-parity-migration.md\n├── skills/adversarial-review.md\n├── skills/code-archaeology.md\n├── skills/incident-response.md\n├── skills/integration-checker.md\n├── scripts/css-audit.sh\n└── hooks/post-iteration-visual-diff.sh\n\n                    │ ralph-plan detects patterns\n                    ▼\n\n.ralph-hybrid/{feature}/          ← Customized per-feature\n├── skills/visual-parity-migration.md   ← Customized for project\n├── skills/adversarial-review.md        ← Security review skill\n├── skills/code-archaeology.md          ← Legacy code investigation skill\n├── skills/incident-response.md         ← Production incident handling skill\n├── skills/integration-checker.md       ← Feature integration validation skill\n├── scripts/css-audit.sh                ← Configured with project paths\n└── hooks/post-iteration-visual-diff.sh ← Configured with URLs"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":789,"cache_read_input_tokens":65984,"cache_creation":{"ephemeral_5m_input_tokens":789,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"05cddcfe-e149-4f13-9bab-31b74ce640fb"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01RfEQpU4soh7VB2zJaEFgPs","type":"tool_result","content":"The file /home/ryan/Work/ralph-hybrid/SPEC.md has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"0b333732-5246-476b-9e75-662b5fe18628","tool_use_result":{"filePath":"/home/ryan/Work/ralph-hybrid/SPEC.md","oldString":"ralph-hybrid/templates/           ← Generic templates (this repo)\n├── skills/visual-parity-migration.md\n├── skills/adversarial-review.md\n├── skills/code-archaeology.md\n├── skills/incident-response.md\n├── scripts/css-audit.sh\n└── hooks/post-iteration-visual-diff.sh\n\n                    │ ralph-plan detects patterns\n                    ▼\n\n.ralph-hybrid/{feature}/          ← Customized per-feature\n├── skills/visual-parity-migration.md   ← Customized for project\n├── skills/adversarial-review.md        ← Security review skill\n├── skills/code-archaeology.md          ← Legacy code investigation skill\n├── skills/incident-response.md         ← Production incident handling skill\n├── scripts/css-audit.sh                ← Configured with project paths\n└── hooks/post-iteration-visual-diff.sh ← Configured with URLs","newString":"ralph-hybrid/templates/           ← Generic templates (this repo)\n├── skills/visual-parity-migration.md\n├── skills/adversarial-review.md\n├── skills/code-archaeology.md\n├── skills/incident-response.md\n├── skills/integration-checker.md\n├── scripts/css-audit.sh\n└── hooks/post-iteration-visual-diff.sh\n\n                    │ ralph-plan detects patterns\n                    ▼\n\n.ralph-hybrid/{feature}/          ← Customized per-feature\n├── skills/visual-parity-migration.md   ← Customized for project\n├── skills/adversarial-review.md        ← Security review skill\n├── skills/code-archaeology.md          ← Legacy code investigation skill\n├── skills/incident-response.md         ← Production incident handling skill\n├── skills/integration-checker.md       ← Feature integration validation skill\n├── scripts/css-audit.sh                ← Configured with project paths\n└── hooks/post-iteration-visual-diff.sh ← Configured with URLs","originalFile":"# Ralph Hybrid - Technical Specification\n\n> Implementation specification for the Ralph Hybrid autonomous development loop.\n> For background, philosophy, and rationale, see [README.md](README.md).\n\n---\n\n## Table of Contents\n\n1. [Requirements](#requirements)\n2. [Architecture](#architecture)\n3. [File Structure](#file-structure)\n4. [CLI Interface](#cli-interface)\n5. [Configuration](#configuration)\n6. [Core Loop Logic](#core-loop-logic)\n7. [File Ownership](#file-ownership)\n8. [Preflight Validation](#preflight-validation)\n9. [Planning Workflow](#planning-workflow)\n10. [Amendment System](#amendment-system)\n11. [PRD Format](#prd-format)\n12. [Spec Format](#spec-format)\n13. [Progress Tracking](#progress-tracking)\n14. [Prompt Template](#prompt-template)\n15. [Safety Mechanisms](#safety-mechanisms)\n16. [Monitoring Dashboard](#monitoring-dashboard-tmux)\n17. [Exit Conditions](#exit-conditions)\n18. [Extensibility Hooks](#extensibility-hooks)\n19. [Installation](#installation)\n20. [Testing](#testing)\n\n---\n\n## Requirements\n\n### Functional Requirements\n\n| ID | Requirement |\n|----|-------------|\n| F1 | Execute Claude Code in a loop until completion or limit reached |\n| F2 | Each iteration MUST start a fresh Claude Code session |\n| F3 | Read task state from prd.json at each iteration |\n| F4 | Read prior context from progress.txt at each iteration |\n| F5 | Detect completion via `<promise>COMPLETE</promise>` signal |\n| F5a | Detect story completion via `<promise>STORY_COMPLETE</promise>` signal |\n| F6 | Detect completion via all stories having `passes: true` |\n| F7 | Support max iterations as CLI argument |\n| F8 | Support per-iteration timeout |\n| F9 | Archive completed features with timestamp |\n| F10 | Isolate features in separate folders |\n| F11 | Support mid-implementation amendments (ADD/CORRECT/REMOVE) |\n| F12 | Preserve completed work when adding amendments |\n| F13 | Track amendment history with sequential IDs (AMD-NNN) |\n| F14 | Warn before resetting completed stories during correction |\n\n### Safety Requirements\n\n| ID | Requirement |\n|----|-------------|\n| S1 | Circuit breaker: stop after N iterations with no progress |\n| S2 | Circuit breaker: stop after N iterations with same error |\n| S3 | Rate limiting: cap API calls per hour |\n| S4 | Timeout: kill iteration if exceeds time limit |\n| S5 | API limit: detect Claude 5-hour limit and handle gracefully |\n\n### Non-Functional Requirements\n\n| ID | Requirement |\n|----|-------------|\n| N1 | Bash 4.0+ compatibility |\n| N2 | Minimal dependencies (jq, git, timeout) |\n| N3 | YAML configuration files |\n| N4 | BATS test coverage for core functions |\n\n---\n\n## Architecture\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                         ralph.sh                                │\n│                    (Main orchestrator)                          │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                 │\n│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │\n│  │   lib/      │  │   lib/      │  │   lib/                  │ │\n│  │  circuit_   │  │  rate_      │  │  exit_                  │ │\n│  │  breaker.sh │  │  limiter.sh │  │  detection.sh           │ │\n│  └─────────────┘  └─────────────┘  └─────────────────────────┘ │\n│                                                                 │\n│  ┌─────────────────────────────────────────────────────────┐   │\n│  │                    Main Loop                             │   │\n│  │  for i in 1..MAX_ITERATIONS:                            │   │\n│  │    1. Check circuit breaker                             │   │\n│  │    2. Check rate limit                                  │   │\n│  │    3. Snapshot prd.json                                 │   │\n│  │    4. Run Claude Code with timeout                      │   │\n│  │    5. Check completion signals                          │   │\n│  │    6. Detect progress                                   │   │\n│  │    7. Update circuit breaker state                      │   │\n│  └─────────────────────────────────────────────────────────┘   │\n│                                                                 │\n└─────────────────────────────────────────────────────────────────┘\n                              │\n                              ▼\n┌─────────────────────────────────────────────────────────────────┐\n│                      Claude Code                                │\n│                   (Fresh session each iteration)                │\n├─────────────────────────────────────────────────────────────────┤\n│  Reads:                                                         │\n│  ├── prompt.md (instructions)                                   │\n│  ├── prd.json (task list)                                       │\n│  ├── progress.txt (prior context)                               │\n│  └── specs/ (detailed requirements)                             │\n│                                                                 │\n│  Writes:                                                        │\n│  ├── Source code                                                │\n│  ├── Tests                                                      │\n│  ├── prd.json (updates passes field)                            │\n│  ├── progress.txt (appends learnings)                           │\n│  └── Git commits                                                │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n---\n\n## File Structure\n\n### Tool Repository\n\n```\nralph-hybrid/\n├── ralph                       # Main script (no extension)\n├── lib/\n│   ├── circuit_breaker.sh\n│   ├── rate_limiter.sh\n│   ├── exit_detection.sh\n│   ├── archive.sh\n│   ├── monitor.sh\n│   ├── preflight.sh\n│   ├── hooks.sh                # Extensibility hooks system\n│   └── utils.sh\n├── templates/\n│   ├── prompt.md\n│   ├── prompt-tdd.md\n│   ├── prd.json.example\n│   ├── config.yaml.example\n│   ├── spec.md.example\n│   ├── skills/                 # Skill templates for pattern-based generation\n│   │   └── visual-parity-migration.md\n│   ├── scripts/                # Script templates for tool call reduction\n│   │   ├── css-audit.sh\n│   │   ├── endpoint-validation.sh\n│   │   ├── file-inventory.sh\n│   │   └── template-comparison.sh\n│   └── hooks/                  # Hook templates for automation\n│       └── post-iteration-visual-diff.sh\n├── install.sh\n├── uninstall.sh\n└── config.yaml.example\n```\n\n### Per-Project Structure\n\n```\n<project>/\n└── .ralph-hybrid/\n    ├── config.yaml                         # Project settings (optional)\n    ├── <feature-name>/                     # Active feature folder\n    │   ├── prd.json                        # User stories with passes field\n    │   ├── progress.txt                    # Append-only iteration log\n    │   ├── status.json                     # Machine-readable status (for monitor)\n    │   ├── prompt.md                       # Custom prompt (optional)\n    │   ├── hooks/                          # User-defined hook scripts (optional)\n    │   │   ├── pre_run.sh\n    │   │   ├── post_run.sh\n    │   │   ├── pre_iteration.sh\n    │   │   ├── post_iteration.sh\n    │   │   ├── on_completion.sh\n    │   │   └── on_error.sh\n    │   ├── logs/                           # Iteration logs\n    │   │   └── iteration-N.log\n    │   └── specs/                          # Detailed requirements\n    │       └── *.md\n    └── archive/                            # Completed features\n        └── <timestamp>-<feature-name>/\n            ├── prd.json\n            ├── progress.txt\n            └── specs/\n```\n\n---\n\n## CLI Interface\n\n### Commands\n\n```bash\nralph-hybrid setup                     # Install Claude commands to project (.claude/commands/)\nralph-hybrid run [options]             # Execute the loop (includes preflight validation)\nralph-hybrid status                    # Show current state\nralph-hybrid monitor                   # Launch tmux monitoring dashboard\nralph-hybrid archive                   # Archive current feature\nralph-hybrid validate                  # Run preflight checks without starting loop\nralph-hybrid verify [options]          # Run goal-backward verification on current feature\nralph-hybrid debug [options] \"desc\"    # Start or continue scientific debugging session\nralph-hybrid import <file> [options]   # Import PRD from Markdown or JSON file\nralph-hybrid help                      # Show help\n```\n\n> **Note:** Run `ralph-hybrid setup` first in each project to install the `/ralph-hybrid-plan` and `/ralph-hybrid-amend` commands. The feature folder is derived from the current git branch name.\n\n### Run Options\n\n| Option | Default | Description |\n|--------|---------|-------------|\n| `-n, --max-iterations` | 20 | Maximum iterations |\n| `-t, --timeout` | 15 | Per-iteration timeout (minutes) |\n| `-r, --rate-limit` | 100 | Max API calls per hour |\n| `-p, --prompt` | default | Custom prompt file |\n| `-m, --model` | (none) | Claude model (opus, sonnet, or full name) |\n| `--profile` | balanced | Model profile (quality, balanced, budget, or custom) |\n| `-v, --verbose` | false | Detailed output |\n| `--no-archive` | false | Don't archive on completion |\n| `--dry-run` | false | Show what would happen |\n| `--monitor` | false | Launch with tmux monitoring dashboard |\n| `--skip-preflight` | false | Skip preflight validation (use with caution) |\n| `--dangerously-skip-permissions` | false | Pass to Claude Code |\n\n#### Model Selection Priority\n\nModels are selected with the following priority:\n\n1. **Story-level model** (from `prd.json` story's `model` field) - highest priority\n2. **CLI `--model` flag** - explicit model override\n3. **Profile's execution model** (from `--profile` or config) - cost optimization\n4. **Claude CLI default** - if nothing specified\n\nThis allows fine-grained control: use profiles for cost optimization, but override specific stories that need a more capable model.\n\n> **Note:** The feature folder is automatically derived from the current git branch name. No `-f` flag is needed.\n\n### Verify Options\n\n| Option | Default | Description |\n|--------|---------|-------------|\n| `--profile` | (from config) | Model profile for verification (quality, balanced, budget) |\n| `-m, --model` | (profile default) | Specific model to use (overrides profile) |\n| `-o, --output` | .ralph-hybrid/{branch}/VERIFICATION.md | Output file for verification results |\n| `-v, --verbose` | false | Enable verbose output |\n\n#### Verification Exit Codes\n\n| Exit Code | Meaning | Description |\n|-----------|---------|-------------|\n| 0 | VERIFIED | All goals achieved, no issues found |\n| 1 | NEEDS_WORK | Issues found that need to be fixed |\n| 2 | BLOCKED | Critical issues preventing feature completion |\n\n#### Verification Process\n\nThe `ralph-hybrid verify` command uses the goal-backward verification approach:\n\n1. **Goal Extraction** - Extracts concrete goals from spec.md\n2. **Deliverables Verification** - Verifies code exists, is accessible, and is integrated\n3. **Stub Detection** - Scans for placeholder implementations, TODO comments, empty functions\n4. **Wiring Verification** - Verifies components are connected (frontend→backend→database)\n5. **Human Testing Items** - Flags items requiring manual verification (UI/UX, user flows)\n\nOutput is written to VERIFICATION.md with:\n- Goals verification table\n- Deliverables check (completed and incomplete)\n- Stub detection results\n- Wiring verification status\n- Human testing checklist\n- Issue summary and recommendations\n\n### Import Options\n\n| Option | Default | Description |\n|--------|---------|-------------|\n| `--format` | auto-detect | Override format detection (markdown, json) |\n| `--output, -o` | .ralph-hybrid/{branch}/prd.json | Output path for the generated prd.json |\n\n#### Supported Import Formats\n\n| Format | Extensions | Description |\n|--------|------------|-------------|\n| Markdown | .md, .markdown | Stories as headers (### STORY-XXX) or lists (- STORY-XXX) |\n| JSON | .json | External PRD formats (userStories, stories, requirements, tasks) |\n| PDF | .pdf | Future enhancement (requires external dependencies) |\n\n#### Import Examples\n\n```bash\n# Import from Markdown spec file\nralph-hybrid import spec.md\n\n# Import from JSON with explicit output path\nralph-hybrid import requirements.json --output ./custom-prd.json\n\n# Override format detection\nralph-hybrid import my-spec.txt --format markdown\n```\n\n### Debug Options\n\n| Option | Default | Description |\n|--------|---------|-------------|\n| `--profile` | (from config) | Model profile for debugging (quality, balanced, budget) |\n| `-m, --model` | (profile default) | Specific model to use (overrides profile) |\n| `--continue` | false | Continue from previous debug state |\n| `--reset` | false | Start fresh, discarding previous debug state |\n| `-v, --verbose` | false | Enable verbose output |\n\n#### Debug Exit Codes\n\n| Exit Code | Meaning | Description |\n|-----------|---------|-------------|\n| 0 | ROOT_CAUSE_FOUND or DEBUG_COMPLETE | Root cause found or issue resolved |\n| 1 | ERROR | Error during debugging |\n| 10 | CHECKPOINT_REACHED | Progress saved, needs continuation |\n\n#### Debug Return States\n\n| State | Description |\n|-------|-------------|\n| ROOT_CAUSE_FOUND | Root cause identified with evidence; user chooses: fix now, plan solution, or handle manually |\n| DEBUG_COMPLETE | Issue fixed and verified |\n| CHECKPOINT_REACHED | Progress saved for multi-session debugging |\n\n#### Debug Process\n\nThe `ralph-hybrid debug` command uses the scientific method:\n\n1. **Gather Symptoms** - Collect observable evidence before forming hypotheses\n2. **Form Hypotheses** - Propose ranked, testable explanations (H1, H2, H3...)\n3. **Test One Variable** - Change exactly one thing per test, revert if not fixed\n4. **Collect Evidence** - Record results: CONFIRMED, RULED_OUT, INCONCLUSIVE, PARTIAL\n5. **Iterate** - Refine hypotheses based on evidence\n\nState persists in `.ralph-hybrid/{branch}/debug-state.md` across sessions, enabling:\n- Multi-session debugging for complex issues\n- Handoff between context windows\n- Progress tracking with hypotheses, evidence, and findings\n\n#### Debug Examples\n\n```bash\n# Start new debug session\nralph-hybrid debug \"tests failing after refactor\"\n\n# Continue previous debug session\nralph-hybrid debug --continue\n\n# Start fresh (discard previous state)\nralph-hybrid debug --reset \"investigate from scratch\"\n\n# Use quality profile for debugging\nralph-hybrid debug --profile quality \"complex race condition\"\n```\n\n---\n\n## Configuration\n\n### Global Config (~/.ralph-hybrid/config.yaml)\n\n```yaml\ndefaults:\n  max_iterations: 20\n  timeout_minutes: 15\n  rate_limit_per_hour: 100\n\ncircuit_breaker:\n  no_progress_threshold: 3\n  same_error_threshold: 5\n\ncompletion:\n  promise: \"<promise>COMPLETE</promise>\"\n\nclaude:\n  dangerously_skip_permissions: false\n  allowed_tools: \"Write,Bash(git *),Read\"\n```\n\n### Project Config (.ralph-hybrid/config.yaml)\n\n```yaml\ndefaults:\n  max_iterations: 30\n\nquality_checks:\n  backend: \"docker compose exec backend pytest tests/\"\n  frontend: \"docker compose exec frontend pnpm check\"\n\n# Protected branches - ralph will warn if running on these\nprotected_branches:\n  - main\n  - master\n  - develop\n```\n\n---\n\n## Core Loop Logic\n\n### Feature Detection\n\nThe feature folder is derived from the current git branch name:\n\n```bash\nget_feature_dir() {\n    local branch=$(git branch --show-current)\n\n    # Error if detached HEAD\n    [[ -z \"$branch\" ]] && error \"Not on a branch (detached HEAD)\"\n\n    # Warn if on protected branch\n    if is_protected_branch \"$branch\"; then\n        warn \"Running on protected branch '$branch'\"\n    fi\n\n    # Sanitize: feature/user-auth → feature-user-auth\n    local feature_name=\"${branch//\\//-}\"\n    echo \".ralph-hybrid/${feature_name}\"\n}\n```\n\n### Main Loop (Pseudocode)\n\n```bash\nmain() {\n    load_config\n    check_prerequisites\n\n    # Derive feature folder from branch\n    FEATURE_DIR=$(get_feature_dir)\n\n    # Preflight validation\n    run_preflight_checks || exit 1\n\n    iteration=0\n    no_progress_count=0\n    same_error_count=0\n    last_error=\"\"\n\n    while [ $iteration -lt $MAX_ITERATIONS ]; do\n        iteration=$((iteration + 1))\n\n        # Safety checks\n        check_circuit_breaker || exit 1\n        check_rate_limit || wait_for_reset\n\n        # Update status for monitor\n        update_status \"running\" \"$iteration\"\n\n        # Snapshot before\n        prd_before=$(get_passes_state)\n\n        # Run iteration\n        output=$(run_claude_with_timeout)\n\n        # Check completion\n        if contains_completion_promise \"$output\"; then\n            archive_and_exit 0\n        fi\n        if all_stories_complete; then\n            archive_and_exit 0\n        fi\n\n        # Detect progress\n        prd_after=$(get_passes_state)\n        if [ \"$prd_before\" = \"$prd_after\" ]; then\n            no_progress_count=$((no_progress_count + 1))\n        else\n            no_progress_count=0\n        fi\n\n        # Check repeated errors\n        current_error=$(extract_error \"$output\")\n        if [ \"$current_error\" = \"$last_error\" ]; then\n            same_error_count=$((same_error_count + 1))\n        else\n            same_error_count=0\n            last_error=\"$current_error\"\n        fi\n\n        sleep 2\n    done\n\n    exit 1  # Max iterations reached\n}\n```\n\n### Run Iteration\n\n```bash\nrun_claude_with_timeout() {\n    local prompt=$(build_prompt)\n\n    timeout \"${TIMEOUT_MINUTES}m\" claude \\\n        ${SKIP_PERMISSIONS:+--dangerously-skip-permissions} \\\n        -p \"$prompt\" \\\n        2>&1\n}\n\nbuild_prompt() {\n    cat <<EOF\n@${FEATURE_DIR}/prd.json\n@${FEATURE_DIR}/progress.txt\n@${FEATURE_DIR}/specs/\n\n$(cat \"${FEATURE_DIR}/prompt.md\")\nEOF\n}\n```\n\n---\n\n## File Ownership\n\nClear separation of what writes each file:\n\n| File | Written By | Read By | Purpose |\n|------|------------|---------|---------|\n| `spec.md` | `/ralph-hybrid-plan`, `/ralph-hybrid-amend` (Claude) | `/ralph-hybrid-plan --regenerate`, Claude agent | Source of truth for requirements |\n| `prd.json` | `/ralph-hybrid-plan --regenerate`, `/ralph-hybrid-amend` (Claude) | Ralph loop, Claude agent | Machine-readable task state |\n| `progress.txt` | Claude agent (appends), `/ralph-hybrid-amend` | Claude agent | Iteration history, learnings, amendments |\n| `status.json` | Ralph loop (bash) | Monitor script | Real-time loop status |\n| `logs/iteration-N.log` | Ralph loop (bash) | Monitor script, debugging | Raw Claude output per iteration |\n\n### Source of Truth Hierarchy\n\n```\nspec.md (human-readable requirements)\n    ↓\n    /ralph-hybrid-plan --regenerate generates (or /ralph-hybrid-amend updates)\n    ↓\nprd.json (machine-readable, derived)\n    ↓\n    Claude updates passes field\n    ↓\nprogress.txt (append-only history + amendment log)\n```\n\n**Important:** `spec.md` is the source of truth. For requirement changes:\n- **During planning:** Edit `spec.md` and regenerate with `/ralph-hybrid-plan --regenerate`\n- **During implementation:** Use `/ralph-hybrid-amend` to safely modify requirements\n\n---\n\n## Preflight Validation\n\nBefore starting the loop, `ralph-hybrid run` performs preflight checks. These can also be run standalone with `ralph-hybrid validate`.\n\n### Checks Performed\n\n| Check | Severity | Description |\n|-------|----------|-------------|\n| Branch detected | ERROR | Must be on a branch (not detached HEAD) |\n| Protected branch | WARN | Warn if on main/master/develop |\n| Folder exists | ERROR | `.ralph-hybrid/{branch}/` must exist |\n| Required files | ERROR | spec.md, prd.json, progress.txt must exist |\n| prd.json schema | ERROR | Valid JSON with required fields |\n| spec.md structure | WARN | Has Problem Statement, Success Criteria, Stories |\n| **Sync check** | ERROR | spec.md and prd.json must be in sync |\n\n### Sync Check\n\nThe sync check ensures `prd.json` reflects the current `spec.md`:\n\n```bash\nsync_check() {\n    # Generate temp prd.json from current spec.md\n    temp_prd=$(generate_prd_from_spec \"$FEATURE_DIR/spec.md\")\n\n    # Compare stories (ignoring passes field and notes)\n    current_stories=$(jq '[.userStories[] | {id, title, acceptanceCriteria}]' \"$FEATURE_DIR/prd.json\")\n    spec_stories=$(jq '[.userStories[] | {id, title, acceptanceCriteria}]' <<< \"$temp_prd\")\n\n    if [[ \"$current_stories\" != \"$spec_stories\" ]]; then\n        error \"spec.md and prd.json are out of sync\"\n        diff_stories \"$current_stories\" \"$spec_stories\"\n        echo \"Run '/ralph-hybrid-plan --regenerate' to regenerate prd.json from spec.md\"\n        return 1\n    fi\n}\n```\n\n### Sync Scenarios\n\n| Scenario | Detection | Severity | Resolution |\n|----------|-----------|----------|------------|\n| New story in spec.md | Story in spec not in prd | ERROR | Run `/ralph-hybrid-plan --regenerate` |\n| Acceptance criteria changed | Criteria arrays differ | ERROR | Run `/ralph-hybrid-plan --regenerate` |\n| Orphaned story (passes: false) | Story in prd not in spec | WARN | Run `/ralph-hybrid-plan --regenerate` or add to spec |\n| **Orphaned story (passes: true)** | Completed story in prd not in spec | **ERROR** | Requires explicit confirmation |\n| Only `passes` field differs | Ignored | OK | Expected (work in progress) |\n| Only `notes` field differs | Ignored | OK | Agent notes are ephemeral |\n\n### Orphaned Story Handling\n\nOrphaned stories are stories present in `prd.json` but not in `spec.md`. This usually means:\n1. Story was removed from spec.md (intentional)\n2. Story was manually added to prd.json without spec (bad practice)\n3. Merge conflict or accidental deletion\n\n**Critical:** If an orphaned story has `passes: true`, this represents **completed work that will be discarded**. This requires explicit user confirmation.\n\n```bash\norphan_check() {\n    prd_ids=$(jq -r '.userStories[].id' \"$FEATURE_DIR/prd.json\")\n    spec_ids=$(extract_story_ids \"$FEATURE_DIR/spec.md\")\n\n    for id in $prd_ids; do\n        if ! echo \"$spec_ids\" | grep -q \"^$id$\"; then\n            passes=$(jq -r \".userStories[] | select(.id==\\\"$id\\\") | .passes\" \"$FEATURE_DIR/prd.json\")\n            if [[ \"$passes\" == \"true\" ]]; then\n                error \"Orphaned COMPLETED story: $id\"\n                echo \"  This story has passes:true but is not in spec.md\"\n                echo \"  Options:\"\n                echo \"    1. Add story back to spec.md (preserve work)\"\n                echo \"    2. Run '/ralph-hybrid-plan --regenerate --confirm-orphan-removal' (discard work)\"\n                return 1\n            else\n                warn \"Orphaned story: $id (passes: false, will be removed)\"\n            fi\n        fi\n    done\n}\n```\n\n### Preflight Output\n\n```\n$ ralph-hybrid validate\n\nPreflight checks for branch: feature/user-auth\nFeature folder: .ralph-hybrid/feature-user-auth/\n\n✓ Branch detected: feature/user-auth\n✓ Folder exists: .ralph-hybrid/feature-user-auth/\n✓ Required files present\n✓ prd.json schema valid\n✓ spec.md structure valid\n✓ Sync check passed\n\nAll checks passed. Ready to run.\n```\n\n```\n$ ralph-hybrid validate\n\nPreflight checks for branch: feature/user-auth\nFeature folder: .ralph-hybrid/feature-user-auth/\n\n✓ Branch detected: feature/user-auth\n✓ Folder exists: .ralph-hybrid/feature-user-auth/\n✓ Required files present\n✓ prd.json schema valid\n⚠ spec.md missing \"Out of Scope\" section (recommended)\n✗ Sync check failed:\n    - STORY-004 in spec.md not found in prd.json\n    - STORY-002 acceptance criteria differs\n\nResolve sync issues by running '/ralph-hybrid-plan --regenerate' in Claude Code.\n```\n\n**Example: Orphaned completed story detected**\n```\n$ ralph-hybrid validate\n\nPreflight checks for branch: feature/user-auth\nFeature folder: .ralph-hybrid/feature-user-auth/\n\n✓ Branch detected: feature/user-auth\n✓ Folder exists: .ralph-hybrid/feature-user-auth/\n✓ Required files present\n✓ prd.json schema valid\n✓ spec.md structure valid\n✗ Orphan check failed:\n    - STORY-003 in prd.json (passes: true) not found in spec.md\n      ^^^ COMPLETED WORK WILL BE LOST\n\nThis story was completed but is no longer in spec.md.\nOptions:\n  1. Add STORY-003 back to spec.md (preserve completed work)\n  2. Run '/ralph-hybrid-plan --regenerate' and confirm orphan removal (discard work)\n```\n\n---\n\n## Planning Workflow\n\nRalph Hybrid provides Claude Code commands for guided feature planning. This separates **planning** (done interactively with Claude) from **execution** (done autonomously by Ralph loop).\n\n### Commands\n\n| Command | Purpose |\n|---------|---------|\n| `/ralph-hybrid-plan <description>` | Interactive planning workflow |\n| `/ralph-hybrid-plan --list-assumptions` | Surface implicit assumptions before planning |\n| `/ralph-hybrid-plan --research` | Planning with research agent investigation |\n| `/ralph-hybrid-plan --regenerate` | Generate prd.json from existing spec.md |\n| `/ralph-hybrid-plan --skip-verify` | Skip plan verification phase (not recommended) |\n\n### Workflow States\n\n```\n┌─────────────┐\n│  DISCOVER   │ ← Extract context from GitHub issue (if branch has issue #)\n└──────┬──────┘\n       │\n       ▼\n┌─────────────┐\n│  SUMMARIZE  │ ← Combine issue context + user input\n└──────┬──────┘\n       │\n       ▼ (if --list-assumptions flag)\n┌─────────────┐\n│ ASSUMPTIONS │ ← [Optional] Surface implicit assumptions in feature description\n└──────┬──────┘\n       │\n       ▼\n┌─────────────┐\n│   CLARIFY   │ ← Ask 3-5 targeted questions (fewer if issue has details)\n└──────┬──────┘\n       │\n       ▼ (if --research flag)\n┌─────────────┐\n│  RESEARCH   │ ← [Optional] Spawn research agents for topics\n└──────┬──────┘\n       │\n       ▼\n┌─────────────┐\n│   ANALYZE   │ ← Detect patterns requiring skills/scripts/hooks\n└──────┬──────┘\n       │\n       ▼\n┌─────────────┐\n│    DRAFT    │ ← Generate spec.md (with research context if available)\n└──────┬──────┘\n       │\n       ▼\n┌─────────────┐\n│  DECOMPOSE  │ ← Break into properly-sized stories\n└──────┬──────┘\n       │\n       ▼\n┌─────────────┐\n│  GENERATE   │ ← Create prd.json + progress.txt\n└──────┬──────┘\n       │\n       ▼ (unless --skip-verify)\n┌─────────────┐\n│   VERIFY    │ ← Run plan checker, revision loop for BLOCKERs\n└─────────────┘\n```\n\n### Plan Verification Phase\n\nAfter generating spec.md and prd.json, the planning workflow runs plan verification (unless `--skip-verify` is provided):\n\n**Plan Checker Agent:**\n- Uses `templates/plan-checker.md` to verify the plan across six dimensions:\n  - Coverage: Does the plan address all aspects of the stated problem?\n  - Completeness: Is each story fully specified and implementable?\n  - Dependencies: Are story ordering and dependencies correct?\n  - Links: Are references and connections valid?\n  - Scope: Is the plan appropriately scoped for iterative implementation?\n  - Verification: Is there an adequate verification approach?\n\n**Issue Classification:**\n- **BLOCKER**: Must be fixed before implementation can succeed\n- **WARNING**: Should be addressed but won't prevent basic implementation\n- **INFO**: Observations and suggestions for improvement\n\n**Verdict and Revision Loop:**\n- **READY**: Zero BLOCKERs, plan is ready for execution\n- **NEEDS_REVISION**: Fixable BLOCKERs, enters revision loop (up to 3 iterations)\n- **BLOCKED**: Significant issues requiring manual intervention\n\n**Revision Loop (up to 3 iterations):**\n1. Identify BLOCKER issues from PLAN-REVIEW.md\n2. Apply fixes to spec.md and/or prd.json\n3. Regenerate prd.json if spec.md was modified\n4. Re-run plan checker\n5. Repeat until READY or iteration limit reached\n\n**Output:**\n- `PLAN-REVIEW.md` saved to feature folder with verification results\n- Final plan status shown to user (READY/NEEDS_REVISION/BLOCKED/NOT_VERIFIED)\n\n### Assumption Lister (Optional)\n\nWhen the `--list-assumptions` flag is provided, assumptions are surfaced before planning proceeds:\n\n**Why Surface Assumptions?**\nMisaligned assumptions are a leading cause of planning failures:\n- Technical assumptions that don't match reality\n- Scope assumptions that lead to missed requirements\n- Order assumptions that create blocking dependencies\n- Risk assumptions that leave vulnerabilities unaddressed\n- Dependency assumptions that cause delays\n\n**Five Assumption Categories:**\n\n| Category | Description | Examples |\n|----------|-------------|----------|\n| Technical | Technologies, frameworks, infrastructure | \"The database supports transactions\" |\n| Order | What must happen before what | \"Users must be logged in first\" |\n| Scope | What's included or excluded | \"Mobile support isn't needed\" |\n| Risk | What could go wrong | \"The API will always respond\" |\n| Dependencies | External systems, teams, resources | \"The design team will provide mockups\" |\n\n**Confidence and Impact Levels:**\n\nEach assumption is rated for:\n- **Confidence**: HIGH (verified), MEDIUM (reasonable but unverified), LOW (uncertain)\n- **Impact**: CRITICAL (invalidates plan), HIGH (significant rework), MEDIUM (some adjustment), LOW (minor)\n\nAssumptions with HIGH impact AND (LOW or MEDIUM confidence) require validation before planning proceeds.\n\n**Assumption Lister Workflow:**\n1. Analyze feature description, GitHub issue, and clarifying answers\n2. Surface implicit assumptions across all five categories\n3. Rate each assumption for confidence and impact\n4. Present critical assumptions (high impact, low confidence) to user\n5. Guide validation of uncertain assumptions\n6. Update context and proceed to CLARIFY phase\n\n**Output:**\n- `ASSUMPTIONS.md` saved to feature folder with categorized assumptions\n- Questions to ask user derived from uncertain assumptions\n- Updated context informs CLARIFY phase questions\n\n**Output Location:**\n```\n.ralph-hybrid/{branch}/\n├── ASSUMPTIONS.md   # Assumption analysis results\n├── spec.md          # (created later, informed by assumptions)\n├── prd.json\n└── progress.txt\n```\n\n### Research Phase (Optional)\n\nWhen the `--research` flag is provided, research agents are spawned to investigate topics extracted from the description:\n\n**Topic Extraction:**\n1. Parse description, GitHub issue, and clarifying question answers\n2. Extract technical/domain terms (filtering common words)\n3. Deduplicate and limit to configurable max (default: 5 topics)\n\n**Research Agent Workflow:**\n1. Spawn parallel agents for each topic (max 3 concurrent by default)\n2. Each agent produces `RESEARCH-{topic}.md` with structured output:\n   - Summary (2-3 sentences)\n   - Key Findings (with evidence and impact)\n   - Confidence Level (HIGH/MEDIUM/LOW with criteria)\n   - Sources consulted\n   - Recommendations\n3. Synthesize findings into `RESEARCH-SUMMARY.md`\n4. Inject research context into spec generation\n\n**Research Output Location:**\n```\n.ralph-hybrid/{branch}/\n├── research/\n│   ├── RESEARCH-{topic1}.md\n│   ├── RESEARCH-{topic2}.md\n│   └── RESEARCH-SUMMARY.md\n├── spec.md          ← Uses research context\n├── prd.json\n└── progress.txt\n```\n\n**Configuration:**\n```yaml\nresearch:\n  max_topics: 5          # Max topics to research per planning session\n  max_agents: 3          # Max concurrent research agents\n  timeout: 600           # Per-agent timeout in seconds\n```\n\n### GitHub Issue Integration\n\nIf the branch name contains an issue number (e.g., `feature/42-user-auth`), the `/ralph-hybrid-plan` command will:\n\n1. **Detect** issue number from branch name patterns\n2. **Fetch** issue via `gh issue view 42 --json title,body,labels`\n3. **Extract** problem statement, acceptance criteria from issue body\n4. **Use** as starting context (reduces clarifying questions needed)\n5. **Link** spec.md back to the GitHub issue for traceability\n\nBranch patterns recognized:\n- `feature/42-description` → issue #42\n- `issue-42-description` → issue #42\n- `42-description` → issue #42\n- `fix/42-description` → issue #42\n\n### Clarifying Questions\n\nFocus on critical ambiguities:\n\n1. **Problem Definition**: \"What specific problem does this solve?\"\n2. **Scope Boundaries**: \"What should it NOT do?\" (prevents scope creep)\n3. **Success Criteria**: \"How do we know it's done?\"\n4. **Technical Constraints**: \"Any existing patterns to follow?\"\n5. **Dependencies**: \"What does this depend on?\"\n\n### Story Sizing Rule\n\n> Each story must be completable in ONE Ralph iteration (one context window).\n\n**Split indicators:**\n- Description exceeds 2-3 sentences\n- More than 6 acceptance criteria\n- Changes more than 3 files\n\n### Acceptance Criteria Format\n\n**Required for ALL stories:**\n- `Typecheck passes`\n- `Unit tests pass` (or specific test file)\n\n**For UI stories, add:**\n- `Verify in browser` or E2E test reference\n\n**Good criteria are:**\n\n| Trait | Good Example | Bad Example |\n|-------|--------------|-------------|\n| Verifiable | \"Email format is validated\" | \"Works correctly\" |\n| Measurable | \"Response time < 200ms\" | \"Is fast\" |\n| Specific | \"GET /api/users returns 200\" | \"API works\" |\n\n### Output Files\n\nAfter `/ralph-hybrid-plan` completes:\n\n```\n.ralph-hybrid/{feature}/\n├── spec.md           # Full specification (human-readable)\n├── prd.json          # Machine-readable task list\n├── progress.txt      # Empty, ready for iterations\n└── specs/            # Additional detailed specs (optional)\n```\n\n### Usage\n\n```bash\n# In Claude Code session:\n/ralph-hybrid-plan Add user authentication with JWT\n\n# Follow interactive prompts...\n\n# After planning completes:\nralph-hybrid run\n```\n\n---\n\n## Amendment System\n\nPlans evolve during implementation. Edge cases emerge. Stakeholders clarify requirements. The amendment system handles scope changes without losing progress.\n\n### Philosophy\n\n> **\"No plan survives first contact with implementation.\"**\n\nTraditional workflows force a choice between:\n- Manual prd.json edits (risky, loses context)\n- Starting over (loses progress)\n- Hoping the AI remembers verbal changes (it won't)\n\nRalph Hybrid treats scope changes as **expected, not exceptional**.\n\n### Commands\n\n| Command | Purpose |\n|---------|---------|\n| `/ralph-hybrid-amend add <description>` | Add new requirement discovered during implementation |\n| `/ralph-hybrid-amend correct <story-id> <description>` | Fix or clarify existing story |\n| `/ralph-hybrid-amend remove <story-id> <reason>` | Descope story (archived, not deleted) |\n| `/ralph-hybrid-amend status` | View amendment history and current state |\n\n### Amendment Modes\n\n#### ADD Mode\n\nAdds new requirements discovered during implementation.\n\n**Workflow:**\n```\n1. VALIDATE   - Confirm feature folder exists\n2. CLARIFY    - Mini-planning session (2-3 questions max)\n3. DEFINE     - Create acceptance criteria\n4. SIZE       - Check if story needs splitting\n5. INTEGRATE  - Update spec.md and prd.json\n6. LOG        - Record amendment in progress.txt\n7. CONFIRM    - Show summary\n```\n\n**Key behaviors:**\n- Asks focused clarifying questions (max 3)\n- Generates proper acceptance criteria\n- Assigns priority (usually after existing stories)\n- Preserves all existing `passes: true` stories\n\n#### CORRECT Mode\n\nFixes or clarifies existing story requirements.\n\n**Workflow:**\n```\n1. VALIDATE   - Confirm story exists\n2. SHOW       - Display current definition\n3. IDENTIFY   - What needs to change?\n4. WARN       - If passes: true, warn about reset\n5. UPDATE     - Modify spec.md and prd.json\n6. LOG        - Record correction in progress.txt\n7. CONFIRM    - Show diff and summary\n```\n\n**Key behaviors:**\n- Shows current story before changes\n- Warns if correcting completed (`passes: true`) story\n- Resets `passes` to `false` if story was complete (requires re-verification)\n- Logs before/after for audit trail\n\n#### REMOVE Mode\n\nDescopes a story (moves elsewhere, no longer needed, etc.).\n\n**Workflow:**\n```\n1. VALIDATE   - Confirm story exists\n2. SHOW       - Display story and status\n3. CONFIRM    - Require reason for removal\n4. ARCHIVE    - Move to Descoped section (never deleted)\n5. UPDATE     - Remove from active prd.json stories\n6. LOG        - Record removal in progress.txt\n7. CONFIRM    - Show summary\n```\n\n**Key behaviors:**\n- Stories are **never deleted** - moved to \"Descoped Stories\" section\n- Requires explicit reason\n- Warns about dependencies (if other stories depend on this one)\n- Full audit trail preserved\n\n### Amendment ID Format\n\n```\nAMD-001  # First amendment\nAMD-002  # Second amendment\nAMD-NNN  # Sequential within feature\n```\n\n**Rules:**\n- Unique per feature (not global)\n- Never reused (even if amendment is reverted)\n- Referenced in spec.md, prd.json, and progress.txt\n\n### File Updates\n\nEach amendment updates three files consistently:\n\n#### spec.md Updates\n\nAmendments are recorded in a dedicated section:\n\n```markdown\n---\n\n## Amendments\n\n### AMD-001: CSV Export (2026-01-09T14:32:00Z)\n\n**Type:** ADD\n**Reason:** User needs data export for external reporting\n**Added by:** /ralph-hybrid-amend\n\n#### STORY-004: Export data as CSV\n\n**As a** user\n**I want to** export my data as CSV\n**So that** I can analyze it in spreadsheets\n\n**Acceptance Criteria:**\n- [ ] Export button visible on data list view\n- [ ] Clicking export downloads CSV file\n- [ ] Typecheck passes\n- [ ] Unit tests pass\n\n**Priority:** 2\n\n---\n\n### AMD-002: STORY-003 Correction (2026-01-09T15:10:00Z)\n\n**Type:** CORRECT\n**Target:** STORY-003 - Validate user input\n**Reason:** Email validation was underspecified\n\n**Changes:**\n| Field | Before | After |\n|-------|--------|-------|\n| Acceptance Criteria #1 | Email field is required | Email validated against RFC 5322 |\n\n**Status Impact:** passes reset to false\n\n---\n\n## Descoped Stories\n\n### STORY-005: Advanced filtering (Removed AMD-003)\n\n**Removed:** 2026-01-09T16:00:00Z\n**Reason:** Moved to separate issue #47 for Phase 2\n**Status at removal:** passes: false\n\n**Original Definition:**\n[full story preserved here]\n```\n\n#### prd.json Updates\n\nStories include amendment metadata:\n\n```json\n{\n  \"id\": \"STORY-004\",\n  \"title\": \"Export data as CSV\",\n  \"description\": \"As a user I want to export my data as CSV...\",\n  \"acceptanceCriteria\": [\"...\"],\n  \"priority\": 2,\n  \"passes\": false,\n  \"notes\": \"\",\n  \"amendment\": {\n    \"id\": \"AMD-001\",\n    \"type\": \"add\",\n    \"timestamp\": \"2026-01-09T14:32:00Z\",\n    \"reason\": \"User needs data export for external reporting\"\n  }\n}\n```\n\nFor corrections:\n\n```json\n{\n  \"amendment\": {\n    \"id\": \"AMD-002\",\n    \"type\": \"correct\",\n    \"timestamp\": \"2026-01-09T15:10:00Z\",\n    \"reason\": \"Email validation was underspecified\",\n    \"changes\": {\n      \"acceptanceCriteria\": {\n        \"before\": [\"Email field is required\"],\n        \"after\": [\"Email validated against RFC 5322\"]\n      },\n      \"passesReset\": true\n    }\n  }\n}\n```\n\n#### progress.txt Updates\n\nAmendments are logged with full context:\n\n```\n---\n## Amendment AMD-001: 2026-01-09T14:32:00Z\n\nType: ADD\nCommand: /ralph-hybrid-amend add \"Users need CSV export for reporting\"\n\nAdded Stories:\n  - STORY-004: Export data as CSV (priority: 2)\n\nReason: User needs data export for external reporting\n\nFiles Updated:\n  - spec.md: Added Amendments section\n  - prd.json: Added STORY-004\n\nContext: Discovered during STORY-002 implementation that users\nneed to export filtered results for monthly reporting.\n\n---\n```\n\n### Edge Cases\n\n#### Adding to Completed Feature\n\n```\n/ralph-hybrid-amend add \"One more thing...\"\n\n⚠️  All stories currently pass. Adding new story will:\n  - Mark feature incomplete\n  - Require additional Ralph runs\n\nProceed? (y/N)\n```\n\n#### Correcting a Blocking Story\n\n```\n/ralph-hybrid-amend correct STORY-001 \"Change API contract\"\n\n⚠️  STORY-001 is a dependency for:\n  - STORY-002 (passes: true)\n  - STORY-003 (passes: false)\n\nCorrecting may invalidate dependent stories.\nReset all dependent stories? (y/N/select)\n```\n\n#### Removing a Story with Dependents\n\n```\n/ralph-hybrid-amend remove STORY-002 \"Not needed\"\n\n⚠️  STORY-002 blocks:\n  - STORY-003 (passes: false)\n  - STORY-004 (passes: false)\n\nOptions:\n  A) Remove STORY-002, keep dependent stories\n  B) Remove STORY-002 and all dependent stories\n  C) Cancel\n\nChoice:\n```\n\n### Integration with Ralph Loop\n\nThe prompt template acknowledges amendments:\n\n```markdown\n## Amendment Awareness\n\nWhen you see stories with `amendment` field in prd.json:\n- These were added/modified after initial planning\n- Check progress.txt for context on why\n- Amendments marked with AMD-XXX in spec.md have full details\n\nAmendments are normal. Plans evolve. Implement them like any other story.\n```\n\n### Preflight Validation\n\nThe sync check (see [Preflight Validation](#preflight-validation)) validates amendments:\n\n| Check | Severity | Description |\n|-------|----------|-------------|\n| Amendment IDs unique | ERROR | No duplicate AMD-NNN within feature |\n| Amendment referenced | WARN | Stories with `amendment` field should have matching AMD in spec.md |\n| Descoped stories archived | ERROR | Removed stories must be in Descoped section |\n\n---\n\n## PRD Format\n\n### Schema (prd.json)\n\nThe prd.json file is a **derived artifact** generated from spec.md by `/ralph-hybrid-plan --regenerate`. It provides machine-readable task state for the Ralph loop.\n\n> **Note:** The feature identifier is derived from the current git branch name. No `feature` or `branchName` fields are needed in prd.json.\n\n```json\n{\n  \"description\": \"string\",\n  \"createdAt\": \"ISO-8601\",\n  \"userStories\": [\n    {\n      \"id\": \"string\",\n      \"title\": \"string\",\n      \"description\": \"string\",\n      \"acceptanceCriteria\": [\"string\"],\n      \"priority\": \"number (1=highest)\",\n      \"passes\": \"boolean\",\n      \"notes\": \"string\",\n      \"spec_ref\": \"string (optional, path to detailed spec)\",\n      \"model\": \"string (optional, e.g., opus, sonnet, haiku)\",\n      \"mcpServers\": [\"string\"] // optional, MCP server names\n    }\n  ]\n}\n```\n\n### Field Specifications\n\n| Field | Type | Required | Description |\n|-------|------|----------|-------------|\n| `description` | string | Yes | High-level feature description |\n| `createdAt` | ISO-8601 | Yes | Creation timestamp |\n| `userStories` | array | Yes | List of stories |\n| `userStories[].id` | string | Yes | Unique identifier (e.g., STORY-001 or STORY-002.1 for inserted stories) |\n| `userStories[].title` | string | Yes | Short title |\n| `userStories[].description` | string | No | User story or description |\n| `userStories[].acceptanceCriteria` | array | Yes | Testable criteria |\n| `userStories[].priority` | number | Yes | 1 = highest |\n| `userStories[].passes` | boolean | Yes | Completion status (updated by Claude) |\n| `userStories[].notes` | string | No | Agent notes, blockers |\n| `userStories[].spec_ref` | string | No | Path to detailed spec file (e.g., \"specs/validation.spec.md\") |\n| `userStories[].model` | string | No | Claude model for this story (opus, sonnet, haiku, or full claude-* name). Overrides CLI `--model` flag. |\n| `userStories[].mcpServers` | array | No | MCP server names for this story. Empty array `[]` = no MCP. Omitted = use global config. |\n| `userStories[].amendment` | object | No | Amendment metadata (if added/modified via /ralph-hybrid-amend) |\n| `userStories[].amendment.id` | string | Yes* | Amendment ID (e.g., AMD-001) |\n| `userStories[].amendment.type` | string | Yes* | \"add\", \"correct\", or \"remove\" |\n| `userStories[].amendment.timestamp` | ISO-8601 | Yes* | When amendment was made |\n| `userStories[].amendment.reason` | string | Yes* | Why the amendment was made |\n| `userStories[].amendment.changes` | object | No | For corrections: before/after values |\n\n*Required if `amendment` object is present\n\n### Decimal Story IDs\n\nStories can have decimal IDs (e.g., `STORY-002.1`) to support insertion without renumbering:\n\n```\nSTORY-001\nSTORY-002\nSTORY-002.1   ← Inserted after STORY-002\nSTORY-002.2   ← Another insertion\nSTORY-003\n```\n\n**Key Properties:**\n- Created via `/ralph-hybrid-amend add --insert-after STORY-002`\n- Decimal parts are treated as integers: STORY-002.9 < STORY-002.10\n- Existing story numbers are never changed\n- Stories automatically sort by their numeric value\n\n**ID Format:** `STORY-NNN` or `STORY-NNN.D` where:\n- `NNN` = one or more digits (e.g., 001, 12, 123)\n- `D` = optional decimal part, one or more digits (e.g., 1, 10, 99)\n\n**Functions (lib/prd.sh):**\n- `prd_validate_story_id()` - Validates ID format\n- `prd_parse_story_id()` - Extracts numeric value\n- `prd_compare_story_ids()` - Compares two IDs (-1, 0, 1)\n- `prd_sort_stories_by_id()` - Returns sorted story array\n- `prd_insert_story_after()` - Inserts with auto-generated decimal ID\n- `prd_get_next_decimal_id()` - Gets next available decimal ID\n\n### Per-Story Model and MCP Configuration\n\nStories can optionally specify custom Claude model and MCP server configurations, allowing different stories to use different resources based on their complexity and requirements.\n\n#### Model Configuration\n\nThe `model` field overrides the CLI `--model` flag for a specific story:\n\n```json\n{\n  \"id\": \"STORY-001\",\n  \"title\": \"Complex algorithm\",\n  \"model\": \"opus\",  // Use opus for complex reasoning\n  ...\n}\n```\n\n**Precedence:** story-level `model` > CLI `--model` flag > default\n\n**Valid values:** `opus`, `sonnet`, `haiku`, or full model names like `claude-opus-4-5-20251101`\n\n#### MCP Server Configuration\n\nThe `mcpServers` field controls which MCP servers are available during story execution:\n\n| Configuration | Behavior |\n|--------------|----------|\n| Field omitted | Uses global MCP config (all enabled servers) |\n| `\"mcpServers\": []` | Explicitly disables all MCP servers |\n| `\"mcpServers\": [\"playwright\"]` | Only specified servers available |\n\nWhen `mcpServers` is specified (including empty array), Ralph uses `--strict-mcp-config` to restrict available servers.\n\n**Example configurations:**\n\n```json\n// Backend story - no MCP needed\n{\n  \"id\": \"STORY-001\",\n  \"title\": \"Create data model\",\n  \"mcpServers\": []\n}\n\n// UI testing story - only Playwright\n{\n  \"id\": \"STORY-002\",\n  \"title\": \"Write E2E tests\",\n  \"mcpServers\": [\"playwright\"]\n}\n\n// UI debugging - Chrome DevTools\n{\n  \"id\": \"STORY-003\",\n  \"title\": \"Fix console errors\",\n  \"mcpServers\": [\"chrome-devtools\"]\n}\n```\n\n**MCP server names** must match servers registered with `claude mcp add`. Preflight validation ensures all specified servers are configured.\n\n---\n\n## Spec Format\n\n### Schema (spec.md)\n\nThe spec.md file is a human-readable specification generated by `/ralph-hybrid-plan`. It serves as the source of truth for feature requirements.\n\n### Spec Files (specs/ directory)\n\nThe `specs/` directory within each feature folder provides a central location for detailed feature specifications that supplement the main `spec.md` file.\n\n#### Purpose\n\n| Use Case | Description |\n|----------|-------------|\n| Complex features | Break large features into separate, focused spec files |\n| Domain documentation | Document domain concepts, business rules, data models |\n| API contracts | Define API schemas, endpoints, request/response formats |\n| Integration specs | Document external service integrations |\n| Reusable components | Spec files can be referenced across multiple stories |\n\n#### Directory Structure\n\n```\n.ralph-hybrid/{feature-name}/\n├── spec.md                    # Main specification (required)\n├── prd.json                   # Machine-readable tasks (required)\n├── progress.txt               # Iteration log (required)\n└── specs/                     # Detailed specifications (optional)\n    ├── api-design.spec.md     # API endpoint specifications\n    ├── data-model.spec.md     # Database schema, entities\n    ├── validation.spec.md     # Input validation rules\n    └── error-handling.spec.md # Error codes, messages\n```\n\n#### Naming Conventions\n\n| Pattern | Use Case | Example |\n|---------|----------|---------|\n| `{topic}.spec.md` | General spec file | `api-design.spec.md` |\n| `{story-id}.spec.md` | Story-specific details | `STORY-003.spec.md` |\n| `{domain}.spec.md` | Domain documentation | `authentication.spec.md` |\n\n#### Spec File Structure\n\nEach spec file follows a consistent structure:\n\n```markdown\n---\ncreated: {ISO-8601}\nrelated_stories: [STORY-001, STORY-002]\n---\n\n# {Topic Title}\n\n## Overview\n\n{Brief description of what this spec covers}\n\n## Details\n\n{Detailed specifications, requirements, or documentation}\n\n## Examples\n\n{Code examples, API request/response samples, etc.}\n\n## References\n\n- Link to external documentation\n- Related spec files\n```\n\n#### Relationship to prd.json\n\nStories in `prd.json` can reference spec files via the optional `spec_ref` field:\n\n```json\n{\n  \"id\": \"STORY-003\",\n  \"title\": \"Validate user input\",\n  \"spec_ref\": \"specs/validation.spec.md\",\n  \"acceptanceCriteria\": [\"...\"],\n  \"passes\": false\n}\n```\n\nThis enables:\n- **Traceability**: Link stories to their detailed specifications\n- **Context**: Agent can read referenced spec for implementation details\n- **Organization**: Keep `spec.md` concise, details in `specs/`\n\n#### How Ralph Uses Spec Files\n\n1. **During planning** (`/ralph-hybrid-plan`): Complex requirements generate additional spec files\n2. **During implementation** (Ralph loop): Agent reads `specs/` for detailed requirements\n3. **During amendments** (`/ralph-hybrid-amend`): New specs can be created for added requirements\n\nThe prompt template instructs the agent to check `specs/` for detailed requirements:\n\n```markdown\n## Context Files\n- **specs/**: Detailed requirements and specifications\n```\n\n#### Best Practices\n\n1. **Keep spec.md high-level**: Use specs/ for implementation details\n2. **One topic per file**: Each spec file should focus on one concern\n3. **Link from stories**: Use `spec_ref` to connect stories to relevant specs\n4. **Include examples**: Code samples, API examples aid implementation\n5. **Update with amendments**: When requirements change, update relevant specs\n\n### Structure\n\n```markdown\n---\ncreated: {ISO-8601}\n---\n\n# {Feature Title}\n\n<!-- Feature folder: .ralph-hybrid/{branch-name}/ (derived from git branch) -->\n\n## Problem Statement\n{Description of the problem being solved}\n\n## Success Criteria\n- [ ] {High-level measurable outcome}\n\n## User Stories\n\n### STORY-001: {Title}\n**As a** {user type}\n**I want to** {goal}\n**So that** {benefit}\n\n**Acceptance Criteria:**\n- [ ] {Specific, testable criterion}\n- [ ] Typecheck passes\n- [ ] Unit tests pass\n\n**Technical Notes:**\n- {Implementation hints}\n\n## Out of Scope\n- {Explicitly excluded features}\n\n## Open Questions\n- {Unresolved decisions}\n\n---\n\n## Amendments\n<!-- Added by /ralph-hybrid-amend - DO NOT manually edit this section -->\n\n### AMD-001: {Title} ({ISO-8601})\n\n**Type:** ADD | CORRECT | REMOVE\n**Reason:** {Why the amendment was made}\n**Added by:** /ralph-hybrid-amend\n\n{Story definition for ADD, change table for CORRECT}\n\n---\n\n## Descoped Stories\n<!-- Stories removed via /ralph-hybrid-amend remove - preserved for audit trail -->\n\n### {STORY-ID}: {Title} (Removed {AMD-ID})\n\n**Removed:** {ISO-8601}\n**Reason:** {Why removed}\n**Status at removal:** passes: true|false\n\n**Original Definition:**\n{Full story preserved here}\n```\n\n### Frontmatter Fields\n\n| Field | Type | Required | Description |\n|-------|------|----------|-------------|\n| `created` | ISO-8601 | Yes | Creation timestamp |\n\n> **Note:** No `feature` or `branch` fields. The feature is identified by the folder path, which is derived from the current git branch (e.g., branch `feature/user-auth` → folder `.ralph-hybrid/feature-user-auth/`).\n\n### Story Format\n\nEach story follows the user story format with structured sections:\n\n| Section | Purpose |\n|---------|---------|\n| **As a / I want / So that** | User perspective and motivation |\n| **Acceptance Criteria** | Testable requirements |\n| **Technical Notes** | Implementation guidance |\n\n### Best Practices\n\n1. **Keep stories small**: One context window per story\n2. **Be specific**: Avoid vague criteria like \"works correctly\"\n3. **Include tech checks**: Always include typecheck/test criteria\n4. **Document exclusions**: \"Out of Scope\" prevents scope creep\n5. **Capture decisions**: Document resolved \"Open Questions\"\n\n---\n\n## Progress Tracking\n\n### Format (progress.txt)\n\n```\n# Progress Log: <feature-name>\n# Started: <ISO-8601>\n\n---\nIteration: <N>\nDate: <ISO-8601>\nStory: <ID> - <Title>\nStatus: complete|in-progress|blocked\nFiles Changed:\n  - <path>\nTests Added:\n  - <test_name>\nLearnings:\n  - <insight>\nCommit: <hash>\n```\n\n### Amendment Log Format\n\nAmendments are logged in progress.txt with a distinct format:\n\n```\n---\n## Amendment AMD-001: <ISO-8601>\n\nType: ADD | CORRECT | REMOVE\nCommand: /ralph-hybrid-amend <mode> \"<description>\"\n\nAdded Stories:           # For ADD\n  - <ID>: <Title> (priority: N)\n\nCorrected Story:         # For CORRECT\n  - <ID>: <Title>\n  - Changes: <summary>\n  - Status Reset: yes|no\n\nRemoved Story:           # For REMOVE\n  - <ID>: <Title>\n  - Previous Status: passes: true|false\n\nReason: <why the amendment was made>\n\nFiles Updated:\n  - spec.md: <what changed>\n  - prd.json: <what changed>\n\nContext: <additional context from the amendment session>\n\n---\n```\n\n### Purpose\n\n| Use | Description |\n|-----|-------------|\n| Agent continuity | Agent reads to understand prior work |\n| Progress detection | Compare iterations to detect stuck loops |\n| **Amendment history** | Track scope changes and their rationale |\n| Post-mortem analysis | Review iteration patterns and amendments |\n| Prompt refinement | Identify what causes many iterations |\n| **Learning data** | Amendments show where initial planning fell short |\n\n---\n\n## Prompt Template\n\n### Default TDD Template (templates/prompt-tdd.md)\n\n```markdown\n# Ralph Agent Instructions\n\nYou are an autonomous development agent working through a PRD using TDD.\n\n**CRITICAL: You must complete exactly ONE story per session, then STOP.**\nEach session starts with fresh context. Memory persists via prd.json, progress.txt, and git commits.\n\n## Context Files\n\n- **prd.json**: User stories with `passes: true/false`\n- **progress.txt**: Previous iteration log (includes amendment history)\n- **specs/**: Detailed requirements\n- **spec.md**: Full specification (includes Amendments section)\n\n## Workflow\n\n1. Read prd.json, find highest priority story where `passes: false`\n2. Read progress.txt for prior context\n3. Read specs/ for detailed requirements\n4. Implement using TDD:\n   - Write failing test\n   - Implement to pass\n   - Run quality checks\n5. If checks pass:\n   - Commit changes\n   - Set `passes: true` in prd.json\n   - Append to progress.txt\n6. Signal completion and STOP:\n   - If ALL stories pass: output `<promise>COMPLETE</promise>` and STOP\n   - If more stories remain: output `<promise>STORY_COMPLETE</promise>` and STOP\n\n## Amendment Awareness\n\nStories may have an `amendment` field in prd.json. This means they were added\nor modified after initial planning via `/ralph-hybrid-amend`.\n\nWhen you see amended stories:\n- Check progress.txt for \"## Amendment AMD-XXX\" entries explaining why\n- Check spec.md \"## Amendments\" section for full context\n- Implement them like any other story - amendments are normal\n\n**Amendments are expected.** Plans evolve during implementation. Treat amended\nstories with the same rigor as original stories.\n\n## Rules\n\n- ONE story, then STOP - Complete exactly one story, signal, and stop\n- Signal when done - Output the appropriate promise tag and stop immediately\n- Tests first - Always write failing tests before implementation\n- Never commit broken code - All checks must pass\n- Document learnings in progress.txt\n- Treat amended stories the same as original stories\n```\n\n---\n\n## Safety Mechanisms\n\n### Circuit Breaker\n\n| Trigger | Threshold | Action |\n|---------|-----------|--------|\n| No progress | 3 consecutive iterations | Exit with code 1 |\n| Same error | 5 consecutive iterations | Exit with code 1 |\n\n**Progress detection**: Compare `passes` field values in prd.json before/after iteration.\n\n### Rate Limiting\n\n| Parameter | Default | Description |\n|-----------|---------|-------------|\n| Calls per hour | 100 | Maximum API calls |\n| Reset behavior | Wait | Pause until hour resets |\n\n### Per-Iteration Timeout\n\n| Parameter | Default | Description |\n|-----------|---------|-------------|\n| Timeout | 15 min | Kill iteration if exceeded |\n| Behavior | Fail | Counts as failed iteration |\n\n### API Limit Handling\n\n| Detection | Action |\n|-----------|--------|\n| \"usage limit\" in output | Prompt user: wait or exit |\n| No response in 30s | Auto-exit |\n\n---\n\n## Monitoring Dashboard (tmux)\n\nRalph Hybrid provides an optional tmux-based monitoring dashboard for real-time visibility into loop execution. This feature is adapted from [frankbria/ralph-claude-code](https://github.com/frankbria/ralph-claude-code).\n\n### Commands\n\n| Command | Description |\n|---------|-------------|\n| `ralph-hybrid run --monitor` | Start loop with integrated tmux dashboard |\n| `ralph-hybrid monitor` | Launch standalone dashboard (attach to running loop) |\n\n### Dashboard Display\n\nThe live dashboard shows:\n\n| Metric | Description |\n|--------|-------------|\n| Loop count | Current iteration number / max iterations |\n| Status | Running, paused, completed, or failed |\n| API usage | Calls used vs. rate limit (e.g., 45/100) |\n| Rate limit countdown | Time until limit resets |\n| Recent logs | Last N log entries from current iteration |\n| Progress | Stories completed vs. total |\n\n### Layout\n\n```\n┌─────────────────────────────────┬─────────────────────────────────┐\n│                                 │                                 │\n│        RALPH LOOP               │        MONITOR                  │\n│                                 │                                 │\n│  Claude Code output             │  Iteration: 5/20                │\n│  appears here                   │  Status: Running                │\n│                                 │  API: 45/100 (resets in 23m)    │\n│                                 │  Progress: 2/6 stories          │\n│                                 │                                 │\n│                                 │  Recent:                        │\n│                                 │  [12:34] Started STORY-003      │\n│                                 │  [12:35] Running tests...       │\n│                                 │  [12:36] Tests passed           │\n│                                 │                                 │\n└─────────────────────────────────┴─────────────────────────────────┘\n```\n\n### tmux Controls\n\n| Key | Action |\n|-----|--------|\n| `Ctrl+B D` | Detach from session (loop continues in background) |\n| `Ctrl+B ←/→` | Switch between panes |\n| `tmux attach -t ralph` | Reattach to detached session |\n| `tmux list-sessions` | List all active sessions |\n\n### Implementation\n\n| File | Purpose |\n|------|---------|\n| `lib/monitor.sh` | Dashboard rendering and update logic |\n| `logs/` | Directory for iteration logs |\n| `status.json` | Machine-readable status (for programmatic access) |\n\n### Status File Format (status.json)\n\n```json\n{\n  \"iteration\": 5,\n  \"maxIterations\": 20,\n  \"status\": \"running\",\n  \"feature\": \"user-authentication\",\n  \"storiesComplete\": 2,\n  \"storiesTotal\": 6,\n  \"apiCallsUsed\": 45,\n  \"apiCallsLimit\": 100,\n  \"rateLimitResetsAt\": \"2026-01-09T13:00:00Z\",\n  \"startedAt\": \"2026-01-09T12:00:00Z\",\n  \"lastUpdated\": \"2026-01-09T12:36:00Z\"\n}\n```\n\n### Prerequisites\n\n- tmux must be installed (`brew install tmux` or `apt-get install tmux`)\n- If tmux is not available, `--monitor` flag is ignored with a warning\n\n---\n\n## Exit Conditions\n\n### Iteration Exit Conditions\n\n| Condition | Result | Description |\n|-----------|--------|-------------|\n| Story complete signal | Next iteration | Output contains `<promise>STORY_COMPLETE</promise>` - fresh context for next story |\n| All stories complete | Feature complete | All `passes: true` |\n| Completion promise | Feature complete | Output contains `<promise>COMPLETE</promise>` |\n| Timeout | Next iteration | Iteration exceeded time limit |\n| API limit | Wait or exit | Claude usage limit reached |\n\n### Loop Exit Conditions\n\n| Condition | Exit Code | Description |\n|-----------|-----------|-------------|\n| All stories complete | 0 | All `passes: true` |\n| Completion promise | 0 | Output contains `<promise>COMPLETE</promise>` |\n| Max iterations | 1 | Reached limit |\n| Circuit breaker | 1 | No progress or repeated errors |\n| User interrupt | 130 | Ctrl+C |\n| API limit (exit chosen) | 2 | Claude 5-hour limit |\n\n### Fresh Context Model\n\nRalph enforces **one story per iteration** to ensure fresh context:\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│  Iteration N                                                │\n│  ┌─────────────────────────────────────────────────────┐   │\n│  │  1. Read prd.json, progress.txt                     │   │\n│  │  2. Work on ONE story                               │   │\n│  │  3. Commit & update prd.json                        │   │\n│  │  4. Output <promise>STORY_COMPLETE</promise>        │   │\n│  │  5. STOP                                            │   │\n│  └─────────────────────────────────────────────────────┘   │\n└─────────────────────────────────────────────────────────────┘\n                              │\n                              ▼ Fresh context\n┌─────────────────────────────────────────────────────────────┐\n│  Iteration N+1                                              │\n│  ┌─────────────────────────────────────────────────────┐   │\n│  │  1. Read prd.json, progress.txt (has latest state)  │   │\n│  │  2. Work on NEXT story                              │   │\n│  │  ... (repeat)                                       │   │\n│  └─────────────────────────────────────────────────────┘   │\n└─────────────────────────────────────────────────────────────┘\n```\n\n**Why fresh context matters:**\n- Prevents context pollution from accumulated state\n- Ensures reliable, predictable execution\n- Memory persists via files (prd.json, progress.txt, git commits, memories.md)\n\n---\n\n## Memory System\n\nRalph Hybrid includes a memory system for persisting learnings across context resets. Unlike progress.txt (which logs what happened), memories capture reusable knowledge.\n\n### Memory File Format\n\nMemory files use markdown with four standard categories:\n\n```markdown\n# Memories\n\nAccumulated learnings and context for this project/feature.\n\n## Patterns\n\n<!-- Code patterns, architectural decisions, project conventions -->\n- [2024-01-15T10:30:00Z] [tags: api,rest] Use dependency injection for all service classes\n- [2024-01-16T14:00:00Z] [tags: testing] Always mock external APIs in unit tests\n\n## Decisions\n\n<!-- Why certain approaches were chosen -->\n- [2024-01-15T11:00:00Z] [tags: architecture] Chose Redux over Context for state management due to devtools support\n\n## Fixes\n\n<!-- Common issues and their solutions -->\n- [2024-01-15T16:00:00Z] [tags: auth,bug] Fixed race condition in auth flow by adding mutex lock\n\n## Context\n\n<!-- Project-specific context and domain knowledge -->\n- [2024-01-15T09:00:00Z] [tags: domain] User accounts must be verified before placing orders\n```\n\n### Memory Inheritance\n\nMemories are loaded from two levels:\n\n| Level | File Location | Purpose |\n|-------|---------------|---------|\n| Project | `.ralph-hybrid/memories.md` | Cross-feature learnings |\n| Feature | `.ralph-hybrid/{branch}/memories.md` | Feature-specific context |\n\nWhen both exist, they are combined with feature memories taking priority if token budget is limited.\n\n### Memory Functions\n\n| Function | Purpose |\n|----------|---------|\n| `load_memories(feature_dir, token_budget)` | Load combined memories within budget |\n| `write_memory(dir, category, content, tags)` | Append entry to memory file |\n| `memory_filter_by_tags(content, tags)` | Filter memories by tag |\n| `memory_load_with_tags(dir, tags, budget)` | Load and filter in one call |\n| `memory_get_for_iteration(dir, tags)` | Get formatted memories for prompt |\n\n### Tag-based Filtering\n\nMemory entries can include tags for filtering:\n\n```markdown\n- [2024-01-15T10:30:00Z] [tags: api,auth,security] Always validate JWT tokens server-side\n```\n\nFilter by tags to include only relevant memories:\n\n```bash\n# Load only auth-related memories\nmemories=$(memory_load_with_tags \"$feature_dir\" \"auth,security\" 2000)\n```\n\n### Token Budget\n\nMemories are automatically truncated to fit within the token budget:\n\n| Setting | Default | Description |\n|---------|---------|-------------|\n| `memory.token_budget` | 2000 | Max tokens (~8000 chars) for memory injection |\n\nToken calculation uses ~4 characters per token (conservative estimate).\n\n### Injection Modes\n\nConfigure how memories are injected into iteration prompts:\n\n| Mode | Description |\n|------|-------------|\n| `auto` | Automatically inject memories (default) |\n| `manual` | Only inject when explicitly requested |\n| `none` | Never inject memories |\n\nConfiguration in `config.yaml`:\n\n```yaml\nmemory:\n  token_budget: 2000\n  injection: auto  # auto, manual, or none\n```\n\nOr via environment variable:\n\n```bash\nexport RALPH_HYBRID_MEMORY_INJECTION=manual\nexport RALPH_HYBRID_MEMORY_TOKEN_BUDGET=3000\n```\n\n### Memory vs Progress\n\n| Aspect | progress.txt | memories.md |\n|--------|--------------|-------------|\n| Purpose | Log what happened | Store reusable knowledge |\n| Format | Chronological log | Categorized entries |\n| Growth | Grows each iteration | Curated, may be pruned |\n| Injection | Always included | Configurable (auto/manual/none) |\n| Tags | No | Yes |\n| Budget | No limit | Token budget enforced |\n\n### Example Usage\n\n**Writing a memory after fixing a bug:**\n\n```bash\nwrite_memory \"$FEATURE_DIR\" \"Fixes\" \"Fixed null pointer in auth by checking token existence first\" \"auth,bug\"\n```\n\n**Loading memories for a story with specific tags:**\n\n```bash\n# In iteration prompt, filtered to story-relevant tags\nmemories=$(memory_load_with_tags \"$FEATURE_DIR\" \"auth,api\" 2000)\n```\n\n---\n\n## Extensibility Hooks\n\nRalph Hybrid provides a hooks system for extending and customizing behavior at various points during execution.\n\n### Hook Points\n\n| Hook Point | When Triggered | Use Cases |\n|------------|----------------|-----------|\n| `pre_run` | Before the run loop starts | Setup, notifications, validation |\n| `post_run` | After the run loop completes | Cleanup, notifications, reporting |\n| `pre_iteration` | Before each iteration | Custom logging, rate limiting |\n| `post_iteration` | After each iteration | Progress notifications, custom metrics |\n| `on_completion` | When feature completes successfully | Deployment triggers, notifications |\n| `on_error` | When an error occurs (circuit breaker, max iterations) | Error reporting, cleanup |\n\n### Hook Directory Structure\n\n```\n<project>/\n└── .ralph-hybrid/\n    ├── <feature-name>/\n    │   └── hooks/                      # Feature-specific hooks\n    │       ├── pre_run.sh\n    │       ├── post_run.sh\n    │       ├── pre_iteration.sh\n    │       ├── post_iteration.sh\n    │       ├── on_completion.sh\n    │       └── on_error.sh\n    └── hooks/                          # Global hooks (future)\n```\n\n### Creating Hook Scripts\n\nHook scripts are bash scripts placed in the `.ralph-hybrid/<feature>/hooks/` directory. They are named after the hook point they handle.\n\n**Example: post_iteration.sh**\n\n```bash\n#!/bin/bash\n# Run after each iteration\n\necho \"Iteration $RALPH_ITERATION completed\"\n\n# Example: Send Slack notification\n# curl -X POST \"$SLACK_WEBHOOK_URL\" \\\n#   -H 'Content-Type: application/json' \\\n#   -d \"{\\\"text\\\":\\\"Iteration $RALPH_ITERATION completed for $RALPH_FEATURE_NAME\\\"}\"\n\n# Example: Run custom validation\n# ./scripts/validate.sh\n\n# Example: Log to external service\n# curl -X POST \"https://api.example.com/logs\" \\\n#   -d \"feature=$RALPH_FEATURE_NAME&iteration=$RALPH_ITERATION\"\n```\n\nMake hooks executable: `chmod +x .ralph-hybrid/<feature>/hooks/post_iteration.sh`\n\n### Environment Variables in Hooks\n\nThe following environment variables are available to hook scripts:\n\n| Variable | Description | Available In |\n|----------|-------------|--------------|\n| `RALPH_HOOK_POINT` | Current hook point being executed | All hooks |\n| `RALPH_ITERATION` | Current iteration number | `pre_iteration`, `post_iteration` |\n| `RALPH_FEATURE_DIR` | Path to feature directory | All hooks |\n| `RALPH_PRD_FILE` | Path to prd.json | All hooks |\n| `RALPH_FEATURE_NAME` | Name of the current feature | All hooks |\n| `RALPH_RUN_STATUS` | Run outcome: \"complete\", \"error\", \"user_exit\" | `post_run` |\n| `RALPH_ERROR_TYPE` | Error type: \"circuit_breaker\", \"max_iterations\" | `on_error` |\n\n### Programmatic Hook Registration\n\nHooks can also be registered programmatically in bash:\n\n```bash\n# Register a function as a hook\nmy_custom_hook() {\n    echo \"Custom hook called with iteration: $RALPH_ITERATION\"\n}\n\nsource lib/hooks.sh\nhk_register \"post_iteration\" \"my_custom_hook\"\n```\n\n### Custom Completion Patterns\n\nIn addition to the built-in completion signal (`<promise>COMPLETE</promise>`), you can define custom patterns in configuration:\n\n**In config.yaml:**\n\n```yaml\ncompletion:\n  promise: \"<promise>COMPLETE</promise>\"      # Built-in (default)\n  custom_patterns: \"DONE,FINISHED,ALL_COMPLETE\"  # Additional patterns\n```\n\n**Or via environment variable:**\n\n```bash\nexport RALPH_CUSTOM_COMPLETION_PATTERNS=\"DONE,FINISHED,ALL_COMPLETE\"\n```\n\nCustom patterns are checked in addition to the built-in pattern. All patterns require that all stories have `passes: true` for completion to be triggered.\n\n### Configuration\n\nHooks can be disabled via configuration:\n\n```yaml\nhooks:\n  enabled: true  # Set to false to disable all hooks\n```\n\nOr via environment variable:\n\n```bash\nexport RALPH_HOOKS_ENABLED=false\n```\n\n### Hook Execution Behavior\n\n1. **Isolation**: Hook scripts run in a subshell to prevent unintended side effects\n2. **Failure handling**: Hook failures are logged as warnings but do not stop the main loop\n3. **Execution order**: Registered function hooks run before directory-based hooks\n4. **Multiple hooks**: Multiple hooks can be registered for the same hook point\n\n### Use Cases\n\n| Use Case | Hook Point | Example |\n|----------|------------|---------|\n| Slack notifications | `post_iteration`, `on_completion` | Notify team of progress |\n| Custom metrics | `post_iteration` | Send to monitoring system |\n| Pre-run validation | `pre_run` | Check external dependencies |\n| Deployment triggers | `on_completion` | Trigger CI/CD pipeline |\n| Error alerting | `on_error` | Page on-call engineer |\n| Custom cleanup | `post_run` | Clean up temp files |\n\n---\n\n## Template Library\n\nRalph Hybrid includes a template library for skills, scripts, and hooks that can be customized per-feature. These templates are designed to reduce tool calls during execution and enforce best practices.\n\n### Template Types\n\n| Type | Purpose | Location |\n|------|---------|----------|\n| **Skills** | Claude instructions for specific patterns (migration, visual parity) | `templates/skills/` |\n| **Scripts** | Bash scripts that batch operations (reduce tool calls) | `templates/scripts/` |\n| **Hooks** | Pre/post iteration automation (visual regression, notifications) | `templates/hooks/` |\n\n### Available Templates\n\n#### Skills\n\n| Template | Use When | Description |\n|----------|----------|-------------|\n| `visual-parity-migration.md` | Migrating UI frameworks | Enforces verbatim class copying, CSS variable auditing, visual regression validation |\n| `adversarial-review.md` | Security-focused code review | Red team/blue team pattern for finding injection, auth bypass, data exposure, race conditions |\n| `code-archaeology.md` | Legacy code modification | Four-role pattern (Surveyor, Historian, Archaeologist, Careful Modifier) for safe legacy changes |\n| `incident-response.md` | Production incidents | OODA loop pattern (Observer, Mitigator, Investigator, Fixer) with speed vs thoroughness separation |\n| `integration-checker.md` | Feature completion validation | Verifies exports used, routes have consumers, auth on sensitive routes, end-to-end flow tracing |\n\n#### Scripts\n\n| Template | Use When | Description |\n|----------|----------|-------------|\n| `css-audit.sh` | CSS/styling work | Audits CSS variable usage vs definitions, reports undefined variables |\n| `endpoint-validation.sh` | API/route work | Batch validates all endpoints at once, returns JSON report |\n| `file-inventory.sh` | Large features | Pre-reads relevant files by category, reduces repeated file reads |\n| `template-comparison.sh` | Framework migration | Compares source vs target class usage, reports missing classes |\n\n#### Hooks\n\n| Template | Use When | Description |\n|----------|----------|-------------|\n| `post-iteration-visual-diff.sh` | Visual parity requirements | Screenshots pages and compares against baseline, reports pixel differences |\n\n### Template Flow\n\nTemplates are copied and customized per-feature during planning:\n\n```\nralph-hybrid/templates/           ← Generic templates (this repo)\n├── skills/visual-parity-migration.md\n├── skills/adversarial-review.md\n├── skills/code-archaeology.md\n├── skills/incident-response.md\n├── scripts/css-audit.sh\n└── hooks/post-iteration-visual-diff.sh\n\n                    │ ralph-plan detects patterns\n                    ▼\n\n.ralph-hybrid/{feature}/          ← Customized per-feature\n├── skills/visual-parity-migration.md   ← Customized for project\n├── skills/adversarial-review.md        ← Security review skill\n├── skills/code-archaeology.md          ← Legacy code investigation skill\n├── skills/incident-response.md         ← Production incident handling skill\n├── scripts/css-audit.sh                ← Configured with project paths\n└── hooks/post-iteration-visual-diff.sh ← Configured with URLs\n```\n\n### Pattern Detection\n\nThe `/ralph-hybrid-plan` command detects patterns in the epic description and proposes relevant templates:\n\n| Pattern | Detection Keywords | Proposed Assets |\n|---------|-------------------|-----------------|\n| Framework Migration | migrate, convert, port, React, Jinja2 | visual-parity skill, css-audit, template-comparison |\n| Visual Parity | match styling, same look, pixel perfect | visual-parity skill, visual-diff hook |\n| API Changes | endpoint, REST, routes | endpoint-validation script |\n| Large Codebase | many files, multiple subsystems | file-inventory script |\n| Security Review | auth, login, password, security, encrypt, token, session | adversarial-review skill |\n| Legacy Code | legacy, old, refactor, migrate, ancient, technical debt, modernize | code-archaeology skill |\n| Incident Response | incident, outage, down, production, alert, emergency, urgent, critical, SEV-1, SEV-2 | incident-response skill |\n\n### Script Output Format\n\nAll scripts output JSON for easy parsing by Claude:\n\n```json\n{\n  \"audit\": \"css-variables\",\n  \"summary\": {\n    \"variables_used\": 15,\n    \"variables_defined\": 12,\n    \"variables_undefined\": 3,\n    \"status\": \"fail\"\n  },\n  \"undefined\": [\"--color-bg-surface\", \"--color-text-primary\", \"--border-hover\"]\n}\n```\n\nHuman-readable summaries are written to stderr so Claude sees the JSON on stdout.\n\n### Tool Call Reduction\n\nThe template scripts are designed to reduce tool calls:\n\n| Without Script | With Script |\n|----------------|-------------|\n| 50 curl calls (one per endpoint) | 1 endpoint-validation.sh call |\n| 19 file reads (same file repeatedly) | 1 file-inventory.sh call |\n| 30 grep commands (CSS variables) | 1 css-audit.sh call |\n\nTarget: Reduce average tool calls from 74 per iteration to <50.\n\n---\n\n## Installation\n\n### Prerequisites\n\n- Bash 4.0+\n- Claude Code CLI\n- jq\n- Git\n- timeout (coreutils)\n\n### Install\n\n```bash\n# Clone and install globally\ngit clone https://github.com/krazyuniks/ralph-hybrid.git\ncd ralph-hybrid\n./install.sh                # installs to ~/.ralph-hybrid/\n```\n\nThe install script:\n1. Copies files to `~/.ralph-hybrid/` (ralph, lib/, templates/, commands/)\n2. Creates default config.yaml\n\nAfter installation, add `~/.ralph-hybrid` to your PATH:\n\n```bash\n# Add to your shell config (e.g., ~/.zshrc, ~/.bashrc, or your dotfiles)\nexport PATH=\"$HOME/.ralph-hybrid:$PATH\"\n```\n\nThen restart your shell or source your config file. The cloned repo can be deleted.\n\n### Project Setup\n\n```bash\n# In each project where you want to use Ralph:\ncd your-project\nralph-hybrid setup                 # installs Claude commands to .claude/commands/\n```\n\nThe setup command copies `/ralph-hybrid-plan` and `/ralph-hybrid-amend` to your project's `.claude/commands/` directory. This is idempotent - running it again updates the commands.\n\n### Uninstall\n\n```bash\n./uninstall.sh\n# Or manually: rm -rf ~/.ralph-hybrid and remove PATH entry\n```\n\n### Verify Installation\n\n```bash\nralph --version\nralph-hybrid help\n```\n\n---\n\n## Testing\n\n### Framework\n\n[BATS](https://github.com/bats-core/bats-core) (Bash Automated Testing System)\n\n### Test Structure\n\n```\ntests/\n├── unit/\n│   ├── test_circuit_breaker.bats\n│   ├── test_rate_limiter.bats\n│   ├── test_exit_detection.bats\n│   └── test_utils.bats\n└── integration/\n    └── test_loop.bats\n```\n\n### Test Cases\n\n| Component | Test |\n|-----------|------|\n| Circuit breaker | Triggers at no_progress_threshold |\n| Circuit breaker | Triggers at same_error_threshold |\n| Circuit breaker | Resets on progress |\n| Rate limiter | Pauses at limit |\n| Rate limiter | Resets after hour |\n| Exit detection | Detects completion promise |\n| Exit detection | Detects all stories complete |\n| Progress detection | Detects passes field changes |\n| Archive | Creates timestamped directory |\n| Archive | Copies all feature files |\n| CLI | Parses all arguments correctly |\n| **Amendment** | ADD mode creates new story |\n| **Amendment** | ADD mode preserves existing passes:true stories |\n| **Amendment** | ADD mode generates sequential AMD-NNN IDs |\n| **Amendment** | CORRECT mode updates story |\n| **Amendment** | CORRECT mode warns on passes:true story |\n| **Amendment** | CORRECT mode resets passes to false |\n| **Amendment** | REMOVE mode archives to Descoped section |\n| **Amendment** | REMOVE mode never deletes story |\n| **Amendment** | STATUS mode shows amendment history |\n| **Amendment** | Updates spec.md Amendments section |\n| **Amendment** | Updates prd.json with amendment metadata |\n| **Amendment** | Logs to progress.txt |\n| **Preflight** | Validates amendment ID uniqueness |\n| **Preflight** | Validates descoped stories are archived |\n| **Hooks** | Registers hooks for valid hook points |\n| **Hooks** | Rejects registration for invalid hook points |\n| **Hooks** | Executes registered function hooks |\n| **Hooks** | Executes directory-based hook scripts |\n| **Hooks** | Handles hook failures gracefully |\n| **Hooks** | Custom completion patterns merge with built-in |\n| **Hooks** | Custom completion patterns require all stories complete |\n| **Hooks** | Hooks can be disabled via config |\n| **Hooks** | Hook environment variables are set correctly |\n\n### Running Tests\n\n```bash\n./run_tests.sh              # All tests\nbats tests/unit/            # Unit tests only\nbats tests/integration/     # Integration tests only\n```\n\n### Dependency Abstraction Layer (lib/deps.sh)\n\nThe `lib/deps.sh` module provides wrapper functions for external commands (`jq`, `date`, `git`, `claude`, `tmux`, `timeout`) that can be mocked in tests. This enables testing code paths that depend on external commands without actually invoking them.\n\n#### Available Wrappers\n\n| Function | Wraps | Mock Variable | Mock Function |\n|----------|-------|---------------|---------------|\n| `deps_jq` | `jq` | `RALPH_MOCK_JQ` | `_ralph_mock_jq` |\n| `deps_date` | `date` | `RALPH_MOCK_DATE` | `_ralph_mock_date` |\n| `deps_git` | `git` | `RALPH_MOCK_GIT` | `_ralph_mock_git` |\n| `deps_claude` | `claude` | `RALPH_MOCK_CLAUDE` | `_ralph_mock_claude` |\n| `deps_tmux` | `tmux` | `RALPH_MOCK_TMUX` | `_ralph_mock_tmux` |\n| `deps_timeout` | `timeout` | `RALPH_MOCK_TIMEOUT` | `_ralph_mock_timeout` |\n\n#### Mocking in Tests\n\n**Method 1: Mock Function Override**\n\n```bash\nsetup() {\n    source \"$PROJECT_ROOT/lib/deps.sh\"\n\n    # Enable mock\n    export RALPH_MOCK_JQ=1\n\n    # Define mock function\n    _ralph_mock_jq() {\n        case \"$1\" in\n            '.userStories | length')\n                echo \"5\"\n                ;;\n            *)\n                echo \"{}\"\n                ;;\n        esac\n    }\n}\n\nteardown() {\n    deps_reset_mocks\n}\n```\n\n**Method 2: Command Path Override**\n\n```bash\nexport RALPH_JQ_CMD=\"/path/to/mock_jq_script\"\n```\n\n#### Helper Functions\n\n| Function | Description |\n|----------|-------------|\n| `deps_check_available <cmd>` | Check if a command is available (real or mocked) |\n| `deps_check_all` | Check all required dependencies are available |\n| `deps_reset_mocks` | Reset all mock state (for test teardown) |\n| `deps_setup_simple_mock <cmd> <value>` | Set up a mock that returns a fixed value |\n\n#### Example: Testing get_feature_dir Without Git\n\n```bash\n@test \"get_feature_dir returns feature path from branch\" {\n    source \"$PROJECT_ROOT/lib/utils.sh\"\n\n    export RALPH_MOCK_GIT=1\n    _ralph_mock_git() {\n        case \"$1\" in\n            \"rev-parse\")\n                echo \".git\"\n                return 0\n                ;;\n            \"branch\")\n                echo \"feature/my-feature\"\n                ;;\n        esac\n    }\n\n    run get_feature_dir\n    [ \"$output\" = \".ralph-hybrid/feature-my-feature\" ]\n}\n```\n\n---\n\n## Version\n\n- **Spec Version**: 0.1.0\n- **Status**: Draft\n","structuredPatch":[{"oldStart":2248,"oldLines":6,"newStart":2248,"newLines":7,"lines":[" ├── skills/adversarial-review.md"," ├── skills/code-archaeology.md"," ├── skills/incident-response.md","+├── skills/integration-checker.md"," ├── scripts/css-audit.sh"," └── hooks/post-iteration-visual-diff.sh"," "]},{"oldStart":2259,"oldLines":6,"newStart":2260,"newLines":7,"lines":[" ├── skills/adversarial-review.md        ← Security review skill"," ├── skills/code-archaeology.md          ← Legacy code investigation skill"," ├── skills/incident-response.md         ← Production incident handling skill","+├── skills/integration-checker.md       ← Feature integration validation skill"," ├── scripts/css-audit.sh                ← Configured with project paths"," └── hooks/post-iteration-visual-diff.sh ← Configured with URLs"," ```"]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_019xag7LMMKGdQYEZaXfZ3S5","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01MtjjKViYrXAJQFWfk4phQd","name":"Edit","input":{"replace_all":false,"file_path":"/home/ryan/Work/ralph-hybrid/SPEC.md","old_string":"| Pattern | Detection Keywords | Proposed Assets |\n|---------|-------------------|-----------------|\n| Framework Migration | migrate, convert, port, React, Jinja2 | visual-parity skill, css-audit, template-comparison |\n| Visual Parity | match styling, same look, pixel perfect | visual-parity skill, visual-diff hook |\n| API Changes | endpoint, REST, routes | endpoint-validation script |\n| Large Codebase | many files, multiple subsystems | file-inventory script |\n| Security Review | auth, login, password, security, encrypt, token, session | adversarial-review skill |\n| Legacy Code | legacy, old, refactor, migrate, ancient, technical debt, modernize | code-archaeology skill |\n| Incident Response | incident, outage, down, production, alert, emergency, urgent, critical, SEV-1, SEV-2 | incident-response skill |","new_string":"| Pattern | Detection Keywords | Proposed Assets |\n|---------|-------------------|-----------------|\n| Framework Migration | migrate, convert, port, React, Jinja2 | visual-parity skill, css-audit, template-comparison |\n| Visual Parity | match styling, same look, pixel perfect | visual-parity skill, visual-diff hook |\n| API Changes | endpoint, REST, routes | endpoint-validation script |\n| Large Codebase | many files, multiple subsystems | file-inventory script |\n| Security Review | auth, login, password, security, encrypt, token, session | adversarial-review skill |\n| Legacy Code | legacy, old, refactor, migrate, ancient, technical debt, modernize | code-archaeology skill |\n| Incident Response | incident, outage, down, production, alert, emergency, urgent, critical, SEV-1, SEV-2 | incident-response skill |\n| Feature Integration | integrate, wire, connect, orphan, dead code, complete feature, verify integration | integration-checker skill |"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":654,"cache_read_input_tokens":66773,"cache_creation":{"ephemeral_5m_input_tokens":654,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"f2433537-f83e-47f1-808d-48bcc7f6af7d"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01MtjjKViYrXAJQFWfk4phQd","type":"tool_result","content":"The file /home/ryan/Work/ralph-hybrid/SPEC.md has been updated successfully."}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"69096d19-9f41-4dfd-8f7d-b10d55345b6a","tool_use_result":{"filePath":"/home/ryan/Work/ralph-hybrid/SPEC.md","oldString":"| Pattern | Detection Keywords | Proposed Assets |\n|---------|-------------------|-----------------|\n| Framework Migration | migrate, convert, port, React, Jinja2 | visual-parity skill, css-audit, template-comparison |\n| Visual Parity | match styling, same look, pixel perfect | visual-parity skill, visual-diff hook |\n| API Changes | endpoint, REST, routes | endpoint-validation script |\n| Large Codebase | many files, multiple subsystems | file-inventory script |\n| Security Review | auth, login, password, security, encrypt, token, session | adversarial-review skill |\n| Legacy Code | legacy, old, refactor, migrate, ancient, technical debt, modernize | code-archaeology skill |\n| Incident Response | incident, outage, down, production, alert, emergency, urgent, critical, SEV-1, SEV-2 | incident-response skill |","newString":"| Pattern | Detection Keywords | Proposed Assets |\n|---------|-------------------|-----------------|\n| Framework Migration | migrate, convert, port, React, Jinja2 | visual-parity skill, css-audit, template-comparison |\n| Visual Parity | match styling, same look, pixel perfect | visual-parity skill, visual-diff hook |\n| API Changes | endpoint, REST, routes | endpoint-validation script |\n| Large Codebase | many files, multiple subsystems | file-inventory script |\n| Security Review | auth, login, password, security, encrypt, token, session | adversarial-review skill |\n| Legacy Code | legacy, old, refactor, migrate, ancient, technical debt, modernize | code-archaeology skill |\n| Incident Response | incident, outage, down, production, alert, emergency, urgent, critical, SEV-1, SEV-2 | incident-response skill |\n| Feature Integration | integrate, wire, connect, orphan, dead code, complete feature, verify integration | integration-checker skill |","originalFile":"# Ralph Hybrid - Technical Specification\n\n> Implementation specification for the Ralph Hybrid autonomous development loop.\n> For background, philosophy, and rationale, see [README.md](README.md).\n\n---\n\n## Table of Contents\n\n1. [Requirements](#requirements)\n2. [Architecture](#architecture)\n3. [File Structure](#file-structure)\n4. [CLI Interface](#cli-interface)\n5. [Configuration](#configuration)\n6. [Core Loop Logic](#core-loop-logic)\n7. [File Ownership](#file-ownership)\n8. [Preflight Validation](#preflight-validation)\n9. [Planning Workflow](#planning-workflow)\n10. [Amendment System](#amendment-system)\n11. [PRD Format](#prd-format)\n12. [Spec Format](#spec-format)\n13. [Progress Tracking](#progress-tracking)\n14. [Prompt Template](#prompt-template)\n15. [Safety Mechanisms](#safety-mechanisms)\n16. [Monitoring Dashboard](#monitoring-dashboard-tmux)\n17. [Exit Conditions](#exit-conditions)\n18. [Extensibility Hooks](#extensibility-hooks)\n19. [Installation](#installation)\n20. [Testing](#testing)\n\n---\n\n## Requirements\n\n### Functional Requirements\n\n| ID | Requirement |\n|----|-------------|\n| F1 | Execute Claude Code in a loop until completion or limit reached |\n| F2 | Each iteration MUST start a fresh Claude Code session |\n| F3 | Read task state from prd.json at each iteration |\n| F4 | Read prior context from progress.txt at each iteration |\n| F5 | Detect completion via `<promise>COMPLETE</promise>` signal |\n| F5a | Detect story completion via `<promise>STORY_COMPLETE</promise>` signal |\n| F6 | Detect completion via all stories having `passes: true` |\n| F7 | Support max iterations as CLI argument |\n| F8 | Support per-iteration timeout |\n| F9 | Archive completed features with timestamp |\n| F10 | Isolate features in separate folders |\n| F11 | Support mid-implementation amendments (ADD/CORRECT/REMOVE) |\n| F12 | Preserve completed work when adding amendments |\n| F13 | Track amendment history with sequential IDs (AMD-NNN) |\n| F14 | Warn before resetting completed stories during correction |\n\n### Safety Requirements\n\n| ID | Requirement |\n|----|-------------|\n| S1 | Circuit breaker: stop after N iterations with no progress |\n| S2 | Circuit breaker: stop after N iterations with same error |\n| S3 | Rate limiting: cap API calls per hour |\n| S4 | Timeout: kill iteration if exceeds time limit |\n| S5 | API limit: detect Claude 5-hour limit and handle gracefully |\n\n### Non-Functional Requirements\n\n| ID | Requirement |\n|----|-------------|\n| N1 | Bash 4.0+ compatibility |\n| N2 | Minimal dependencies (jq, git, timeout) |\n| N3 | YAML configuration files |\n| N4 | BATS test coverage for core functions |\n\n---\n\n## Architecture\n\n```\n┌─────────────────────────────────────────────────────────────────┐\n│                         ralph.sh                                │\n│                    (Main orchestrator)                          │\n├─────────────────────────────────────────────────────────────────┤\n│                                                                 │\n│  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────────┐ │\n│  │   lib/      │  │   lib/      │  │   lib/                  │ │\n│  │  circuit_   │  │  rate_      │  │  exit_                  │ │\n│  │  breaker.sh │  │  limiter.sh │  │  detection.sh           │ │\n│  └─────────────┘  └─────────────┘  └─────────────────────────┘ │\n│                                                                 │\n│  ┌─────────────────────────────────────────────────────────┐   │\n│  │                    Main Loop                             │   │\n│  │  for i in 1..MAX_ITERATIONS:                            │   │\n│  │    1. Check circuit breaker                             │   │\n│  │    2. Check rate limit                                  │   │\n│  │    3. Snapshot prd.json                                 │   │\n│  │    4. Run Claude Code with timeout                      │   │\n│  │    5. Check completion signals                          │   │\n│  │    6. Detect progress                                   │   │\n│  │    7. Update circuit breaker state                      │   │\n│  └─────────────────────────────────────────────────────────┘   │\n│                                                                 │\n└─────────────────────────────────────────────────────────────────┘\n                              │\n                              ▼\n┌─────────────────────────────────────────────────────────────────┐\n│                      Claude Code                                │\n│                   (Fresh session each iteration)                │\n├─────────────────────────────────────────────────────────────────┤\n│  Reads:                                                         │\n│  ├── prompt.md (instructions)                                   │\n│  ├── prd.json (task list)                                       │\n│  ├── progress.txt (prior context)                               │\n│  └── specs/ (detailed requirements)                             │\n│                                                                 │\n│  Writes:                                                        │\n│  ├── Source code                                                │\n│  ├── Tests                                                      │\n│  ├── prd.json (updates passes field)                            │\n│  ├── progress.txt (appends learnings)                           │\n│  └── Git commits                                                │\n└─────────────────────────────────────────────────────────────────┘\n```\n\n---\n\n## File Structure\n\n### Tool Repository\n\n```\nralph-hybrid/\n├── ralph                       # Main script (no extension)\n├── lib/\n│   ├── circuit_breaker.sh\n│   ├── rate_limiter.sh\n│   ├── exit_detection.sh\n│   ├── archive.sh\n│   ├── monitor.sh\n│   ├── preflight.sh\n│   ├── hooks.sh                # Extensibility hooks system\n│   └── utils.sh\n├── templates/\n│   ├── prompt.md\n│   ├── prompt-tdd.md\n│   ├── prd.json.example\n│   ├── config.yaml.example\n│   ├── spec.md.example\n│   ├── skills/                 # Skill templates for pattern-based generation\n│   │   └── visual-parity-migration.md\n│   ├── scripts/                # Script templates for tool call reduction\n│   │   ├── css-audit.sh\n│   │   ├── endpoint-validation.sh\n│   │   ├── file-inventory.sh\n│   │   └── template-comparison.sh\n│   └── hooks/                  # Hook templates for automation\n│       └── post-iteration-visual-diff.sh\n├── install.sh\n├── uninstall.sh\n└── config.yaml.example\n```\n\n### Per-Project Structure\n\n```\n<project>/\n└── .ralph-hybrid/\n    ├── config.yaml                         # Project settings (optional)\n    ├── <feature-name>/                     # Active feature folder\n    │   ├── prd.json                        # User stories with passes field\n    │   ├── progress.txt                    # Append-only iteration log\n    │   ├── status.json                     # Machine-readable status (for monitor)\n    │   ├── prompt.md                       # Custom prompt (optional)\n    │   ├── hooks/                          # User-defined hook scripts (optional)\n    │   │   ├── pre_run.sh\n    │   │   ├── post_run.sh\n    │   │   ├── pre_iteration.sh\n    │   │   ├── post_iteration.sh\n    │   │   ├── on_completion.sh\n    │   │   └── on_error.sh\n    │   ├── logs/                           # Iteration logs\n    │   │   └── iteration-N.log\n    │   └── specs/                          # Detailed requirements\n    │       └── *.md\n    └── archive/                            # Completed features\n        └── <timestamp>-<feature-name>/\n            ├── prd.json\n            ├── progress.txt\n            └── specs/\n```\n\n---\n\n## CLI Interface\n\n### Commands\n\n```bash\nralph-hybrid setup                     # Install Claude commands to project (.claude/commands/)\nralph-hybrid run [options]             # Execute the loop (includes preflight validation)\nralph-hybrid status                    # Show current state\nralph-hybrid monitor                   # Launch tmux monitoring dashboard\nralph-hybrid archive                   # Archive current feature\nralph-hybrid validate                  # Run preflight checks without starting loop\nralph-hybrid verify [options]          # Run goal-backward verification on current feature\nralph-hybrid debug [options] \"desc\"    # Start or continue scientific debugging session\nralph-hybrid import <file> [options]   # Import PRD from Markdown or JSON file\nralph-hybrid help                      # Show help\n```\n\n> **Note:** Run `ralph-hybrid setup` first in each project to install the `/ralph-hybrid-plan` and `/ralph-hybrid-amend` commands. The feature folder is derived from the current git branch name.\n\n### Run Options\n\n| Option | Default | Description |\n|--------|---------|-------------|\n| `-n, --max-iterations` | 20 | Maximum iterations |\n| `-t, --timeout` | 15 | Per-iteration timeout (minutes) |\n| `-r, --rate-limit` | 100 | Max API calls per hour |\n| `-p, --prompt` | default | Custom prompt file |\n| `-m, --model` | (none) | Claude model (opus, sonnet, or full name) |\n| `--profile` | balanced | Model profile (quality, balanced, budget, or custom) |\n| `-v, --verbose` | false | Detailed output |\n| `--no-archive` | false | Don't archive on completion |\n| `--dry-run` | false | Show what would happen |\n| `--monitor` | false | Launch with tmux monitoring dashboard |\n| `--skip-preflight` | false | Skip preflight validation (use with caution) |\n| `--dangerously-skip-permissions` | false | Pass to Claude Code |\n\n#### Model Selection Priority\n\nModels are selected with the following priority:\n\n1. **Story-level model** (from `prd.json` story's `model` field) - highest priority\n2. **CLI `--model` flag** - explicit model override\n3. **Profile's execution model** (from `--profile` or config) - cost optimization\n4. **Claude CLI default** - if nothing specified\n\nThis allows fine-grained control: use profiles for cost optimization, but override specific stories that need a more capable model.\n\n> **Note:** The feature folder is automatically derived from the current git branch name. No `-f` flag is needed.\n\n### Verify Options\n\n| Option | Default | Description |\n|--------|---------|-------------|\n| `--profile` | (from config) | Model profile for verification (quality, balanced, budget) |\n| `-m, --model` | (profile default) | Specific model to use (overrides profile) |\n| `-o, --output` | .ralph-hybrid/{branch}/VERIFICATION.md | Output file for verification results |\n| `-v, --verbose` | false | Enable verbose output |\n\n#### Verification Exit Codes\n\n| Exit Code | Meaning | Description |\n|-----------|---------|-------------|\n| 0 | VERIFIED | All goals achieved, no issues found |\n| 1 | NEEDS_WORK | Issues found that need to be fixed |\n| 2 | BLOCKED | Critical issues preventing feature completion |\n\n#### Verification Process\n\nThe `ralph-hybrid verify` command uses the goal-backward verification approach:\n\n1. **Goal Extraction** - Extracts concrete goals from spec.md\n2. **Deliverables Verification** - Verifies code exists, is accessible, and is integrated\n3. **Stub Detection** - Scans for placeholder implementations, TODO comments, empty functions\n4. **Wiring Verification** - Verifies components are connected (frontend→backend→database)\n5. **Human Testing Items** - Flags items requiring manual verification (UI/UX, user flows)\n\nOutput is written to VERIFICATION.md with:\n- Goals verification table\n- Deliverables check (completed and incomplete)\n- Stub detection results\n- Wiring verification status\n- Human testing checklist\n- Issue summary and recommendations\n\n### Import Options\n\n| Option | Default | Description |\n|--------|---------|-------------|\n| `--format` | auto-detect | Override format detection (markdown, json) |\n| `--output, -o` | .ralph-hybrid/{branch}/prd.json | Output path for the generated prd.json |\n\n#### Supported Import Formats\n\n| Format | Extensions | Description |\n|--------|------------|-------------|\n| Markdown | .md, .markdown | Stories as headers (### STORY-XXX) or lists (- STORY-XXX) |\n| JSON | .json | External PRD formats (userStories, stories, requirements, tasks) |\n| PDF | .pdf | Future enhancement (requires external dependencies) |\n\n#### Import Examples\n\n```bash\n# Import from Markdown spec file\nralph-hybrid import spec.md\n\n# Import from JSON with explicit output path\nralph-hybrid import requirements.json --output ./custom-prd.json\n\n# Override format detection\nralph-hybrid import my-spec.txt --format markdown\n```\n\n### Debug Options\n\n| Option | Default | Description |\n|--------|---------|-------------|\n| `--profile` | (from config) | Model profile for debugging (quality, balanced, budget) |\n| `-m, --model` | (profile default) | Specific model to use (overrides profile) |\n| `--continue` | false | Continue from previous debug state |\n| `--reset` | false | Start fresh, discarding previous debug state |\n| `-v, --verbose` | false | Enable verbose output |\n\n#### Debug Exit Codes\n\n| Exit Code | Meaning | Description |\n|-----------|---------|-------------|\n| 0 | ROOT_CAUSE_FOUND or DEBUG_COMPLETE | Root cause found or issue resolved |\n| 1 | ERROR | Error during debugging |\n| 10 | CHECKPOINT_REACHED | Progress saved, needs continuation |\n\n#### Debug Return States\n\n| State | Description |\n|-------|-------------|\n| ROOT_CAUSE_FOUND | Root cause identified with evidence; user chooses: fix now, plan solution, or handle manually |\n| DEBUG_COMPLETE | Issue fixed and verified |\n| CHECKPOINT_REACHED | Progress saved for multi-session debugging |\n\n#### Debug Process\n\nThe `ralph-hybrid debug` command uses the scientific method:\n\n1. **Gather Symptoms** - Collect observable evidence before forming hypotheses\n2. **Form Hypotheses** - Propose ranked, testable explanations (H1, H2, H3...)\n3. **Test One Variable** - Change exactly one thing per test, revert if not fixed\n4. **Collect Evidence** - Record results: CONFIRMED, RULED_OUT, INCONCLUSIVE, PARTIAL\n5. **Iterate** - Refine hypotheses based on evidence\n\nState persists in `.ralph-hybrid/{branch}/debug-state.md` across sessions, enabling:\n- Multi-session debugging for complex issues\n- Handoff between context windows\n- Progress tracking with hypotheses, evidence, and findings\n\n#### Debug Examples\n\n```bash\n# Start new debug session\nralph-hybrid debug \"tests failing after refactor\"\n\n# Continue previous debug session\nralph-hybrid debug --continue\n\n# Start fresh (discard previous state)\nralph-hybrid debug --reset \"investigate from scratch\"\n\n# Use quality profile for debugging\nralph-hybrid debug --profile quality \"complex race condition\"\n```\n\n---\n\n## Configuration\n\n### Global Config (~/.ralph-hybrid/config.yaml)\n\n```yaml\ndefaults:\n  max_iterations: 20\n  timeout_minutes: 15\n  rate_limit_per_hour: 100\n\ncircuit_breaker:\n  no_progress_threshold: 3\n  same_error_threshold: 5\n\ncompletion:\n  promise: \"<promise>COMPLETE</promise>\"\n\nclaude:\n  dangerously_skip_permissions: false\n  allowed_tools: \"Write,Bash(git *),Read\"\n```\n\n### Project Config (.ralph-hybrid/config.yaml)\n\n```yaml\ndefaults:\n  max_iterations: 30\n\nquality_checks:\n  backend: \"docker compose exec backend pytest tests/\"\n  frontend: \"docker compose exec frontend pnpm check\"\n\n# Protected branches - ralph will warn if running on these\nprotected_branches:\n  - main\n  - master\n  - develop\n```\n\n---\n\n## Core Loop Logic\n\n### Feature Detection\n\nThe feature folder is derived from the current git branch name:\n\n```bash\nget_feature_dir() {\n    local branch=$(git branch --show-current)\n\n    # Error if detached HEAD\n    [[ -z \"$branch\" ]] && error \"Not on a branch (detached HEAD)\"\n\n    # Warn if on protected branch\n    if is_protected_branch \"$branch\"; then\n        warn \"Running on protected branch '$branch'\"\n    fi\n\n    # Sanitize: feature/user-auth → feature-user-auth\n    local feature_name=\"${branch//\\//-}\"\n    echo \".ralph-hybrid/${feature_name}\"\n}\n```\n\n### Main Loop (Pseudocode)\n\n```bash\nmain() {\n    load_config\n    check_prerequisites\n\n    # Derive feature folder from branch\n    FEATURE_DIR=$(get_feature_dir)\n\n    # Preflight validation\n    run_preflight_checks || exit 1\n\n    iteration=0\n    no_progress_count=0\n    same_error_count=0\n    last_error=\"\"\n\n    while [ $iteration -lt $MAX_ITERATIONS ]; do\n        iteration=$((iteration + 1))\n\n        # Safety checks\n        check_circuit_breaker || exit 1\n        check_rate_limit || wait_for_reset\n\n        # Update status for monitor\n        update_status \"running\" \"$iteration\"\n\n        # Snapshot before\n        prd_before=$(get_passes_state)\n\n        # Run iteration\n        output=$(run_claude_with_timeout)\n\n        # Check completion\n        if contains_completion_promise \"$output\"; then\n            archive_and_exit 0\n        fi\n        if all_stories_complete; then\n            archive_and_exit 0\n        fi\n\n        # Detect progress\n        prd_after=$(get_passes_state)\n        if [ \"$prd_before\" = \"$prd_after\" ]; then\n            no_progress_count=$((no_progress_count + 1))\n        else\n            no_progress_count=0\n        fi\n\n        # Check repeated errors\n        current_error=$(extract_error \"$output\")\n        if [ \"$current_error\" = \"$last_error\" ]; then\n            same_error_count=$((same_error_count + 1))\n        else\n            same_error_count=0\n            last_error=\"$current_error\"\n        fi\n\n        sleep 2\n    done\n\n    exit 1  # Max iterations reached\n}\n```\n\n### Run Iteration\n\n```bash\nrun_claude_with_timeout() {\n    local prompt=$(build_prompt)\n\n    timeout \"${TIMEOUT_MINUTES}m\" claude \\\n        ${SKIP_PERMISSIONS:+--dangerously-skip-permissions} \\\n        -p \"$prompt\" \\\n        2>&1\n}\n\nbuild_prompt() {\n    cat <<EOF\n@${FEATURE_DIR}/prd.json\n@${FEATURE_DIR}/progress.txt\n@${FEATURE_DIR}/specs/\n\n$(cat \"${FEATURE_DIR}/prompt.md\")\nEOF\n}\n```\n\n---\n\n## File Ownership\n\nClear separation of what writes each file:\n\n| File | Written By | Read By | Purpose |\n|------|------------|---------|---------|\n| `spec.md` | `/ralph-hybrid-plan`, `/ralph-hybrid-amend` (Claude) | `/ralph-hybrid-plan --regenerate`, Claude agent | Source of truth for requirements |\n| `prd.json` | `/ralph-hybrid-plan --regenerate`, `/ralph-hybrid-amend` (Claude) | Ralph loop, Claude agent | Machine-readable task state |\n| `progress.txt` | Claude agent (appends), `/ralph-hybrid-amend` | Claude agent | Iteration history, learnings, amendments |\n| `status.json` | Ralph loop (bash) | Monitor script | Real-time loop status |\n| `logs/iteration-N.log` | Ralph loop (bash) | Monitor script, debugging | Raw Claude output per iteration |\n\n### Source of Truth Hierarchy\n\n```\nspec.md (human-readable requirements)\n    ↓\n    /ralph-hybrid-plan --regenerate generates (or /ralph-hybrid-amend updates)\n    ↓\nprd.json (machine-readable, derived)\n    ↓\n    Claude updates passes field\n    ↓\nprogress.txt (append-only history + amendment log)\n```\n\n**Important:** `spec.md` is the source of truth. For requirement changes:\n- **During planning:** Edit `spec.md` and regenerate with `/ralph-hybrid-plan --regenerate`\n- **During implementation:** Use `/ralph-hybrid-amend` to safely modify requirements\n\n---\n\n## Preflight Validation\n\nBefore starting the loop, `ralph-hybrid run` performs preflight checks. These can also be run standalone with `ralph-hybrid validate`.\n\n### Checks Performed\n\n| Check | Severity | Description |\n|-------|----------|-------------|\n| Branch detected | ERROR | Must be on a branch (not detached HEAD) |\n| Protected branch | WARN | Warn if on main/master/develop |\n| Folder exists | ERROR | `.ralph-hybrid/{branch}/` must exist |\n| Required files | ERROR | spec.md, prd.json, progress.txt must exist |\n| prd.json schema | ERROR | Valid JSON with required fields |\n| spec.md structure | WARN | Has Problem Statement, Success Criteria, Stories |\n| **Sync check** | ERROR | spec.md and prd.json must be in sync |\n\n### Sync Check\n\nThe sync check ensures `prd.json` reflects the current `spec.md`:\n\n```bash\nsync_check() {\n    # Generate temp prd.json from current spec.md\n    temp_prd=$(generate_prd_from_spec \"$FEATURE_DIR/spec.md\")\n\n    # Compare stories (ignoring passes field and notes)\n    current_stories=$(jq '[.userStories[] | {id, title, acceptanceCriteria}]' \"$FEATURE_DIR/prd.json\")\n    spec_stories=$(jq '[.userStories[] | {id, title, acceptanceCriteria}]' <<< \"$temp_prd\")\n\n    if [[ \"$current_stories\" != \"$spec_stories\" ]]; then\n        error \"spec.md and prd.json are out of sync\"\n        diff_stories \"$current_stories\" \"$spec_stories\"\n        echo \"Run '/ralph-hybrid-plan --regenerate' to regenerate prd.json from spec.md\"\n        return 1\n    fi\n}\n```\n\n### Sync Scenarios\n\n| Scenario | Detection | Severity | Resolution |\n|----------|-----------|----------|------------|\n| New story in spec.md | Story in spec not in prd | ERROR | Run `/ralph-hybrid-plan --regenerate` |\n| Acceptance criteria changed | Criteria arrays differ | ERROR | Run `/ralph-hybrid-plan --regenerate` |\n| Orphaned story (passes: false) | Story in prd not in spec | WARN | Run `/ralph-hybrid-plan --regenerate` or add to spec |\n| **Orphaned story (passes: true)** | Completed story in prd not in spec | **ERROR** | Requires explicit confirmation |\n| Only `passes` field differs | Ignored | OK | Expected (work in progress) |\n| Only `notes` field differs | Ignored | OK | Agent notes are ephemeral |\n\n### Orphaned Story Handling\n\nOrphaned stories are stories present in `prd.json` but not in `spec.md`. This usually means:\n1. Story was removed from spec.md (intentional)\n2. Story was manually added to prd.json without spec (bad practice)\n3. Merge conflict or accidental deletion\n\n**Critical:** If an orphaned story has `passes: true`, this represents **completed work that will be discarded**. This requires explicit user confirmation.\n\n```bash\norphan_check() {\n    prd_ids=$(jq -r '.userStories[].id' \"$FEATURE_DIR/prd.json\")\n    spec_ids=$(extract_story_ids \"$FEATURE_DIR/spec.md\")\n\n    for id in $prd_ids; do\n        if ! echo \"$spec_ids\" | grep -q \"^$id$\"; then\n            passes=$(jq -r \".userStories[] | select(.id==\\\"$id\\\") | .passes\" \"$FEATURE_DIR/prd.json\")\n            if [[ \"$passes\" == \"true\" ]]; then\n                error \"Orphaned COMPLETED story: $id\"\n                echo \"  This story has passes:true but is not in spec.md\"\n                echo \"  Options:\"\n                echo \"    1. Add story back to spec.md (preserve work)\"\n                echo \"    2. Run '/ralph-hybrid-plan --regenerate --confirm-orphan-removal' (discard work)\"\n                return 1\n            else\n                warn \"Orphaned story: $id (passes: false, will be removed)\"\n            fi\n        fi\n    done\n}\n```\n\n### Preflight Output\n\n```\n$ ralph-hybrid validate\n\nPreflight checks for branch: feature/user-auth\nFeature folder: .ralph-hybrid/feature-user-auth/\n\n✓ Branch detected: feature/user-auth\n✓ Folder exists: .ralph-hybrid/feature-user-auth/\n✓ Required files present\n✓ prd.json schema valid\n✓ spec.md structure valid\n✓ Sync check passed\n\nAll checks passed. Ready to run.\n```\n\n```\n$ ralph-hybrid validate\n\nPreflight checks for branch: feature/user-auth\nFeature folder: .ralph-hybrid/feature-user-auth/\n\n✓ Branch detected: feature/user-auth\n✓ Folder exists: .ralph-hybrid/feature-user-auth/\n✓ Required files present\n✓ prd.json schema valid\n⚠ spec.md missing \"Out of Scope\" section (recommended)\n✗ Sync check failed:\n    - STORY-004 in spec.md not found in prd.json\n    - STORY-002 acceptance criteria differs\n\nResolve sync issues by running '/ralph-hybrid-plan --regenerate' in Claude Code.\n```\n\n**Example: Orphaned completed story detected**\n```\n$ ralph-hybrid validate\n\nPreflight checks for branch: feature/user-auth\nFeature folder: .ralph-hybrid/feature-user-auth/\n\n✓ Branch detected: feature/user-auth\n✓ Folder exists: .ralph-hybrid/feature-user-auth/\n✓ Required files present\n✓ prd.json schema valid\n✓ spec.md structure valid\n✗ Orphan check failed:\n    - STORY-003 in prd.json (passes: true) not found in spec.md\n      ^^^ COMPLETED WORK WILL BE LOST\n\nThis story was completed but is no longer in spec.md.\nOptions:\n  1. Add STORY-003 back to spec.md (preserve completed work)\n  2. Run '/ralph-hybrid-plan --regenerate' and confirm orphan removal (discard work)\n```\n\n---\n\n## Planning Workflow\n\nRalph Hybrid provides Claude Code commands for guided feature planning. This separates **planning** (done interactively with Claude) from **execution** (done autonomously by Ralph loop).\n\n### Commands\n\n| Command | Purpose |\n|---------|---------|\n| `/ralph-hybrid-plan <description>` | Interactive planning workflow |\n| `/ralph-hybrid-plan --list-assumptions` | Surface implicit assumptions before planning |\n| `/ralph-hybrid-plan --research` | Planning with research agent investigation |\n| `/ralph-hybrid-plan --regenerate` | Generate prd.json from existing spec.md |\n| `/ralph-hybrid-plan --skip-verify` | Skip plan verification phase (not recommended) |\n\n### Workflow States\n\n```\n┌─────────────┐\n│  DISCOVER   │ ← Extract context from GitHub issue (if branch has issue #)\n└──────┬──────┘\n       │\n       ▼\n┌─────────────┐\n│  SUMMARIZE  │ ← Combine issue context + user input\n└──────┬──────┘\n       │\n       ▼ (if --list-assumptions flag)\n┌─────────────┐\n│ ASSUMPTIONS │ ← [Optional] Surface implicit assumptions in feature description\n└──────┬──────┘\n       │\n       ▼\n┌─────────────┐\n│   CLARIFY   │ ← Ask 3-5 targeted questions (fewer if issue has details)\n└──────┬──────┘\n       │\n       ▼ (if --research flag)\n┌─────────────┐\n│  RESEARCH   │ ← [Optional] Spawn research agents for topics\n└──────┬──────┘\n       │\n       ▼\n┌─────────────┐\n│   ANALYZE   │ ← Detect patterns requiring skills/scripts/hooks\n└──────┬──────┘\n       │\n       ▼\n┌─────────────┐\n│    DRAFT    │ ← Generate spec.md (with research context if available)\n└──────┬──────┘\n       │\n       ▼\n┌─────────────┐\n│  DECOMPOSE  │ ← Break into properly-sized stories\n└──────┬──────┘\n       │\n       ▼\n┌─────────────┐\n│  GENERATE   │ ← Create prd.json + progress.txt\n└──────┬──────┘\n       │\n       ▼ (unless --skip-verify)\n┌─────────────┐\n│   VERIFY    │ ← Run plan checker, revision loop for BLOCKERs\n└─────────────┘\n```\n\n### Plan Verification Phase\n\nAfter generating spec.md and prd.json, the planning workflow runs plan verification (unless `--skip-verify` is provided):\n\n**Plan Checker Agent:**\n- Uses `templates/plan-checker.md` to verify the plan across six dimensions:\n  - Coverage: Does the plan address all aspects of the stated problem?\n  - Completeness: Is each story fully specified and implementable?\n  - Dependencies: Are story ordering and dependencies correct?\n  - Links: Are references and connections valid?\n  - Scope: Is the plan appropriately scoped for iterative implementation?\n  - Verification: Is there an adequate verification approach?\n\n**Issue Classification:**\n- **BLOCKER**: Must be fixed before implementation can succeed\n- **WARNING**: Should be addressed but won't prevent basic implementation\n- **INFO**: Observations and suggestions for improvement\n\n**Verdict and Revision Loop:**\n- **READY**: Zero BLOCKERs, plan is ready for execution\n- **NEEDS_REVISION**: Fixable BLOCKERs, enters revision loop (up to 3 iterations)\n- **BLOCKED**: Significant issues requiring manual intervention\n\n**Revision Loop (up to 3 iterations):**\n1. Identify BLOCKER issues from PLAN-REVIEW.md\n2. Apply fixes to spec.md and/or prd.json\n3. Regenerate prd.json if spec.md was modified\n4. Re-run plan checker\n5. Repeat until READY or iteration limit reached\n\n**Output:**\n- `PLAN-REVIEW.md` saved to feature folder with verification results\n- Final plan status shown to user (READY/NEEDS_REVISION/BLOCKED/NOT_VERIFIED)\n\n### Assumption Lister (Optional)\n\nWhen the `--list-assumptions` flag is provided, assumptions are surfaced before planning proceeds:\n\n**Why Surface Assumptions?**\nMisaligned assumptions are a leading cause of planning failures:\n- Technical assumptions that don't match reality\n- Scope assumptions that lead to missed requirements\n- Order assumptions that create blocking dependencies\n- Risk assumptions that leave vulnerabilities unaddressed\n- Dependency assumptions that cause delays\n\n**Five Assumption Categories:**\n\n| Category | Description | Examples |\n|----------|-------------|----------|\n| Technical | Technologies, frameworks, infrastructure | \"The database supports transactions\" |\n| Order | What must happen before what | \"Users must be logged in first\" |\n| Scope | What's included or excluded | \"Mobile support isn't needed\" |\n| Risk | What could go wrong | \"The API will always respond\" |\n| Dependencies | External systems, teams, resources | \"The design team will provide mockups\" |\n\n**Confidence and Impact Levels:**\n\nEach assumption is rated for:\n- **Confidence**: HIGH (verified), MEDIUM (reasonable but unverified), LOW (uncertain)\n- **Impact**: CRITICAL (invalidates plan), HIGH (significant rework), MEDIUM (some adjustment), LOW (minor)\n\nAssumptions with HIGH impact AND (LOW or MEDIUM confidence) require validation before planning proceeds.\n\n**Assumption Lister Workflow:**\n1. Analyze feature description, GitHub issue, and clarifying answers\n2. Surface implicit assumptions across all five categories\n3. Rate each assumption for confidence and impact\n4. Present critical assumptions (high impact, low confidence) to user\n5. Guide validation of uncertain assumptions\n6. Update context and proceed to CLARIFY phase\n\n**Output:**\n- `ASSUMPTIONS.md` saved to feature folder with categorized assumptions\n- Questions to ask user derived from uncertain assumptions\n- Updated context informs CLARIFY phase questions\n\n**Output Location:**\n```\n.ralph-hybrid/{branch}/\n├── ASSUMPTIONS.md   # Assumption analysis results\n├── spec.md          # (created later, informed by assumptions)\n├── prd.json\n└── progress.txt\n```\n\n### Research Phase (Optional)\n\nWhen the `--research` flag is provided, research agents are spawned to investigate topics extracted from the description:\n\n**Topic Extraction:**\n1. Parse description, GitHub issue, and clarifying question answers\n2. Extract technical/domain terms (filtering common words)\n3. Deduplicate and limit to configurable max (default: 5 topics)\n\n**Research Agent Workflow:**\n1. Spawn parallel agents for each topic (max 3 concurrent by default)\n2. Each agent produces `RESEARCH-{topic}.md` with structured output:\n   - Summary (2-3 sentences)\n   - Key Findings (with evidence and impact)\n   - Confidence Level (HIGH/MEDIUM/LOW with criteria)\n   - Sources consulted\n   - Recommendations\n3. Synthesize findings into `RESEARCH-SUMMARY.md`\n4. Inject research context into spec generation\n\n**Research Output Location:**\n```\n.ralph-hybrid/{branch}/\n├── research/\n│   ├── RESEARCH-{topic1}.md\n│   ├── RESEARCH-{topic2}.md\n│   └── RESEARCH-SUMMARY.md\n├── spec.md          ← Uses research context\n├── prd.json\n└── progress.txt\n```\n\n**Configuration:**\n```yaml\nresearch:\n  max_topics: 5          # Max topics to research per planning session\n  max_agents: 3          # Max concurrent research agents\n  timeout: 600           # Per-agent timeout in seconds\n```\n\n### GitHub Issue Integration\n\nIf the branch name contains an issue number (e.g., `feature/42-user-auth`), the `/ralph-hybrid-plan` command will:\n\n1. **Detect** issue number from branch name patterns\n2. **Fetch** issue via `gh issue view 42 --json title,body,labels`\n3. **Extract** problem statement, acceptance criteria from issue body\n4. **Use** as starting context (reduces clarifying questions needed)\n5. **Link** spec.md back to the GitHub issue for traceability\n\nBranch patterns recognized:\n- `feature/42-description` → issue #42\n- `issue-42-description` → issue #42\n- `42-description` → issue #42\n- `fix/42-description` → issue #42\n\n### Clarifying Questions\n\nFocus on critical ambiguities:\n\n1. **Problem Definition**: \"What specific problem does this solve?\"\n2. **Scope Boundaries**: \"What should it NOT do?\" (prevents scope creep)\n3. **Success Criteria**: \"How do we know it's done?\"\n4. **Technical Constraints**: \"Any existing patterns to follow?\"\n5. **Dependencies**: \"What does this depend on?\"\n\n### Story Sizing Rule\n\n> Each story must be completable in ONE Ralph iteration (one context window).\n\n**Split indicators:**\n- Description exceeds 2-3 sentences\n- More than 6 acceptance criteria\n- Changes more than 3 files\n\n### Acceptance Criteria Format\n\n**Required for ALL stories:**\n- `Typecheck passes`\n- `Unit tests pass` (or specific test file)\n\n**For UI stories, add:**\n- `Verify in browser` or E2E test reference\n\n**Good criteria are:**\n\n| Trait | Good Example | Bad Example |\n|-------|--------------|-------------|\n| Verifiable | \"Email format is validated\" | \"Works correctly\" |\n| Measurable | \"Response time < 200ms\" | \"Is fast\" |\n| Specific | \"GET /api/users returns 200\" | \"API works\" |\n\n### Output Files\n\nAfter `/ralph-hybrid-plan` completes:\n\n```\n.ralph-hybrid/{feature}/\n├── spec.md           # Full specification (human-readable)\n├── prd.json          # Machine-readable task list\n├── progress.txt      # Empty, ready for iterations\n└── specs/            # Additional detailed specs (optional)\n```\n\n### Usage\n\n```bash\n# In Claude Code session:\n/ralph-hybrid-plan Add user authentication with JWT\n\n# Follow interactive prompts...\n\n# After planning completes:\nralph-hybrid run\n```\n\n---\n\n## Amendment System\n\nPlans evolve during implementation. Edge cases emerge. Stakeholders clarify requirements. The amendment system handles scope changes without losing progress.\n\n### Philosophy\n\n> **\"No plan survives first contact with implementation.\"**\n\nTraditional workflows force a choice between:\n- Manual prd.json edits (risky, loses context)\n- Starting over (loses progress)\n- Hoping the AI remembers verbal changes (it won't)\n\nRalph Hybrid treats scope changes as **expected, not exceptional**.\n\n### Commands\n\n| Command | Purpose |\n|---------|---------|\n| `/ralph-hybrid-amend add <description>` | Add new requirement discovered during implementation |\n| `/ralph-hybrid-amend correct <story-id> <description>` | Fix or clarify existing story |\n| `/ralph-hybrid-amend remove <story-id> <reason>` | Descope story (archived, not deleted) |\n| `/ralph-hybrid-amend status` | View amendment history and current state |\n\n### Amendment Modes\n\n#### ADD Mode\n\nAdds new requirements discovered during implementation.\n\n**Workflow:**\n```\n1. VALIDATE   - Confirm feature folder exists\n2. CLARIFY    - Mini-planning session (2-3 questions max)\n3. DEFINE     - Create acceptance criteria\n4. SIZE       - Check if story needs splitting\n5. INTEGRATE  - Update spec.md and prd.json\n6. LOG        - Record amendment in progress.txt\n7. CONFIRM    - Show summary\n```\n\n**Key behaviors:**\n- Asks focused clarifying questions (max 3)\n- Generates proper acceptance criteria\n- Assigns priority (usually after existing stories)\n- Preserves all existing `passes: true` stories\n\n#### CORRECT Mode\n\nFixes or clarifies existing story requirements.\n\n**Workflow:**\n```\n1. VALIDATE   - Confirm story exists\n2. SHOW       - Display current definition\n3. IDENTIFY   - What needs to change?\n4. WARN       - If passes: true, warn about reset\n5. UPDATE     - Modify spec.md and prd.json\n6. LOG        - Record correction in progress.txt\n7. CONFIRM    - Show diff and summary\n```\n\n**Key behaviors:**\n- Shows current story before changes\n- Warns if correcting completed (`passes: true`) story\n- Resets `passes` to `false` if story was complete (requires re-verification)\n- Logs before/after for audit trail\n\n#### REMOVE Mode\n\nDescopes a story (moves elsewhere, no longer needed, etc.).\n\n**Workflow:**\n```\n1. VALIDATE   - Confirm story exists\n2. SHOW       - Display story and status\n3. CONFIRM    - Require reason for removal\n4. ARCHIVE    - Move to Descoped section (never deleted)\n5. UPDATE     - Remove from active prd.json stories\n6. LOG        - Record removal in progress.txt\n7. CONFIRM    - Show summary\n```\n\n**Key behaviors:**\n- Stories are **never deleted** - moved to \"Descoped Stories\" section\n- Requires explicit reason\n- Warns about dependencies (if other stories depend on this one)\n- Full audit trail preserved\n\n### Amendment ID Format\n\n```\nAMD-001  # First amendment\nAMD-002  # Second amendment\nAMD-NNN  # Sequential within feature\n```\n\n**Rules:**\n- Unique per feature (not global)\n- Never reused (even if amendment is reverted)\n- Referenced in spec.md, prd.json, and progress.txt\n\n### File Updates\n\nEach amendment updates three files consistently:\n\n#### spec.md Updates\n\nAmendments are recorded in a dedicated section:\n\n```markdown\n---\n\n## Amendments\n\n### AMD-001: CSV Export (2026-01-09T14:32:00Z)\n\n**Type:** ADD\n**Reason:** User needs data export for external reporting\n**Added by:** /ralph-hybrid-amend\n\n#### STORY-004: Export data as CSV\n\n**As a** user\n**I want to** export my data as CSV\n**So that** I can analyze it in spreadsheets\n\n**Acceptance Criteria:**\n- [ ] Export button visible on data list view\n- [ ] Clicking export downloads CSV file\n- [ ] Typecheck passes\n- [ ] Unit tests pass\n\n**Priority:** 2\n\n---\n\n### AMD-002: STORY-003 Correction (2026-01-09T15:10:00Z)\n\n**Type:** CORRECT\n**Target:** STORY-003 - Validate user input\n**Reason:** Email validation was underspecified\n\n**Changes:**\n| Field | Before | After |\n|-------|--------|-------|\n| Acceptance Criteria #1 | Email field is required | Email validated against RFC 5322 |\n\n**Status Impact:** passes reset to false\n\n---\n\n## Descoped Stories\n\n### STORY-005: Advanced filtering (Removed AMD-003)\n\n**Removed:** 2026-01-09T16:00:00Z\n**Reason:** Moved to separate issue #47 for Phase 2\n**Status at removal:** passes: false\n\n**Original Definition:**\n[full story preserved here]\n```\n\n#### prd.json Updates\n\nStories include amendment metadata:\n\n```json\n{\n  \"id\": \"STORY-004\",\n  \"title\": \"Export data as CSV\",\n  \"description\": \"As a user I want to export my data as CSV...\",\n  \"acceptanceCriteria\": [\"...\"],\n  \"priority\": 2,\n  \"passes\": false,\n  \"notes\": \"\",\n  \"amendment\": {\n    \"id\": \"AMD-001\",\n    \"type\": \"add\",\n    \"timestamp\": \"2026-01-09T14:32:00Z\",\n    \"reason\": \"User needs data export for external reporting\"\n  }\n}\n```\n\nFor corrections:\n\n```json\n{\n  \"amendment\": {\n    \"id\": \"AMD-002\",\n    \"type\": \"correct\",\n    \"timestamp\": \"2026-01-09T15:10:00Z\",\n    \"reason\": \"Email validation was underspecified\",\n    \"changes\": {\n      \"acceptanceCriteria\": {\n        \"before\": [\"Email field is required\"],\n        \"after\": [\"Email validated against RFC 5322\"]\n      },\n      \"passesReset\": true\n    }\n  }\n}\n```\n\n#### progress.txt Updates\n\nAmendments are logged with full context:\n\n```\n---\n## Amendment AMD-001: 2026-01-09T14:32:00Z\n\nType: ADD\nCommand: /ralph-hybrid-amend add \"Users need CSV export for reporting\"\n\nAdded Stories:\n  - STORY-004: Export data as CSV (priority: 2)\n\nReason: User needs data export for external reporting\n\nFiles Updated:\n  - spec.md: Added Amendments section\n  - prd.json: Added STORY-004\n\nContext: Discovered during STORY-002 implementation that users\nneed to export filtered results for monthly reporting.\n\n---\n```\n\n### Edge Cases\n\n#### Adding to Completed Feature\n\n```\n/ralph-hybrid-amend add \"One more thing...\"\n\n⚠️  All stories currently pass. Adding new story will:\n  - Mark feature incomplete\n  - Require additional Ralph runs\n\nProceed? (y/N)\n```\n\n#### Correcting a Blocking Story\n\n```\n/ralph-hybrid-amend correct STORY-001 \"Change API contract\"\n\n⚠️  STORY-001 is a dependency for:\n  - STORY-002 (passes: true)\n  - STORY-003 (passes: false)\n\nCorrecting may invalidate dependent stories.\nReset all dependent stories? (y/N/select)\n```\n\n#### Removing a Story with Dependents\n\n```\n/ralph-hybrid-amend remove STORY-002 \"Not needed\"\n\n⚠️  STORY-002 blocks:\n  - STORY-003 (passes: false)\n  - STORY-004 (passes: false)\n\nOptions:\n  A) Remove STORY-002, keep dependent stories\n  B) Remove STORY-002 and all dependent stories\n  C) Cancel\n\nChoice:\n```\n\n### Integration with Ralph Loop\n\nThe prompt template acknowledges amendments:\n\n```markdown\n## Amendment Awareness\n\nWhen you see stories with `amendment` field in prd.json:\n- These were added/modified after initial planning\n- Check progress.txt for context on why\n- Amendments marked with AMD-XXX in spec.md have full details\n\nAmendments are normal. Plans evolve. Implement them like any other story.\n```\n\n### Preflight Validation\n\nThe sync check (see [Preflight Validation](#preflight-validation)) validates amendments:\n\n| Check | Severity | Description |\n|-------|----------|-------------|\n| Amendment IDs unique | ERROR | No duplicate AMD-NNN within feature |\n| Amendment referenced | WARN | Stories with `amendment` field should have matching AMD in spec.md |\n| Descoped stories archived | ERROR | Removed stories must be in Descoped section |\n\n---\n\n## PRD Format\n\n### Schema (prd.json)\n\nThe prd.json file is a **derived artifact** generated from spec.md by `/ralph-hybrid-plan --regenerate`. It provides machine-readable task state for the Ralph loop.\n\n> **Note:** The feature identifier is derived from the current git branch name. No `feature` or `branchName` fields are needed in prd.json.\n\n```json\n{\n  \"description\": \"string\",\n  \"createdAt\": \"ISO-8601\",\n  \"userStories\": [\n    {\n      \"id\": \"string\",\n      \"title\": \"string\",\n      \"description\": \"string\",\n      \"acceptanceCriteria\": [\"string\"],\n      \"priority\": \"number (1=highest)\",\n      \"passes\": \"boolean\",\n      \"notes\": \"string\",\n      \"spec_ref\": \"string (optional, path to detailed spec)\",\n      \"model\": \"string (optional, e.g., opus, sonnet, haiku)\",\n      \"mcpServers\": [\"string\"] // optional, MCP server names\n    }\n  ]\n}\n```\n\n### Field Specifications\n\n| Field | Type | Required | Description |\n|-------|------|----------|-------------|\n| `description` | string | Yes | High-level feature description |\n| `createdAt` | ISO-8601 | Yes | Creation timestamp |\n| `userStories` | array | Yes | List of stories |\n| `userStories[].id` | string | Yes | Unique identifier (e.g., STORY-001 or STORY-002.1 for inserted stories) |\n| `userStories[].title` | string | Yes | Short title |\n| `userStories[].description` | string | No | User story or description |\n| `userStories[].acceptanceCriteria` | array | Yes | Testable criteria |\n| `userStories[].priority` | number | Yes | 1 = highest |\n| `userStories[].passes` | boolean | Yes | Completion status (updated by Claude) |\n| `userStories[].notes` | string | No | Agent notes, blockers |\n| `userStories[].spec_ref` | string | No | Path to detailed spec file (e.g., \"specs/validation.spec.md\") |\n| `userStories[].model` | string | No | Claude model for this story (opus, sonnet, haiku, or full claude-* name). Overrides CLI `--model` flag. |\n| `userStories[].mcpServers` | array | No | MCP server names for this story. Empty array `[]` = no MCP. Omitted = use global config. |\n| `userStories[].amendment` | object | No | Amendment metadata (if added/modified via /ralph-hybrid-amend) |\n| `userStories[].amendment.id` | string | Yes* | Amendment ID (e.g., AMD-001) |\n| `userStories[].amendment.type` | string | Yes* | \"add\", \"correct\", or \"remove\" |\n| `userStories[].amendment.timestamp` | ISO-8601 | Yes* | When amendment was made |\n| `userStories[].amendment.reason` | string | Yes* | Why the amendment was made |\n| `userStories[].amendment.changes` | object | No | For corrections: before/after values |\n\n*Required if `amendment` object is present\n\n### Decimal Story IDs\n\nStories can have decimal IDs (e.g., `STORY-002.1`) to support insertion without renumbering:\n\n```\nSTORY-001\nSTORY-002\nSTORY-002.1   ← Inserted after STORY-002\nSTORY-002.2   ← Another insertion\nSTORY-003\n```\n\n**Key Properties:**\n- Created via `/ralph-hybrid-amend add --insert-after STORY-002`\n- Decimal parts are treated as integers: STORY-002.9 < STORY-002.10\n- Existing story numbers are never changed\n- Stories automatically sort by their numeric value\n\n**ID Format:** `STORY-NNN` or `STORY-NNN.D` where:\n- `NNN` = one or more digits (e.g., 001, 12, 123)\n- `D` = optional decimal part, one or more digits (e.g., 1, 10, 99)\n\n**Functions (lib/prd.sh):**\n- `prd_validate_story_id()` - Validates ID format\n- `prd_parse_story_id()` - Extracts numeric value\n- `prd_compare_story_ids()` - Compares two IDs (-1, 0, 1)\n- `prd_sort_stories_by_id()` - Returns sorted story array\n- `prd_insert_story_after()` - Inserts with auto-generated decimal ID\n- `prd_get_next_decimal_id()` - Gets next available decimal ID\n\n### Per-Story Model and MCP Configuration\n\nStories can optionally specify custom Claude model and MCP server configurations, allowing different stories to use different resources based on their complexity and requirements.\n\n#### Model Configuration\n\nThe `model` field overrides the CLI `--model` flag for a specific story:\n\n```json\n{\n  \"id\": \"STORY-001\",\n  \"title\": \"Complex algorithm\",\n  \"model\": \"opus\",  // Use opus for complex reasoning\n  ...\n}\n```\n\n**Precedence:** story-level `model` > CLI `--model` flag > default\n\n**Valid values:** `opus`, `sonnet`, `haiku`, or full model names like `claude-opus-4-5-20251101`\n\n#### MCP Server Configuration\n\nThe `mcpServers` field controls which MCP servers are available during story execution:\n\n| Configuration | Behavior |\n|--------------|----------|\n| Field omitted | Uses global MCP config (all enabled servers) |\n| `\"mcpServers\": []` | Explicitly disables all MCP servers |\n| `\"mcpServers\": [\"playwright\"]` | Only specified servers available |\n\nWhen `mcpServers` is specified (including empty array), Ralph uses `--strict-mcp-config` to restrict available servers.\n\n**Example configurations:**\n\n```json\n// Backend story - no MCP needed\n{\n  \"id\": \"STORY-001\",\n  \"title\": \"Create data model\",\n  \"mcpServers\": []\n}\n\n// UI testing story - only Playwright\n{\n  \"id\": \"STORY-002\",\n  \"title\": \"Write E2E tests\",\n  \"mcpServers\": [\"playwright\"]\n}\n\n// UI debugging - Chrome DevTools\n{\n  \"id\": \"STORY-003\",\n  \"title\": \"Fix console errors\",\n  \"mcpServers\": [\"chrome-devtools\"]\n}\n```\n\n**MCP server names** must match servers registered with `claude mcp add`. Preflight validation ensures all specified servers are configured.\n\n---\n\n## Spec Format\n\n### Schema (spec.md)\n\nThe spec.md file is a human-readable specification generated by `/ralph-hybrid-plan`. It serves as the source of truth for feature requirements.\n\n### Spec Files (specs/ directory)\n\nThe `specs/` directory within each feature folder provides a central location for detailed feature specifications that supplement the main `spec.md` file.\n\n#### Purpose\n\n| Use Case | Description |\n|----------|-------------|\n| Complex features | Break large features into separate, focused spec files |\n| Domain documentation | Document domain concepts, business rules, data models |\n| API contracts | Define API schemas, endpoints, request/response formats |\n| Integration specs | Document external service integrations |\n| Reusable components | Spec files can be referenced across multiple stories |\n\n#### Directory Structure\n\n```\n.ralph-hybrid/{feature-name}/\n├── spec.md                    # Main specification (required)\n├── prd.json                   # Machine-readable tasks (required)\n├── progress.txt               # Iteration log (required)\n└── specs/                     # Detailed specifications (optional)\n    ├── api-design.spec.md     # API endpoint specifications\n    ├── data-model.spec.md     # Database schema, entities\n    ├── validation.spec.md     # Input validation rules\n    └── error-handling.spec.md # Error codes, messages\n```\n\n#### Naming Conventions\n\n| Pattern | Use Case | Example |\n|---------|----------|---------|\n| `{topic}.spec.md` | General spec file | `api-design.spec.md` |\n| `{story-id}.spec.md` | Story-specific details | `STORY-003.spec.md` |\n| `{domain}.spec.md` | Domain documentation | `authentication.spec.md` |\n\n#### Spec File Structure\n\nEach spec file follows a consistent structure:\n\n```markdown\n---\ncreated: {ISO-8601}\nrelated_stories: [STORY-001, STORY-002]\n---\n\n# {Topic Title}\n\n## Overview\n\n{Brief description of what this spec covers}\n\n## Details\n\n{Detailed specifications, requirements, or documentation}\n\n## Examples\n\n{Code examples, API request/response samples, etc.}\n\n## References\n\n- Link to external documentation\n- Related spec files\n```\n\n#### Relationship to prd.json\n\nStories in `prd.json` can reference spec files via the optional `spec_ref` field:\n\n```json\n{\n  \"id\": \"STORY-003\",\n  \"title\": \"Validate user input\",\n  \"spec_ref\": \"specs/validation.spec.md\",\n  \"acceptanceCriteria\": [\"...\"],\n  \"passes\": false\n}\n```\n\nThis enables:\n- **Traceability**: Link stories to their detailed specifications\n- **Context**: Agent can read referenced spec for implementation details\n- **Organization**: Keep `spec.md` concise, details in `specs/`\n\n#### How Ralph Uses Spec Files\n\n1. **During planning** (`/ralph-hybrid-plan`): Complex requirements generate additional spec files\n2. **During implementation** (Ralph loop): Agent reads `specs/` for detailed requirements\n3. **During amendments** (`/ralph-hybrid-amend`): New specs can be created for added requirements\n\nThe prompt template instructs the agent to check `specs/` for detailed requirements:\n\n```markdown\n## Context Files\n- **specs/**: Detailed requirements and specifications\n```\n\n#### Best Practices\n\n1. **Keep spec.md high-level**: Use specs/ for implementation details\n2. **One topic per file**: Each spec file should focus on one concern\n3. **Link from stories**: Use `spec_ref` to connect stories to relevant specs\n4. **Include examples**: Code samples, API examples aid implementation\n5. **Update with amendments**: When requirements change, update relevant specs\n\n### Structure\n\n```markdown\n---\ncreated: {ISO-8601}\n---\n\n# {Feature Title}\n\n<!-- Feature folder: .ralph-hybrid/{branch-name}/ (derived from git branch) -->\n\n## Problem Statement\n{Description of the problem being solved}\n\n## Success Criteria\n- [ ] {High-level measurable outcome}\n\n## User Stories\n\n### STORY-001: {Title}\n**As a** {user type}\n**I want to** {goal}\n**So that** {benefit}\n\n**Acceptance Criteria:**\n- [ ] {Specific, testable criterion}\n- [ ] Typecheck passes\n- [ ] Unit tests pass\n\n**Technical Notes:**\n- {Implementation hints}\n\n## Out of Scope\n- {Explicitly excluded features}\n\n## Open Questions\n- {Unresolved decisions}\n\n---\n\n## Amendments\n<!-- Added by /ralph-hybrid-amend - DO NOT manually edit this section -->\n\n### AMD-001: {Title} ({ISO-8601})\n\n**Type:** ADD | CORRECT | REMOVE\n**Reason:** {Why the amendment was made}\n**Added by:** /ralph-hybrid-amend\n\n{Story definition for ADD, change table for CORRECT}\n\n---\n\n## Descoped Stories\n<!-- Stories removed via /ralph-hybrid-amend remove - preserved for audit trail -->\n\n### {STORY-ID}: {Title} (Removed {AMD-ID})\n\n**Removed:** {ISO-8601}\n**Reason:** {Why removed}\n**Status at removal:** passes: true|false\n\n**Original Definition:**\n{Full story preserved here}\n```\n\n### Frontmatter Fields\n\n| Field | Type | Required | Description |\n|-------|------|----------|-------------|\n| `created` | ISO-8601 | Yes | Creation timestamp |\n\n> **Note:** No `feature` or `branch` fields. The feature is identified by the folder path, which is derived from the current git branch (e.g., branch `feature/user-auth` → folder `.ralph-hybrid/feature-user-auth/`).\n\n### Story Format\n\nEach story follows the user story format with structured sections:\n\n| Section | Purpose |\n|---------|---------|\n| **As a / I want / So that** | User perspective and motivation |\n| **Acceptance Criteria** | Testable requirements |\n| **Technical Notes** | Implementation guidance |\n\n### Best Practices\n\n1. **Keep stories small**: One context window per story\n2. **Be specific**: Avoid vague criteria like \"works correctly\"\n3. **Include tech checks**: Always include typecheck/test criteria\n4. **Document exclusions**: \"Out of Scope\" prevents scope creep\n5. **Capture decisions**: Document resolved \"Open Questions\"\n\n---\n\n## Progress Tracking\n\n### Format (progress.txt)\n\n```\n# Progress Log: <feature-name>\n# Started: <ISO-8601>\n\n---\nIteration: <N>\nDate: <ISO-8601>\nStory: <ID> - <Title>\nStatus: complete|in-progress|blocked\nFiles Changed:\n  - <path>\nTests Added:\n  - <test_name>\nLearnings:\n  - <insight>\nCommit: <hash>\n```\n\n### Amendment Log Format\n\nAmendments are logged in progress.txt with a distinct format:\n\n```\n---\n## Amendment AMD-001: <ISO-8601>\n\nType: ADD | CORRECT | REMOVE\nCommand: /ralph-hybrid-amend <mode> \"<description>\"\n\nAdded Stories:           # For ADD\n  - <ID>: <Title> (priority: N)\n\nCorrected Story:         # For CORRECT\n  - <ID>: <Title>\n  - Changes: <summary>\n  - Status Reset: yes|no\n\nRemoved Story:           # For REMOVE\n  - <ID>: <Title>\n  - Previous Status: passes: true|false\n\nReason: <why the amendment was made>\n\nFiles Updated:\n  - spec.md: <what changed>\n  - prd.json: <what changed>\n\nContext: <additional context from the amendment session>\n\n---\n```\n\n### Purpose\n\n| Use | Description |\n|-----|-------------|\n| Agent continuity | Agent reads to understand prior work |\n| Progress detection | Compare iterations to detect stuck loops |\n| **Amendment history** | Track scope changes and their rationale |\n| Post-mortem analysis | Review iteration patterns and amendments |\n| Prompt refinement | Identify what causes many iterations |\n| **Learning data** | Amendments show where initial planning fell short |\n\n---\n\n## Prompt Template\n\n### Default TDD Template (templates/prompt-tdd.md)\n\n```markdown\n# Ralph Agent Instructions\n\nYou are an autonomous development agent working through a PRD using TDD.\n\n**CRITICAL: You must complete exactly ONE story per session, then STOP.**\nEach session starts with fresh context. Memory persists via prd.json, progress.txt, and git commits.\n\n## Context Files\n\n- **prd.json**: User stories with `passes: true/false`\n- **progress.txt**: Previous iteration log (includes amendment history)\n- **specs/**: Detailed requirements\n- **spec.md**: Full specification (includes Amendments section)\n\n## Workflow\n\n1. Read prd.json, find highest priority story where `passes: false`\n2. Read progress.txt for prior context\n3. Read specs/ for detailed requirements\n4. Implement using TDD:\n   - Write failing test\n   - Implement to pass\n   - Run quality checks\n5. If checks pass:\n   - Commit changes\n   - Set `passes: true` in prd.json\n   - Append to progress.txt\n6. Signal completion and STOP:\n   - If ALL stories pass: output `<promise>COMPLETE</promise>` and STOP\n   - If more stories remain: output `<promise>STORY_COMPLETE</promise>` and STOP\n\n## Amendment Awareness\n\nStories may have an `amendment` field in prd.json. This means they were added\nor modified after initial planning via `/ralph-hybrid-amend`.\n\nWhen you see amended stories:\n- Check progress.txt for \"## Amendment AMD-XXX\" entries explaining why\n- Check spec.md \"## Amendments\" section for full context\n- Implement them like any other story - amendments are normal\n\n**Amendments are expected.** Plans evolve during implementation. Treat amended\nstories with the same rigor as original stories.\n\n## Rules\n\n- ONE story, then STOP - Complete exactly one story, signal, and stop\n- Signal when done - Output the appropriate promise tag and stop immediately\n- Tests first - Always write failing tests before implementation\n- Never commit broken code - All checks must pass\n- Document learnings in progress.txt\n- Treat amended stories the same as original stories\n```\n\n---\n\n## Safety Mechanisms\n\n### Circuit Breaker\n\n| Trigger | Threshold | Action |\n|---------|-----------|--------|\n| No progress | 3 consecutive iterations | Exit with code 1 |\n| Same error | 5 consecutive iterations | Exit with code 1 |\n\n**Progress detection**: Compare `passes` field values in prd.json before/after iteration.\n\n### Rate Limiting\n\n| Parameter | Default | Description |\n|-----------|---------|-------------|\n| Calls per hour | 100 | Maximum API calls |\n| Reset behavior | Wait | Pause until hour resets |\n\n### Per-Iteration Timeout\n\n| Parameter | Default | Description |\n|-----------|---------|-------------|\n| Timeout | 15 min | Kill iteration if exceeded |\n| Behavior | Fail | Counts as failed iteration |\n\n### API Limit Handling\n\n| Detection | Action |\n|-----------|--------|\n| \"usage limit\" in output | Prompt user: wait or exit |\n| No response in 30s | Auto-exit |\n\n---\n\n## Monitoring Dashboard (tmux)\n\nRalph Hybrid provides an optional tmux-based monitoring dashboard for real-time visibility into loop execution. This feature is adapted from [frankbria/ralph-claude-code](https://github.com/frankbria/ralph-claude-code).\n\n### Commands\n\n| Command | Description |\n|---------|-------------|\n| `ralph-hybrid run --monitor` | Start loop with integrated tmux dashboard |\n| `ralph-hybrid monitor` | Launch standalone dashboard (attach to running loop) |\n\n### Dashboard Display\n\nThe live dashboard shows:\n\n| Metric | Description |\n|--------|-------------|\n| Loop count | Current iteration number / max iterations |\n| Status | Running, paused, completed, or failed |\n| API usage | Calls used vs. rate limit (e.g., 45/100) |\n| Rate limit countdown | Time until limit resets |\n| Recent logs | Last N log entries from current iteration |\n| Progress | Stories completed vs. total |\n\n### Layout\n\n```\n┌─────────────────────────────────┬─────────────────────────────────┐\n│                                 │                                 │\n│        RALPH LOOP               │        MONITOR                  │\n│                                 │                                 │\n│  Claude Code output             │  Iteration: 5/20                │\n│  appears here                   │  Status: Running                │\n│                                 │  API: 45/100 (resets in 23m)    │\n│                                 │  Progress: 2/6 stories          │\n│                                 │                                 │\n│                                 │  Recent:                        │\n│                                 │  [12:34] Started STORY-003      │\n│                                 │  [12:35] Running tests...       │\n│                                 │  [12:36] Tests passed           │\n│                                 │                                 │\n└─────────────────────────────────┴─────────────────────────────────┘\n```\n\n### tmux Controls\n\n| Key | Action |\n|-----|--------|\n| `Ctrl+B D` | Detach from session (loop continues in background) |\n| `Ctrl+B ←/→` | Switch between panes |\n| `tmux attach -t ralph` | Reattach to detached session |\n| `tmux list-sessions` | List all active sessions |\n\n### Implementation\n\n| File | Purpose |\n|------|---------|\n| `lib/monitor.sh` | Dashboard rendering and update logic |\n| `logs/` | Directory for iteration logs |\n| `status.json` | Machine-readable status (for programmatic access) |\n\n### Status File Format (status.json)\n\n```json\n{\n  \"iteration\": 5,\n  \"maxIterations\": 20,\n  \"status\": \"running\",\n  \"feature\": \"user-authentication\",\n  \"storiesComplete\": 2,\n  \"storiesTotal\": 6,\n  \"apiCallsUsed\": 45,\n  \"apiCallsLimit\": 100,\n  \"rateLimitResetsAt\": \"2026-01-09T13:00:00Z\",\n  \"startedAt\": \"2026-01-09T12:00:00Z\",\n  \"lastUpdated\": \"2026-01-09T12:36:00Z\"\n}\n```\n\n### Prerequisites\n\n- tmux must be installed (`brew install tmux` or `apt-get install tmux`)\n- If tmux is not available, `--monitor` flag is ignored with a warning\n\n---\n\n## Exit Conditions\n\n### Iteration Exit Conditions\n\n| Condition | Result | Description |\n|-----------|--------|-------------|\n| Story complete signal | Next iteration | Output contains `<promise>STORY_COMPLETE</promise>` - fresh context for next story |\n| All stories complete | Feature complete | All `passes: true` |\n| Completion promise | Feature complete | Output contains `<promise>COMPLETE</promise>` |\n| Timeout | Next iteration | Iteration exceeded time limit |\n| API limit | Wait or exit | Claude usage limit reached |\n\n### Loop Exit Conditions\n\n| Condition | Exit Code | Description |\n|-----------|-----------|-------------|\n| All stories complete | 0 | All `passes: true` |\n| Completion promise | 0 | Output contains `<promise>COMPLETE</promise>` |\n| Max iterations | 1 | Reached limit |\n| Circuit breaker | 1 | No progress or repeated errors |\n| User interrupt | 130 | Ctrl+C |\n| API limit (exit chosen) | 2 | Claude 5-hour limit |\n\n### Fresh Context Model\n\nRalph enforces **one story per iteration** to ensure fresh context:\n\n```\n┌─────────────────────────────────────────────────────────────┐\n│  Iteration N                                                │\n│  ┌─────────────────────────────────────────────────────┐   │\n│  │  1. Read prd.json, progress.txt                     │   │\n│  │  2. Work on ONE story                               │   │\n│  │  3. Commit & update prd.json                        │   │\n│  │  4. Output <promise>STORY_COMPLETE</promise>        │   │\n│  │  5. STOP                                            │   │\n│  └─────────────────────────────────────────────────────┘   │\n└─────────────────────────────────────────────────────────────┘\n                              │\n                              ▼ Fresh context\n┌─────────────────────────────────────────────────────────────┐\n│  Iteration N+1                                              │\n│  ┌─────────────────────────────────────────────────────┐   │\n│  │  1. Read prd.json, progress.txt (has latest state)  │   │\n│  │  2. Work on NEXT story                              │   │\n│  │  ... (repeat)                                       │   │\n│  └─────────────────────────────────────────────────────┘   │\n└─────────────────────────────────────────────────────────────┘\n```\n\n**Why fresh context matters:**\n- Prevents context pollution from accumulated state\n- Ensures reliable, predictable execution\n- Memory persists via files (prd.json, progress.txt, git commits, memories.md)\n\n---\n\n## Memory System\n\nRalph Hybrid includes a memory system for persisting learnings across context resets. Unlike progress.txt (which logs what happened), memories capture reusable knowledge.\n\n### Memory File Format\n\nMemory files use markdown with four standard categories:\n\n```markdown\n# Memories\n\nAccumulated learnings and context for this project/feature.\n\n## Patterns\n\n<!-- Code patterns, architectural decisions, project conventions -->\n- [2024-01-15T10:30:00Z] [tags: api,rest] Use dependency injection for all service classes\n- [2024-01-16T14:00:00Z] [tags: testing] Always mock external APIs in unit tests\n\n## Decisions\n\n<!-- Why certain approaches were chosen -->\n- [2024-01-15T11:00:00Z] [tags: architecture] Chose Redux over Context for state management due to devtools support\n\n## Fixes\n\n<!-- Common issues and their solutions -->\n- [2024-01-15T16:00:00Z] [tags: auth,bug] Fixed race condition in auth flow by adding mutex lock\n\n## Context\n\n<!-- Project-specific context and domain knowledge -->\n- [2024-01-15T09:00:00Z] [tags: domain] User accounts must be verified before placing orders\n```\n\n### Memory Inheritance\n\nMemories are loaded from two levels:\n\n| Level | File Location | Purpose |\n|-------|---------------|---------|\n| Project | `.ralph-hybrid/memories.md` | Cross-feature learnings |\n| Feature | `.ralph-hybrid/{branch}/memories.md` | Feature-specific context |\n\nWhen both exist, they are combined with feature memories taking priority if token budget is limited.\n\n### Memory Functions\n\n| Function | Purpose |\n|----------|---------|\n| `load_memories(feature_dir, token_budget)` | Load combined memories within budget |\n| `write_memory(dir, category, content, tags)` | Append entry to memory file |\n| `memory_filter_by_tags(content, tags)` | Filter memories by tag |\n| `memory_load_with_tags(dir, tags, budget)` | Load and filter in one call |\n| `memory_get_for_iteration(dir, tags)` | Get formatted memories for prompt |\n\n### Tag-based Filtering\n\nMemory entries can include tags for filtering:\n\n```markdown\n- [2024-01-15T10:30:00Z] [tags: api,auth,security] Always validate JWT tokens server-side\n```\n\nFilter by tags to include only relevant memories:\n\n```bash\n# Load only auth-related memories\nmemories=$(memory_load_with_tags \"$feature_dir\" \"auth,security\" 2000)\n```\n\n### Token Budget\n\nMemories are automatically truncated to fit within the token budget:\n\n| Setting | Default | Description |\n|---------|---------|-------------|\n| `memory.token_budget` | 2000 | Max tokens (~8000 chars) for memory injection |\n\nToken calculation uses ~4 characters per token (conservative estimate).\n\n### Injection Modes\n\nConfigure how memories are injected into iteration prompts:\n\n| Mode | Description |\n|------|-------------|\n| `auto` | Automatically inject memories (default) |\n| `manual` | Only inject when explicitly requested |\n| `none` | Never inject memories |\n\nConfiguration in `config.yaml`:\n\n```yaml\nmemory:\n  token_budget: 2000\n  injection: auto  # auto, manual, or none\n```\n\nOr via environment variable:\n\n```bash\nexport RALPH_HYBRID_MEMORY_INJECTION=manual\nexport RALPH_HYBRID_MEMORY_TOKEN_BUDGET=3000\n```\n\n### Memory vs Progress\n\n| Aspect | progress.txt | memories.md |\n|--------|--------------|-------------|\n| Purpose | Log what happened | Store reusable knowledge |\n| Format | Chronological log | Categorized entries |\n| Growth | Grows each iteration | Curated, may be pruned |\n| Injection | Always included | Configurable (auto/manual/none) |\n| Tags | No | Yes |\n| Budget | No limit | Token budget enforced |\n\n### Example Usage\n\n**Writing a memory after fixing a bug:**\n\n```bash\nwrite_memory \"$FEATURE_DIR\" \"Fixes\" \"Fixed null pointer in auth by checking token existence first\" \"auth,bug\"\n```\n\n**Loading memories for a story with specific tags:**\n\n```bash\n# In iteration prompt, filtered to story-relevant tags\nmemories=$(memory_load_with_tags \"$FEATURE_DIR\" \"auth,api\" 2000)\n```\n\n---\n\n## Extensibility Hooks\n\nRalph Hybrid provides a hooks system for extending and customizing behavior at various points during execution.\n\n### Hook Points\n\n| Hook Point | When Triggered | Use Cases |\n|------------|----------------|-----------|\n| `pre_run` | Before the run loop starts | Setup, notifications, validation |\n| `post_run` | After the run loop completes | Cleanup, notifications, reporting |\n| `pre_iteration` | Before each iteration | Custom logging, rate limiting |\n| `post_iteration` | After each iteration | Progress notifications, custom metrics |\n| `on_completion` | When feature completes successfully | Deployment triggers, notifications |\n| `on_error` | When an error occurs (circuit breaker, max iterations) | Error reporting, cleanup |\n\n### Hook Directory Structure\n\n```\n<project>/\n└── .ralph-hybrid/\n    ├── <feature-name>/\n    │   └── hooks/                      # Feature-specific hooks\n    │       ├── pre_run.sh\n    │       ├── post_run.sh\n    │       ├── pre_iteration.sh\n    │       ├── post_iteration.sh\n    │       ├── on_completion.sh\n    │       └── on_error.sh\n    └── hooks/                          # Global hooks (future)\n```\n\n### Creating Hook Scripts\n\nHook scripts are bash scripts placed in the `.ralph-hybrid/<feature>/hooks/` directory. They are named after the hook point they handle.\n\n**Example: post_iteration.sh**\n\n```bash\n#!/bin/bash\n# Run after each iteration\n\necho \"Iteration $RALPH_ITERATION completed\"\n\n# Example: Send Slack notification\n# curl -X POST \"$SLACK_WEBHOOK_URL\" \\\n#   -H 'Content-Type: application/json' \\\n#   -d \"{\\\"text\\\":\\\"Iteration $RALPH_ITERATION completed for $RALPH_FEATURE_NAME\\\"}\"\n\n# Example: Run custom validation\n# ./scripts/validate.sh\n\n# Example: Log to external service\n# curl -X POST \"https://api.example.com/logs\" \\\n#   -d \"feature=$RALPH_FEATURE_NAME&iteration=$RALPH_ITERATION\"\n```\n\nMake hooks executable: `chmod +x .ralph-hybrid/<feature>/hooks/post_iteration.sh`\n\n### Environment Variables in Hooks\n\nThe following environment variables are available to hook scripts:\n\n| Variable | Description | Available In |\n|----------|-------------|--------------|\n| `RALPH_HOOK_POINT` | Current hook point being executed | All hooks |\n| `RALPH_ITERATION` | Current iteration number | `pre_iteration`, `post_iteration` |\n| `RALPH_FEATURE_DIR` | Path to feature directory | All hooks |\n| `RALPH_PRD_FILE` | Path to prd.json | All hooks |\n| `RALPH_FEATURE_NAME` | Name of the current feature | All hooks |\n| `RALPH_RUN_STATUS` | Run outcome: \"complete\", \"error\", \"user_exit\" | `post_run` |\n| `RALPH_ERROR_TYPE` | Error type: \"circuit_breaker\", \"max_iterations\" | `on_error` |\n\n### Programmatic Hook Registration\n\nHooks can also be registered programmatically in bash:\n\n```bash\n# Register a function as a hook\nmy_custom_hook() {\n    echo \"Custom hook called with iteration: $RALPH_ITERATION\"\n}\n\nsource lib/hooks.sh\nhk_register \"post_iteration\" \"my_custom_hook\"\n```\n\n### Custom Completion Patterns\n\nIn addition to the built-in completion signal (`<promise>COMPLETE</promise>`), you can define custom patterns in configuration:\n\n**In config.yaml:**\n\n```yaml\ncompletion:\n  promise: \"<promise>COMPLETE</promise>\"      # Built-in (default)\n  custom_patterns: \"DONE,FINISHED,ALL_COMPLETE\"  # Additional patterns\n```\n\n**Or via environment variable:**\n\n```bash\nexport RALPH_CUSTOM_COMPLETION_PATTERNS=\"DONE,FINISHED,ALL_COMPLETE\"\n```\n\nCustom patterns are checked in addition to the built-in pattern. All patterns require that all stories have `passes: true` for completion to be triggered.\n\n### Configuration\n\nHooks can be disabled via configuration:\n\n```yaml\nhooks:\n  enabled: true  # Set to false to disable all hooks\n```\n\nOr via environment variable:\n\n```bash\nexport RALPH_HOOKS_ENABLED=false\n```\n\n### Hook Execution Behavior\n\n1. **Isolation**: Hook scripts run in a subshell to prevent unintended side effects\n2. **Failure handling**: Hook failures are logged as warnings but do not stop the main loop\n3. **Execution order**: Registered function hooks run before directory-based hooks\n4. **Multiple hooks**: Multiple hooks can be registered for the same hook point\n\n### Use Cases\n\n| Use Case | Hook Point | Example |\n|----------|------------|---------|\n| Slack notifications | `post_iteration`, `on_completion` | Notify team of progress |\n| Custom metrics | `post_iteration` | Send to monitoring system |\n| Pre-run validation | `pre_run` | Check external dependencies |\n| Deployment triggers | `on_completion` | Trigger CI/CD pipeline |\n| Error alerting | `on_error` | Page on-call engineer |\n| Custom cleanup | `post_run` | Clean up temp files |\n\n---\n\n## Template Library\n\nRalph Hybrid includes a template library for skills, scripts, and hooks that can be customized per-feature. These templates are designed to reduce tool calls during execution and enforce best practices.\n\n### Template Types\n\n| Type | Purpose | Location |\n|------|---------|----------|\n| **Skills** | Claude instructions for specific patterns (migration, visual parity) | `templates/skills/` |\n| **Scripts** | Bash scripts that batch operations (reduce tool calls) | `templates/scripts/` |\n| **Hooks** | Pre/post iteration automation (visual regression, notifications) | `templates/hooks/` |\n\n### Available Templates\n\n#### Skills\n\n| Template | Use When | Description |\n|----------|----------|-------------|\n| `visual-parity-migration.md` | Migrating UI frameworks | Enforces verbatim class copying, CSS variable auditing, visual regression validation |\n| `adversarial-review.md` | Security-focused code review | Red team/blue team pattern for finding injection, auth bypass, data exposure, race conditions |\n| `code-archaeology.md` | Legacy code modification | Four-role pattern (Surveyor, Historian, Archaeologist, Careful Modifier) for safe legacy changes |\n| `incident-response.md` | Production incidents | OODA loop pattern (Observer, Mitigator, Investigator, Fixer) with speed vs thoroughness separation |\n| `integration-checker.md` | Feature completion validation | Verifies exports used, routes have consumers, auth on sensitive routes, end-to-end flow tracing |\n\n#### Scripts\n\n| Template | Use When | Description |\n|----------|----------|-------------|\n| `css-audit.sh` | CSS/styling work | Audits CSS variable usage vs definitions, reports undefined variables |\n| `endpoint-validation.sh` | API/route work | Batch validates all endpoints at once, returns JSON report |\n| `file-inventory.sh` | Large features | Pre-reads relevant files by category, reduces repeated file reads |\n| `template-comparison.sh` | Framework migration | Compares source vs target class usage, reports missing classes |\n\n#### Hooks\n\n| Template | Use When | Description |\n|----------|----------|-------------|\n| `post-iteration-visual-diff.sh` | Visual parity requirements | Screenshots pages and compares against baseline, reports pixel differences |\n\n### Template Flow\n\nTemplates are copied and customized per-feature during planning:\n\n```\nralph-hybrid/templates/           ← Generic templates (this repo)\n├── skills/visual-parity-migration.md\n├── skills/adversarial-review.md\n├── skills/code-archaeology.md\n├── skills/incident-response.md\n├── skills/integration-checker.md\n├── scripts/css-audit.sh\n└── hooks/post-iteration-visual-diff.sh\n\n                    │ ralph-plan detects patterns\n                    ▼\n\n.ralph-hybrid/{feature}/          ← Customized per-feature\n├── skills/visual-parity-migration.md   ← Customized for project\n├── skills/adversarial-review.md        ← Security review skill\n├── skills/code-archaeology.md          ← Legacy code investigation skill\n├── skills/incident-response.md         ← Production incident handling skill\n├── skills/integration-checker.md       ← Feature integration validation skill\n├── scripts/css-audit.sh                ← Configured with project paths\n└── hooks/post-iteration-visual-diff.sh ← Configured with URLs\n```\n\n### Pattern Detection\n\nThe `/ralph-hybrid-plan` command detects patterns in the epic description and proposes relevant templates:\n\n| Pattern | Detection Keywords | Proposed Assets |\n|---------|-------------------|-----------------|\n| Framework Migration | migrate, convert, port, React, Jinja2 | visual-parity skill, css-audit, template-comparison |\n| Visual Parity | match styling, same look, pixel perfect | visual-parity skill, visual-diff hook |\n| API Changes | endpoint, REST, routes | endpoint-validation script |\n| Large Codebase | many files, multiple subsystems | file-inventory script |\n| Security Review | auth, login, password, security, encrypt, token, session | adversarial-review skill |\n| Legacy Code | legacy, old, refactor, migrate, ancient, technical debt, modernize | code-archaeology skill |\n| Incident Response | incident, outage, down, production, alert, emergency, urgent, critical, SEV-1, SEV-2 | incident-response skill |\n\n### Script Output Format\n\nAll scripts output JSON for easy parsing by Claude:\n\n```json\n{\n  \"audit\": \"css-variables\",\n  \"summary\": {\n    \"variables_used\": 15,\n    \"variables_defined\": 12,\n    \"variables_undefined\": 3,\n    \"status\": \"fail\"\n  },\n  \"undefined\": [\"--color-bg-surface\", \"--color-text-primary\", \"--border-hover\"]\n}\n```\n\nHuman-readable summaries are written to stderr so Claude sees the JSON on stdout.\n\n### Tool Call Reduction\n\nThe template scripts are designed to reduce tool calls:\n\n| Without Script | With Script |\n|----------------|-------------|\n| 50 curl calls (one per endpoint) | 1 endpoint-validation.sh call |\n| 19 file reads (same file repeatedly) | 1 file-inventory.sh call |\n| 30 grep commands (CSS variables) | 1 css-audit.sh call |\n\nTarget: Reduce average tool calls from 74 per iteration to <50.\n\n---\n\n## Installation\n\n### Prerequisites\n\n- Bash 4.0+\n- Claude Code CLI\n- jq\n- Git\n- timeout (coreutils)\n\n### Install\n\n```bash\n# Clone and install globally\ngit clone https://github.com/krazyuniks/ralph-hybrid.git\ncd ralph-hybrid\n./install.sh                # installs to ~/.ralph-hybrid/\n```\n\nThe install script:\n1. Copies files to `~/.ralph-hybrid/` (ralph, lib/, templates/, commands/)\n2. Creates default config.yaml\n\nAfter installation, add `~/.ralph-hybrid` to your PATH:\n\n```bash\n# Add to your shell config (e.g., ~/.zshrc, ~/.bashrc, or your dotfiles)\nexport PATH=\"$HOME/.ralph-hybrid:$PATH\"\n```\n\nThen restart your shell or source your config file. The cloned repo can be deleted.\n\n### Project Setup\n\n```bash\n# In each project where you want to use Ralph:\ncd your-project\nralph-hybrid setup                 # installs Claude commands to .claude/commands/\n```\n\nThe setup command copies `/ralph-hybrid-plan` and `/ralph-hybrid-amend` to your project's `.claude/commands/` directory. This is idempotent - running it again updates the commands.\n\n### Uninstall\n\n```bash\n./uninstall.sh\n# Or manually: rm -rf ~/.ralph-hybrid and remove PATH entry\n```\n\n### Verify Installation\n\n```bash\nralph --version\nralph-hybrid help\n```\n\n---\n\n## Testing\n\n### Framework\n\n[BATS](https://github.com/bats-core/bats-core) (Bash Automated Testing System)\n\n### Test Structure\n\n```\ntests/\n├── unit/\n│   ├── test_circuit_breaker.bats\n│   ├── test_rate_limiter.bats\n│   ├── test_exit_detection.bats\n│   └── test_utils.bats\n└── integration/\n    └── test_loop.bats\n```\n\n### Test Cases\n\n| Component | Test |\n|-----------|------|\n| Circuit breaker | Triggers at no_progress_threshold |\n| Circuit breaker | Triggers at same_error_threshold |\n| Circuit breaker | Resets on progress |\n| Rate limiter | Pauses at limit |\n| Rate limiter | Resets after hour |\n| Exit detection | Detects completion promise |\n| Exit detection | Detects all stories complete |\n| Progress detection | Detects passes field changes |\n| Archive | Creates timestamped directory |\n| Archive | Copies all feature files |\n| CLI | Parses all arguments correctly |\n| **Amendment** | ADD mode creates new story |\n| **Amendment** | ADD mode preserves existing passes:true stories |\n| **Amendment** | ADD mode generates sequential AMD-NNN IDs |\n| **Amendment** | CORRECT mode updates story |\n| **Amendment** | CORRECT mode warns on passes:true story |\n| **Amendment** | CORRECT mode resets passes to false |\n| **Amendment** | REMOVE mode archives to Descoped section |\n| **Amendment** | REMOVE mode never deletes story |\n| **Amendment** | STATUS mode shows amendment history |\n| **Amendment** | Updates spec.md Amendments section |\n| **Amendment** | Updates prd.json with amendment metadata |\n| **Amendment** | Logs to progress.txt |\n| **Preflight** | Validates amendment ID uniqueness |\n| **Preflight** | Validates descoped stories are archived |\n| **Hooks** | Registers hooks for valid hook points |\n| **Hooks** | Rejects registration for invalid hook points |\n| **Hooks** | Executes registered function hooks |\n| **Hooks** | Executes directory-based hook scripts |\n| **Hooks** | Handles hook failures gracefully |\n| **Hooks** | Custom completion patterns merge with built-in |\n| **Hooks** | Custom completion patterns require all stories complete |\n| **Hooks** | Hooks can be disabled via config |\n| **Hooks** | Hook environment variables are set correctly |\n\n### Running Tests\n\n```bash\n./run_tests.sh              # All tests\nbats tests/unit/            # Unit tests only\nbats tests/integration/     # Integration tests only\n```\n\n### Dependency Abstraction Layer (lib/deps.sh)\n\nThe `lib/deps.sh` module provides wrapper functions for external commands (`jq`, `date`, `git`, `claude`, `tmux`, `timeout`) that can be mocked in tests. This enables testing code paths that depend on external commands without actually invoking them.\n\n#### Available Wrappers\n\n| Function | Wraps | Mock Variable | Mock Function |\n|----------|-------|---------------|---------------|\n| `deps_jq` | `jq` | `RALPH_MOCK_JQ` | `_ralph_mock_jq` |\n| `deps_date` | `date` | `RALPH_MOCK_DATE` | `_ralph_mock_date` |\n| `deps_git` | `git` | `RALPH_MOCK_GIT` | `_ralph_mock_git` |\n| `deps_claude` | `claude` | `RALPH_MOCK_CLAUDE` | `_ralph_mock_claude` |\n| `deps_tmux` | `tmux` | `RALPH_MOCK_TMUX` | `_ralph_mock_tmux` |\n| `deps_timeout` | `timeout` | `RALPH_MOCK_TIMEOUT` | `_ralph_mock_timeout` |\n\n#### Mocking in Tests\n\n**Method 1: Mock Function Override**\n\n```bash\nsetup() {\n    source \"$PROJECT_ROOT/lib/deps.sh\"\n\n    # Enable mock\n    export RALPH_MOCK_JQ=1\n\n    # Define mock function\n    _ralph_mock_jq() {\n        case \"$1\" in\n            '.userStories | length')\n                echo \"5\"\n                ;;\n            *)\n                echo \"{}\"\n                ;;\n        esac\n    }\n}\n\nteardown() {\n    deps_reset_mocks\n}\n```\n\n**Method 2: Command Path Override**\n\n```bash\nexport RALPH_JQ_CMD=\"/path/to/mock_jq_script\"\n```\n\n#### Helper Functions\n\n| Function | Description |\n|----------|-------------|\n| `deps_check_available <cmd>` | Check if a command is available (real or mocked) |\n| `deps_check_all` | Check all required dependencies are available |\n| `deps_reset_mocks` | Reset all mock state (for test teardown) |\n| `deps_setup_simple_mock <cmd> <value>` | Set up a mock that returns a fixed value |\n\n#### Example: Testing get_feature_dir Without Git\n\n```bash\n@test \"get_feature_dir returns feature path from branch\" {\n    source \"$PROJECT_ROOT/lib/utils.sh\"\n\n    export RALPH_MOCK_GIT=1\n    _ralph_mock_git() {\n        case \"$1\" in\n            \"rev-parse\")\n                echo \".git\"\n                return 0\n                ;;\n            \"branch\")\n                echo \"feature/my-feature\"\n                ;;\n        esac\n    }\n\n    run get_feature_dir\n    [ \"$output\" = \".ralph-hybrid/feature-my-feature\" ]\n}\n```\n\n---\n\n## Version\n\n- **Spec Version**: 0.1.0\n- **Status**: Draft\n","structuredPatch":[{"oldStart":2278,"oldLines":6,"newStart":2278,"newLines":7,"lines":[" | Security Review | auth, login, password, security, encrypt, token, session | adversarial-review skill |"," | Legacy Code | legacy, old, refactor, migrate, ancient, technical debt, modernize | code-archaeology skill |"," | Incident Response | incident, outage, down, production, alert, emergency, urgent, critical, SEV-1, SEV-2 | incident-response skill |","+| Feature Integration | integrate, wire, connect, orphan, dead code, complete feature, verify integration | integration-checker skill |"," "," ### Script Output Format"," "]}],"userModified":false,"replaceAll":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01AVfeqezbStjY8cP3fEocL2","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the todos and commit."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":595,"cache_read_input_tokens":67427,"cache_creation":{"ephemeral_5m_input_tokens":595,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"a1047b5a-ccaa-49b7-b387-0be64ea9c133"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01AVfeqezbStjY8cP3fEocL2","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_011Tf7ofHCpft4KGfR7fVm9C","name":"TodoWrite","input":{"todos":[{"content":"Create templates/integration-checker.md with integration verification prompt","status":"completed","activeForm":"Creating integration checker template"},{"content":"Add integration checks for exports, routes, auth on sensitive routes","status":"completed","activeForm":"Adding integration checks"},{"content":"Add end-to-end flow tracing with break point identification","status":"completed","activeForm":"Adding flow tracing"},{"content":"Define INTEGRATION.md output format","status":"completed","activeForm":"Defining output format"},{"content":"Create unit tests for integration checker","status":"completed","activeForm":"Creating unit tests"},{"content":"Commit and update prd.json","status":"in_progress","activeForm":"Committing changes"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":595,"cache_read_input_tokens":67427,"cache_creation":{"ephemeral_5m_input_tokens":595,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"ff488472-8755-4d67-8b7d-31ae0c153147"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_011Tf7ofHCpft4KGfR7fVm9C","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"9dce1163-b587-4897-b845-e6cf624dc0c1","tool_use_result":{"oldTodos":[{"content":"Create templates/integration-checker.md with integration verification prompt","status":"completed","activeForm":"Creating integration checker template"},{"content":"Add integration checks for exports, routes, auth on sensitive routes","status":"completed","activeForm":"Adding integration checks"},{"content":"Add end-to-end flow tracing with break point identification","status":"completed","activeForm":"Adding flow tracing"},{"content":"Define INTEGRATION.md output format","status":"completed","activeForm":"Defining output format"},{"content":"Create unit tests for integration checker","status":"in_progress","activeForm":"Creating unit tests"},{"content":"Commit and update prd.json","status":"pending","activeForm":"Committing changes"}],"newTodos":[{"content":"Create templates/integration-checker.md with integration verification prompt","status":"completed","activeForm":"Creating integration checker template"},{"content":"Add integration checks for exports, routes, auth on sensitive routes","status":"completed","activeForm":"Adding integration checks"},{"content":"Add end-to-end flow tracing with break point identification","status":"completed","activeForm":"Adding flow tracing"},{"content":"Define INTEGRATION.md output format","status":"completed","activeForm":"Defining output format"},{"content":"Create unit tests for integration checker","status":"completed","activeForm":"Creating unit tests"},{"content":"Commit and update prd.json","status":"in_progress","activeForm":"Committing changes"}]}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FvEC6ocK69NAEVueDx7Y1Y","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01WQg9MdQ16SrwHfTQ2hP9yX","name":"Bash","input":{"command":"git status","description":"Check git status"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":294,"cache_read_input_tokens":68022,"cache_creation":{"ephemeral_5m_input_tokens":294,"ephemeral_1h_input_tokens":0},"output_tokens":26,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"87233c81-1db9-494d-b771-c4d087763f51"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01WQg9MdQ16SrwHfTQ2hP9yX","type":"tool_result","content":"On branch 33-adopt-gsd-ralph-orchestrator-features\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/logs/iteration-5.log\n\tmodified:   .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/logs/iteration-6.log\n\tmodified:   .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/logs/iteration-7.log\n\tmodified:   SPEC.md\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\ttemplates/integration-checker.md\n\ttests/unit/test_integration_checker.bats\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"518deba0-b039-4f3d-990a-d3cfc5cb4a13","tool_use_result":{"stdout":"On branch 33-adopt-gsd-ralph-orchestrator-features\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/logs/iteration-5.log\n\tmodified:   .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/logs/iteration-6.log\n\tmodified:   .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/logs/iteration-7.log\n\tmodified:   SPEC.md\n\nUntracked files:\n  (use \"git add <file>...\" to include in what will be committed)\n\ttemplates/integration-checker.md\n\ttests/unit/test_integration_checker.bats\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01NDXzPgXHh7toizaLzb8RLu","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016ibrnXszuiQTxxXNtTmmcZ","name":"Bash","input":{"command":"git diff SPEC.md | head -100","description":"Review SPEC.md changes"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":316,"cache_read_input_tokens":68316,"cache_creation":{"ephemeral_5m_input_tokens":316,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"499c0b6d-9648-44c3-82ed-81e4f7300875"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016ibrnXszuiQTxxXNtTmmcZ","type":"tool_result","content":"diff --git a/SPEC.md b/SPEC.md\nindex 73169b0..1386556 100644\n--- a/SPEC.md\n+++ b/SPEC.md\n@@ -2221,6 +2221,7 @@ Ralph Hybrid includes a template library for skills, scripts, and hooks that can\n | `adversarial-review.md` | Security-focused code review | Red team/blue team pattern for finding injection, auth bypass, data exposure, race conditions |\n | `code-archaeology.md` | Legacy code modification | Four-role pattern (Surveyor, Historian, Archaeologist, Careful Modifier) for safe legacy changes |\n | `incident-response.md` | Production incidents | OODA loop pattern (Observer, Mitigator, Investigator, Fixer) with speed vs thoroughness separation |\n+| `integration-checker.md` | Feature completion validation | Verifies exports used, routes have consumers, auth on sensitive routes, end-to-end flow tracing |\n \n #### Scripts\n \n@@ -2247,6 +2248,7 @@ ralph-hybrid/templates/           ← Generic templates (this repo)\n ├── skills/adversarial-review.md\n ├── skills/code-archaeology.md\n ├── skills/incident-response.md\n+├── skills/integration-checker.md\n ├── scripts/css-audit.sh\n └── hooks/post-iteration-visual-diff.sh\n \n@@ -2258,6 +2260,7 @@ ralph-hybrid/templates/           ← Generic templates (this repo)\n ├── skills/adversarial-review.md        ← Security review skill\n ├── skills/code-archaeology.md          ← Legacy code investigation skill\n ├── skills/incident-response.md         ← Production incident handling skill\n+├── skills/integration-checker.md       ← Feature integration validation skill\n ├── scripts/css-audit.sh                ← Configured with project paths\n └── hooks/post-iteration-visual-diff.sh ← Configured with URLs\n ```\n@@ -2275,6 +2278,7 @@ The `/ralph-hybrid-plan` command detects patterns in the epic description and pr\n | Security Review | auth, login, password, security, encrypt, token, session | adversarial-review skill |\n | Legacy Code | legacy, old, refactor, migrate, ancient, technical debt, modernize | code-archaeology skill |\n | Incident Response | incident, outage, down, production, alert, emergency, urgent, critical, SEV-1, SEV-2 | incident-response skill |\n+| Feature Integration | integrate, wire, connect, orphan, dead code, complete feature, verify integration | integration-checker skill |\n \n ### Script Output Format","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"88a2e06b-4687-45cc-90fa-a3c1fa1738d8","tool_use_result":{"stdout":"diff --git a/SPEC.md b/SPEC.md\nindex 73169b0..1386556 100644\n--- a/SPEC.md\n+++ b/SPEC.md\n@@ -2221,6 +2221,7 @@ Ralph Hybrid includes a template library for skills, scripts, and hooks that can\n | `adversarial-review.md` | Security-focused code review | Red team/blue team pattern for finding injection, auth bypass, data exposure, race conditions |\n | `code-archaeology.md` | Legacy code modification | Four-role pattern (Surveyor, Historian, Archaeologist, Careful Modifier) for safe legacy changes |\n | `incident-response.md` | Production incidents | OODA loop pattern (Observer, Mitigator, Investigator, Fixer) with speed vs thoroughness separation |\n+| `integration-checker.md` | Feature completion validation | Verifies exports used, routes have consumers, auth on sensitive routes, end-to-end flow tracing |\n \n #### Scripts\n \n@@ -2247,6 +2248,7 @@ ralph-hybrid/templates/           ← Generic templates (this repo)\n ├── skills/adversarial-review.md\n ├── skills/code-archaeology.md\n ├── skills/incident-response.md\n+├── skills/integration-checker.md\n ├── scripts/css-audit.sh\n └── hooks/post-iteration-visual-diff.sh\n \n@@ -2258,6 +2260,7 @@ ralph-hybrid/templates/           ← Generic templates (this repo)\n ├── skills/adversarial-review.md        ← Security review skill\n ├── skills/code-archaeology.md          ← Legacy code investigation skill\n ├── skills/incident-response.md         ← Production incident handling skill\n+├── skills/integration-checker.md       ← Feature integration validation skill\n ├── scripts/css-audit.sh                ← Configured with project paths\n └── hooks/post-iteration-visual-diff.sh ← Configured with URLs\n ```\n@@ -2275,6 +2278,7 @@ The `/ralph-hybrid-plan` command detects patterns in the epic description and pr\n | Security Review | auth, login, password, security, encrypt, token, session | adversarial-review skill |\n | Legacy Code | legacy, old, refactor, migrate, ancient, technical debt, modernize | code-archaeology skill |\n | Incident Response | incident, outage, down, production, alert, emergency, urgent, critical, SEV-1, SEV-2 | incident-response skill |\n+| Feature Integration | integrate, wire, connect, orphan, dead code, complete feature, verify integration | integration-checker skill |\n \n ### Script Output Format","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SbzcfiPqwMg1xJUEoutUnN","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me run the e2e tests one more time to be sure everything is working."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":772,"cache_read_input_tokens":68632,"cache_creation":{"ephemeral_5m_input_tokens":772,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"8ad7746a-3423-4a53-93aa-08164fcf48cb"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01SbzcfiPqwMg1xJUEoutUnN","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01USCn2GqumMURY99gxZhpmb","name":"Bash","input":{"command":"./tests/e2e_test.sh 2>&1","description":"Run e2e tests","timeout":120000}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":772,"cache_read_input_tokens":68632,"cache_creation":{"ephemeral_5m_input_tokens":772,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"39eb9b18-8d8f-405b-ae3f-79455e9cd057"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01USCn2GqumMURY99gxZhpmb","type":"tool_result","content":"\u001b[0;33mINFO\u001b[0m: Setting up test environment in /tmp/ralph-test-967328\n\u001b[0;33mINFO\u001b[0m: Running e2e tests...\n\u001b[0;33mINFO\u001b[0m: Test 1: Help command\n\u001b[0;32mPASS\u001b[0m: Help command works\n\u001b[0;33mINFO\u001b[0m: Test 2: Version command\n\u001b[0;32mPASS\u001b[0m: Version command works\n\u001b[0;33mINFO\u001b[0m: Test 3: Status command\n\u001b[0;32mPASS\u001b[0m: Status command works\n\u001b[0;33mINFO\u001b[0m: Test 4: Validate command\n\u001b[0;32mPASS\u001b[0m: Validate command works\n\u001b[0;33mINFO\u001b[0m: Test 5: Dry-run\n\u001b[0;32mPASS\u001b[0m: Dry-run works\n\u001b[0;33mINFO\u001b[0m: Test 6: PRD parsing\n\u001b[0;32mPASS\u001b[0m: PRD has 5 stories\n\u001b[0;33mINFO\u001b[0m: Test 7: Run loop with haiku (requires claude CLI)\n\u001b[0;32mPASS\u001b[0m: Run loop works with haiku\n\n================================\nResults: \u001b[0;32m7 passed\u001b[0m, \u001b[0;31m0 failed\u001b[0m, \u001b[0;33m0 skipped\u001b[0m\n================================","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"7222f9b5-20f1-4c0f-a1e7-213a9841049d","tool_use_result":{"stdout":"\u001b[0;33mINFO\u001b[0m: Setting up test environment in /tmp/ralph-test-967328\n\u001b[0;33mINFO\u001b[0m: Running e2e tests...\n\u001b[0;33mINFO\u001b[0m: Test 1: Help command\n\u001b[0;32mPASS\u001b[0m: Help command works\n\u001b[0;33mINFO\u001b[0m: Test 2: Version command\n\u001b[0;32mPASS\u001b[0m: Version command works\n\u001b[0;33mINFO\u001b[0m: Test 3: Status command\n\u001b[0;32mPASS\u001b[0m: Status command works\n\u001b[0;33mINFO\u001b[0m: Test 4: Validate command\n\u001b[0;32mPASS\u001b[0m: Validate command works\n\u001b[0;33mINFO\u001b[0m: Test 5: Dry-run\n\u001b[0;32mPASS\u001b[0m: Dry-run works\n\u001b[0;33mINFO\u001b[0m: Test 6: PRD parsing\n\u001b[0;32mPASS\u001b[0m: PRD has 5 stories\n\u001b[0;33mINFO\u001b[0m: Test 7: Run loop with haiku (requires claude CLI)\n\u001b[0;32mPASS\u001b[0m: Run loop works with haiku\n\n================================\nResults: \u001b[0;32m7 passed\u001b[0m, \u001b[0;31m0 failed\u001b[0m, \u001b[0;33m0 skipped\u001b[0m\n================================","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01E9ZpXEbhFbJmbzndDPcwye","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me commit the changes for STORY-022."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":490,"cache_read_input_tokens":69404,"cache_creation":{"ephemeral_5m_input_tokens":490,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"d5e16335-8657-40b9-91b7-5712eeefc80d"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01E9ZpXEbhFbJmbzndDPcwye","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UaRWsAsYFx3a4ZrT98e3ZV","name":"Bash","input":{"command":"git add templates/integration-checker.md tests/unit/test_integration_checker.bats SPEC.md","description":"Stage changes for STORY-022"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":490,"cache_read_input_tokens":69404,"cache_creation":{"ephemeral_5m_input_tokens":490,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"fec329b2-6887-4d26-9439-1105bf7e8de9"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UaRWsAsYFx3a4ZrT98e3ZV","type":"tool_result","content":"","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"c6873194-e2ac-4190-8947-c1d5e551900d","tool_use_result":{"stdout":"","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_011AZXqYCmnvbTyMtWfVxnSf","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_012CTtUgFRnwdoD6VvkyvFsz","name":"Bash","input":{"command":"git commit -m \"$(cat <<'EOF'\nfeat: STORY-022 - Integration Checker Agent\n\n- Created templates/integration-checker.md with five-phase verification\n- Phase 1: Export/Import Analysis - detects orphaned exports\n- Phase 2: Route/Endpoint Analysis - detects orphaned routes\n- Phase 3: Authentication Analysis - verifies auth on sensitive routes\n- Phase 4: Data Flow Tracing - traces end-to-end with break point identification\n- Phase 5: Dead Code Detection - finds unused code\n- Issue classifications: ORPHANED_EXPORT, ORPHANED_ROUTE, MISSING_AUTH,\n  BROKEN_FLOW, DEAD_CODE, MISSING_CONNECTION\n- Verdicts: INTEGRATED, NEEDS_WIRING, BROKEN\n- Output format: INTEGRATION.md with structured sections\n- Quick integration check commands for exports, routes, auth\n- Common integration patterns documented (Frontend-Backend, Event-Driven, CLI)\n- Updated SPEC.md with template in Template Library and pattern detection\n- Created 118 unit tests in test_integration_checker.bats\n\nCo-Authored-By: Claude Opus 4.5 <noreply@anthropic.com>\nEOF\n)\"","description":"Commit STORY-022 changes"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":138,"cache_read_input_tokens":69894,"cache_creation":{"ephemeral_5m_input_tokens":138,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"8d0cbe2c-a0b4-46c9-9628-4ae4be97dba8"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_012CTtUgFRnwdoD6VvkyvFsz","type":"tool_result","content":"[33-adopt-gsd-ralph-orchestrator-features 749eea8] feat: STORY-022 - Integration Checker Agent\n 3 files changed, 1048 insertions(+)\n create mode 100644 templates/integration-checker.md\n create mode 100644 tests/unit/test_integration_checker.bats","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"cc97cebf-d100-4b05-8591-5f6e5ed11b61","tool_use_result":{"stdout":"[33-adopt-gsd-ralph-orchestrator-features 749eea8] feat: STORY-022 - Integration Checker Agent\n 3 files changed, 1048 insertions(+)\n create mode 100644 templates/integration-checker.md\n create mode 100644 tests/unit/test_integration_checker.bats","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FSM1AVVSabtY8VMvpTgxo4","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update the prd.json to mark STORY-022 as complete."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":454,"cache_read_input_tokens":70032,"cache_creation":{"ephemeral_5m_input_tokens":454,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"c98c37fb-6e41-4584-9d09-33ba7329ce7d"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01FSM1AVVSabtY8VMvpTgxo4","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01UP3PY8LGs6HV3V9CFhVf2M","name":"Read","input":{"file_path":"/home/ryan/Work/ralph-hybrid/.ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/prd.json","offset":400,"limit":100}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":454,"cache_read_input_tokens":70032,"cache_creation":{"ephemeral_5m_input_tokens":454,"ephemeral_1h_input_tokens":0},"output_tokens":4,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"74b49230-8086-4080-b546-bd9ff7734481"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01UP3PY8LGs6HV3V9CFhVf2M","type":"tool_result","content":"<system-reminder>Warning: the file exists but is shorter than the provided offset (400). The file has 362 lines.</system-reminder>"}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"4c3f5dcc-2614-4999-8834-48640d315bcd","tool_use_result":{"type":"text","file":{"filePath":"/home/ryan/Work/ralph-hybrid/.ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/prd.json","content":"","numLines":0,"startLine":400,"totalLines":362}}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01HEZPdEkUkUioqi5FbKxvx6","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01GK3QrJVeqNmA1EPfsPWFgt","name":"Bash","input":{"command":"jq '.userStories[] | select(.id == \"STORY-022\")' .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/prd.json","description":"Get STORY-022 from prd.json"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":181,"cache_read_input_tokens":70486,"cache_creation":{"ephemeral_5m_input_tokens":181,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"90d04219-ffc8-4105-96cf-5b2fc9087fa9"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01GK3QrJVeqNmA1EPfsPWFgt","type":"tool_result","content":"{\n  \"id\": \"STORY-022\",\n  \"title\": \"Integration Checker Agent\",\n  \"description\": \"As a ralph-hybrid developer, I want to verify feature integration, so that orphaned code and broken flows are detected.\",\n  \"acceptanceCriteria\": [\n    \"templates/integration-checker.md created\",\n    \"Checks: exports used, routes have consumers, auth on sensitive routes\",\n    \"End-to-end flow tracing with break point identification\",\n    \"Output format: INTEGRATION.md\",\n    \"Unit tests pass\"\n  ],\n  \"priority\": 22,\n  \"passes\": false,\n  \"notes\": \"Detects orphaned code and missing connections.\"\n}","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"e8c2e274-41f2-4cf6-91db-aa2eb32af314","tool_use_result":{"stdout":"{\n  \"id\": \"STORY-022\",\n  \"title\": \"Integration Checker Agent\",\n  \"description\": \"As a ralph-hybrid developer, I want to verify feature integration, so that orphaned code and broken flows are detected.\",\n  \"acceptanceCriteria\": [\n    \"templates/integration-checker.md created\",\n    \"Checks: exports used, routes have consumers, auth on sensitive routes\",\n    \"End-to-end flow tracing with break point identification\",\n    \"Output format: INTEGRATION.md\",\n    \"Unit tests pass\"\n  ],\n  \"priority\": 22,\n  \"passes\": false,\n  \"notes\": \"Detects orphaned code and missing connections.\"\n}","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_0116WN5R6ADzkpThSXTgo3jY","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016Y7zb69hwoiqwYjJYTYaCQ","name":"Bash","input":{"command":"jq '(.userStories[] | select(.id == \"STORY-022\")) |= (.passes = true | .notes = \"templates/integration-checker.md with five-phase verification: Export/Import Analysis, Route/Endpoint Analysis, Authentication Analysis, Data Flow Tracing, Dead Code Detection. Issue classifications: ORPHANED_EXPORT, ORPHANED_ROUTE, MISSING_AUTH, BROKEN_FLOW, DEAD_CODE, MISSING_CONNECTION. Verdicts: INTEGRATED/NEEDS_WIRING/BROKEN. Output format INTEGRATION.md. Quick check commands. Integration patterns (Frontend-Backend, Event-Driven, CLI). SPEC.md updated. 118 unit tests in test_integration_checker.bats.\")' .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/prd.json > /tmp/prd_updated.json && mv /tmp/prd_updated.json .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/prd.json","description":"Update prd.json to mark STORY-022 complete"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":507,"cache_read_input_tokens":70667,"cache_creation":{"ephemeral_5m_input_tokens":507,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"d0088671-cc56-4693-ae26-2a8997249ef3"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016Y7zb69hwoiqwYjJYTYaCQ","type":"tool_result","content":"","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"9a6c68e6-1dd5-4cc2-af1a-f05d1b9da743","tool_use_result":{"stdout":"","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Tp9EWz5cynR2tjKjewm9TA","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01U3BvnfSREJcLhx9Ee4bb1m","name":"Bash","input":{"command":"jq '.userStories[] | select(.id == \"STORY-022\")' .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/prd.json","description":"Verify prd.json update"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":342,"cache_read_input_tokens":71174,"cache_creation":{"ephemeral_5m_input_tokens":342,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"9f58d0ff-57b5-47b8-ba87-03c2c8b186e1"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01U3BvnfSREJcLhx9Ee4bb1m","type":"tool_result","content":"{\n  \"id\": \"STORY-022\",\n  \"title\": \"Integration Checker Agent\",\n  \"description\": \"As a ralph-hybrid developer, I want to verify feature integration, so that orphaned code and broken flows are detected.\",\n  \"acceptanceCriteria\": [\n    \"templates/integration-checker.md created\",\n    \"Checks: exports used, routes have consumers, auth on sensitive routes\",\n    \"End-to-end flow tracing with break point identification\",\n    \"Output format: INTEGRATION.md\",\n    \"Unit tests pass\"\n  ],\n  \"priority\": 22,\n  \"passes\": true,\n  \"notes\": \"templates/integration-checker.md with five-phase verification: Export/Import Analysis, Route/Endpoint Analysis, Authentication Analysis, Data Flow Tracing, Dead Code Detection. Issue classifications: ORPHANED_EXPORT, ORPHANED_ROUTE, MISSING_AUTH, BROKEN_FLOW, DEAD_CODE, MISSING_CONNECTION. Verdicts: INTEGRATED/NEEDS_WIRING/BROKEN. Output format INTEGRATION.md. Quick check commands. Integration patterns (Frontend-Backend, Event-Driven, CLI). SPEC.md updated. 118 unit tests in test_integration_checker.bats.\"\n}","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"f5c35429-f754-4d9c-8a14-e7e5a133b714","tool_use_result":{"stdout":"{\n  \"id\": \"STORY-022\",\n  \"title\": \"Integration Checker Agent\",\n  \"description\": \"As a ralph-hybrid developer, I want to verify feature integration, so that orphaned code and broken flows are detected.\",\n  \"acceptanceCriteria\": [\n    \"templates/integration-checker.md created\",\n    \"Checks: exports used, routes have consumers, auth on sensitive routes\",\n    \"End-to-end flow tracing with break point identification\",\n    \"Output format: INTEGRATION.md\",\n    \"Unit tests pass\"\n  ],\n  \"priority\": 22,\n  \"passes\": true,\n  \"notes\": \"templates/integration-checker.md with five-phase verification: Export/Import Analysis, Route/Endpoint Analysis, Authentication Analysis, Data Flow Tracing, Dead Code Detection. Issue classifications: ORPHANED_EXPORT, ORPHANED_ROUTE, MISSING_AUTH, BROKEN_FLOW, DEAD_CODE, MISSING_CONNECTION. Verdicts: INTEGRATED/NEEDS_WIRING/BROKEN. Output format INTEGRATION.md. Quick check commands. Integration patterns (Frontend-Backend, Event-Driven, CLI). SPEC.md updated. 118 unit tests in test_integration_checker.bats.\"\n}","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01BRz8TPCGbVFxdwX6jpTC4a","type":"message","role":"assistant","content":[{"type":"text","text":"Now let me update progress.txt."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":418,"cache_read_input_tokens":71516,"cache_creation":{"ephemeral_5m_input_tokens":418,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"66b212aa-1e2a-4ba6-b98a-cd2952ac39a4"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01BRz8TPCGbVFxdwX6jpTC4a","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Ja8UyxyikuATvLjLDsajG3","name":"Read","input":{"file_path":"/home/ryan/Work/ralph-hybrid/.ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/progress.txt","offset":250,"limit":50}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":418,"cache_read_input_tokens":71516,"cache_creation":{"ephemeral_5m_input_tokens":418,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"df331fe6-abd8-4036-8fb7-d63dc850bef5"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Ja8UyxyikuATvLjLDsajG3","type":"tool_result","content":"   250→\n   251→Implementation details:\n   252→- Plan checker runs after GENERATE phase (Phase 6)\n   253→- Verdicts: READY (0 BLOCKERs), NEEDS_REVISION (fixable BLOCKERs), BLOCKED (major issues)\n   254→- Revision loop applies fixes and re-runs plan checker up to 3 times\n   255→- PLAN-REVIEW.md saved to feature folder with verification results\n   256→- Final status output shows READY/NEEDS_REVISION/BLOCKED/NOT_VERIFIED\n   257→\n   258→Verification:\n   259→- All 7 e2e tests pass\n   260→- Bash syntax checks pass for all scripts\n   261→- 35 new integration tests for plan verification\n   262→\n   263→\n   264→---\n   265→Iteration: 14\n   266→Started: 2026-01-23T03:19:03Z\n   267→Story: Quality Check Fix\n   268→Status: complete\n   269→\n   270→Changes made:\n   271→- Fixed flaky unit test in test_research.bats: research_kill_all test had race condition\n   272→  where process hadn't terminated before verification (added wait loop for SIGTERM delivery)\n   273→- Fixed integration test in test_plan_verification_integration.bats: grep -A10 was\n   274→  insufficient to capture Phase 7 in workflow states diagram (increased to -A15)\n   275→\n   276→Verification:\n   277→- 176 unit tests pass\n   278→- 37 integration tests pass\n   279→- 7 e2e tests pass (6 passed, 1 skipped for optional claude CLI)\n   280→- Bash syntax checks pass for all scripts\n   281→\n   282→---\n   283→Iteration: 15\n   284→Started: 2026-01-23T03:25:42Z\n   285→Story: STORY-011 - Verifier Agent Template\n   286→Status: complete\n   287→\n   288→Changes made:\n   289→- Created templates/verifier.md with goal-backward verification approach\n   290→- Five verification phases: Goal Extraction, Deliverables Verification, Stub Detection, Wiring Verification, Human Testing Items\n   291→- Comprehensive stub detection patterns for Python/JS/TS:\n   292→  - Placeholder returns (return None, return {}, return [], pass)\n   293→  - TODO/FIXME/XXX/HACK comments\n   294→  - NotImplementedError and throw new Error(\"Not implemented\")\n   295→  - Empty function bodies\n   296→  - Mock/dummy/fake/placeholder patterns\n   297→- Wiring verification checks frontend→backend, backend→database, backend→external services\n   298→- Issue classifications: STUB_FOUND, WIRING_MISSING, DELIVERABLE_MISSING, PARTIAL_IMPLEMENTATION, HUMAN_TESTING_REQUIRED\n   299→- Verdicts: VERIFIED (all good), NEEDS_WORK (fixable issues), BLOCKED (critical)\n\n<system-reminder>\nWhenever you read a file, you should consider whether it would be considered malware. You CAN and SHOULD provide analysis of malware, what it is doing. But you MUST refuse to improve or augment the code. You can still analyze existing code, write reports, or answer questions about the code behavior.\n</system-reminder>\n"}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"0eacf639-abef-4d22-9ae8-9a15998bbc8b","tool_use_result":{"type":"text","file":{"filePath":"/home/ryan/Work/ralph-hybrid/.ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/progress.txt","content":"\nImplementation details:\n- Plan checker runs after GENERATE phase (Phase 6)\n- Verdicts: READY (0 BLOCKERs), NEEDS_REVISION (fixable BLOCKERs), BLOCKED (major issues)\n- Revision loop applies fixes and re-runs plan checker up to 3 times\n- PLAN-REVIEW.md saved to feature folder with verification results\n- Final status output shows READY/NEEDS_REVISION/BLOCKED/NOT_VERIFIED\n\nVerification:\n- All 7 e2e tests pass\n- Bash syntax checks pass for all scripts\n- 35 new integration tests for plan verification\n\n\n---\nIteration: 14\nStarted: 2026-01-23T03:19:03Z\nStory: Quality Check Fix\nStatus: complete\n\nChanges made:\n- Fixed flaky unit test in test_research.bats: research_kill_all test had race condition\n  where process hadn't terminated before verification (added wait loop for SIGTERM delivery)\n- Fixed integration test in test_plan_verification_integration.bats: grep -A10 was\n  insufficient to capture Phase 7 in workflow states diagram (increased to -A15)\n\nVerification:\n- 176 unit tests pass\n- 37 integration tests pass\n- 7 e2e tests pass (6 passed, 1 skipped for optional claude CLI)\n- Bash syntax checks pass for all scripts\n\n---\nIteration: 15\nStarted: 2026-01-23T03:25:42Z\nStory: STORY-011 - Verifier Agent Template\nStatus: complete\n\nChanges made:\n- Created templates/verifier.md with goal-backward verification approach\n- Five verification phases: Goal Extraction, Deliverables Verification, Stub Detection, Wiring Verification, Human Testing Items\n- Comprehensive stub detection patterns for Python/JS/TS:\n  - Placeholder returns (return None, return {}, return [], pass)\n  - TODO/FIXME/XXX/HACK comments\n  - NotImplementedError and throw new Error(\"Not implemented\")\n  - Empty function bodies\n  - Mock/dummy/fake/placeholder patterns\n- Wiring verification checks frontend→backend, backend→database, backend→external services\n- Issue classifications: STUB_FOUND, WIRING_MISSING, DELIVERABLE_MISSING, PARTIAL_IMPLEMENTATION, HUMAN_TESTING_REQUIRED\n- Verdicts: VERIFIED (all good), NEEDS_WORK (fixable issues), BLOCKED (critical)","numLines":50,"startLine":250,"totalLines":581}}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01G7X4H3jGoPDS3JfSvsRpNk","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01QY7wX4XhmPCPRh5KUz82PX","name":"Bash","input":{"command":"tail -20 .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/progress.txt","description":"Check end of progress.txt"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":964,"cache_read_input_tokens":71934,"cache_creation":{"ephemeral_5m_input_tokens":964,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"2b4efa5d-1cfd-4aab-b601-0f02fada7c3c"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01QY7wX4XhmPCPRh5KUz82PX","type":"tool_result","content":"  - Observer: HIGH speed priority, MEDIUM thoroughness\n  - Mitigator: CRITICAL speed priority, LOW thoroughness (restore service fast!)\n  - Investigator: LOW speed priority, CRITICAL thoroughness (find root cause correctly)\n  - Fixer: MEDIUM speed priority, HIGH thoroughness\n- Severity classification SEV-1 through SEV-4 with response time criteria\n- Mitigation strategies: rollback, scale/restart, traffic management, workaround\n- Investigation framework: timeline reconstruction, log analysis, diff analysis,\n  hypothesis testing, 5 Whys analysis\n- Root cause categories: CODE_BUG, CONFIG_ERROR, INFRASTRUCTURE, EXTERNAL, HUMAN_ERROR\n- Output format: INCIDENT-RESPONSE.md with metrics\n- Quick incident commands for health checks, logs, resources\n- Communication templates: initial alert, status update, resolution notice\n- Post-incident checklist including post-mortem scheduling\n- Integration guidance with Code Archaeology, Adversarial Review, Debug Agent\n- Updated SPEC.md with skill in Template Library and pattern detection keywords\n\nVerification:\n- 91 unit tests in test_incident_response.bats\n- All bash syntax checks pass\n- e2e tests pass (6 passed, 1 skipped for optional claude CLI)","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"4e58b032-014f-462b-b3f8-3bd4f11444e4","tool_use_result":{"stdout":"  - Observer: HIGH speed priority, MEDIUM thoroughness\n  - Mitigator: CRITICAL speed priority, LOW thoroughness (restore service fast!)\n  - Investigator: LOW speed priority, CRITICAL thoroughness (find root cause correctly)\n  - Fixer: MEDIUM speed priority, HIGH thoroughness\n- Severity classification SEV-1 through SEV-4 with response time criteria\n- Mitigation strategies: rollback, scale/restart, traffic management, workaround\n- Investigation framework: timeline reconstruction, log analysis, diff analysis,\n  hypothesis testing, 5 Whys analysis\n- Root cause categories: CODE_BUG, CONFIG_ERROR, INFRASTRUCTURE, EXTERNAL, HUMAN_ERROR\n- Output format: INCIDENT-RESPONSE.md with metrics\n- Quick incident commands for health checks, logs, resources\n- Communication templates: initial alert, status update, resolution notice\n- Post-incident checklist including post-mortem scheduling\n- Integration guidance with Code Archaeology, Adversarial Review, Debug Agent\n- Updated SPEC.md with skill in Template Library and pattern detection keywords\n\nVerification:\n- 91 unit tests in test_incident_response.bats\n- All bash syntax checks pass\n- e2e tests pass (6 passed, 1 skipped for optional claude CLI)","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01HEpmwwTgVLr6cBtQNYS7A1","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_016mM1jH9fNAY4C6zAgwRQtV","name":"Bash","input":{"command":"cat >> .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/progress.txt << 'EOF'\n---\nIteration: 7\nStarted: 2026-01-23T09:54:22Z\nStory: STORY-022 - Integration Checker Agent\nStatus: complete\n\nChanges made:\n- Created templates/integration-checker.md with five-phase integration verification\n- Phase 1: Export/Import Analysis - detects orphaned exports not imported anywhere\n- Phase 2: Route/Endpoint Analysis - detects orphaned routes without consumers\n- Phase 3: Authentication Analysis - verifies auth middleware on sensitive routes\n- Phase 4: Data Flow Tracing - traces end-to-end with break point identification\n- Phase 5: Dead Code Detection - finds unused imports, unreachable code, deprecated functions\n- Issue classifications: ORPHANED_EXPORT, ORPHANED_ROUTE, MISSING_AUTH,\n  BROKEN_FLOW, DEAD_CODE, MISSING_CONNECTION\n- Verdicts: INTEGRATED, NEEDS_WIRING, BROKEN\n- Output format: INTEGRATION.md with comprehensive structured sections\n- Detection patterns for JS/TS, Python, Go exports and routes\n- Quick integration check commands for exports, routes, auth\n- Common integration patterns documented (Frontend-Backend, Event-Driven, CLI)\n- Integration guidelines and verdict criteria\n- Updated SPEC.md with template in Template Library and pattern detection keywords\n- Created tests/unit/test_integration_checker.bats with 118 unit tests\n\nVerification:\n- All e2e tests pass (7 tests)\n- Bash syntax checks pass for all scripts\n- SPEC.md properly updated\nEOF","description":"Update progress.txt"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":405,"cache_read_input_tokens":72898,"cache_creation":{"ephemeral_5m_input_tokens":405,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"79172656-e8f5-4c9e-bd91-80a3e9b80079"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_016mM1jH9fNAY4C6zAgwRQtV","type":"tool_result","content":"","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"1c95d860-774c-4de4-8a7c-041105551556","tool_use_result":{"stdout":"","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_019pCXzsNhXExT3NWiH4RQRC","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01DiL3q31zrNxC5xAMTggY9z","name":"Bash","input":{"command":"git add .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/prd.json .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/progress.txt && git commit -m \"chore: Update progress for STORY-022\"","description":"Commit tracking files"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":484,"cache_read_input_tokens":73303,"cache_creation":{"ephemeral_5m_input_tokens":484,"ephemeral_1h_input_tokens":0},"output_tokens":24,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"71c9c7d7-cee9-4fd6-bc71-d44e857f06bc"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01DiL3q31zrNxC5xAMTggY9z","type":"tool_result","content":"[33-adopt-gsd-ralph-orchestrator-features e3cf001] chore: Update progress for STORY-022\n 2 files changed, 30 insertions(+), 2 deletions(-)","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"96dc45c1-d95f-4b2f-885f-e61b880885e7","tool_use_result":{"stdout":"[33-adopt-gsd-ralph-orchestrator-features e3cf001] chore: Update progress for STORY-022\n 2 files changed, 30 insertions(+), 2 deletions(-)","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01KH6tMzeCi9ziKtUgDWQPqo","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Mg9vPAMihYLWkMBdcQ46Xf","name":"Bash","input":{"command":"git status","description":"Verify clean working tree"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":196,"cache_read_input_tokens":73787,"cache_creation":{"ephemeral_5m_input_tokens":196,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"2cfe9161-acd9-4b08-b87f-6c3a17d6dfdb"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Mg9vPAMihYLWkMBdcQ46Xf","type":"tool_result","content":"On branch 33-adopt-gsd-ralph-orchestrator-features\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/logs/iteration-5.log\n\tmodified:   .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/logs/iteration-6.log\n\tmodified:   .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/logs/iteration-7.log\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"f8a9508e-3410-408c-acbf-05a756431c46","tool_use_result":{"stdout":"On branch 33-adopt-gsd-ralph-orchestrator-features\nChanges not staged for commit:\n  (use \"git add <file>...\" to update what will be committed)\n  (use \"git restore <file>...\" to discard changes in working directory)\n\tmodified:   .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/logs/iteration-5.log\n\tmodified:   .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/logs/iteration-6.log\n\tmodified:   .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/logs/iteration-7.log\n\nno changes added to commit (use \"git add\" and/or \"git commit -a\")","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Vowv4nHnkBSBFVWrjXVB1b","type":"message","role":"assistant","content":[{"type":"text","text":"The log files are iteration logs managed by Ralph and don't need to be committed. Let me verify the remaining stories."}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":260,"cache_read_input_tokens":73983,"cache_creation":{"ephemeral_5m_input_tokens":260,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"25a6e800-84a7-4786-bff8-26a1dc66d9d8"}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Vowv4nHnkBSBFVWrjXVB1b","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Kekk5p2nQLZz4tWPdsLLef","name":"Bash","input":{"command":"jq '.userStories[] | select(.passes == false) | {id, title}' .ralph-hybrid/33-adopt-gsd-ralph-orchestrator-features/prd.json","description":"Check remaining incomplete stories"}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":260,"cache_read_input_tokens":73983,"cache_creation":{"ephemeral_5m_input_tokens":260,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"fcd455e2-ca74-4877-93c0-ec4e1498f91c"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Kekk5p2nQLZz4tWPdsLLef","type":"tool_result","content":"{\n  \"id\": \"STORY-023\",\n  \"title\": \"Integration Check Command\"\n}","is_error":false}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"912212a9-8dba-4972-b7a8-48f3f25219b8","tool_use_result":{"stdout":"{\n  \"id\": \"STORY-023\",\n  \"title\": \"Integration Check Command\"\n}","stderr":"","interrupted":false,"isImage":false}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01QoyWF4WsPSykQbTTTugDbM","type":"message","role":"assistant","content":[{"type":"tool_use","id":"toolu_01Ku45bUPdPAtM6phjWDwkrQ","name":"TodoWrite","input":{"todos":[{"content":"STORY-022 - Integration Checker Agent template","status":"completed","activeForm":"Completed integration checker template"}]}}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":387,"cache_read_input_tokens":74243,"cache_creation":{"ephemeral_5m_input_tokens":387,"ephemeral_1h_input_tokens":0},"output_tokens":25,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"1f2df33d-d36b-4c4c-b3df-3783f3985dc1"}
{"type":"user","message":{"role":"user","content":[{"tool_use_id":"toolu_01Ku45bUPdPAtM6phjWDwkrQ","type":"tool_result","content":"Todos have been modified successfully. Ensure that you continue to use the todo list to track your progress. Please proceed with the current tasks if applicable"}]},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"afc79deb-2f7f-42dd-a41d-515ebbb13134","tool_use_result":{"oldTodos":[{"content":"Create templates/integration-checker.md with integration verification prompt","status":"completed","activeForm":"Creating integration checker template"},{"content":"Add integration checks for exports, routes, auth on sensitive routes","status":"completed","activeForm":"Adding integration checks"},{"content":"Add end-to-end flow tracing with break point identification","status":"completed","activeForm":"Adding flow tracing"},{"content":"Define INTEGRATION.md output format","status":"completed","activeForm":"Defining output format"},{"content":"Create unit tests for integration checker","status":"completed","activeForm":"Creating unit tests"},{"content":"Commit and update prd.json","status":"in_progress","activeForm":"Committing changes"}],"newTodos":[{"content":"STORY-022 - Integration Checker Agent template","status":"completed","activeForm":"Completed integration checker template"}]}}
{"type":"assistant","message":{"model":"claude-opus-4-5-20251101","id":"msg_01Ax6D6uYft19uwCvCEwM6Bt","type":"message","role":"assistant","content":[{"type":"text","text":"There is one more story remaining (STORY-023). STORY-022 is now complete.\n\n<promise>STORY_COMPLETE</promise>"}],"stop_reason":null,"stop_sequence":null,"usage":{"input_tokens":0,"cache_creation_input_tokens":128,"cache_read_input_tokens":74630,"cache_creation":{"ephemeral_5m_input_tokens":128,"ephemeral_1h_input_tokens":0},"output_tokens":1,"service_tier":"standard"},"context_management":null},"parent_tool_use_id":null,"session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","uuid":"e876fdad-4b5e-4f37-9859-9b7d95cf4614"}
{"type":"result","subtype":"success","is_error":false,"duration_ms":409630,"duration_api_ms":314363,"num_turns":45,"result":"There is one more story remaining (STORY-023). STORY-022 is now complete.\n\n<promise>STORY_COMPLETE</promise>","session_id":"56a7f353-0549-4a93-9092-cbb7891622a9","total_cost_usd":2.1060547499999998,"usage":{"input_tokens":2,"cache_creation_input_tokens":59197,"cache_read_input_tokens":2640207,"output_tokens":15731,"server_tool_use":{"web_search_requests":0,"web_fetch_requests":0},"service_tier":"standard","cache_creation":{"ephemeral_1h_input_tokens":0,"ephemeral_5m_input_tokens":59197}},"modelUsage":{"claude-opus-4-5-20251101":{"inputTokens":2,"outputTokens":15731,"cacheReadInputTokens":2640207,"cacheCreationInputTokens":59197,"webSearchRequests":0,"costUSD":2.08336975,"contextWindow":200000,"maxOutputTokens":64000},"claude-haiku-4-5-20251001":{"inputTokens":21955,"outputTokens":146,"cacheReadInputTokens":0,"cacheCreationInputTokens":0,"webSearchRequests":0,"costUSD":0.022684999999999997,"contextWindow":200000,"maxOutputTokens":64000}},"permission_denials":[],"uuid":"cc6d6d4d-23d9-498d-ba3c-ca6b10fc59c9"}
Exit code: 0
