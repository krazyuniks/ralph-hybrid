# Visual Parity Migration Skill

> **Use when:** Migrating UI from one framework to another (React to Jinja2, Vue to Svelte, etc.)
> **Generated by:** `ralph-plan` when migration pattern detected in epic description

## Purpose

Ensure the target framework implementation visually matches the source framework. This skill enforces verbatim class copying, CSS variable auditing, and visual regression testing.

---

## Pre-Implementation Checklist

Before starting any migration story:

### 1. CSS Variable Audit

**Run the audit script first:**
```bash
./scripts/css-audit.sh <templates-dir> <base-template>
```

**Manual check:**
```bash
# Find all CSS variables used in source
grep -rohE 'var\(--[^)]+\)' <source-dir> | sort -u > source-vars.txt

# Find all CSS variables defined in target base template
grep -oE '--[a-z-]+:' <base-template> | tr -d ':' | sort -u > defined-vars.txt

# Find undefined (must be zero)
comm -23 source-vars.txt defined-vars.txt
```

**Critical:** ALL CSS variables used in source MUST be defined in target base template.

### 2. Identify Framework-Specific Patterns

| Source Pattern | Target Equivalent |
|---------------|-------------------|
| React `className` | Standard `class` |
| Astro `class:list` | Space-separated `class` |
| Vue `:class` binding | Alpine.js `x-bind:class` or static |
| Conditional classes | HTMX/Alpine.js equivalents |

### 3. Document Color System

Before migrating, document:
- [ ] Background colors and their use cases
- [ ] Text colors (primary, secondary, muted)
- [ ] Accent colors (primary, secondary, error, warning, success)
- [ ] Border colors
- [ ] Any component-specific colors (block types, status indicators)

---

## During Implementation

### Class Verbatim Copy Rules

**DO copy exactly:**
```html
<!-- Source (React) -->
<div className="flex items-center gap-2 px-4 py-2 rounded-lg bg-[var(--color-bg-surface)]">

<!-- Target (Jinja2) - CORRECT -->
<div class="flex items-center gap-2 px-4 py-2 rounded-lg bg-[var(--color-bg-surface)]">
```

**DO NOT "simplify" or "improve":**
```html
<!-- WRONG - Don't substitute CSS variables with hardcoded values -->
<div class="flex items-center gap-2 px-4 py-2 rounded-lg bg-gray-800">

<!-- WRONG - Don't remove arbitrary value syntax -->
<div class="flex items-center gap-2 px-4 py-2 rounded-lg bg-surface">
```

### Framework-Specific Translations

Only translate framework syntax, never visual styling:

```jsx
// React with conditional classes
<div className={`base ${isActive ? 'bg-amber-500' : 'bg-gray-700'}`}>

// Jinja2 + Alpine.js equivalent
<div class="base" x-bind:class="isActive ? 'bg-amber-500' : 'bg-gray-700'">
```

### CSS Variable Handling

**Required in target base template:**
```css
:root {
  /* Background layers */
  --color-bg-base: #0a0a0a;
  --color-bg-surface: #141414;
  --color-bg-elevated: #1f1f1f;
  --color-bg-secondary: #1a1a1a;

  /* Text colors */
  --color-text-primary: #ffffff;
  --color-text-secondary: #a1a1a1;
  --color-text-muted: #666666;

  /* Accent colors */
  --color-accent-primary: #3b82f6;
  --color-accent-primary-hover: #2563eb;
  --color-accent-secondary: #60a5fa;
  --color-accent-success: #22c55e;
  --color-accent-warning: #f59e0b;
  --color-accent-error: #ef4444;

  /* Borders */
  --border: #333333;
  --border-hover: #444444;
}
```

---

## Post-Implementation Validation

### 1. CSS Variable Check (Required)

```bash
# Must return empty (no undefined variables)
./scripts/css-audit.sh <templates-dir> <base-template>
```

### 2. Visual Regression (Recommended)

```bash
# Run visual diff if configured
./callbacks/post-iteration-visual-diff.sh
```

### 3. Browser Console Check (Required)

Open DevTools Console and verify:
- [ ] No "Invalid property value" errors for CSS variables
- [ ] No missing resource errors
- [ ] No JavaScript errors related to styling

### 4. Dark Theme Verification (Required)

For dark-themed applications:
- [ ] All backgrounds render as dark colors (not transparent/white)
- [ ] Text is readable on all backgrounds
- [ ] Hover states are visible

### 5. Component-by-Component Visual Comparison

For each migrated component:
- [ ] Side-by-side screenshots match (within 5% threshold)
- [ ] All states rendered (default, hover, active, disabled)
- [ ] Responsive breakpoints match

---

## Common Mistakes to Avoid

### 1. Variable Substitution

```html
<!-- WRONG: Substituted variable with hardcoded value -->
<div class="text-white">  <!-- Was: text-[var(--color-text-primary)] -->

<!-- CORRECT: Keep the variable reference -->
<div class="text-[var(--color-text-primary)]">
```

### 2. Missing Variable Definitions

```html
<!-- Template uses variable -->
<div class="bg-[var(--color-bg-surface)]">

<!-- BUT base template doesn't define it! -->
<style>
  :root {
    /* --color-bg-surface missing! */
  }
</style>
```

### 3. Different Variable Systems

```css
/* Source uses project tokens */
--color-bg-surface: #141414;

/* Target uses shadcn/ui tokens (different names!) */
--background: oklch(0.145 0 0);  /* NOT the same as --color-bg-surface */
```

**Solution:** Define BOTH systems in target, or map one to the other.

### 4. Conditional Class Translation Errors

```jsx
// React
<div className={isActive ? 'bg-blue-500' : 'bg-gray-700'}>

// WRONG: Lost the conditional
<div class="bg-blue-500">

// CORRECT: Preserve conditional with Alpine.js
<div x-bind:class="isActive ? 'bg-blue-500' : 'bg-gray-700'">
```

---

## Validation Checklist

Copy this checklist to each migration story's acceptance criteria:

```markdown
**Visual Parity Validation:**
- [ ] CSS audit script returns no undefined variables
- [ ] Browser console shows no CSS errors
- [ ] Dark backgrounds render correctly
- [ ] Text is readable on all surfaces
- [ ] Hover/active states work
- [ ] Side-by-side comparison within 5% threshold
```

---

## Related Scripts

- `scripts/css-audit.sh` - Audit CSS variable usage vs definitions
- `scripts/template-comparison.sh` - Compare source vs target class usage
- `callbacks/post-iteration-visual-diff.sh` - Visual regression testing

---

## When to Deviate

Only deviate from verbatim copying when:

1. **Framework requires it:** e.g., Astro `class:list` â†’ standard `class`
2. **Performance optimization:** e.g., removing unused vendor prefixes
3. **Accessibility improvement:** e.g., adding ARIA attributes

Document ALL deviations in the story's technical notes.
