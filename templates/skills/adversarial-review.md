# Adversarial Security Review Skill

> **Use when:** Reviewing code for security vulnerabilities before merge
> **Generated by:** `ralph-plan` when security-related patterns detected or explicitly requested

## Purpose

Conduct security-focused code review using a red team/blue team pattern. Blue team identifies secure implementation requirements, red team attempts to find vulnerabilities, and the fixer role proposes remediations.

---

## Three-Role Pattern

### Role 1: Blue Team (Secure Implementation Analyst)

**Goal:** Understand the intended secure behavior and identify security-critical code paths.

**Tasks:**
1. Identify all entry points (APIs, forms, file uploads, CLI args)
2. Map data flows from untrusted input to sensitive operations
3. List security controls that SHOULD be present
4. Document authentication/authorization checkpoints
5. Note cryptographic operations and their purposes

**Output Format:**
```markdown
## Blue Team Analysis

### Entry Points
| Location | Input Type | Trust Level |
|----------|-----------|-------------|
| /api/login | JSON body | UNTRUSTED |
| /upload | Multipart file | UNTRUSTED |

### Security Controls Required
- [ ] Input validation at [location]
- [ ] Authentication check at [location]
- [ ] Authorization check at [location]
- [ ] Rate limiting at [location]
- [ ] Output encoding at [location]

### Data Flow Diagram
[Input] → [Validation] → [Auth] → [Processing] → [Output]
```

---

### Role 2: Red Team (Penetration Tester)

**Goal:** Find vulnerabilities by attempting to bypass security controls.

**Focus Areas:**

#### 1. Injection Attacks
```
# SQL Injection patterns
' OR '1'='1
'; DROP TABLE users;--
UNION SELECT * FROM passwords

# Command Injection patterns
; ls -la
| cat /etc/passwd
$(whoami)
`id`

# Template Injection patterns
{{7*7}}
${7*7}
<%= 7*7 %>

# LDAP Injection
*)(uid=*))(|(uid=*
```

#### 2. Authentication Bypass
```
# Check for:
- Direct object references (IDOR): /user/123 → /user/124
- Session fixation vulnerabilities
- JWT algorithm confusion (alg: none)
- Password reset token predictability
- Timing attacks on password comparison
- Default/hardcoded credentials
- Missing authentication on sensitive endpoints
```

#### 3. Data Exposure
```
# Check for:
- Sensitive data in logs (passwords, tokens, PII)
- API responses leaking internal data
- Error messages revealing stack traces
- .env files, config files in web root
- Hardcoded secrets in source code
- Unencrypted sensitive data in transit/at rest
- Missing security headers (HSTS, CSP, X-Frame-Options)
```

#### 4. Race Conditions
```
# Check for:
- Time-of-check to time-of-use (TOCTOU)
- Double-spend in transactions
- Rate limit bypass via concurrent requests
- Session race conditions
- File operation races
```

#### 5. Logic Flaws
```
# Check for:
- Negative quantity/amount inputs
- Integer overflow/underflow
- State machine violations
- Privilege escalation via role confusion
- Mass assignment vulnerabilities
```

**Red Team Checklist:**
- [ ] Tested all injection vectors
- [ ] Attempted authentication bypass
- [ ] Searched for data exposure
- [ ] Checked for race conditions
- [ ] Analyzed business logic for flaws
- [ ] Reviewed error handling for info leaks
- [ ] Checked for insecure deserialization
- [ ] Tested file upload handling
- [ ] Verified CORS configuration
- [ ] Checked for SSRF vulnerabilities

**Output Format:**
```markdown
## Red Team Findings

### Finding: [Title]
**Severity:** CRITICAL | HIGH | MEDIUM | LOW
**Location:** [file:line]
**CWE:** [CWE-XXX]
**OWASP:** [Category]

**Description:**
[What the vulnerability is]

**Proof of Concept:**
[How to exploit it]

**Impact:**
[What damage could be done]

**Recommendation:**
[How to fix it]
```

---

### Role 3: Fixer (Security Engineer)

**Goal:** Propose and validate remediations for identified vulnerabilities.

**Tasks:**
1. Prioritize findings by severity and exploitability
2. Propose minimal, targeted fixes
3. Verify fix doesn't introduce new vulnerabilities
4. Ensure fix maintains functionality
5. Add security tests to prevent regression

**Fix Patterns:**

#### Input Validation
```python
# BEFORE (vulnerable)
def search(query):
    return db.execute(f"SELECT * FROM items WHERE name = '{query}'")

# AFTER (secure)
def search(query):
    return db.execute("SELECT * FROM items WHERE name = ?", [query])
```

#### Output Encoding
```python
# BEFORE (vulnerable)
return f"<div>{user_input}</div>"

# AFTER (secure)
from html import escape
return f"<div>{escape(user_input)}</div>"
```

#### Authentication
```python
# BEFORE (vulnerable)
if request.headers.get('X-Admin') == 'true':
    return admin_panel()

# AFTER (secure)
if current_user.is_authenticated and current_user.has_role('admin'):
    return admin_panel()
```

#### Timing-Safe Comparison
```python
# BEFORE (vulnerable)
if token == expected_token:
    return True

# AFTER (secure)
import hmac
if hmac.compare_digest(token.encode(), expected_token.encode()):
    return True
```

**Output Format:**
```markdown
## Remediation Plan

### Priority 1: CRITICAL Fixes
| Finding | Fix | Verified |
|---------|-----|----------|
| SQL Injection in /search | Parameterized queries | [ ] |

### Priority 2: HIGH Fixes
...

### Security Tests Added
- [ ] Test: SQL injection blocked in /search
- [ ] Test: XSS encoded in user display
```

---

## Severity Levels

| Level | Description | Criteria |
|-------|-------------|----------|
| **CRITICAL** | Immediate exploitation possible | Remote code execution, auth bypass, data breach |
| **HIGH** | Significant risk | Privilege escalation, sensitive data exposure |
| **MEDIUM** | Moderate risk | Limited impact vulnerabilities, defense-in-depth failures |
| **LOW** | Minor issues | Information disclosure, best practice violations |

---

## Security Review Output Format

Generate `SECURITY-REVIEW.md`:

```markdown
# Security Review: [Feature/PR Name]

**Reviewer:** Adversarial Review Skill
**Date:** [TIMESTAMP]
**Branch:** [BRANCH_NAME]

## Executive Summary

**Overall Risk Level:** CRITICAL | HIGH | MEDIUM | LOW | PASS
**Findings:** X critical, Y high, Z medium, W low
**Recommendation:** BLOCK_MERGE | CONDITIONAL_MERGE | APPROVE

## Blue Team Analysis
[From Role 1]

## Red Team Findings
[From Role 2]

## Remediation Plan
[From Role 3]

## Checklist Summary

### Injection Prevention
- [ ] SQL queries use parameterization
- [ ] OS commands avoid user input
- [ ] Template rendering escapes by default
- [ ] LDAP queries use proper escaping

### Authentication & Authorization
- [ ] All sensitive endpoints require authentication
- [ ] Authorization checked at every access point
- [ ] Session management is secure
- [ ] Password storage uses strong hashing

### Data Protection
- [ ] Sensitive data encrypted at rest
- [ ] TLS enforced for data in transit
- [ ] No secrets in source code
- [ ] Logs sanitized of sensitive data

### Security Headers
- [ ] Content-Security-Policy configured
- [ ] X-Frame-Options set
- [ ] X-Content-Type-Options: nosniff
- [ ] Strict-Transport-Security enabled

## Sign-Off

| Role | Status | Notes |
|------|--------|-------|
| Blue Team | COMPLETE | [summary] |
| Red Team | COMPLETE | [summary] |
| Fixer | COMPLETE | [summary] |
```

---

## Quick Security Checks

Run these commands to detect common issues:

```bash
# Find hardcoded secrets
grep -rn "password\s*=" --include="*.py" --include="*.js" --include="*.ts"
grep -rn "api_key\s*=" --include="*.py" --include="*.js" --include="*.ts"
grep -rn "secret\s*=" --include="*.py" --include="*.js" --include="*.ts"

# Find SQL string formatting (potential injection)
grep -rn "execute.*f'" --include="*.py"
grep -rn "execute.*%s" --include="*.py"
grep -rn "query.*\+" --include="*.js" --include="*.ts"

# Find eval/exec usage
grep -rn "eval(" --include="*.py" --include="*.js" --include="*.ts"
grep -rn "exec(" --include="*.py"
grep -rn "subprocess.*shell=True" --include="*.py"

# Find unsafe deserialization
grep -rn "pickle.loads" --include="*.py"
grep -rn "yaml.load(" --include="*.py"
grep -rn "JSON.parse.*user" --include="*.js" --include="*.ts"

# Find missing output encoding
grep -rn "innerHTML\s*=" --include="*.js" --include="*.ts"
grep -rn "dangerouslySetInnerHTML" --include="*.jsx" --include="*.tsx"
grep -rn "\|safe" --include="*.html" --include="*.jinja2"
```

---

## Integration with CI/CD

**Pre-merge gate:**
```yaml
# .github/workflows/security.yml
security-review:
  runs-on: ubuntu-latest
  steps:
    - uses: actions/checkout@v4
    - name: Run security checks
      run: |
        # Your security scanning tools
        bandit -r src/ -f json -o bandit-report.json
        npm audit --json > npm-audit.json
        trivy fs --format json --output trivy-report.json .
```

**Post-review hook:**
```bash
#!/bin/bash
# .ralph-hybrid/hooks/post_security_review.sh
# Blocks merge if CRITICAL findings exist

if grep -q '"severity": "CRITICAL"' SECURITY-REVIEW.md; then
    echo "CRITICAL security findings - merge blocked"
    exit 75  # VERIFICATION_FAILED
fi
```

---

## When to Trigger This Skill

Automatically activate for:
- Authentication/authorization changes
- Input handling modifications
- Database query changes
- API endpoint additions
- File upload functionality
- Cryptographic operations
- Session management changes
- External service integrations

Keywords that trigger: `auth`, `login`, `password`, `token`, `session`, `security`, `encrypt`, `hash`, `upload`, `query`, `execute`, `eval`, `admin`, `privilege`, `permission`

---

## References

- OWASP Top 10: https://owasp.org/www-project-top-ten/
- CWE Top 25: https://cwe.mitre.org/top25/
- OWASP Cheat Sheets: https://cheatsheetseries.owasp.org/
