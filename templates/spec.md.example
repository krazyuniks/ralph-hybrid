---
created: 2026-01-09T12:00:00Z
---

<!-- Feature folder derived from git branch: feature/user-authentication â†’ .ralph/feature-user-authentication/ -->

# User Authentication

## Problem Statement

Users need secure access to their accounts. Currently there is no authentication system, meaning all data is publicly accessible. This feature adds email/password authentication with JWT tokens, enabling secure user sessions and protecting user data.

## Success Criteria

- [ ] Users can register with email and password
- [ ] Users can log in and receive a JWT token
- [ ] Protected routes reject unauthenticated requests
- [ ] Sessions persist across page refresh (token storage)
- [ ] Invalid credentials show appropriate error message

## Execution Guidelines

**Use background agents for parallel sub-tasks.** When implementing stories, use the Task tool with `run_in_background: true` to maximize throughput without cluttering the output stream:

1. **Background agents for independent work:**
   - `Explore` agent - Codebase research, finding related files/patterns
   - `Bash` agent - Running tests, builds, type checks in background
   - `general-purpose` agent - Complex multi-step research tasks

2. **When to use background agents:**
   - Long-running tests while you continue implementing
   - Searching large codebases for patterns
   - Build/typecheck validation while moving to next file
   - Exploring multiple subsystems in parallel

3. **Example workflow:**
   ```
   Before implementing a story:
   1. Spawn background Explore agent: "Find all files related to X"
   2. Spawn background Bash agent: "Run existing tests for module Y"
   3. While agents run, read and edit the main files
   4. Check agent results, incorporate findings
   ```

4. **Note:** Background agents write to output files (not the main stream), so they won't clutter the iteration log. Check results with `Read` tool when needed.

## Related Specs

For detailed specifications, see the `specs/` directory:

| Spec File | Description |
|-----------|-------------|
| `specs/api-design.spec.md` | API endpoint contracts, request/response schemas |
| `specs/data-model.spec.md` | Database schema, entity relationships |
| `specs/validation.spec.md` | Input validation rules, error messages |

## User Stories

### STORY-001: User Registration

**As a** new user
**I want to** create an account with email and password
**So that** I can access the application securely

**Acceptance Criteria:**
- [ ] POST /api/auth/register accepts email and password
- [ ] Email format is validated
- [ ] Password requires 8+ characters
- [ ] Duplicate email returns 409 Conflict
- [ ] Success returns 201 with user object (no password)
- [ ] Typecheck passes
- [ ] Unit tests pass

**Technical Notes:**
- Use bcrypt for password hashing (cost factor 12)
- Store in users table with id, email, password_hash, created_at
- See `specs/api-design.spec.md` for request/response format

---

### STORY-002: User Login

**As a** registered user
**I want to** log in with my credentials
**So that** I can access protected resources

**Acceptance Criteria:**
- [ ] POST /api/auth/login accepts email and password
- [ ] Valid credentials return JWT token
- [ ] Invalid credentials return 401 Unauthorized
- [ ] Token expires after 7 days
- [ ] Typecheck passes
- [ ] Unit tests pass

**Technical Notes:**
- JWT payload: { sub: user_id, email, iat, exp }
- Use HS256 algorithm with secret from env

---

### STORY-003: Auth Middleware

**As a** developer
**I want to** protect routes with authentication middleware
**So that** only authenticated users can access sensitive endpoints

**Acceptance Criteria:**
- [ ] Middleware extracts token from Authorization header
- [ ] Valid token attaches user to request context
- [ ] Invalid/expired token returns 401
- [ ] Missing token returns 401
- [ ] Typecheck passes
- [ ] Unit tests pass

**Technical Notes:**
- Header format: `Authorization: Bearer <token>`
- Attach decoded user to req.user or context

**Spec Reference:** `specs/validation.spec.md`

---

### STORY-004: Token Refresh (Optional)

**As a** logged-in user
**I want to** refresh my token before it expires
**So that** I don't get logged out unexpectedly

**Acceptance Criteria:**
- [ ] POST /api/auth/refresh accepts valid (non-expired) token
- [ ] Returns new token with extended expiration
- [ ] Expired tokens cannot be refreshed (must re-login)
- [ ] Typecheck passes
- [ ] Unit tests pass

**Technical Notes:**
- Only allow refresh within last 24 hours of token life
- Consider refresh token pattern for production

---

## Out of Scope

- Social login (OAuth/Google/GitHub) - separate feature
- Password reset / forgot password - separate feature
- Multi-factor authentication (MFA) - future enhancement
- Email verification - could add later
- Rate limiting on auth endpoints - separate security feature

## Open Questions

- Should we implement refresh tokens or just short-lived JWTs?
  - **Decision:** Start with 7-day JWTs, add refresh tokens if needed
- Where should tokens be stored client-side?
  - **Decision:** httpOnly cookie for web, localStorage acceptable for now
- Should failed login attempts be logged/tracked?
  - **Decision:** Out of scope for v1, add in security hardening phase
